<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>EcoPark Admin Panel</title>
  <!-- Inter Font & Bootstrap 5 -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter',Arial,sans-serif; background:#f7fafc; }
    .container {max-width: 1100px; margin: 36px auto 10px auto; background: #fff; border-radius:14px; box-shadow:0 8px 32px #064e3b17; padding: 32px;}
    h2 { margin-top:0; font-weight:800;}
    .auth-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px;}
    .admin-email { font-size: 15px; color: #059669; font-weight: 600; }
    .searchbar {margin: 18px 0;}
    .searchbar input[type="search"] {padding:8px 10px; border-radius:7px; border:1px solid #cbead6; font-size:15px; width:280px;}
    .table-responsive { border-radius:12px; box-shadow:0 2px 8px #064e3b13; background:#f8fafc; }
    table {width:100%; border-collapse:collapse; margin:0;}
    thead th { position:sticky; top:0; background:#e6f9ee; color:#064e3b; z-index:2;}
    th, td { padding: 10px 7px; text-align:left; font-size:15px; vertical-align:middle;}
    tr:nth-child(even) { background: #f3fff7; }
    tr:hover {padding:12px;}
      .auth-row {flex-direction:column;gap:8px;}
      .searchbar input[type="search"] {width:100%;}
      table, thead, tbody, th, td, tr {display:block;}
      thead {display:none;}
      tr {margin-bottom:12px;}
      td {border: none; position:relative; padding-left:45%; min-height:32px;}
      td:before {position:absolute; left:8px; top:8px; width:40%; white-space:nowrap; font-weight:700; color:#aaa; }
      td[data-label]:before {content: attr(data-label);}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><i class="bi bi-shield-lock-fill"></i> EcoPark Admin Panel</h2>
    <div class="auth-row">
      <span id="adminStatus" class="small">Authenticating...</span>
      <div>
        <span id="adminEmail" class="admin-email" style="display:none"></span>
        <button class="btn btn-success btn-sm" id="signInBtn" style="display:none"><i class="bi bi-google"></i> Sign in with Google</button>
        <button class="btn btn-danger btn-sm" id="signOutBtn" style="display:none"><i class="bi bi-box-arrow-right"></i> Sign Out</button>
      </div>
    </div>
    <div id="adminContent" style="display:none">
      <div class="searchbar">
        <input type="search" placeholder="Search bookings (ID, name, phone...)" id="bookingSearch" aria-label="Filter bookings"/>
      </div>
      <div class="table-responsive">
        <table class="table align-middle table-hover" id="bookingsTable">
          <thead>
            <tr>
              <th>Booking ID</th>
              <th>Type</th>
              <th>Name</th>
              <th>Mobile</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
              <th style="min-width:110px;">Actions</th>
            </tr>
          </thead>
          <tbody id="bookingsBody"></tbody>
        </table>
      </div>
      <div class="footer mt-4">
        &copy; 2024 EcoPark Admin. Secure this panel and your Firestore rules!
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="bookingDetailsModalLabel">
            <i class="bi bi-info-circle-fill"></i>Booking Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bookingDetailsBody" style="background:#f8fafc;"></div>
        <div class="modal-footer" style="background:#f8fafc;">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // --- CONFIG --- (Replace with your Firebase project config)
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    const allowedAdmins = ["your-admin-email@gmail.com"]; // <-- ADD YOUR ADMIN EMAIL HERE

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- UI Elements ---
    const adminStatus = document.getElementById('adminStatus');
    const adminEmail = document.getElementById('adminEmail');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const adminContent = document.getElementById('adminContent');
    const bookingsBody = document.getElementById('bookingsBody');
    const bookingSearch = document.getElementById('bookingSearch');
    const toastContainer = document.getElementById('toastContainer');

    // --- Auth Logic ---
    signInBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };
    signOutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user => {
      if(user && allowedAdmins.includes(user.email)) {
        adminStatus.textContent = "Signed in as admin";
        adminEmail.style.display = '';
        adminEmail.textContent = user.email;
        signInBtn.style.display = 'none';
        signOutBtn.style.display = '';
        adminContent.style.display = '';
        loadBookings();
      } else if (user) {
        adminStatus.innerHTML = `<span class="text-danger">You are not authorized. Contact admin.</span>`;
        adminEmail.style.display = '';
        adminEmail.textContent = user.email;
        signInBtn.style.display = 'none';
        signOutBtn.style.display = '';
        adminContent.style.display = 'none';
      } else {
        adminStatus.textContent = "Please sign in as admin.";
        adminEmail.style.display = 'none';
        signInBtn.style.display = '';
        signOutBtn.style.display = 'none';
        adminContent.style.display = 'none';
      }
    });

    // --- Firestore: Load bookings ---
    let allBookings = [];
    async function loadBookings() {
      bookingsBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>';
      try {
        const q = db.collection('bookings').orderBy('createdAt','desc').limit(200);
        q.onSnapshot(snap=>{
          allBookings = [];
          bookingsBody.innerHTML = '';
          snap.forEach(doc=>{
            const b = doc.data();
            allBookings.push(b);
          });
          renderBookings(allBookings);
        });
      } catch(e) {
        bookingsBody.innerHTML = `<tr><td colspan="8" class="text-danger">Error loading bookings: ${e.message}</td></tr>`;
      }
    }

    function statusBadge(b) {
      if (b.status && typeof b.status === "string" && b.status.toLowerCase() === "paid") return '<span class="badge badge-status badge-paid">Paid</span>';
      if (b.status && b.status.toLowerCase() === "processing") return '<span class="badge badge-status badge-processing">Processing</span>';
      if (b.status && b.status.toLowerCase() === "unpaid") return '<span class="badge badge-status badge-unpaid">Unpaid</span>';
      if (b.paymentId) return '<span class="badge badge-status badge-paid">Paid</span>';
      return '<span class="badge badge-status badge-unpaid">Unpaid</span>';
    }

    function renderBookings(arr) {
      bookingsBody.innerHTML = '';
      if (!arr.length) {
        bookingsBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No bookings found.</td></tr>';
        return;
      }
      for(const b of arr) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td data-label="Booking ID"><span class="fw-semibold">${escapeHtml(b.bookingId||"")}</span></td>
          <td data-label="Type">${escapeHtml(b.type||'')}</td>
          <td data-label="Name">${escapeHtml(b.name||b.customerName||'-')}</td>
          <td data-label="Mobile">${escapeHtml(b.mobile||b.userPhone||'-')}</td>
          <td data-label="Amount">₹${escapeHtml(String(b.amount||b.total||'0'))}</td>
          <td data-label="Status">${statusBadge(b)}</td>
          <td data-label="Date">${b.createdAt?new Date(b.createdAt).toLocaleString():'-'}</td>
          <td data-label="Actions">
            <button class="btn btn-sm btn-info action-btn" title="Details" onclick="showDetails('${b.bookingId}')"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-danger action-btn" title="Delete" onclick="deleteBooking('${b.bookingId}')"><i class="bi bi-trash"></i></button>
          </td>
        `;
        bookingsBody.appendChild(row);
      }
    }

    // --- Search bookings ---
    bookingSearch.addEventListener('input', function() {
      const q = bookingSearch.value.trim().toLowerCase();
      if (!q) return renderBookings(allBookings);
      const filtered = allBookings.filter(b=> {
        return (b.bookingId||'').toLowerCase().includes(q) ||
               (b.name||'').toLowerCase().includes(q) ||
               (b.mobile||'').toLowerCase().includes(q) ||
               (b.customerName||'').toLowerCase().includes(q);
      });
      renderBookings(filtered);
    });

    // --- Booking Details Modal ---
    window.showDetails = async function(bookingId) {
      const b = allBookings.find(x=>x.bookingId===bookingId);
      if(!b) {
        showToast('Booking not found','danger');
        return;
      }
      const rows = [
        ['Booking ID', b.bookingId],
        ['Type', b.type ],
        ['Name', b.name || b.customerName || '-' ],
        ['Mobile', b.mobile || b.userPhone || '-' ],
        ['Amount', '₹' + (b.amount || b.total || '0')],
        ['Cottage', b.cottageTitle || '-' ],
        ['Guests', b.numPersons || b.guests || '-' ],
        ['Check-in', b.checkin || '-' ],
        ['Check-out', b.checkout || '-' ],
        ['Payment ID', b.paymentId || '-' ],
        ['Status', (b.status|| (b.paymentId ? 'Paid' : 'Unpaid')) ],
        ['Created At', b.createdAt ? new Date(b.createdAt).toLocaleString() : '-' ]
      ];
      let html = `<table class="table table-bordered table-striped align-middle">`;
      for(const [k,v] of rows){
        html += `<tr><th style="width:32%;background:#e6f9ee;">${escapeHtml(k)}</th><td>${escapeHtml(String(v))}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById('bookingDetailsBody').innerHTML = html;
      new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
    };

    // --- Delete Booking ---
    window.deleteBooking = async function(bookingId) {
      if(!confirm(`Delete booking ${bookingId}?`)) return;
      try {
        await db.collection('bookings').doc(bookingId).delete();
        showToast('Booking deleted','success');
      } catch(e) {
        showToast('Error deleting booking: ' + e.message,'danger');
      }
    };

    // --- Toast utility ---
    function showToast(msg, type='info', timeout=2600) {
      const icon = type==='success' ? 'check-circle-fill' : (type==='danger' ? 'exclamation-triangle-fill' : 'info-circle-fill');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0 mb-2 show`;
      toast.setAttribute('role','alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body"><i class="bi bi-${icon} me-2"></i>${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      toastContainer.appendChild(toast);
      setTimeout(()=>toast.remove(), timeout);
    }

    function escapeHtml(txt){
      return String(txt).replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#x60;', '=': '&#x3D;', '/': '&#x2F;'
        })[s];
      });
    }
  </script>
</body>
</html>