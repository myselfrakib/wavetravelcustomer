<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #2c3e50, #3498db);
      color: white;
      margin: 0;
      padding: 0;
    }
    .navbar {
      background: #1f2c3f;
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .navbar button {
      background: #3498db;
      border: none;
      padding: 0.5rem 1rem;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      flex-grow: 1;
    }
    .tab-pane {
      display: none;
      padding: 1rem;
    }
    .tab-pane.active {
      display: block;
    }
    .card {
      background: #ffffff11;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      position: relative;
    }
    .card button {
      margin-top: 0.5rem;
      margin-right: 0.5rem;
      padding: 0.3rem 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .edit-btn { background: #f39c12; color: white; }
    .delete-btn { background: #e74c3c; color: white; }
    .approve-btn { background: #2ecc71; color: white; }
    .loading { text-align: center; margin-top: 2rem; font-size: 1.2rem; }
  </style>
</head>
<body>
  <div class="navbar">
    <button onclick="openTab('users')">Users</button>
    <button onclick="openTab('drivers')">Drivers</button>
    <button onclick="openTab('pending-cars')">Pending Cars</button>
    <button onclick="openTab('slots')">Slots</button>
    <button onclick="openTab('bookings')">Bookings</button>
    <button onclick="openTab('profile')">Profile</button>
  </div>

  <div id="users-tab" class="tab-pane"><h2>Users</h2><div id="users-list"></div></div>
  <div id="drivers-tab" class="tab-pane"><h2>Drivers</h2><div id="drivers-list"></div></div>
  <div id="pending-cars-tab" class="tab-pane"><h2>Pending Cars</h2><div id="pending-cars-list"></div></div>
  <div id="slots-tab" class="tab-pane"><h2>Slots</h2><div id="slots-list"></div></div>
  <div id="bookings-tab" class="tab-pane"><h2>Bookings</h2><div id="bookings-list"></div></div>
  <div id="profile-tab" class="tab-pane"><h2>Admin Profile</h2><div id="profile-details"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, get, remove, update, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentTab = '';

    window.openTab = function(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');

      if (tabName === 'users') fetchData('/users', 'users-list');
      if (tabName === 'drivers') fetchData('/drivers', 'drivers-list');
      if (tabName === 'pending-cars') fetchPendingCars();
      if (tabName === 'slots') fetchData('/availableslots', 'slots-list');
      if (tabName === 'bookings') fetchData('/bookings', 'bookings-list');
      if (tabName === 'profile') fetchData('/admins/KAgLbgB2hNbbDrgBebJV1birY463', 'profile-details', false, true);
    }

    async function fetchData(path, containerId, allowApprove = false, singleItem = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = '<div class="loading">Loading...</div>';
      try {
        const snapshot = await get(ref(db, path));
        if (snapshot.exists()) {
          const data = snapshot.val();
          let html = '';
          if (singleItem) {
            html = `<div class='card'>${Object.entries(data).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br/>')}</div>`;
          } else {
            const entries = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
            for (const [key, item] of entries) {
              html += `<div class='card'><strong>ID:</strong> ${key}<br/>${Object.entries(item).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br/>')}<br/><br/>`;
              html += `<button class='edit-btn' onclick="editItem('${path}','${key}')">Edit</button>`;
              html += `<button class='delete-btn' onclick="deleteItem('${path}','${key}')">Delete</button>`;
              html += `</div>`;
            }
          }
          container.innerHTML = html;
        } else {
          container.innerHTML = 'No data found.';
        }
      } catch (err) {
        console.error('Fetch error:', err);
        container.innerHTML = 'Failed to load data.';
      }
    }

    async function fetchPendingCars() {
      const container = document.getElementById('pending-cars-list');
      container.innerHTML = '<div class="loading">Loading...</div>';
      try {
        const snapshot = await get(ref(db, '/pendingcars'));
        if (snapshot.exists()) {
          const cars = snapshot.val();
          const entries = Object.entries(cars).sort((a, b) => b[1].timestamp - a[1].timestamp);
          let html = '';
          for (const [key, car] of entries) {
            let driverDetails = '';
            if (car.driverId) {
              const driverSnap = await get(ref(db, `/drivers/${car.driverId}`));
              if (driverSnap.exists()) {
                const driver = driverSnap.val();
                driverDetails = '<br/><br/><strong>Driver Details:</strong><br/>' +
                  Object.entries(driver).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br/>');
              }
            }
            html += `<div class='card'><strong>Car ID:</strong> ${key}<br/>` +
                    Object.entries(car).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br/>') +
                    driverDetails +
                    `<br/><br/><button class='edit-btn' onclick="editItem('/pendingcars','${key}')">Edit</button>` +
                    `<button class='delete-btn' onclick="deleteItem('/pendingcars','${key}')">Delete</button>` +
                    `<button class='approve-btn' onclick="approveCar('${key}')">Approve</button></div>`;
          }
          container.innerHTML = html;
        } else {
          container.innerHTML = 'No pending cars.';
        }
      } catch (err) {
        console.error('Pending cars fetch error:', err);
        container.innerHTML = 'Failed to load pending cars.';
      }
    }

    window.deleteItem = async function(path, key) {
      if (confirm('Are you sure you want to delete this item?')) {
        try {
          await remove(ref(db, `${path}/${key}`));
          alert('Deleted successfully.');
          openTab(currentTab);
        } catch (err) {
          console.error('Delete error:', err);
        }
      }
    }

    window.editItem = async function(path, key) {
      const itemRef = ref(db, `${path}/${key}`);
      const snapshot = await get(itemRef);
      if (snapshot.exists()) {
        const itemData = snapshot.val();
        // Placeholder: edit logic could be implemented here
      }
    }

    window.approveCar = async function(key) {
      const carRef = ref(db, `/pendingcars/${key}`);
      const carSnapshot = await get(carRef);
      if (carSnapshot.exists()) {
        const carData = carSnapshot.val();

        // Preserve driverId and move data
        const approvedData = {
          ...carData,
          driverId: carData.driverId || null
        };

        await set(ref(db, `/approvedcars/${key}`), approvedData);
        await remove(ref(db, `/pendingcars/${key}`));
        alert('Car approved.');
        openTab('pending-cars');
      }
    }

    openTab('users');
  </script>
</body>
</html>
