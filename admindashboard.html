<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaveTravel â€” Admin Dashboard</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --success: #059669;
      --danger: #dc2626;
      --warning: #d97706;
      --info: #0891b2;
      --light: #f8fafc;
      --dark: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, Arial, sans-serif;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
    }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 1030;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      color: var(--dark);
      font-weight: 700;
      text-decoration: none;
    }

    .brand img {
      height: 40px;
      width: 40px;
      object-fit: cover;
      border-radius: 10px;
      box-shadow: var(--shadow);
    }

    .brand-text {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .brand-subtitle {
      font-size: 0.875rem;
      color: var(--muted);
      font-weight: 400;
    }

    .nav-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--dark);
      transition: all 0.2s;
    }

    .btn-ghost:hover {
      background: var(--light);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Layout */
    .container-main {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      padding: 24px;
      min-height: calc(100vh - 80px);
    }

    /* Sidebar */
    .sidebar {
      background: white;
      padding: 20px;
      border-radius: 16px;
      height: fit-content;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .sidebar .nav-link {
      color: var(--muted);
      font-weight: 500;
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 4px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
    }

    .sidebar .nav-link:hover {
      background: var(--light);
      color: var(--primary);
    }

    .sidebar .nav-link.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: var(--shadow);
    }

    /* Content area */
    .panel {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .panel h2 {
      font-size: 1.5rem;
      margin: 0 0 20px 0;
      color: var(--dark);
      font-weight: 600;
    }

    /* Tables */
    table.dataTable {
      background: white !important;
      color: var(--dark) !important;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    table.dataTable thead th {
      background: var(--light) !important;
      color: var(--dark) !important;
      font-weight: 600;
      border-bottom: 2px solid var(--border) !important;
    }

    table.dataTable tbody tr:hover {
      background: var(--light) !important;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border: none;
      box-shadow: var(--shadow);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
      border: none;
      box-shadow: var(--shadow);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%);
      border: none;
      box-shadow: var(--shadow);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info) 0%, #06b6d4 100%);
      border: none;
      box-shadow: var(--shadow);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
      border: none;
      box-shadow: var(--shadow);
    }

    /* Driver wallet cards */
    .driver-wallets-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }

    .driver-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      transition: all 0.3s ease;
    }

    .driver-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    .driver-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .driver-meta strong {
      color: var(--dark);
      font-size: 1.1rem;
    }

    .driver-meta .small-muted {
      color: var(--muted);
      font-size: 0.875rem;
    }

    .badge-paid {
      background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-unpaid {
      background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-processing {
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Image gallery */
    .image-gallery {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .image-thumbnail {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
    }

    .image-thumbnail:hover {
      border-color: var(--primary);
      transform: scale(1.05);
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 37%, #f1f5f9 63%);
      background-size: 400% 100%;
      animation: skeleton 1.5s ease-in-out infinite;
      border-radius: 8px;
    }

    @keyframes skeleton {
      0% { background-position: 100% 0; }
      100% { background-position: -100% 0; }
    }

    /* Form controls */
    .form-control {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.875rem;
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-select {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.875rem;
    }

    /* Search box */
    .search-container .form-control {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border);
    }

    .search-container .input-group-text {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border);
      border-right: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .container-main {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      
      .sidebar {
        order: 2;
        height: auto;
      }
      
      .driver-wallets-container {
        grid-template-columns: 1fr;
      }
    }

    /* Modals */
    .modal-content {
      border: none;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
    }

    .modal-header {
      background: var(--light);
      border-bottom: 1px solid var(--border);
      border-radius: 16px 16px 0 0;
    }

    /* Toast */
    .toast {
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
    }

    /* Utilities */
    .small-muted {
      color: var(--muted);
      font-size: 0.875rem;
    }

    .text-primary { color: var(--primary) !important; }
    .text-success { color: var(--success) !important; }
    .text-danger { color: var(--danger) !important; }
    .text-warning { color: var(--warning) !important; }
    .text-info { color: var(--info) !important; }
    .text-muted { color: var(--muted) !important; }

    /* Focus states */
    .nav-link:focus, .btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* DataTables custom styling */
    .dataTables_wrapper {
      font-size: 0.875rem;
    }

    .dataTables_filter input {
      border: 1px solid var(--border) !important;
      border-radius: 8px !important;
      padding: 6px 12px !important;
    }

    .dataTables_length select {
      border: 1px solid var(--border) !important;
      border-radius: 8px !important;
      padding: 6px 12px !important;
    }

    .dt-button {
      background: white !important;
      border: 1px solid var(--border) !important;
      color: var(--dark) !important;
      border-radius: 6px !important;
      padding: 6px 12px !important;
      margin: 2px !important;
    }

    .dt-button:hover {
      background: var(--light) !important;
      border-color: var(--primary) !important;
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <nav class="topbar py-3 px-4 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-4">
      <div class="brand">
        <img src="https://wavetravel-3c4c4.web.app/logo192.png" alt="WaveTravel Logo" onerror="this.style.display='none'">
        <div>
          <div class="brand-text">WaveTravel</div>
          <div class="brand-subtitle">Admin Dashboard</div>
        </div>
      </div>
      <div class="d-none d-md-flex search-container">
        <div class="input-group">
          <span class="input-group-text bg-transparent border-0 text-muted">
            <i class="bi bi-search"></i>
          </span>
          <input id="globalSearch" class="form-control bg-transparent border-0" 
                 placeholder="Quick search (press /)" aria-label="Search" />
        </div>
      </div>
    </div>

    <div class="nav-actions">
      <button id="refreshAllBtn" class="btn btn-sm btn-ghost" title="Refresh current tab">
        <i class="bi bi-arrow-clockwise"></i>
      </button>
      <div class="dropdown">
        <button class="btn btn-sm btn-ghost dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-gear"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" onclick="openTab('users')">
            <i class="bi bi-people me-2"></i>Open Users</a></li>
          <li><a class="dropdown-item" href="#" onclick="openTab('driver-wallets')">
            <i class="bi bi-wallet2 me-2"></i>Open Driver Wallets</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">
            <i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-main">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Main navigation">
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" onclick="openTab('users')">
          <i class="bi bi-people"></i> Users
        </a>
        <a class="nav-link" href="#" onclick="openTab('drivers')">
          <i class="bi bi-person-badge"></i> Drivers
        </a>
        <a class="nav-link" href="#" onclick="openTab('pending-cars')">
          <i class="bi bi-hourglass-split"></i> Pending Cars
        </a>
        <a class="nav-link" href="#" onclick="openTab('approved-cars')">
          <i class="bi bi-check2-square"></i> Approved Cars
        </a>
        <a class="nav-link" href="#" onclick="openTab('slots')">
          <i class="bi bi-calendar2-day"></i> Slots
        </a>
        <a class="nav-link" href="#" onclick="openTab('bookings')">
          <i class="bi bi-journal-check"></i> Bookings
        </a>
        <a class="nav-link" href="#" onclick="openTab('ride-requests')">
          <i class="bi bi-geo-alt"></i> Ride Requests
        </a>
        <a class="nav-link" href="#" onclick="openTab('driver-wallets')">
          <i class="bi bi-wallet2"></i> Driver Wallets
        </a>
        <a class="nav-link" href="#" onclick="openTab('pending-withdrawals')">
          <i class="bi bi-credit-card"></i> Pending Withdrawals
        </a>
        <a class="nav-link" href="#" onclick="openTab('profile')">
          <i class="bi bi-person-circle"></i> Profile
        </a>
        
        <div style="height: 20px;"></div>
        <button class="btn btn-danger w-100" onclick="logout()">
          <i class="bi bi-box-arrow-right me-2"></i> Sign out
        </button>
      </nav>
    </aside>

    <!-- Main content area -->
    <main>
      <!-- USERS TAB -->
      <section id="users-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-people me-2 text-primary"></i>Users</h2>
        <div id="users-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="users-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>User ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Created On</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- DRIVERS TAB -->
      <section id="drivers-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-person-badge me-2 text-primary"></i>Drivers</h2>
        <div id="drivers-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="drivers-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>Driver ID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Vehicle Count</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- PENDING CARS TAB -->
      <section id="pending-cars-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-hourglass-split me-2 text-warning"></i>Pending Cars</h2>
        <div id="pending-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="pending-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>Driver ID</th>
                <th>Car ID</th>
                <th>Brand</th>
                <th>Reg No</th>
                <th>Driver Name</th>
                <th>Driver Number</th>
                <th>Owner Name</th>
                <th>Seats</th>
                <th>Images</th>
                <th>License</th>
                <th>Submitted At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- APPROVED CARS TAB -->
      <section id="approved-cars-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-check2-square me-2 text-success"></i>Approved Cars</h2>
        <div id="approved-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="approved-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>Driver Name</th>
                <th>Phone</th>
                <th>Car ID</th>
                <th>Brand</th>
                <th>Reg No</th>
                <th>Owner</th>
                <th>Seats</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- SLOTS TAB -->
      <section id="slots-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-calendar2-day me-2 text-info"></i>Slots</h2>
        <div id="slots-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="slots-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>Driver Name</th>
                <th>Phone</th>
                <th>Slot ID</th>
                <th>Pickup</th>
                <th>Dropoff</th>
                <th>Date</th>
                <th>Time</th>
                <th>Seats</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- BOOKINGS TAB -->
      <section id="bookings-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-journal-check me-2 text-primary"></i>Bookings</h2>
        <div id="bookings-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="bookings-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>Booking ID</th>
                <th>Customer</th>
                <th>Vehicle</th>
                <th>Pickup</th>
                <th>Dropoff</th>
                <th>Duration</th>
                <th>Fare</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- RIDE REQUESTS TAB -->
      <section id="ride-requests-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-geo-alt me-2 text-info"></i>Ride Requests</h2>
        <div id="riderequest-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="riderequest-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>SL</th>
                <th>Request ID</th>
                <th>Customer</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Trip Type</th>
                <th>Pickup</th>
                <th>Dropoff</th>
                <th>Date</th>
                <th>Status</th>
                <th>Requested At</th>
                <th>Notes</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- DRIVER WALLETS TAB -->
      <section id="driver-wallets-tab" class="tab-pane panel" hidden>
        <div class="d-flex align-items-center justify-content-between mb-4">
          <h2><i class="bi bi-wallet2 me-2 text-success"></i>Driver Wallets</h2>
          <div class="d-flex align-items-center gap-3">
            <label for="walletStatusFilter" class="small-muted mb-0">Filter:</label>
            <select id="walletStatusFilter" class="form-select form-select-sm" style="width: auto;">
              <option value="processing" selected>Processing</option>
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
            <button id="walletFilterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
          </div>
        </div>

        <div id="wallets-loading" class="skeleton" style="height:80px;"></div>
        <div id="driver-wallets-container" class="driver-wallets-container" style="display:none;"></div>
      </section>

      <!-- PENDING WITHDRAWALS TAB -->
      <section id="pending-withdrawals-tab" class="tab-pane panel" hidden>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-credit-card me-2 text-warning"></i>Pending Withdrawals</h2>
          <button id="exportWithdrawalsBtn" class="btn btn-primary">
            <i class="bi bi-download me-2"></i>Export CSV (Grouped)
          </button>
        </div>
        <div id="withdrawals-loading" class="skeleton" style="height:60px;"></div>
        <div id="withdrawals-container" style="display:none;"></div>
      </section>

      <!-- PROFILE TAB -->
      <section id="profile-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-person-circle me-2 text-info"></i>My Profile</h2>
        <div id="profile-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="profile-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead>
              <tr>
                <th>Field</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bookingDetailsBody"></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="imageViewerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageViewerTitle">Image Viewer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center" id="imageViewerBody">
          <img id="imageViewerImg" src="" alt="Image" style="max-width:100%;height:auto;border-radius:8px">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h5 class="text-primary mb-3">UPI Payment QR</h5>
        <div id="qrCode" class="my-3 d-flex justify-content-center"></div>
        <div id="qrInfo" class="mb-3 small-muted"></div>
        <div id="upiUriBox" class="mb-3 small-muted text-start p-3 bg-light rounded" style="word-break:break-all;"></div>
        <div class="d-flex gap-2 justify-content-center flex-wrap">
          <button id="copyUpiUriBtn" class="btn btn-sm btn-outline-primary">Copy Minimal UPI URI</button>
          <button id="copyFullUpiUriBtn" class="btn btn-sm btn-outline-secondary">Copy Full UPI URI</button>
          <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" aria-live="polite" aria-atomic="true" 
       style="position:fixed;right:20px;bottom:20px;z-index:1200;"></div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, update, remove, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Global variables
    const tables = {};
    let currentUser = null;

    // Utility functions
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function sanitizeId(id) {
      return String(id).replace(/[^a-z0-9\-_]/gi, '-');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Toast notification system
    function showToast(message, type = 'info', timeout = 3500) {
      const toastId = 'toast-' + Date.now();
      const bgClass = type === 'success' ? 'text-bg-success' : 
                     type === 'danger' ? 'text-bg-danger' : 
                     type === 'warning' ? 'text-bg-warning' : 
                     'text-bg-info';
      
      const toastHtml = `
        <div id="${toastId}" class="toast ${bgClass} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${escapeHtml(message)}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        </div>`;
      
      const container = document.getElementById('toast-container');
      container.insertAdjacentHTML('beforeend', toastHtml);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: timeout });
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    // DataTable initialization
    function initTable(id, nonSortableCols = []) {
      if (tables[id]) {
        tables[id].clear();
        tables[id].destroy();
      }
      
      tables[id] = $(`#${id}`).DataTable({
        responsive: true,
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'print'],
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        columnDefs: nonSortableCols.map(col => ({ orderable: false, targets: col })),
        language: {
          emptyTable: 'No records found.',
          loadingRecords: 'Loading...',
          processing: 'Processing...'
        },
        order: [[0, 'asc']]
      });
      
      return tables[id];
    }

    // Image viewer functionality
    window.showImage = function(imageUrl, title = 'Image') {
      document.getElementById('imageViewerTitle').textContent = title;
      document.getElementById('imageViewerImg').src = imageUrl;
      const modal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
      modal.show();
    };

    // Create image gallery
    function createImageGallery(images, type = 'car') {
      if (!images || !Array.isArray(images) || images.length === 0) {
        return '<span class="small-muted">No images</span>';
      }
      
      let html = '<div class="image-gallery">';
      images.forEach((imageUrl, index) => {
        const title = type === 'license' ? 'Driver License' : `Car Image ${index + 1}`;
        html += `<img loading="lazy" src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}" 
                     class="image-thumbnail" onclick="showImage('${escapeHtml(imageUrl)}', '${escapeHtml(title)}')">`;
      });
      html += '</div>';
      return html;
    }

    // Safe field picker for nested objects
    function pickField(obj, candidates) {
      for (const key of candidates) {
        if (key.includes('.')) {
          const parts = key.split('.');
          let current = obj;
          let valid = true;
          
          for (const part of parts) {
            if (current && typeof current === 'object' && part in current) {
              current = current[part];
            } else {
              valid = false;
              break;
            }
          }
          
          if (valid && current !== undefined && current !== null && current !== '') {
            return current;
          }
        } else {
          if (obj && typeof obj === 'object' && key in obj && 
              obj[key] !== undefined && obj[key] !== null && obj[key] !== '') {
            return obj[key];
          }
        }
      }
      return null;
    }

    function safeDisplay(value) {
      if (value === null || value === undefined) return '';
      if (typeof value === 'object') {
        try {
          const str = JSON.stringify(value);
          return str.length > 100 ? str.substring(0, 100) + '...' : str;
        } catch (e) {
          return String(value);
        }
      }
      return String(value);
    }

    // Wallet status detection
    function getEffectiveStatusFromWalletEntry(entry) {
      if (!entry) return 'unpaid';
      
      // Check explicit status first
      if (entry.status) {
        const status = String(entry.status).toLowerCase();
        if (['paid', 'approved', 'completed'].includes(status)) return 'paid';
        if (['processing', 'pending', 'requested'].includes(status)) return 'processing';
      }
      
      // Check paidout flag
      if (entry.paidout === true) return 'paid';
      
      // Check withdrawal request flags
      const withdrawalFlags = [
        'withdrawalRequested', 'withdrawal_requested', 'requested',
        'pendingWithdrawal', 'withdrawRequested', 'withdraw_requested'
      ];
      
      for (const flag of withdrawalFlags) {
        if (entry[flag] === true) return 'processing';
      }
      
      // Check timestamp fields
      const timestampFields = ['requestedAt', 'requestedOn', 'requestTimestamp'];
      for (const field of timestampFields) {
        if (entry[field]) return 'processing';
      }
      
      return 'unpaid';
    }

    // Authentication
    window.logout = () => {
      signOut(auth).then(() => {
        window.location.href = 'adminlogin.html';
      }).catch((error) => {
        showToast('Logout failed: ' + error.message, 'danger');
      });
    };

    // CRUD Operations
    async function safeDelete(path, confirmMsg, successMsg, reloadFn) {
      if (!confirm(confirmMsg)) return;
      
      try {
        await remove(ref(db, path));
        showToast(successMsg, 'success');
        if (typeof reloadFn === 'function') {
          reloadFn();
        }
      } catch (error) {
        showToast('Delete failed: ' + error.message, 'danger');
        console.error('Delete error:', error);
      }
    }

    // Load functions
    async function loadUsers() {
      document.getElementById('users-table').style.display = 'none';
      document.getElementById('users-loading').style.display = 'block';
      
      const table = initTable('users-table', [7]);
      
      try {
        const snapshot = await get(ref(db, 'users'));
        const rows = [];
        let serialNo = 1;
        
        if (snapshot.exists()) {
          const users = snapshot.val();
          for (const [uid, user] of Object.entries(users)) {
            rows.push([
              serialNo++,
              uid,
              escapeHtml(user.name || ''),
              escapeHtml(user.email || ''),
              escapeHtml(user.phone || ''),
              escapeHtml(user.address || ''),
              escapeHtml(user.createdOn || ''),
              `<button class="btn btn-sm btn-danger" onclick="deleteUser('${escapeHtml(uid)}')">
                <i class="bi bi-trash"></i> Delete
               </button>`
            ]);
          }
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load users: ' + error.message, 'danger');
        console.error('Load users error:', error);
      } finally {
        document.getElementById('users-loading').style.display = 'none';
        document.getElementById('users-table').style.display = 'table';
      }
    }

    async function loadDrivers() {
      document.getElementById('drivers-table').style.display = 'none';
      document.getElementById('drivers-loading').style.display = 'block';
      
      const table = initTable('drivers-table', [5]);
      
      try {
        const snapshot = await get(ref(db, 'driverdetails'));
        const rows = [];
        let serialNo = 1;
        
        if (snapshot.exists()) {
          const drivers = snapshot.val();
          for (const [driverId, driver] of Object.entries(drivers)) {
            const vehicleCount = driver.vehicles ? Object.keys(driver.vehicles).length : 0;
            rows.push([
              serialNo++,
              driverId,
              escapeHtml(driver.name || ''),
              escapeHtml(driver.phone || ''),
              vehicleCount,
              `<button class="btn btn-sm btn-danger" onclick="deleteDriver('${escapeHtml(driverId)}')">
                <i class="bi bi-trash"></i> Delete
               </button>`
            ]);
          }
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load drivers: ' + error.message, 'danger');
        console.error('Load drivers error:', error);
      } finally {
        document.getElementById('drivers-loading').style.display = 'none';
        document.getElementById('drivers-table').style.display = 'table';
      }
    }

    async function loadPendingCars() {
      document.getElementById('pending-table').style.display = 'none';
      document.getElementById('pending-loading').style.display = 'block';
      
      const table = initTable('pending-table', [9, 10, 12]);
      
      try {
        const snapshot = await get(ref(db, 'pendingcars'));
        const rows = [];
        let serialNo = 1;
        
        if (snapshot.exists()) {
          const pendingCars = snapshot.val();
          for (const [driverId, cars] of Object.entries(pendingCars)) {
            for (const [carId, car] of Object.entries(cars)) {
              const imageGallery = createImageGallery(car.carImages || [], 'car');
              const licenseGallery = car.driverLicense ? 
                createImageGallery([car.driverLicense], 'license') : 
                '<span class="small-muted">No license</span>';
              
              rows.push([
                serialNo++,
                driverId,
                carId,
                escapeHtml(car.carBrand || ''),
                escapeHtml(car.carReg || ''),
                escapeHtml(car.driverName || ''),
                escapeHtml(car.driverNumber || ''),
                escapeHtml(car.ownerName || ''),
                escapeHtml(car.seats || ''),
                imageGallery,
                licenseGallery,
                escapeHtml(car.submittedAt || ''),
                `<div class="btn-group">
                  <button class="btn btn-sm btn-success" onclick="approveCar('${escapeHtml(driverId)}', '${escapeHtml(carId)}')">
                    <i class="bi bi-check"></i> Approve
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deletePendingCar('${escapeHtml(driverId)}', '${escapeHtml(carId)}')">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </div>`
              ]);
            }
          }
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load pending cars: ' + error.message, 'danger');
        console.error('Load pending cars error:', error);
      } finally {
        document.getElementById('pending-loading').style.display = 'none';
        document.getElementById('pending-table').style.display = 'table';
      }
    }

    async function loadApprovedCars() {
      document.getElementById('approved-table').style.display = 'none';
      document.getElementById('approved-loading').style.display = 'block';
      
      const table = initTable('approved-table', [8]);
      
      try {
        const snapshot = await get(ref(db, 'approvedcars'));
        const rows = [];
        let serialNo = 1;
        
        if (snapshot.exists()) {
          const approvedCars = snapshot.val();
          for (const [driverId, cars] of Object.entries(approvedCars)) {
            for (const [carId, car] of Object.entries(cars)) {
              rows.push([
                serialNo++,
                escapeHtml(car.driverName || ''),
                escapeHtml(car.driverNumber || ''),
                carId,
                escapeHtml(car.carBrand || ''),
                escapeHtml(car.carReg || ''),
                escapeHtml(car.ownerName || ''),
                escapeHtml(car.seats || ''),
                `<button class="btn btn-sm btn-danger" onclick="deleteApprovedCar('${escapeHtml(driverId)}', '${escapeHtml(carId)}')">
                  <i class="bi bi-trash"></i> Delete
                 </button>`
              ]);
            }
          }
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load approved cars: ' + error.message, 'danger');
        console.error('Load approved cars error:', error);
      } finally {
        document.getElementById('approved-loading').style.display = 'none';
        document.getElementById('approved-table').style.display = 'table';
      }
    }

    async function loadSlots() {
      document.getElementById('slots-table').style.display = 'none';
      document.getElementById('slots-loading').style.display = 'block';
      
      const table = initTable('slots-table', [9]);
      
      try {
        const snapshot = await get(ref(db, 'availableslots'));
        const rows = [];
        let serialNo = 1;
        
        if (snapshot.exists()) {
          const slots = snapshot.val();
          for (const [driverId, driverSlots] of Object.entries(slots)) {
            // Get driver details
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            const driver = driverSnapshot.exists() ? driverSnapshot.val() : {};
            
            for (const [slotId, slot] of Object.entries(driverSlots)) {
              rows.push([
                serialNo++,
                escapeHtml(driver.name || ''),
                escapeHtml(driver.phone || ''),
                slotId,
                escapeHtml(slot.pickup || ''),
                escapeHtml(slot.dropoff || ''),
                escapeHtml(slot.date || ''),
                escapeHtml(slot.time || ''),
                escapeHtml(slot.seats || ''),
                `<button class="btn btn-sm btn-danger" onclick="deleteSlot('${escapeHtml(driverId)}', '${escapeHtml(slotId)}')">
                  <i class="bi bi-trash"></i> Delete
                 </button>`
              ]);
            }
          }
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load slots: ' + error.message, 'danger');
        console.error('Load slots error:', error);
      } finally {
        document.getElementById('slots-loading').style.display = 'none';
        document.getElementById('slots-table').style.display = 'table';
      }
    }

    async function loadBookings() {
      document.getElementById('bookings-table').style.display = 'none';
      document.getElementById('bookings-loading').style.display = 'block';
      
      const table = initTable('bookings-table', [9]);
      
      try {
        const snapshot = await get(ref(db, 'bookings'));
        const rows = [];
        let serialNo = 1;
        
        if (snapshot.exists()) {
          const bookings = snapshot.val();
          
          function processBooking(bookingId, booking) {
            const customer = pickField(booking, ['customerName', 'userName', 'customer', 'name']) || '';
            let vehicle = pickField(booking, ['vehicle', 'car', 'vehicleInfo', 'carBrand']) || '';
            
            if (typeof vehicle === 'object') {
              vehicle = vehicle.brand ? 
                `${vehicle.brand}${vehicle.reg ? ' (' + vehicle.reg + ')' : ''}` :
                (vehicle.reg || JSON.stringify(vehicle));
            }
            
            const pickup = pickField(booking, ['pickup', 'from', 'start']) || '';
            const dropoff = pickField(booking, ['dropoff', 'to', 'end']) || '';
            const duration = pickField(booking, ['duration', 'tripDuration']) || '';
            const fare = pickField(booking, ['fare', 'amount', 'price']) || '';
            const status = pickField(booking, ['status', 'paymentStatus', 'state']) || '';
            
            rows.push([
              serialNo++,
              bookingId,
              escapeHtml(safeDisplay(customer)),
              escapeHtml(safeDisplay(vehicle)),
              escapeHtml(safeDisplay(pickup)),
              escapeHtml(safeDisplay(dropoff)),
              escapeHtml(safeDisplay(duration)),
              escapeHtml(safeDisplay(fare)),
              escapeHtml(safeDisplay(status)),
              `<button class="btn btn-sm btn-danger" onclick="deleteBooking('${escapeHtml(bookingId)}')">
                <i class="bi bi-trash"></i> Delete
               </button>`
            ]);
          }
          
          // Handle both flat and nested booking structures
          const values = Object.values(bookings);
          const isFlat = values.some(v => v && (v.pickup || v.fare || v.customerName));
          
          if (isFlat) {
            for (const [bookingId, booking] of Object.entries(bookings)) {
              processBooking(bookingId, booking);
            }
          } else {
            for (const [groupKey, group] of Object.entries(bookings)) {
              if (group && typeof group === 'object') {
                for (const [bookingId, booking] of Object.entries(group)) {
                  processBooking(bookingId, booking);
                }
              }
            }
          }
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load bookings: ' + error.message, 'danger');
        console.error('Load bookings error:', error);
      } finally {
        document.getElementById('bookings-loading').style.display = 'none';
        document.getElementById('bookings-table').style.display = 'table';
      }
    }

    async function loadRideRequests() {
      document.getElementById('riderequest-table').style.display = 'none';
      document.getElementById('riderequest-loading').style.display = 'block';
      const table = initTable('riderequest-table', [12]);
      try {
        const snapshot = await get(ref(db, 'riderequest'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const requests = snapshot.val();
          for (const [requestId, req] of Object.entries(requests)) {
            const requestedAt = req.requestedAt ? new Date(Number(req.requestedAt)).toLocaleString() : '';
            rows.push([
              serialNo++,
              requestId,
              escapeHtml(req.customerName || ''),
              escapeHtml(req.customerEmail || ''),
              escapeHtml(req.customerPhone || ''),
              escapeHtml(req.tripType || ''),
              escapeHtml(req.pickup || ''),
              escapeHtml(req.dropoff || ''),
              escapeHtml(req.date || ''),
              escapeHtml(req.status || ''),
              escapeHtml(requestedAt),
              escapeHtml(req.notes || ''),
              `<button class="btn btn-sm btn-danger" onclick="deleteRideRequest('${escapeHtml(requestId)}')">
                <i class="bi bi-trash"></i> Delete
               </button>`
            ]);
          }
        }
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load ride requests: ' + error.message, 'danger');
        console.error('Load ride requests error:', error);
      } finally {
        document.getElementById('riderequest-loading').style.display = 'none';
        document.getElementById('riderequest-table').style.display = 'table';
      }
    }

    async function loadWallets() {
      document.getElementById('driver-wallets-container').style.display = 'none';
      document.getElementById('wallets-loading').style.display = 'block';
      
      const container = document.getElementById('driver-wallets-container');
      container.innerHTML = '';
      
      const statusFilter = (document.getElementById('walletStatusFilter')?.value || 'processing').toLowerCase();
      
      try {
        const snapshot = await get(ref(db, 'driverWallet'));
        
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No wallet entries found.</p></div>';
          return;
        }
        
        const allDriverWallets = snapshot.val();
        
        for (const [driverId, entries] of Object.entries(allDriverWallets)) {
          const matchingEntries = {};
          
          // Filter entries by status
          for (const [bookingId, entry] of Object.entries(entries)) {
            const effectiveStatus = getEffectiveStatusFromWalletEntry(entry);
            if (effectiveStatus === statusFilter) {
              matchingEntries[bookingId] = { entry, effectiveStatus };
            }
          }
          
          if (Object.keys(matchingEntries).length === 0) continue;
          
          // Get driver details
          let driverName = null;
          let upiId = null;
          
          try {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            if (driverSnapshot.exists()) {
              const driver = driverSnapshot.val();
              driverName = driver.name || null;
              upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
            }
          } catch (e) {
            console.warn('Failed to load driver details:', e);
          }
          
          // Calculate totals
          let totalFiltered = 0;
          let totalProcessing = 0;
          
          for (const [bookingId, obj] of Object.entries(matchingEntries)) {
            const amount = parseFloat(obj.entry.amount) || 0;
            totalFiltered += amount;
            if (obj.effectiveStatus === 'processing') {
              totalProcessing += amount;
            }
          }
          
          // Create driver card
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card';
          
          const sanitizedId = sanitizeId(driverId);
          
          driverCard.innerHTML = `
            <div class="driver-header">
              <div class="driver-info">
                <div class="driver-meta">
                  <strong>${driverName ? escapeHtml(driverName) : escapeHtml(driverId)}</strong>
                  <div class="small-muted">ID: ${escapeHtml(driverId)}</div>
                  <div class="small-muted">UPI: <span id="upi-${sanitizedId}">${upiId ? escapeHtml(upiId) : 'â€”'}</span></div>
                </div>
              </div>
              <div class="d-flex align-items-center gap-3">
                <div class="text-end">
                  <h4 class="m-0 text-primary">â‚¹${totalFiltered.toFixed(2)}</h4>
                  <div class="small-muted">Total (${escapeHtml(statusFilter)})</div>
                </div>
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="copy-upi-${sanitizedId}" ${!upiId ? 'disabled' : ''}>
                      <i class="bi bi-clipboard"></i> Copy UPI
                    </button>
                    <button class="btn btn-sm btn-primary" id="qr-total-${sanitizedId}" ${(!upiId || totalProcessing <= 0) ? 'disabled' : ''}>
                      <i class="bi bi-qr-code"></i> Show QR
                    </button>
                    <button class="btn btn-sm btn-success" id="mark-all-paid-${sanitizedId}">
                      <i class="bi bi-cash-stack"></i> Mark All Paid
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="mt-3">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>SL</th>
                    <th>Booking</th>
                    <th>Amount</th>
                    <th>Fare</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="entries-${sanitizedId}">
                </tbody>
              </table>
            </div>
          `;
          
          // Populate entries table
          const tbody = driverCard.querySelector(`#entries-${sanitizedId}`);
          let entryIndex = 1;
          
          for (const [bookingId, obj] of Object.entries(matchingEntries)) {
            const entry = obj.entry;
            const effectiveStatus = obj.effectiveStatus;
            const amount = Number(entry.amount) || 0;
            const fare = entry.fare ?? entry.booking?.fare ?? 'N/A';
            const isPaid = entry.paidout === true || effectiveStatus === 'paid';
            const pickup = entry.booking?.pickup || entry.pickup || 'N/A';
            const dropoff = entry.booking?.dropoff || entry.dropoff || 'N/A';
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${entryIndex++}</td>
              <td style="min-width: 200px;">
                <div><strong>${escapeHtml(bookingId)}</strong></div>
                <small class="text-muted">${escapeHtml(pickup)} â†’ ${escapeHtml(dropoff)}</small>
              </td>
              <td>â‚¹${amount.toFixed(2)}</td>
              <td>â‚¹${escapeHtml(String(fare))}</td>
              <td>
                ${isPaid ? 
                  '<span class="badge-paid">Paid</span>' : 
                  effectiveStatus === 'processing' ? '<span class="badge-processing">Processing</span>' : '<span class="badge-unpaid">Unpaid</span>'
                }
              </td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-info" onclick="showBookingModal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${amount}, '${escapeHtml(bookingId)}')" 
                          ${(!upiId || isPaid) ? 'disabled' : ''}>
                    <i class="bi bi-qr-code"></i>
                  </button>
                  <button class="btn btn-sm btn-success" onclick="markPaidEntry('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(row);
          }
          
          container.appendChild(driverCard);
          
          // Wire up card-level buttons
          setTimeout(() => {
            const copyBtn = document.getElementById(`copy-upi-${sanitizedId}`);
            if (copyBtn && upiId) {
              copyBtn.addEventListener('click', async () => {
                try {
                  await navigator.clipboard.writeText(upiId);
                  showToast('UPI ID copied to clipboard', 'success');
                } catch (error) {
                  showToast('Failed to copy UPI ID', 'danger');
                }
              });
            }
            
            const qrTotalBtn = document.getElementById(`qr-total-${sanitizedId}`);
            if (qrTotalBtn && upiId && !qrTotalBtn.disabled) {
              qrTotalBtn.addEventListener('click', () => {
                showQrModal(driverId, totalProcessing, '');
              });
            }
            
            const markAllBtn = document.getElementById(`mark-all-paid-${sanitizedId}`);
            if (markAllBtn) {
              markAllBtn.addEventListener('click', () => {
                markAllPaidForDriver(driverId);
              });
            }
          }, 100);
        }
      } catch (error) {
        showToast('Failed to load wallets: ' + error.message, 'danger');
        console.error('Load wallets error:', error);
      } finally {
        document.getElementById('wallets-loading').style.display = 'none';
        document.getElementById('driver-wallets-container').style.display = 'grid';
      }
    }

    async function loadWithdrawals() {
      document.getElementById('withdrawals-container').style.display = 'none';
      document.getElementById('withdrawals-loading').style.display = 'block';
      
      const container = document.getElementById('withdrawals-container');
      container.innerHTML = '';
      
      try {
        const snapshot = await get(ref(db, 'pendingWithdrawals'));
        
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No pending withdrawals found.</p></div>';
          return;
        }
        
        const withdrawalsByDriver = snapshot.val();
        
        for (const [driverId, bookingsObj] of Object.entries(withdrawalsByDriver)) {
          let totalAmount = 0;
          for (const booking of Object.values(bookingsObj)) {
            totalAmount += Number(booking.amount) || 0;
          }
          
          // Get driver details
          let driverName = null;
          let upiId = null;
          
          try {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            if (driverSnapshot.exists()) {
              const driver = driverSnapshot.val();
              driverName = driver.name || null;
              upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
            }
          } catch (e) {
            console.warn('Failed to load driver details:', e);
          }
          
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card mb-4';
          
          driverCard.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="m-0 text-primary">Driver: ${escapeHtml(driverId)} ${driverName ? `â€” ${escapeHtml(driverName)}` : ''}</h5>
                <small class="text-muted">UPI: ${upiId ? escapeHtml(upiId) : 'â€”'}</small>
              </div>
              <div class="text-end">
                <h5 class="m-0">Total: â‚¹${totalAmount.toFixed(2)}</h5>
                <div class="mt-2 d-flex gap-2 justify-content-end">
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${totalAmount}, '')" 
                          ${!upiId ? 'disabled' : ''}>
                    <i class="bi bi-qr-code"></i> Show QR (Total)
                  </button>
                  <button class="btn btn-sm btn-success" onclick="markAllPaidForDriver('${escapeHtml(driverId)}')">
                    <i class="bi bi-cash-stack"></i> Mark All Paid
                  </button>
                </div>
              </div>
            </div>
            
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>SL</th>
                    <th>Booking</th>
                    <th>Amount</th>
                    <th>Fare</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          `;
          
          const tbody = driverCard.querySelector('tbody');
          let serialNo = 1;
          
          for (const [bookingId, data] of Object.entries(bookingsObj)) {
            const pickup = data.booking?.pickup || data.pickup || 'N/A';
            const dropoff = data.booking?.dropoff || data.dropoff || 'N/A';
            const amount = Number(data.amount) ? Number(data.amount).toFixed(2) : '0.00';
            const fare = data.fare ?? 'N/A';
            const status = data.status ?? 'pending';
            const isPaid = data.paidout === true || ['paid', 'approved'].includes(String(status).toLowerCase());
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${serialNo++}</td>
              <td style="min-width: 180px;">
                <div><strong>${escapeHtml(bookingId)}</strong></div>
                <small class="text-muted">${escapeHtml(pickup)} â†’ ${escapeHtml(dropoff)}</small>
              </td>
              <td>â‚¹${amount}</td>
              <td>â‚¹${escapeHtml(String(fare))}</td>
              <td>
                ${isPaid ? '<span class="badge-paid">Paid</span>' : '<span class="badge-unpaid">Unpaid</span>'}
              </td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-info" onclick="showBookingModal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${Number(amount) || 0}, '${escapeHtml(bookingId)}')"
                          ${(!upiId || isPaid) ? 'disabled' : ''}>
                    <i class="bi bi-qr-code"></i>
                  </button>
                  <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-check"></i> Approve
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-x"></i> Reject
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(row);
          }
          
          container.appendChild(driverCard);
        }
        
        // Wire up export button
        document.getElementById('exportWithdrawalsBtn').onclick = () => exportWithdrawalsGrouped(withdrawalsByDriver);
        
      } catch (error) {
        showToast('Failed to load withdrawals: ' + error.message, 'danger');
        console.error('Load withdrawals error:', error);
      } finally {
        document.getElementById('withdrawals-loading').style.display = 'none';
        document.getElementById('withdrawals-container').style.display = 'block';
      }
    }

    async function loadProfile() {
      document.getElementById('profile-table').style.display = 'none';
      document.getElementById('profile-loading').style.display = 'block';
      
      const table = initTable('profile-table');
      
      try {
        const user = auth.currentUser;
        const profileData = {
          'Name': user?.displayName || 'Admin',
          'Email': user?.email || '',
          'UID': user?.uid || '',
          'Last Sign In': user?.metadata?.lastSignInTime || '',
          'Creation Time': user?.metadata?.creationTime || ''
        };
        
        const rows = [];
        for (const [field, value] of Object.entries(profileData)) {
          rows.push([escapeHtml(field), escapeHtml(String(value))]);
        }
        
        if (rows.length > 0) {
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load profile: ' + error.message, 'danger');
        console.error('Load profile error:', error);
      } finally {
        document.getElementById('profile-loading').style.display = 'none';
        document.getElementById('profile-table').style.display = 'table';
      }
    }

    // Modal functions
    async function showBookingModal(driverId, bookingId) {
      try {
        const snapshot = await get(ref(db, `driverWallet/${driverId}/${bookingId}`));
        
        if (!snapshot.exists()) {
          document.getElementById('bookingDetailsBody').innerHTML = 
            `<div class="alert alert-warning">No booking data found for ${escapeHtml(bookingId)}</div>`;
        } else {
          const entry = snapshot.val();
          const booking = entry.booking || entry.bookingdata || entry;
          
          const details = [
            ['Booking ID', bookingId],
            ['Driver ID', booking.driverId || entry.driverId || driverId],
            ['Driver Name', booking.driverName || entry.driverName || 'N/A'],
            ['User Name', booking.userName || booking.customerName || entry.userName || 'N/A'],
            ['User Phone', booking.userPhone || entry.userPhone || 'N/A'],
            ['Pickup', booking.pickup || 'N/A'],
            ['Dropoff', booking.dropoff || 'N/A'],
            ['Date', booking.date || entry.date || 'N/A'],
            ['Time', booking.time || entry.time || 'N/A'],
            ['Booked At', booking.bookedAt || entry.bookedAt || 'N/A'],
            ['Fare', booking.fare || entry.fare || 'N/A'],
            ['Amount', entry.amount || 'N/A'],
            ['Payment ID', booking.paymentId || entry.paymentId || 'N/A'],
            ['Status', entry.status || (entry.paidout ? 'paid' : (entry.withdrawalRequested ? 'processing' : 'unpaid')) || 'N/A']
          ];
          
          let html = '<table class="table table-bordered table-striped">';
          for (const [label, value] of details) {
            const displayValue = (value !== undefined && value !== null) ? escapeHtml(String(value)) : 'N/A';
            html += `<tr><th style="width: 30%;">${escapeHtml(label)}</th><td>${displayValue}</td></tr>`;
          }
          html += '</table>';
          
          document.getElementById('bookingDetailsBody').innerHTML = html;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        modal.show();
      } catch (error) {
        document.getElementById('bookingDetailsBody').innerHTML = 
          `<div class="alert alert-danger">Error: ${escapeHtml(error.message || String(error))}</div>`;
        const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        modal.show();
      }
    }

    async function showQrModal(driverId, amount, bookingId) {
      try {
        const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
        
        if (!driverSnapshot.exists()) {
          showToast('Driver details not found', 'danger');
          return;
        }
        
        const driver = driverSnapshot.val();
        let upiId = driver.upiId;
        
        if (typeof upiId === 'string') {
          upiId = upiId.trim();
        }
        
        if (!upiId) {
          showToast('UPI ID not set for this driver', 'warning');
          return;
        }
        
        // Validation for specific booking
        if (bookingId) {
          const walletSnapshot = await get(ref(db, `driverWallet/${driverId}/${bookingId}`));
          if (walletSnapshot.exists()) {
            const walletEntry = walletSnapshot.val();
            const status = walletEntry.status ?? (walletEntry.paidout ? 'paid' : '');
            const isPaid = walletEntry.paidout === true || String(status).toLowerCase() === 'paid';
            
            if (isPaid) {
              showToast('Cannot generate QR: entry already paid', 'warning');
              return;
            }
            
            const effectiveStatus = getEffectiveStatusFromWalletEntry(walletEntry);
            if (effectiveStatus !== 'processing') {
              showToast('QR allowed only for processing entries', 'warning');
              return;
            }
          }
        }
        
        const driverName = (driver.name || driverId || 'Payee').trim();
        const payeeName = driverName.split(/\s+/).map(word => 
          word ? word[0].toUpperCase() + word.slice(1).toLowerCase() : ''
        ).join(' ');
        
        const paEncoded = encodeURIComponent(upiId);
        const pnEncoded = encodeURIComponent(payeeName);
        const amountStr = Number(amount) ? Number(amount).toFixed(2) : '0.00';
        
        const minimalUri = `upi://pay?pa=${paEncoded}&pn=${pnEncoded}&am=${encodeURIComponent(amountStr)}&cu=INR`;
        
        const transactionNote = bookingId ? `Payment for ${bookingId}` : 'Withdrawal payment';
        const transactionRef = bookingId || `txn${Date.now()}`;
        const fullUri = `upi://pay?pa=${paEncoded}&pn=${pnEncoded}&am=${encodeURIComponent(amountStr)}&tn=${encodeURIComponent(transactionNote)}&tr=${encodeURIComponent(transactionRef)}&cu=INR`;
        
        // Clear previous QR code and generate new one
        document.getElementById('qrCode').innerHTML = '';
        new QRCode(document.getElementById('qrCode'), {
          text: minimalUri,
          width: 256,
          height: 256,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
        
        document.getElementById('qrInfo').innerHTML = 
          `UPI: ${escapeHtml(upiId)} â€” ${escapeHtml(payeeName)} â€” Amount: â‚¹${amountStr}`;
        
        document.getElementById('upiUriBox').innerHTML = `
          <strong>Minimal URI (used for QR):</strong>
          <div class="mt-2 p-2 bg-white rounded border" style="font-family: monospace; font-size: 0.8rem;">
            ${escapeHtml(minimalUri)}
          </div>
          <hr>
          <strong>Full URI (with transaction details):</strong>
          <div class="mt-2 p-2 bg-white rounded border" style="font-family: monospace; font-size: 0.8rem;">
            ${escapeHtml(fullUri)}
          </div>
        `;
        
        document.getElementById('copyUpiUriBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(minimalUri);
            showToast('Minimal UPI URI copied to clipboard', 'success');
          } catch (error) {
            showToast('Failed to copy URI', 'danger');
          }
        };
        
        document.getElementById('copyFullUpiUriBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(fullUri);
            showToast('Full UPI URI copied to clipboard', 'success');
          } catch (error) {
            showToast('Failed to copy URI', 'danger');
          }
        };
        
        const modal = new bootstrap.Modal(document.getElementById('qrModal'));
        modal.show();
        
      } catch (error) {
        showToast('Failed to generate QR: ' + (error.message || String(error)), 'danger');
        console.error('QR generation error:', error);
      }
    }

    // Action functions
    async function markPaidEntry(driverId, bookingId) {
      if (!confirm(`Mark ${bookingId} as paid?`)) return;
      
      try {
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), {
          paidout: true,
          status: 'paid',
          paidAt: new Date().toISOString()
        });
        
        // Log admin action
        await set(ref(db, `adminActions/${Date.now()}`), {
          adminUid: currentUser?.uid || null,
          action: 'markPaidEntry',
          driverId,
          bookingId,
          timestamp: Date.now()
        });
        
        showToast('Entry marked as paid', 'success');
        loadWallets();
      } catch (error) {
        showToast('Failed to mark as paid: ' + (error.message || String(error)), 'danger');
        console.error('Mark paid error:', error);
      }
    }

    async function markAllPaidForDriver(driverId) {
      if (!confirm(`Mark ALL processing entries for ${driverId} as paid?`)) return;
      
      try {
        const snapshot = await get(ref(db, `driverWallet/${driverId}`));
        
        if (!snapshot.exists()) {
          showToast('No wallet entries found for this driver', 'warning');
          return;
        }
        
        const entries = snapshot.val();
        const updates = {};
        const bookingIds = [];
        
        for (const [bookingId, entry] of Object.entries(entries)) {
          const effectiveStatus = getEffectiveStatusFromWalletEntry(entry);
          if (effectiveStatus === 'processing') {
            updates[`driverWallet/${driverId}/${bookingId}/paidout`] = true;
            updates[`driverWallet/${driverId}/${bookingId}/status`] = 'paid';
            updates[`driverWallet/${driverId}/${bookingId}/paidAt`] = new Date().toISOString();
            bookingIds.push(bookingId);
          }
        }
        
        if (Object.keys(updates).length === 0) {
          showToast('No processing entries found to mark as paid', 'info');
          return;
        }
        
        await update(ref(db), updates);
        
        // Log admin action
        await set(ref(db, `adminActions/${Date.now()}`), {
          adminUid: currentUser?.uid || null,
          action: 'markAllPaidForDriver',
          driverId,
          bookingIds,
          count: bookingIds.length,
          timestamp: Date.now()
        });
        
        showToast(`Marked ${bookingIds.length} entries as paid for ${driverId}`, 'success');
        loadWallets();
      } catch (error) {
        showToast('Failed to mark all as paid: ' + (error.message || String(error)), 'danger');
        console.error('Mark all paid error:', error);
      }
    }

    async function approveWithdrawal(driverId, bookingId) {
      if (!confirm(`Approve withdrawal for ${bookingId}?`)) return;
      
      try {
        await update(ref(db, `pendingWithdrawals/${driverId}/${bookingId}`), {
          status: 'approved',
          paidout: true,
          approvedAt: new Date().toISOString()
        });
        
        // Log admin action
        await set(ref(db, `adminActions/${Date.now()}`), {
          adminUid: currentUser?.uid || null,
          action: 'approveWithdrawal',
          driverId,
          bookingId,
          timestamp: Date.now()
        });
        
        showToast('Withdrawal approved', 'success');
        loadWithdrawals();
      } catch (error) {
        showToast('Failed to approve withdrawal: ' + error.message, 'danger');
        console.error('Approve withdrawal error:', error);
      }
    }

    async function rejectWithdrawal(driverId, bookingId) {
      if (!confirm(`Reject withdrawal for ${bookingId}?`)) return;
      
      try {
        await remove(ref(db, `pendingWithdrawals/${driverId}/${bookingId}`));
        
        // Log admin action
        await set(ref(db, `adminActions/${Date.now()}`), {
          adminUid: currentUser?.uid || null,
          action: 'rejectWithdrawal',
          driverId,
          bookingId,
          timestamp: Date.now()
        });
        
        showToast('Withdrawal rejected', 'warning');
        loadWithdrawals();
      } catch (error) {
        showToast('Failed to reject withdrawal: ' + error.message, 'danger');
        console.error('Reject withdrawal error:', error);
      }
    }

    function exportWithdrawalsGrouped(dataByDriver) {
      try {
        const rows = [['Driver ID', 'Driver Name', 'UPI', 'Booking ID', 'Amount', 'Fare', 'Status', 'Pickup', 'Dropoff']];
        
        for (const [driverId, bookingsObj] of Object.entries(dataByDriver)) {
          for (const [bookingId, data] of Object.entries(bookingsObj)) {
            rows.push([
              driverId,
              data.driverName || '',
              data.upi || '',
              bookingId,
              (Number(data.amount) || 0).toFixed(2),
              data.fare || '',
              data.status || '',
              data.pickup || data.booking?.pickup || '',
              data.dropoff || data.booking?.dropoff || ''
            ]);
          }
        }
        
        const csv = rows.map(row => 
          row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(',')
        ).join('\r\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `pending_withdrawals_grouped_${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // Log admin action
        set(ref(db, `adminActions/${Date.now()}`), {
          adminUid: currentUser?.uid || null,
          action: 'exportWithdrawalsGrouped',
          timestamp: Date.now()
        });
        
        showToast('CSV exported successfully', 'success');
      } catch (error) {
        showToast('Export failed: ' + (error.message || String(error)), 'danger');
        console.error('Export error:', error);
      }
    }

    // Delete functions
    window.deleteUser = (uid) => safeDelete(`users/${uid}`, 'Delete this user?', 'User deleted', loadUsers);
    window.deleteDriver = (driverId) => safeDelete(`driverdetails/${driverId}`, 'Delete this driver?', 'Driver deleted', loadDrivers);
    window.deletePendingCar = (driverId, carId) => safeDelete(`pendingcars/${driverId}/${carId}`, 'Delete this pending car?', 'Pending car deleted', loadPendingCars);
    window.deleteApprovedCar = (driverId, carId) => safeDelete(`approvedcars/${driverId}/${carId}`, 'Delete this approved car?', 'Approved car deleted', loadApprovedCars);
    window.deleteSlot = (driverId, slotId) => safeDelete(`availableslots/${driverId}/${slotId}`, 'Delete this slot?', 'Slot deleted', loadSlots);
    window.deleteBooking = (bookingId) => safeDelete(`bookings/${bookingId}`, 'Delete this booking?', 'Booking deleted', loadBookings);
    window.deleteRideRequest = (requestId) => safeDelete(`riderequest/${requestId}`, 'Delete this ride request?', 'Ride request deleted', loadRideRequests);

    // Approve car function
    window.approveCar = async (driverId, carId) => {
      if (!confirm('Approve this car?')) return;
      
      try {
        const snapshot = await get(ref(db, `pendingcars/${driverId}/${carId}`));
        
        if (!snapshot.exists()) {
          showToast('Car not found', 'warning');
          return;
        }
        
        const carData = snapshot.val();
        await set(ref(db, `approvedcars/${driverId}/${carId}`), carData);
        await remove(ref(db, `pendingcars/${driverId}/${carId}`));
        
        // Log admin action
        await set(ref(db, `adminActions/${Date.now()}`), {
          adminUid: currentUser?.uid || null,
          action: 'approveCar',
          driverId,
          carId,
          timestamp: Date.now()
        });
        
        showToast('Car approved successfully', 'success');
        loadPendingCars();
      } catch (error) {
        showToast('Failed to approve car: ' + error.message, 'danger');
        console.error('Approve car error:', error);
      }
    };

    // Expose modal functions globally
    window.showBookingModal = showBookingModal;
    window.showQrModal = showQrModal;
    window.markPaidEntry = markPaidEntry;
    window.markAllPaidForDriver = markAllPaidForDriver;
    window.approveWithdrawal = approveWithdrawal;
    window.rejectWithdrawal = rejectWithdrawal;

    // Tab management
    window.openTab = function(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.hidden = true;
      });
      
      // Show selected tab
      const targetTab = document.getElementById(`${tabName}-tab`);
      if (!targetTab) {
        // Default to users tab if not found
        document.getElementById('users-tab').hidden = false;
        loadUsers();
        return;
      }
      
      targetTab.hidden = false;
      
      // Update active nav link
      document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      const activeLink = Array.from(document.querySelectorAll('.sidebar .nav-link')).find(link => {
        const onclick = link.getAttribute('onclick');
        return onclick && onclick.includes(`openTab('${tabName}')`);
      });
      
      if (activeLink) {
        activeLink.classList.add('active');
      }
      
      // Load appropriate data
      switch (tabName) {
        case 'users':
          loadUsers();
          break;
        case 'drivers':
          loadDrivers();
          break;
        case 'pending-cars':
          loadPendingCars();
          break;
        case 'approved-cars':
          loadApprovedCars();
          break;
        case 'slots':
          loadSlots();
          break;
        case 'bookings':
          loadBookings();
          break;
        case 'ride-requests':
          loadRideRequests();
          break;
        case 'driver-wallets':
          loadWallets();
          break;
        case 'pending-withdrawals':
          loadWithdrawals();
          break;
        case 'profile':
          loadProfile();
          break;
        default:
          console.warn('Unknown tab:', tabName);
          break;
      }
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Global search
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch) {
        globalSearch.addEventListener('input', debounce(function(e) {
          const searchValue = e.target.value;
          Object.values(tables).forEach(table => {
            if (table && typeof table.search === 'function') {
              table.search(searchValue).draw();
            }
          });
        }, 300));
      }
      
      // Keyboard shortcut for search
      document.addEventListener('keydown', function(e) {
        if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
          const activeElement = document.activeElement;
          if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            globalSearch?.focus();
          }
        }
      });
      
      // Refresh button
      const refreshBtn = document.getElementById('refreshAllBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
          const activeTab = document.querySelector('.tab-pane:not([hidden])');
          if (activeTab) {
            const tabId = activeTab.id.replace('-tab', '');
            openTab(tabId);
            showToast('Data refreshed', 'info');
          }
        });
      }
      
      // Wallet filter
      const filterApplyBtn = document.getElementById('walletFilterApplyBtn');
      if (filterApplyBtn) {
        filterApplyBtn.addEventListener('click', loadWallets);
      }
      
      const walletFilter = document.getElementById('walletStatusFilter');
      if (walletFilter) {
        walletFilter.addEventListener('change', loadWallets);
      }
    });

    // Authentication state observer
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      
      if (!user) {
        window.location.href = 'adminlogin.html';
        return;
      }
      
      // Initialize dashboard
      const initDashboard = () => {
        openTab('users'); // Default tab
      };
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDashboard, { once: true });
      } else {
        initDashboard();
      }
    });

  </script>
</body>
</html>
