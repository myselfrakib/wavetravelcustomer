<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WaveTravel Admin Panel</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius:4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

  <!-- SIDE NAV -->
  <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0">
    <div class="p-4 text-2xl font-bold text-blue-600">WaveTravel Admin</div>
    <nav class="mt-6">
      <button data-tab="users" class="w-full text-left px-4 py-2 hover:bg-gray-50 tab-btn">Users</button>
      <button data-tab="drivers" class="w-full text-left px-4 py-2 hover:bg-gray-50 tab-btn">Drivers</button>
      <button data-tab="pendingCars" class="w-full text-left px-4 py-2 hover:bg-gray-50 tab-btn">Pending Cars</button>
      <button data-tab="slots" class="w-full text-left px-4 py-2 hover:bg-gray-50 tab-btn">Available Slots</button>
      <button data-tab="bookings" class="w-full text-left px-4 py-2 hover:bg-gray-50 tab-btn">Bookings</button>
      <button data-tab="profile" class="w-full text-left px-4 py-2 hover:bg-gray-50 tab-btn">My Profile</button>
      <button id="logoutBtn" class="w-full text-left px-4 py-2 text-red-600 hover:bg-gray-50 mt-4">Logout</button>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 overflow-auto">
    <div class="p-6">
      <!-- Search & Export Bar -->
      <div id="toolbar" class="flex justify-between items-center mb-4">
        <input id="searchInput" type="text" placeholder="Search…" class="px-3 py-2 border rounded w-1/3"/>
        <button id="exportBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
          <i class="fas fa-file-csv mr-2"></i>Export CSV
        </button>
      </div>

      <!-- TABS CONTENT -->
      <section id="users" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Users</h2>
        <div id="usersList" class="space-y-2"></div>
      </section>

      <section id="drivers" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Drivers</h2>
        <div id="driversList" class="space-y-2"></div>
      </section>

      <section id="pendingCars" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Pending Cars</h2>
        <div id="pendingCarsList" class="space-y-2"></div>
      </section>

      <section id="slots" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Available Slots</h2>
        <div id="slotsList" class="space-y-2"></div>
      </section>

      <section id="bookings" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">Bookings</h2>
        <div id="bookingsList" class="space-y-2"></div>
      </section>

      <section id="profile" class="tab-content hidden">
        <h2 class="text-xl font-semibold mb-4">My Profile</h2>
        <div id="profileDetails" class="bg-white p-4 rounded shadow"></div>
      </section>
    </div>
  </main>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getDatabase, ref, get, remove, query, orderByChild, equalTo
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // ——— Your Firebase Config ———
    const firebaseConfig = {
      apiKey: "...", authDomain: "...",
      databaseURL: "...", projectId: "...",
      storageBucket: "...", messagingSenderId: "...",
      appId: "..."
    };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ——— UI References ———
    const tabs       = document.querySelectorAll('.tab-btn');
    const contents   = document.querySelectorAll('.tab-content');
    const searchInp  = document.getElementById('searchInput');
    const exportBtn  = document.getElementById('exportBtn');
    const logoutBtn  = document.getElementById('logoutBtn');

    let currentTab = 'users';
    let currentData = [];

    // ——— AUTH GUARD ———
    onAuthStateChanged(auth, user => {
      if (!user) return location.href = 'adminlogin.html';
      // check in /admins
      get(ref(db, `admins/${user.uid}`)).then(snap => {
        if (!snap.exists()) return signOut(auth);
        openTab('users');
        loadTab('users');
      });
    });

    // ——— TAB HANDLING ———
    tabs.forEach(btn => {
      btn.onclick = () => {
        openTab(btn.dataset.tab);
        loadTab(btn.dataset.tab);
      };
    });
    function openTab(name) {
      currentTab = name;
      contents.forEach(s => s.classList.add('hidden'));
      document.getElementById(name).classList.remove('hidden');
      searchInp.value = '';
      currentData = [];
    }

    // ——— DATA LOADERS ———
    async function loadTab(tab) {
      const listEl = document.getElementById(tab + 'List');
      listEl.innerHTML = `<div class="text-center text-gray-500">Loading…</div>`;
      let path = tab;
      if (tab==='pendingCars') path = 'pendingcars';
      else if (tab==='slots') path = 'availableslots';
      const refPath = ref(db, path);
      let snap;
      if (tab==='bookings') {
        snap = await get(refPath);
      } else if (tab==='drivers') {
        snap = await get(ref(db, 'driverdetails'));
      } else {
        snap = await get(refPath);
      }
      const data = snap.exists() ? snap.val() : {};
      currentData = Object.entries(data).map(([k,v]) => ({ id:k, ...v }));
      renderList();
    }

    // ——— RENDER & SEARCH ———
    searchInp.oninput = renderList;
    function renderList() {
      const listEl = document.getElementById(currentTab + 'List');
      const term = searchInp.value.toLowerCase();
      let html = '';
      currentData.forEach(item => {
        const repr = JSON.stringify(item).toLowerCase();
        if (!repr.includes(term)) return;
        html += itemCard(currentTab, item);
      });
      listEl.innerHTML = html || `<div class="text-center text-gray-500">No records found.</div>`;
    }

    // ——— ITEM CARD TEMPLATE ———
    function itemCard(tab, item) {
      let rows = '';
      for (let [k,v] of Object.entries(item)) {
        if (k==='id') continue;
        rows += `<div class="flex justify-between"><span class="font-medium">${k}:</span><span>${v}</span></div>`;
      }
      const deleteBtn = `<button onclick="deleteItem('${tab}','${item.id}')" class="ml-2 text-red-600 hover:underline">Delete</button>`;
      return `
        <div class="bg-white p-4 mb-2 rounded shadow">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold">${tab} • ${item.id}</h3>
            <div>${deleteBtn}</div>
          </div>
          ${rows}
        </div>`;
    }

    // ——— DELETE ———
    window.deleteItem = async (tab, id) => {
      if (!confirm(`Delete ${tab} / ${id}?`)) return;
      let path = tab==='pendingCars'?'pendingcars':tab;
      if (tab==='slots') path = 'availableslots';
      await remove(ref(db, `${path}/${id}`));
      loadTab(tab);
    };

    // ——— EXPORT CSV ———
    exportBtn.onclick = () => {
      if (!currentData.length) return alert('No data to export');
      const headers = Object.keys(currentData[0]).join(',');
      const rows = currentData.map(o => Object.values(o).join(',')).join('\n');
      const csv = [headers, rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = currentTab + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    };

    // ——— LOGOUT ———
    logoutBtn.onclick = () => signOut(auth).then(() => location.href='adminlogin.html');
  </script>
</body>
</html>
