<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Dashboard – WaveTravel</title>
  <style>
    body { margin:0; font-family:sans-serif;
      background: linear-gradient(to right,#2c3e50,#3498db); color:white; }
    .navbar { display:flex; flex-wrap:wrap; gap:0.5rem;
      background:#1f2c3f; padding:1rem; }
    .navbar button { flex:1; background:#3498db; border:none;
      color:white; padding:0.5rem; border-radius:4px; cursor:pointer; }
    .navbar .logout { background:#e74c3c !important; }
    .tab-pane { display:none; padding:1rem; }
    .tab-pane.active { display:block; }
    .card { background:rgba(255,255,255,0.1); padding:1rem;
      margin:0.5rem 0; border-radius:8px; }
    .card button { margin:0.25rem; padding:0.3rem 0.8rem;
      border:none; border-radius:4px; cursor:pointer; }
    .edit   { background:#f39c12; }
    .del    { background:#e74c3c; }
    .approve{ background:#2ecc71; }
    .loading{ text-align:center; color:#ffd700; }
  </style>
</head>
<body>

  <div class="navbar">
    <button onclick="openTab('users')">Users</button>
    <button onclick="openTab('drivers')">Drivers</button>
    <button onclick="openTab('pending-cars')">Pending Cars</button>
    <button onclick="openTab('approved-cars')">Approved Cars</button>
    <button onclick="openTab('slots')">Slots</button>
    <button onclick="openTab('bookings')">Bookings</button>
    <button onclick="openTab('profile')">Profile</button>
    <button class="logout" onclick="logout()">Logout</button>
  </div>

  <div id="users-tab" class="tab-pane"><h2>Users</h2><div id="users-list"></div></div>
  <div id="drivers-tab" class="tab-pane"><h2>Drivers</h2><div id="drivers-list"></div></div>
  <div id="pending-cars-tab" class="tab-pane">
    <h2>Pending Cars</h2><div id="pending-list"></div>
  </div>
  <div id="approved-cars-tab" class="tab-pane">
    <h2>Approved Cars</h2><div id="approved-list"></div>
  </div>
  <div id="slots-tab" class="tab-pane"><h2>Available Slots</h2><div id="slots-list"></div></div>
  <div id="bookings-tab" class="tab-pane"><h2>Bookings</h2><div id="bookings-list"></div></div>
  <div id="profile-tab" class="tab-pane"><h2>Admin Profile</h2><div id="profile-details"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getDatabase, ref, get, remove, set
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    // config
    const cfg = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL:"https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId:"wavetravel-3c4c4",
      storageBucket:"wavetravel-3c4c4.appspot.com",
      messagingSenderId:"298226098137",
      appId:"1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    const app  = initializeApp(cfg);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // guard
    onAuthStateChanged(auth, user=>{
      if(!user) return window.location='adminlogin.html';
      openTab('users');
    });

    // nav
    window.openTab = tn => {
      document.querySelectorAll('.tab-pane').forEach(t=>t.classList.remove('active'));
      document.getElementById(tn+'-tab').classList.add('active');
      if(tn==='users')         fetchList('users','users-list');
      if(tn==='drivers')       fetchList('drivers','drivers-list');
      if(tn==='pending-cars')  fetchPending();
      if(tn==='approved-cars') fetchApproved();
      if(tn==='slots')         fetchNested('availableslots','slots-list');
      if(tn==='bookings')      fetchList('bookings','bookings-list');
      if(tn==='profile')       fetchProfile();
    };

    // generic flat list
    async function fetchList(path, containerId){
      const c=document.getElementById(containerId);
      c.innerHTML='<div class="loading">Loading…</div>';
      const snap=await get(ref(db,path));
      if(!snap.exists()){ c.innerHTML='No data'; return; }
      let html='';
      for(const [k,v] of Object.entries(snap.val())){
        html+=`<div class="card">
                 <strong>${path.slice(0,-1)} ID:</strong> ${k}<br/>`+
                 Object.entries(v).map(([f,val])=>`<strong>${f}:</strong> ${val}`).join('<br/>')+
                 `<br/><button class="del" onclick="delNode('${path}','${k}')">Delete</button>
               </div>`;
      }
      c.innerHTML=html;
    }

    // nested two levels (driverId → items)
    async function fetchNested(path, containerId){
      const c=document.getElementById(containerId);
      c.innerHTML='<div class="loading">Loading…</div>';
      const snap=await get(ref(db,path));
      if(!snap.exists()){ c.innerHTML='No data'; return; }
      let html='', driverIndex=1;
      for(const [drv, slots] of Object.entries(snap.val())){
        html+=`<div class="card">
                  <strong>${driverIndex++}. Driver:</strong> ${drv}<br/>`;
        for(const [sk, s] of Object.entries(slots)){
          html+=`<div style="margin:0.5rem 0;padding:0.5rem;
                     background:rgba(255,255,255,0.05);border-radius:6px;">
                    <strong>Slot ID:</strong> ${sk}<br/>`+
                   Object.entries(s).map(([f,v])=>`<strong>${f}:</strong> ${v}`).join('<br/>')+
                  `</div>`;
        }
        html+='</div>';
      }
      c.innerHTML=html;
    }

    // pending cars
    async function fetchPending(){
      const c=document.getElementById('pending-list');
      c.innerHTML='<div class="loading">Loading…</div>';
      const snap=await get(ref(db,'pendingcars'));
      if(!snap.exists()){ c.innerHTML='No pending'; return; }
      let html='';
      for(const [k,v] of Object.entries(snap.val())){
        html+=`<div class="card">
                 <strong>Car Key:</strong> ${k}<br/>`+
                 Object.entries(v).map(([f,val])=>`<strong>${f}:</strong> ${val}`).join('<br/>')+
                 `<br/><button class="approve" onclick="approve('${k}')">Approve</button>
                  <button class="del"     onclick="delNode('pendingcars','${k}')">Reject</button>
               </div>`;
      }
      c.innerHTML=html;
    }
    async function approve(key){
      const psnap=await get(ref(db,`pendingcars/${key}`));
      const data=psnap.val();
      // store under approvedcars/driverId/key
      await set(ref(db,`approvedcars/${data.driverId}/${key}`),data);
      await remove(ref(db,`pendingcars/${key}`));
      fetchPending();
    }

    // approved cars (two‑level)
    async function fetchApproved(){
      const c=document.getElementById('approved-list');
      c.innerHTML='<div class="loading">Loading…</div>';
      const snap=await get(ref(db,'approvedcars'));
      if(!snap.exists()){ c.innerHTML='No cars'; return; }
      let html='', idx=1;
      for(const [drv, cars] of Object.entries(snap.val())){
        html+=`<div class="card"><strong>${idx++}. Driver:</strong> ${drv}<br/>`;
        for(const [ck,car] of Object.entries(cars)){
          html+=`<div style="margin:0.5rem 0;padding:0.5rem;
                     background:rgba(255,255,255,0.05);border-radius:6px;">
                    <strong>Key:</strong> ${ck}<br/>`+
                   Object.entries(car).map(([f,v])=>`<strong>${f}:</strong> ${v}`).join('<br/>')+
                  `</div>`;
        }
        html+='</div>';
      }
      c.innerHTML=html;
    }

    // bookings flat
    // reuse fetchList('bookings','bookings-list')

    // admin profile
    async function fetchProfile(){
      const c=document.getElementById('profile-details');
      c.innerHTML='<div class="loading">Loading…</div>';
      const uid=auth.currentUser.uid;
      const snap=await get(ref(db,`admins/${uid}`));
      if(!snap.exists()){ c.innerHTML='No profile'; return; }
      const v=snap.val();
      c.innerHTML=`<div class="card">`+
        Object.entries(v).map(([f,val])=>`<strong>${f}:</strong> ${val}`).join('<br/>')+
      `</div>`;
    }

    // delete helper
    async function delNode(path,key){
      if(!confirm('Confirm delete?')) return;
      await remove(ref(db,`${path}/${key}`));
      openTab(currentTab);
    }

    // logout
    function logout(){ signOut(auth).then(_=>location='adminlogin.html'); }

  </script>
</body>
</html>
