<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaveTravel Admin Dashboard</title>

  <!-- Normalize & DataTables CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family:Arial,sans-serif; margin:0; background:linear-gradient(to right,#2c3e50,#3498db); color:#fff; }
    .navbar { display:flex; flex-wrap:wrap; background:#1f2c3f; padding:1rem; gap:.5rem; position:sticky; top:0; z-index:1000; }
    .navbar button { flex:1; padding:.5rem 1rem; border:none; border-radius:4px; background:#3498db; color:#fff; cursor:pointer; }
    .tab-pane { display:none; padding:1rem; overflow:auto; max-height:calc(100vh - 64px); }
    .tab-pane.active { display:block; }
    .loading { text-align:center; margin:2rem; color:#ffd700; }
    table.dataTable { background:rgba(255,255,255,0.1); border-radius:8px; overflow:hidden; color:#000; }
    .dt-button, .dataTables_length select, .dataTables_filter input { color:#000 !important; }

    /* Wallet cards & layout */
    #driver-wallets-container, #withdrawals-container { display:flex; flex-wrap:wrap; gap:1rem; }
    .wallet-card { background:rgba(255,255,255,0.1); padding:1rem; border-radius:8px; width:320px; color:#fff; }
    .wallet-card h3 { margin:0 0 .5rem; color:#ffd700; font-size:1.05rem; }
    .wallet-card p { margin:0.25rem 0; font-size:0.95rem; color:#e9eef8; }
    .wallet-card small { color:#cbd5e1; }
    .wallet-actions { margin-top:0.6rem; display:flex; gap:8px; flex-wrap:wrap; }
    .wallet-actions button { flex: none; }

    /* Pending withdrawals driver card full width */
    .withdrawal-driver-card { background:rgba(255,255,255,0.08); padding:1rem; border-radius:8px; width:100%; color:#fff; }

    /* QR modal center */
    #qrModal .modal-content { background: #0b1220; color: #ffd700; text-align:center; }
    #qrCode { margin: 0 auto 8px; }

    /* Booking details modal */
    #bookingDetailsModal .modal-content { color:#111; }

    @media (max-width:520px) {
      .wallet-card { width:100%; }
    }
  </style>
</head>
<body>

  <div class="navbar">
    <button onclick="openTab('users')">Users</button>
    <button onclick="openTab('drivers')">Drivers</button>
    <button onclick="openTab('pending-cars')">Pending Cars</button>
    <button onclick="openTab('approved-cars')">Approved Cars</button>
    <button onclick="openTab('slots')">Slots</button>
    <button onclick="openTab('bookings')">Bookings</button>
    <button onclick="openTab('driver-wallets')">Driver Wallets</button>
    <button onclick="openTab('pending-withdrawals')">Pending Withdrawals</button>
    <button onclick="openTab('profile')">Profile</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- USERS -->
  <div id="users-tab" class="tab-pane">
    <h2>Users</h2>
    <div id="users-loading" class="loading">Loading users…</div>
    <table id="users-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr>
        <th>SL</th><th>User ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Created On</th><th>Action</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- DRIVERS -->
  <div id="drivers-tab" class="tab-pane">
    <h2>Drivers</h2>
    <div id="drivers-loading" class="loading">Loading drivers…</div>
    <table id="drivers-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr>
        <th>SL</th><th>Driver ID</th><th>Name</th><th>Phone</th><th>Vehicle Count</th><th>Action</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- PENDING CARS -->
  <div id="pending-cars-tab" class="tab-pane">
    <h2>Pending Cars</h2>
    <div id="pending-loading" class="loading">Loading pending cars…</div>
    <table id="pending-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr>
        <th>SL</th><th>Driver ID</th><th>Car ID</th><th>Brand</th><th>Reg No</th>
        <th>Driver Name</th><th>Driver Number</th><th>Owner Name</th><th>Seats</th><th>Submitted At</th><th>Actions</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- APPROVED CARS -->
  <div id="approved-cars-tab" class="tab-pane">
    <h2>Approved Cars</h2>
    <div id="approved-loading" class="loading">Loading approved cars…</div>
    <table id="approved-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr>
        <th>SL</th><th>Driver Name</th><th>Phone</th><th>Car ID</th>
        <th>Brand</th><th>Reg No</th><th>Owner</th><th>Seats</th><th>Action</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- SLOTS -->
  <div id="slots-tab" class="tab-pane">
    <h2>Slots</h2>
    <div id="slots-loading" class="loading">Loading slots…</div>
    <table id="slots-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr>
        <th>SL</th><th>Driver Name</th><th>Phone</th><th>Slot ID</th>
        <th>Pickup</th><th>Dropoff</th><th>Date</th><th>Time</th><th>Seats</th><th>Action</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- BOOKINGS -->
  <div id="bookings-tab" class="tab-pane">
    <h2>Bookings</h2>
    <div id="bookings-loading" class="loading">Loading bookings…</div>
    <table id="bookings-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr>
        <th>SL</th><th>Booking ID</th><th>Customer</th><th>Vehicle</th><th>Pickup</th>
        <th>Dropoff</th><th>Duration</th><th>Fare</th><th>Status</th><th>Action</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- DRIVER WALLETS (unchanged layout) -->
  <div id="driver-wallets-tab" class="tab-pane">
    <h2>Driver Wallets</h2>
    <div id="wallets-loading" class="loading">Loading wallets…</div>
    <div id="driver-wallets-container" style="display:none;"></div>
  </div>

  <!-- PENDING WITHDRAWALS (grouped per driver) -->
  <div id="pending-withdrawals-tab" class="tab-pane">
    <h2>Pending Withdrawals</h2>
    <div id="withdrawals-loading" class="loading">Loading pending withdrawals…</div>
    <div id="withdrawals-container" style="display:none;"></div>
  </div>

  <!-- PROFILE -->
  <div id="profile-tab" class="tab-pane">
    <h2>My Profile</h2>
    <div id="profile-loading" class="loading">Loading profile…</div>
    <table id="profile-table" class="display responsive nowrap" style="width:100%;display:none">
      <thead><tr><th>Field</th><th>Value</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Booking details modal -->
  <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="bookingDetailsBody"></div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-3" id="qrModalContent" style="background:#0b1220;color:#ffd700;">
        <h5>UPI Payment QR</h5>
        <div id="qrCode" class="my-3"></div>
        <div id="qrInfo" class="mb-2"></div>
        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

  <!-- jQuery & DataTables JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- QRCode.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, child, update, remove, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const cfg = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // utilities for DataTables
    const tables = {};
    function initTable(id,noSortCols=[]){
      if(!tables[id]){
        tables[id] = $(`#${id}`).DataTable({
          responsive:true,
          dom:'Bfltip',
          buttons:['copy','csv','print'],
          columnDefs: noSortCols.map(c=>({ orderable:false, targets:c }))
        });
      } else tables[id].clear().draw();
    }

    window.logout = () => signOut(auth).then(() => location.href='adminlogin.html');

    // CRUD helper functions (as before)
    window.deleteUser = async uid => { await remove(ref(db,`users/${uid}`)); loadUsers(); };
    window.deleteDriver = async did => { await remove(ref(db,`driverdetails/${did}`)); loadDrivers(); };
    window.deletePending = async (did,cid) => { await remove(ref(db,`pendingcars/${did}/${cid}`)); loadPending(); };
    window.deleteApproved = async (did,cid) => { await remove(ref(db,`approvedcars/${did}/${cid}`)); loadApproved(); };
    window.deleteSlot = async (did,sid) => { await remove(ref(db,`availableslots/${did}/${sid}`)); loadSlots(); };
    window.deleteBooking = async bid => { await remove(ref(db,`bookings/${bid}`)); loadBookings(); };
    window.approveCar = async (did,cid) => {
      const snap = await get(ref(db,`pendingcars/${did}/${cid}`));
      const car  = snap.val(); if(!car) return;
      await set(ref(db,`approvedcars/${did}/${cid}`), car);
      await remove(ref(db,`pendingcars/${did}/${cid}`));
      loadPending();
    };

    // Wallet Approve/Reject (keeps same behavior, but Mark Paid now confirmed)
    window.approveWalletEntry = async (driverId, bookingId) => {
      if (!confirm(`Mark booking ${bookingId} for driver ${driverId} as paid?`)) return;
      await update(ref(db,`driverWallet/${driverId}/${bookingId}`), { paidout: true, status: 'paid' });
      loadWallets();
    };
    window.rejectWalletEntry = async (driverId, bookingId, amount) => {
      if (!confirm(`Reject wallet entry ${bookingId} and reset amount to ${amount}?`)) return;
      await update(ref(db,`driverWallet/${driverId}/${bookingId}`), { status: 'available', amount });
      loadWallets();
    };

    // Pending Withdrawals Approve/Reject
    window.approveWithdrawal = async (driverId, bookingId) => {
      if (!confirm(`Approve withdrawal ${bookingId} for driver ${driverId}?`)) return;
      await update(ref(db,`pendingWithdrawals/${driverId}/${bookingId}`), { 'status': 'approved' });
      loadWithdrawals();
    };
    window.rejectWithdrawal = async (driverId, bookingId) => {
      if (!confirm(`Reject withdrawal ${bookingId} for driver ${driverId}?`)) return;
      await update(ref(db,`pendingWithdrawals/${driverId}/${bookingId}`), { 'status': 'rejected' });
      loadWithdrawals();
    };

    // --- Load functions for other tabs (kept as before) ---
    async function loadUsers(){
      $('#users-table').hide(); $('#users-loading').show();
      initTable('users-table',[7]);
      const snap = await get(ref(db,'users'));
      let i=1;
      if(snap.exists()) for(const [uid,u] of Object.entries(snap.val())){
        tables['users-table'].row.add([i++,uid,u.name||'',u.email||'',u.phone||'',u.address||'',u.createdOn||'',`<button class="btn btn-sm btn-danger" onclick="deleteUser('${uid}')">Delete</button>`]).draw(false);
      }
      $('#users-loading').hide(); $('#users-table').show();
    }

    async function loadDrivers(){
      $('#drivers-table').hide(); $('#drivers-loading').show();
      initTable('drivers-table',[5]);
      const snap = await get(ref(db,'driverdetails'));
      let i=1;
      if(snap.exists()) for(const [did,d] of Object.entries(snap.val())){
        const vc = d.vehicles?Object.keys(d.vehicles).length:0;
        tables['drivers-table'].row.add([i++,did,d.name||'',d.phone||'',vc,`<button class="btn btn-sm btn-danger" onclick="deleteDriver('${did}')">Delete</button>`]).draw(false);
      }
      $('#drivers-loading').hide(); $('#drivers-table').show();
    }

    async function loadPending(){
      $('#pending-table').hide(); $('#pending-loading').show();
      initTable('pending-table',[10]);
      const snap = await get(ref(db,'pendingcars'));
      let i=1;
      if(snap.exists()) for(const [did,cars] of Object.entries(snap.val())){
        for(const [cid,c] of Object.entries(cars)){
          tables['pending-table'].row.add([
            i++,did,cid,c.carBrand||'',c.carReg||'',c.driverName||'',c.driverNumber||'',c.ownerName||'',c.seats||'',c.submittedAt||'',
            `<button class="btn btn-sm btn-success" onclick="approveCar('${did}','${cid}')">Approve</button> <button class="btn btn-sm btn-danger" onclick="deletePending('${did}','${cid}')">Delete</button>`
          ]).draw(false);
        }
      }
      $('#pending-loading').hide(); $('#pending-table').show();
    }

    async function loadApproved(){
      $('#approved-table').hide(); $('#approved-loading').show();
      initTable('approved-table',[8]);
      const snap = await get(ref(db,'approvedcars'));
      let i=1;
      if(snap.exists()) for(const [did,cars] of Object.entries(snap.val())){
        for(const [cid,c] of Object.entries(cars)){
          tables['approved-table'].row.add([i++,c.driverName||'',c.driverNumber||'',cid,c.carBrand||'',c.carReg||'',c.ownerName||'',c.seats||'',`<button class="btn btn-sm btn-danger" onclick="deleteApproved('${did}','${cid}')">Delete</button>`]).draw(false);
        }
      }
      $('#approved-loading').hide(); $('#approved-table').show();
    }

    async function loadSlots(){
      $('#slots-table').hide(); $('#slots-loading').show();
      initTable('slots-table',[9]);
      const snap = await get(ref(db,'availableslots'));
      let i=1;
      if(snap.exists()) for(const [did,slots] of Object.entries(snap.val())){
        const dSnap = await get(ref(db,`driverdetails/${did}`));
        const d = dSnap.exists()?dSnap.val():{};
        for(const [sid,s] of Object.entries(slots)){
          tables['slots-table'].row.add([i++,d.name||'',d.phone||'',sid,s.pickup||'',s.dropoff||'',s.date||'',s.time||'',s.seats||'',`<button class="btn btn-sm btn-danger" onclick="deleteSlot('${did}','${sid}')">Delete</button>`]).draw(false);
        }
      }
      $('#slots-loading').hide(); $('#slots-table').show();
    }

    async function loadBookings(){
      $('#bookings-table').hide(); $('#bookings-loading').show();
      initTable('bookings-table',[9]);
      const snap = await get(ref(db,'bookings'));
      let i=1;
      if(snap.exists()) for(const [bid,b] of Object.entries(snap.val())){
        tables['bookings-table'].row.add([i++,bid,b.customerName||'',b.vehicle||'',b.pickup||'',b.dropoff||'',b.duration||'',b.fare||'',b.status||'',`<button class="btn btn-sm btn-danger" onclick="deleteBooking('${bid}')">Delete</button>`]).draw(false);
      }
      $('#bookings-loading').hide(); $('#bookings-table').show();
    }

    // ------------------ Driver Wallets (unchanged) ------------------
    async function loadWallets(){
      $('#driver-wallets-container').hide(); $('#wallets-loading').show();
      const container = document.getElementById('driver-wallets-container');
      container.innerHTML = '';

      const snap = await get(ref(db,'driverWallet'));
      if(!snap.exists()){
        container.textContent = 'No wallet entries found.';
        $('#wallets-loading').hide(); $('#driver-wallets-container').show();
        return;
      }

      let sl = 1;
      for(const [driverId, entries] of Object.entries(snap.val())){
        // fetch driver's upi and name once
        let upi = null, driverName = null;
        try {
          const uSnap = await get(ref(db, `driverdetails/${driverId}`));
          if(uSnap.exists()){
            const d = uSnap.val();
            upi = d.upiId || null;
            driverName = d.name || null;
          }
        } catch (e){
          upi = null; driverName = null;
        }

        // driver header
        let driverTotal = 0;
        for(const e of Object.values(entries)) driverTotal += parseFloat(e.amount)||0;
        const headerCard = document.createElement('div');
        headerCard.className = 'wallet-card';
        headerCard.style.width = '100%';
        headerCard.innerHTML = `<h3>Driver: ${driverId} | Total: ₹${driverTotal.toFixed(2)}</h3>
                                <small>UPI: <span id="upi-${driverId}">${upi ? upi : '—'}</span> ${driverName ? ` | ${driverName}` : ''}</small>`;
        container.appendChild(headerCard);

        for(const [bookingId, entry] of Object.entries(entries)){
          const card = document.createElement('div');
          card.className = 'wallet-card';
          const amount = entry.amount !== undefined ? Number(entry.amount) : NaN;
          const fare = (entry.fare ?? (entry.booking?.fare)) ?? 'N/A';
          const status = entry.status ?? (entry.paidout ? 'paid' : 'unpaid') ?? 'unpaid';
          const bookingData = entry.booking || entry.bookingdata || {};
          const pickup = bookingData.pickup || entry.pickup || 'N/A';
          const dropoff = bookingData.dropoff || entry.dropoff || 'N/A';

          const qrDisabled = !upi;
          const btnShow = `<button class="btn btn-sm btn-info" onclick="showBookingModal('${driverId}','${bookingId}')">Show</button>`;
          const btnQr = `<button class="btn btn-sm btn-primary ${qrDisabled ? 'disabled' : ''}" ${qrDisabled ? 'title="UPI missing"' : `onclick="showQrModal('${driverId}', ${isNaN(amount) ? 0 : amount}, '${bookingId}')"`}>Show QR</button>`;
          const btnPaid = `<button class="btn btn-sm btn-success" onclick="markPaidEntry('${driverId}','${bookingId}')">Mark Paid</button>`;

          card.innerHTML = `
            <h3>SL #${sl} — ₹${isNaN(amount) ? '0.00' : amount.toFixed(2)}</h3>
            <p><strong>Booking ID:</strong> ${bookingId}</p>
            <p><strong>Fare:</strong> ₹${fare}</p>
            <p><strong>Status:</strong> ${status}</p>
            <p><strong>Pickup:</strong> ${pickup}</p>
            <p><strong>Dropoff:</strong> ${dropoff}</p>
            <div class="wallet-actions">
              ${btnShow}
              ${btnQr}
              ${btnPaid}
            </div>
          `;
          container.appendChild(card);
          sl++;
        }
      }

      $('#wallets-loading').hide(); $('#driver-wallets-container').show();
    }

    // show booking modal — build a table with representable fields
    async function showBookingModal(driverId, bookingId){
      try {
        const snap = await get(ref(db, `driverWallet/${driverId}/${bookingId}`));
        if(!snap.exists()){
          document.getElementById('bookingDetailsBody').innerHTML = `<div class="alert alert-warning">No booking data found for ${bookingId}</div>`;
          new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
          return;
        }
        const entry = snap.val();
        const b = entry.booking || entry.bookingdata || entry;

        const rows = [
          ['Booking ID', bookingId],
          ['Driver ID', b.driverId || entry.driverId || driverId],
          ['Driver Name', b.driverName || entry.driverName || 'N/A'],
          ['User Name', b.userName || b.customerName || entry.userName || 'N/A'],
          ['User Phone', b.userPhone || entry.userPhone || 'N/A'],
          ['Pickup', b.pickup || 'N/A'],
          ['Dropoff', b.dropoff || 'N/A'],
          ['Date', b.date || entry.date || 'N/A'],
          ['Time', b.time || entry.time || 'N/A'],
          ['Booked At', b.bookedAt || entry.bookedAt || 'N/A'],
          ['Fare', b.fare || entry.fare || 'N/A'],
          ['Amount', entry.amount || 'N/A'],
          ['PaymentId', b.paymentId || entry.paymentId || 'N/A'],
          ['Status', entry.status || b.status || (entry.paidout ? 'paid' : 'unpaid') || 'N/A']
        ];

        let html = `<table class="table table-sm table-bordered">`;
        for(const [label, val] of rows){
          html += `<tr><th style="width:30%">${label}</th><td>${(val !== undefined && val !== null) ? val : 'N/A'}</td></tr>`;
        }
        html += `</table>`;
        document.getElementById('bookingDetailsBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
      } catch (err) {
        document.getElementById('bookingDetailsBody').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
        new bootstrap.Modal(document.getElementById('bookingDetailsModal')).show();
      }
    }

    // Show QR modal: fetch driver's UPI id and name and generate QR
    async function showQrModal(driverId, amount, bookingId){
      try {
        const dSnap = await get(ref(db, `driverdetails/${driverId}`));
        if(!dSnap.exists()){
          alert('Driver details not found for ' + driverId);
          return;
        }
        const d = dSnap.val();
        const upiId = d.upiId;
        const driverName = d.name || '';

        if(!upiId){
          alert('UPI ID not set for this driver.');
          return;
        }

        const amountStr = Number(amount) ? Number(amount).toFixed(2) : '0.00';
        const tn = bookingId ? `Payment for ${bookingId}` : 'Withdrawal payment';
        const upiUri = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(driverName)}&am=${encodeURIComponent(amountStr)}&tn=${encodeURIComponent(tn)}&cu=INR`;

        // clear previous
        document.getElementById('qrCode').innerHTML = '';
        new QRCode(document.getElementById('qrCode'), {
          text: upiUri,
          width: 220,
          height: 220,
          colorDark: '#000000',
          colorLight: '#ffffff'
        });

        document.getElementById('qrInfo').innerHTML = `<small style="color:#fff">UPI: ${upiId} — ${driverName ? driverName + ' — ' : ''}Amount: ₹${amountStr}</small>`;
        new bootstrap.Modal(document.getElementById('qrModal')).show();
      } catch (err) {
        alert('Failed to generate QR: ' + (err.message || err));
      }
    }

    // mark paid for an entry with confirmation
    async function markPaidEntry(driverId, bookingId){
      if(!confirm(`Mark booking ${bookingId} for driver ${driverId} as paid? This will set paidout=true.`)) return;
      try {
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), { paidout:true, status: 'paid' });
        loadWallets();
      } catch (err) {
        alert('Failed to mark paid: ' + (err.message || err));
      }
    }

    // ------------------ Withdrawals (GROUPED PER DRIVER) ------------------
    async function loadWithdrawals(){
      $('#withdrawals-container').hide(); $('#withdrawals-loading').show();
      const container = document.getElementById('withdrawals-container');
      container.innerHTML='';

      const snap = await get(ref(db,'pendingWithdrawals'));
      if(!snap.exists()){
        container.textContent = 'No pending withdrawals found.';
        $('#withdrawals-loading').hide(); $('#withdrawals-container').show();
        return;
      }

      // snap.val() structure: { driverId: { bookingId: {amount, fare, status, booking: {...}} } }
      const byDriver = snap.val();

      // Iterate each driver and create a single card for them
      for(const [driverId, bookingsObj] of Object.entries(byDriver)){
        // compute total
        let total = 0;
        for(const b of Object.values(bookingsObj)) total += Number(b.amount) || 0;

        // fetch driver details for name & upi
        let driverName = null, upi = null;
        try {
          const dSnap = await get(ref(db, `driverdetails/${driverId}`));
          if(dSnap.exists()){
            const d = dSnap.val();
            driverName = d.name || null;
            upi = d.upiId || null;
          }
        } catch (e) {
          driverName = null; upi = null;
        }

        const driverCard = document.createElement('div');
        driverCard.className = 'withdrawal-driver-card';
        // header with total and UPI
        driverCard.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <div>
              <h4 style="margin:0;color:#ffd700">Driver: ${driverId}${driverName ? ` — ${driverName}` : ''}</h4>
              <small style="color:#cbd5e1">UPI: ${upi ? upi : '—'}</small>
            </div>
            <div style="text-align:right;">
              <h4 style="margin:0">Total: ₹${total.toFixed(2)}</h4>
              <div style="margin-top:6px;">
                <button class="btn btn-sm btn-primary" ${upi ? '' : 'disabled title="UPI missing"'} onclick='showQrModal("${driverId}", ${total.toFixed(2)}, "")'>Show QR (Total)</button>
              </div>
            </div>
          </div>
          <hr style="border-color: rgba(255,255,255,0.06)">
          <div id="withdrawals-list-${driverId}"></div>
        `;
        container.appendChild(driverCard);

        // create list/table for bookings inside this card
        const listEl = driverCard.querySelector(`#withdrawals-list-${driverId}`);
        // table
        const tbl = document.createElement('table');
        tbl.className = 'table table-sm table-striped';
        tbl.innerHTML = `<thead><tr><th>SL</th><th>Booking</th><th>Amount</th><th>Fare</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody>`;
        listEl.appendChild(tbl);
        const tbody = tbl.querySelector('tbody');

        let i=1;
        for(const [bookingId, data] of Object.entries(bookingsObj)){
          const tr = document.createElement('tr');
          const pickup = (data.booking && data.booking.pickup) ? data.booking.pickup : (data.pickup || 'N/A');
          const dropoff = (data.booking && data.booking.dropoff) ? data.booking.dropoff : (data.dropoff || 'N/A');
          const amount = Number(data.amount) ? Number(data.amount).toFixed(2) : '0.00';
          const fare = data.fare ?? 'N/A';
          const status = data.status ?? 'pending';

          // actions: approve/reject, show qr for booking
          const btnApprove = `<button class="btn btn-sm btn-success" onclick="approveWithdrawal('${driverId}','${bookingId}')">Approve</button>`;
          const btnReject = `<button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${driverId}','${bookingId}')">Reject</button>`;
          const btnQr = `<button class="btn btn-sm btn-primary" ${upi ? '' : 'disabled title="UPI missing"'} onclick='showQrModal("${driverId}", ${amount}, "${bookingId}")'>Show QR</button>`;
          const btnShowBooking = `<button class="btn btn-sm btn-info" onclick="showBookingModal('${driverId}','${bookingId}')">Show</button>`;

          tr.innerHTML = `<td>${i++}</td>
                          <td style="min-width:180px"><div><strong>${bookingId}</strong></div><small>${pickup} → ${dropoff}</small></td>
                          <td>₹${amount}</td>
                          <td>₹${fare}</td>
                          <td>${status}</td>
                          <td style="white-space:nowrap">${btnShowBooking} ${btnQr} ${btnApprove} ${btnReject}</td>`;
          tbody.appendChild(tr);
        }
      }

      $('#withdrawals-loading').hide(); $('#withdrawals-container').show();
    }

    // PROFILE loader (keeps same)
    async function loadProfile(){
      $('#profile-table').hide(); $('#profile-loading').show();
      initTable('profile-table');
      const user = auth.currentUser;
      const profileData = {
        Name: user?.displayName || 'Admin',
        Email: user?.email || '',
        UID: user?.uid || '',
      };
      for(const [k,v] of Object.entries(profileData)){
        tables['profile-table'].row.add([k,v]).draw(false);
      }
      $('#profile-loading').hide(); $('#profile-table').show();
    }

    // openTab handler used by navbar buttons
    window.openTab = function(tab){
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
      const id = tab+'-tab';
      document.getElementById(id).classList.add('active');
      switch(tab){
        case 'users': loadUsers(); break;
        case 'drivers': loadDrivers(); break;
        case 'pending-cars': loadPending(); break;
        case 'approved-cars': loadApproved(); break;
        case 'slots': loadSlots(); break;
        case 'bookings': loadBookings(); break;
        case 'driver-wallets': loadWallets(); break;
        case 'pending-withdrawals': loadWithdrawals(); break;
        case 'profile': loadProfile(); break;
      }
    };

    // on auth state - default to users tab if logged
    onAuthStateChanged(auth, user => {
      if(user) {
        openTab('users');
      } else {
        location.href = 'adminlogin.html';
      }
    });

  </script>
</body>
</html>
