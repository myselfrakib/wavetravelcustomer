<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaveTravel — Admin Dashboard</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb; --success: #059669; --danger: #dc2626; --warning: #d97706; --info: #0891b2;
      --light: #f8fafc; --dark: #1e293b; --muted: #64748b; --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --whatsapp: #25D366;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    body { font-family: 'Inter', system-ui, -apple-system, Arial, sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: var(--dark); line-height: 1.6; }
    
    .topbar { position: sticky; top: 0; z-index: 1030; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); box-shadow: var(--shadow); }
    .brand { display: flex; gap: 12px; align-items: center; color: var(--dark); font-weight: 700; text-decoration: none; }
    .brand img { height: 40px; width: 40px; object-fit: cover; border-radius: 10px; box-shadow: var(--shadow); }
    .brand-text { font-size: 1.5rem; color: var(--primary); }
    .brand-subtitle { font-size: 0.875rem; color: var(--muted); font-weight: 400; }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--dark); transition: all 0.2s; }
    .btn-ghost:hover { background: var(--light); border-color: var(--primary); color: var(--primary); }
    .btn-whatsapp { background: var(--whatsapp) !important; border: none; color: white !important; }
    .btn-whatsapp:hover { background: #128C7E !important; color: white !important; }
    
    .container-main { display: grid; grid-template-columns: 280px 1fr; gap: 24px; padding: 24px; min-height: calc(100vh - 80px); }
    .sidebar { background: white; padding: 20px; border-radius: 16px; height: fit-content; box-shadow: var(--shadow-lg); border: 1px solid var(--border); position: sticky; top: 100px; }
    .sidebar .nav-link { color: var(--muted); font-weight: 500; border-radius: 10px; padding: 12px 16px; margin-bottom: 4px; text-decoration: none; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
    .sidebar .nav-link:hover { background: var(--light); color: var(--primary); }
    .sidebar .nav-link.active { background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); color: white; box-shadow: var(--shadow); }
    
    .panel { background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
    .panel h2 { font-size: 1.5rem; margin: 0 0 20px 0; color: var(--dark); font-weight: 600; }
    
    .filter-section { background: var(--light); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border); }
    .filter-section .filter-title { font-weight: 600; color: var(--dark); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .filter-controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 0.875rem; color: var(--muted); font-weight: 500; }
    .stats-row { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .stat-card { background: white; padding: 16px; border-radius: 12px; border: 1px solid var(--border); flex: 1; min-width: 200px; }
    .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 0.875rem; color: var(--muted); margin-top: 4px; }
    
    .table-responsive { max-height: calc(100vh - 450px); overflow-y: auto; overflow-x: auto; }
    .table-responsive::-webkit-scrollbar { width: 8px; height: 8px; }
    .table-responsive::-webkit-scrollbar-track { background: var(--light); border-radius: 4px; }
    .table-responsive::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; }
    .table-responsive::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    
    table.dataTable { background: white !important; color: var(--dark) !important; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    table.dataTable thead th { background: var(--light) !important; color: var(--dark) !important; font-weight: 600; border-bottom: 2px solid var(--border) !important; position: sticky; top: 0; z-index: 10; }
    table.dataTable tbody tr:hover { background: var(--light) !important; }
    table.dataTable tbody td { vertical-align: middle; }
    
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); border: none; box-shadow: var(--shadow); }
    .btn-success { background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); border: none; box-shadow: var(--shadow); }
    .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); border: none; box-shadow: var(--shadow); }
    .btn-info { background: linear-gradient(135deg, var(--info) 0%, #06b6d4 100%); border: none; box-shadow: var(--shadow); }
    .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%); border: none; box-shadow: var(--shadow); }
    
    .driver-wallets-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; max-height: calc(100vh - 350px); overflow-y: auto; padding-right: 8px; }
    .driver-wallets-container::-webkit-scrollbar { width: 8px; }
    .driver-wallets-container::-webkit-scrollbar-track { background: var(--light); border-radius: 4px; }
    .driver-wallets-container::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; }
    .driver-wallets-container::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    
    .driver-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-lg); transition: all 0.3s ease; }
    .driver-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    .driver-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .small-muted { color: var(--muted); font-size: 0.875rem; }
    
    .badge-paid { background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
    .badge-unpaid { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
    .badge-processing { background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
    
    .image-gallery { display: flex; gap: 8px; flex-wrap: wrap; }
    .image-thumbnail { width: 80px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .image-thumbnail:hover { border-color: var(--primary); transform: scale(1.05); }
    
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 37%, #f1f5f9 63%); background-size: 400% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 8px; }
    @keyframes skeleton { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    
    .form-control { border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.875rem; }
    .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .form-select { border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.875rem; }
    
    .modal-content { border: none; border-radius: 16px; box-shadow: var(--shadow-lg); }
    .modal-header { background: var(--light); border-bottom: 1px solid var(--border); border-radius: 16px 16px 0 0; }
    .toast { border: none; border-radius: 12px; box-shadow: var(--shadow-lg); }
    
    .dataTables_wrapper .dataTables_paginate { margin-top: 16px; }
    .dataTables_wrapper .dataTables_info { padding-top: 16px; }
    
    #withdrawals-container { max-height: calc(100vh - 350px); overflow-y: auto; padding-right: 8px; }
    #withdrawals-container::-webkit-scrollbar { width: 8px; }
    #withdrawals-container::-webkit-scrollbar-track { background: var(--light); border-radius: 4px; }
    #withdrawals-container::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 4px; }
    #withdrawals-container::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    
    @media (max-width: 1024px) { 
      .container-main { grid-template-columns: 1fr; padding: 16px; } 
      .sidebar { order: 2; height: auto; position: relative; top: 0; } 
      .driver-wallets-container { grid-template-columns: 1fr; } 
      .filter-controls { flex-direction: column; }
      .filter-group { width: 100%; }
    }
  </style>
</head>
<body>

  <nav class="topbar py-3 px-4 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-4">
      <div class="brand">
        <img src="https://wavetravel-3c4c4.web.app/logo192.png" alt="WaveTravel Logo" onerror="this.style.display='none'">
        <div>
          <div class="brand-text">WaveTravel</div>
          <div class="brand-subtitle">Admin Dashboard</div>
        </div>
      </div>
      <div class="d-none d-md-flex">
        <div class="input-group">
          <span class="input-group-text bg-transparent border-0 text-muted"><i class="bi bi-search"></i></span>
          <input id="globalSearch" class="form-control bg-transparent border-0" placeholder="Quick search (press /)" />
        </div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button id="refreshAllBtn" class="btn btn-sm btn-ghost" title="Refresh current tab"><i class="bi bi-arrow-clockwise"></i></button>
      <button class="btn btn-sm btn-ghost" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </nav>

  <div class="container-main">
    <aside class="sidebar">
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" onclick="openTab('users')"><i class="bi bi-people"></i> Users</a>
        <a class="nav-link" href="#" onclick="openTab('drivers')"><i class="bi bi-person-badge"></i> Drivers</a>
        <a class="nav-link" href="#" onclick="openTab('searches')"><i class="bi bi-search"></i> Searches</a>
        <a class="nav-link" href="#" onclick="openTab('ride-requests')"><i class="bi bi-car-front"></i> Ride Requests</a>
        <a class="nav-link" href="#" onclick="openTab('pending-cars')"><i class="bi bi-hourglass-split"></i> Pending Cars</a>
        <a class="nav-link" href="#" onclick="openTab('approved-cars')"><i class="bi bi-check2-square"></i> Approved Cars</a>
        <a class="nav-link" href="#" onclick="openTab('slots')"><i class="bi bi-calendar2-day"></i> Slots</a>
        <a class="nav-link" href="#" onclick="openTab('bookings')"><i class="bi bi-journal-check"></i> Bookings</a>
        <a class="nav-link" href="#" onclick="openTab('driver-wallets')"><i class="bi bi-wallet2"></i> Driver Wallets</a>
        <a class="nav-link" href="#" onclick="openTab('pending-withdrawals')"><i class="bi bi-credit-card"></i> Pending Withdrawals</a>
        <a class="nav-link" href="#" onclick="openTab('profile')"><i class="bi bi-person-circle"></i> Profile</a>
        <div style="height: 20px;"></div>
        <button class="btn btn-danger w-100" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i> Sign out</button>
      </nav>
    </aside>

    <main>
      <section id="users-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-people me-2 text-primary"></i>User Management</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Start Date</label>
              <input type="date" id="usersStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>End Date</label>
              <input type="date" id="usersEndDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>Quick Select</label>
              <select id="usersQuickFilter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="usersFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply Filter</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="usersResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row" id="usersStats">
          <div class="stat-card">
            <div class="stat-value" id="usersTotalCount">0</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="usersFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
        </div>
        
        <div id="users-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="users-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>User ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Registered On</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="drivers-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-person-badge me-2 text-primary"></i>Driver Management</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Vehicle Count</label>
              <select id="driversVehicleFilter" class="form-select">
                <option value="all">All</option>
                <option value="0">No Vehicles</option>
                <option value="1">1 Vehicle</option>
                <option value="2+">2+ Vehicles</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="driversFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply Filter</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="driversResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="driversTotalCount">0</div>
            <div class="stat-label">Total Drivers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="driversFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
        </div>
        
        <div id="drivers-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="drivers-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver ID</th><th>Driver Name</th><th>Phone Number</th><th>Vehicle Count</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="searches-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-search me-2 text-info"></i>User Search History</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Start Date</label>
              <input type="date" id="searchesStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>End Date</label>
              <input type="date" id="searchesEndDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>Quick Select</label>
              <select id="searchesQuickFilter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Fallback Status</label>
              <select id="searchesFallbackFilter" class="form-select">
                <option value="all">All</option>
                <option value="yes">Fallback Used</option>
                <option value="no">No Fallback</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="searchesFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply Filter</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="searchesResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="searchesTotalCount">0</div>
            <div class="stat-label">Total Searches</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="searchesFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="searchesAvgResults">0</div>
            <div class="stat-label">Avg Results/Search</div>
          </div>
        </div>
        
        <div id="searches-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="searches-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Customer Name</th><th>Pickup Location</th><th>Dropoff Location</th><th>Travel Date</th><th>Seats Required</th><th>Results Found</th><th>Searched On</th><th>Fallback Used</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="ride-requests-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-car-front me-2 text-warning"></i>Ride Request Management</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Start Date</label>
              <input type="date" id="requestsStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>End Date</label>
              <input type="date" id="requestsEndDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>Quick Select</label>
              <select id="requestsQuickFilter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Request Status</label>
              <select id="requestStatusFilter" class="form-select">
                <option value="all">All Status</option>
                <option value="pending" selected>Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="requestFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="requestsResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="requestsTotalCount">0</div>
            <div class="stat-label">Total Requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-warning" id="requestsPendingCount">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-success" id="requestsApprovedCount">0</div>
            <div class="stat-label">Approved</div>
          </div>
          <div class="stat-card">
            <div class="stat-value text-danger" id="requestsRejectedCount">0</div>
            <div class="stat-label">Rejected</div>
          </div>
        </div>
        
        <div id="requests-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="requests-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Request ID</th><th>Customer Name</th><th>Email</th><th>Phone</th><th>Pickup Location</th><th>Dropoff Location</th><th>Travel Date</th><th>Trip Type</th><th>Status</th><th>Notes</th><th>Requested On</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="pending-cars-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-hourglass-split me-2 text-warning"></i>Pending Car Approvals</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Start Date</label>
              <input type="date" id="pendingStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>End Date</label>
              <input type="date" id="pendingEndDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>Quick Select</label>
              <select id="pendingQuickFilter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="pendingFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="pendingResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="pendingTotalCount">0</div>
            <div class="stat-label">Total Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="pendingFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
        </div>
        
        <div id="pending-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="pending-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver ID</th><th>Car ID</th><th>Car Brand</th><th>Registration No</th><th>Driver Name</th><th>Driver Number</th><th>Owner Name</th><th>Seats</th><th>Car Images</th><th>License</th><th>Submitted On</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="approved-cars-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-check2-square me-2 text-success"></i>Approved Cars</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Seats</label>
              <select id="approvedSeatsFilter" class="form-select">
                <option value="all">All Seats</option>
                <option value="4">4 Seater</option>
                <option value="5">5 Seater</option>
                <option value="6">6 Seater</option>
                <option value="7">7 Seater</option>
                <option value="8+">8+ Seater</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="approvedFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="approvedResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="approvedTotalCount">0</div>
            <div class="stat-label">Total Approved</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="approvedFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
        </div>
        
        <div id="approved-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="approved-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver Name</th><th>Phone Number</th><th>Car ID</th><th>Car Brand</th><th>Registration No</th><th>Owner Name</th><th>Seats</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="slots-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-calendar2-day me-2 text-info"></i>Available Slots</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Start Date</label>
              <input type="date" id="slotsStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>End Date</label>
              <input type="date" id="slotsEndDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>Quick Select</label>
              <select id="slotsQuickFilter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="slotsFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="slotsResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="slotsTotalCount">0</div>
            <div class="stat-label">Total Slots</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="slotsFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
        </div>
        
        <div id="slots-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="slots-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver Name</th><th>Phone Number</th><th>Slot ID</th><th>Pickup Location</th><th>Dropoff Location</th><th>Travel Date</th><th>Time</th><th>Available Seats</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="bookings-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-journal-check me-2 text-primary"></i>Booking Management</h2>
        
        <div class="filter-section">
          <div class="filter-title"><i class="bi bi-funnel"></i> Filters</div>
          <div class="filter-controls">
            <div class="filter-group">
              <label>Start Date</label>
              <input type="date" id="bookingsStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>End Date</label>
              <input type="date" id="bookingsEndDate" class="form-control">
            </div>
            <div class="filter-group">
              <label>Quick Select</label>
              <select id="bookingsQuickFilter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="year">This Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Status</label>
              <select id="bookingsStatusFilter" class="form-select">
                <option value="all">All Status</option>
                <option value="confirmed">Confirmed</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
                <option value="pending">Pending</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="bookingsFilterBtn" class="btn btn-primary"><i class="bi bi-filter"></i> Apply</button>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button id="bookingsResetBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Reset</button>
            </div>
          </div>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="bookingsTotalCount">0</div>
            <div class="stat-label">Total Bookings</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="bookingsFilteredCount">0</div>
            <div class="stat-label">Filtered Results</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="bookingsTotalRevenue">₹0</div>
            <div class="stat-label">Total Revenue</div>
          </div>
        </div>
        
        <div id="bookings-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="bookings-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Booking ID</th><th>Customer Name</th><th>Vehicle Info</th><th>Pickup Location</th><th>Dropoff Location</th><th>Duration</th><th>Fare Amount</th><th>Payment Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="driver-wallets-tab" class="tab-pane panel" hidden>
        <div class="d-flex align-items-center justify-content-between mb-4">
          <h2><i class="bi bi-wallet2 me-2 text-success"></i>Driver Wallet Management</h2>
          <div class="d-flex align-items-center gap-3">
            <select id="walletStatusFilter" class="form-select form-select-sm" style="width: auto;">
              <option value="processing" selected>Processing</option>
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
            <button id="walletFilterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
          </div>
        </div>
        <div id="wallets-loading" class="skeleton" style="height:80px;"></div>
        <div id="driver-wallets-container" class="driver-wallets-container" style="display:none;"></div>
      </section>

      <section id="pending-withdrawals-tab" class="tab-pane panel" hidden>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-credit-card me-2 text-warning"></i>Pending Withdrawal Requests</h2>
          <button id="exportWithdrawalsBtn" class="btn btn-primary"><i class="bi bi-download me-2"></i>Export CSV</button>
        </div>
        <div id="withdrawals-loading" class="skeleton" style="height:60px;"></div>
        <div id="withdrawals-container" style="display:none;"></div>
      </section>

      <section id="profile-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-person-circle me-2 text-info"></i>Admin Profile</h2>
        <div id="profile-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="profile-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>Field</th><th>Value</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="imageViewerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageViewerTitle">Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="imageViewerImg" src="" alt="Image" style="max-width:100%;height:auto;border-radius:8px">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h5 class="text-primary mb-3">UPI Payment QR</h5>
        <div id="qrCode" class="my-3 d-flex justify-content-center"></div>
        <div id="qrInfo" class="mb-3 small-muted"></div>
        <div class="d-flex gap-2 justify-content-center">
          <button id="copyUpiUriBtn" class="btn btn-sm btn-outline-primary">Copy URI</button>
          <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" style="position:fixed;right:20px;bottom:20px;z-index:1200;"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, update, remove, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const tables = {};
    let currentUser = null;
    let allData = {};

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function sanitizeId(id) { return String(id).replace(/[^a-z0-9\-_]/gi, '-'); }

    function formatDateDDMMYY(dateInput) {
      if (!dateInput) return '';
      let date;
      if (dateInput instanceof Date) {
        date = dateInput;
      } else if (typeof dateInput === 'number') {
        date = new Date(dateInput);
      } else if (typeof dateInput === 'string') {
        date = new Date(dateInput);
      } else {
        return String(dateInput);
      }
      if (isNaN(date.getTime())) return String(dateInput);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${day}/${month}/${year}`;
    }

    function getDateRange(quickFilter) {
      const now = new Date();
      let startDate, endDate = now;
      
      switch(quickFilter) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'week':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
          break;
        case 'month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          break;
        case 'year':
          startDate = new Date(now.getFullYear(), 0, 1);
          break;
        default:
          return null;
      }
      
      return { startDate, endDate };
    }

    function isDateInRange(dateValue, startDate, endDate) {
      if (!dateValue) return false;
      const date = new Date(dateValue);
      if (isNaN(date.getTime())) return false;
      
      if (startDate && date < startDate) return false;
      if (endDate) {
        const endOfDay = new Date(endDate);
        endOfDay.setHours(23, 59, 59, 999);
        if (date > endOfDay) return false;
      }
      return true;
    }

    window.sendWhatsAppMessage = function(pickup, dropoff, date, phone) {
      const formattedDate = formatDateDDMMYY(date);
      const message = `Hello! Your cab is available from ${pickup} to ${dropoff} on ${formattedDate}. Please contact us for booking details and confirmation. We look forward to serving you!`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = phone 
        ? `https://wa.me/${phone.replace(/[^0-9]/g, '')}?text=${encodedMessage}`
        : `https://wa.me/?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
    };

    function showToast(message, type = 'info', timeout = 3500) {
      const toastId = 'toast-' + Date.now();
      const bgClass = type === 'success' ? 'text-bg-success' : type === 'danger' ? 'text-bg-danger' : type === 'warning' ? 'text-bg-warning' : 'text-bg-info';
      const toastHtml = `<div id="${toastId}" class="toast ${bgClass} border-0 mb-2" role="alert"><div class="d-flex"><div class="toast-body">${escapeHtml(message)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
      document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHtml);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: timeout });
      toast.show();
      toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    function initTable(id, nonSortableCols = []) {
      if (tables[id]) { tables[id].clear(); tables[id].destroy(); }
      tables[id] = $(`#${id}`).DataTable({
        responsive: true, 
        dom: 'Bfrtip', 
        buttons: ['copy', 'csv', 'excel', 'print'],
        pageLength: 100,
        lengthMenu: [[25, 50, 100, 200], [25, 50, 100, 200]],
        columnDefs: nonSortableCols.map(col => ({ orderable: false, targets: col })),
        language: { emptyTable: 'No records found.', loadingRecords: 'Loading...', processing: 'Processing...' },
        order: [[0, 'asc']],
        scrollY: 'calc(100vh - 450px)',
        scrollCollapse: true,
        deferRender: true
      });
      return tables[id];
    }

    window.showImage = function(imageUrl, title = 'Image') {
      document.getElementById('imageViewerTitle').textContent = title;
      document.getElementById('imageViewerImg').src = imageUrl;
      new bootstrap.Modal(document.getElementById('imageViewerModal')).show();
    };

    function createImageGallery(images, type = 'car') {
      if (!images || !Array.isArray(images) || images.length === 0) return '<span class="small-muted">No images</span>';
      let html = '<div class="image-gallery">';
      images.forEach((imageUrl, index) => {
        const title = type === 'license' ? 'Driver License' : `Car Image ${index + 1}`;
        html += `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}" class="image-thumbnail" onclick="showImage('${escapeHtml(imageUrl)}', '${escapeHtml(title)}')">`;
      });
      return html + '</div>';
    }

    function pickField(obj, candidates) {
      for (const key of candidates) {
        if (key.includes('.')) {
          const parts = key.split('.');
          let current = obj;
          let valid = true;
          for (const part of parts) {
            if (current && typeof current === 'object' && part in current) { current = current[part]; } else { valid = false; break; }
          }
          if (valid && current !== undefined && current !== null && current !== '') return current;
        } else {
          if (obj && typeof obj === 'object' && key in obj && obj[key] !== undefined && obj[key] !== null && obj[key] !== '') return obj[key];
        }
      }
      return null;
    }

    function safeDisplay(value) {
      if (value === null || value === undefined) return '';
      if (typeof value === 'object') {
        try {
          const str = JSON.stringify(value);
          return str.length > 100 ? str.substring(0, 100) + '...' : str;
        } catch (e) { return String(value); }
      }
      return String(value);
    }

    function getEffectiveStatusFromWalletEntry(entry) {
      if (!entry) return 'unpaid';
      if (entry.status) {
        const status = String(entry.status).toLowerCase();
        if (['paid', 'approved', 'completed'].includes(status)) return 'paid';
        if (['processing', 'pending', 'requested'].includes(status)) return 'processing';
      }
      if (entry.paidout === true) return 'paid';
      const withdrawalFlags = ['withdrawalRequested', 'withdrawal_requested', 'requested', 'pendingWithdrawal'];
      for (const flag of withdrawalFlags) {
        if (entry[flag] === true) return 'processing';
      }
      const timestampFields = ['requestedAt', 'requestedOn', 'requestTimestamp'];
      for (const field of timestampFields) { if (entry[field]) return 'processing'; }
      return 'unpaid';
    }

    window.logout = () => signOut(auth).then(() => window.location.href = 'adminlogin.html').catch(e => showToast('Logout failed: ' + e.message, 'danger'));

    async function safeDelete(path, confirmMsg, successMsg, reloadFn) {
      if (!confirm(confirmMsg)) return;
      try {
        await remove(ref(db, path));
        showToast(successMsg, 'success');
        if (typeof reloadFn === 'function') reloadFn();
      } catch (error) { showToast('Delete failed: ' + error.message, 'danger'); }
    }

    async function loadUsers() {
      document.getElementById('users-table').style.display = 'none';
      document.getElementById('users-loading').style.display = 'block';
      const table = initTable('users-table', [7]);
      try {
        const snapshot = await get(ref(db, 'users'));
        allData.users = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const users = snapshot.val();
          for (const [uid, user] of Object.entries(users)) {
            allData.users.push({ uid, ...user, serialNo: serialNo++ });
          }
        }
        applyUsersFilter();
      } catch (error) { showToast('Failed to load users: ' + error.message, 'danger'); }
      finally {
        document.getElementById('users-loading').style.display = 'none';
        document.getElementById('users-table').style.display = 'table';
      }
    }

    function applyUsersFilter() {
      const quickFilter = document.getElementById('usersQuickFilter').value;
      const startDateInput = document.getElementById('usersStartDate').value;
      const endDateInput = document.getElementById('usersEndDate').value;
      
      let startDate = startDateInput ? new Date(startDateInput) : null;
      let endDate = endDateInput ? new Date(endDateInput) : null;
      
      if (quickFilter !== 'all') {
        const range = getDateRange(quickFilter);
        if (range) {
          startDate = range.startDate;
          endDate = range.endDate;
        }
      }
      
      const filtered = allData.users.filter(user => {
        if (quickFilter === 'all' && !startDate && !endDate) return true;
        return isDateInRange(user.createdOn, startDate, endDate);
      });
      
      const table = tables['users-table'];
      table.clear();
      const rows = filtered.map(user => [
        user.serialNo,
        user.uid,
        escapeHtml(user.name || ''),
        escapeHtml(user.email || ''),
        escapeHtml(user.phone || ''),
        escapeHtml(user.address || ''),
        formatDateDDMMYY(user.createdOn),
        `<button class="btn btn-sm btn-danger" onclick="deleteUser('${escapeHtml(user.uid)}')"><i class="bi bi-trash"></i> Delete</button>`
      ]);
      if (rows.length > 0) table.rows.add(rows).draw();
      
      document.getElementById('usersTotalCount').textContent = allData.users.length;
      document.getElementById('usersFilteredCount').textContent = filtered.length;
    }

    async function loadDrivers() {
      document.getElementById('drivers-table').style.display = 'none';
      document.getElementById('drivers-loading').style.display = 'block';
      const table = initTable('drivers-table', [5]);
      try {
        const snapshot = await get(ref(db, 'driverdetails'));
        allData.drivers = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const drivers = snapshot.val();
          for (const [driverId, driver] of Object.entries(drivers)) {
            const vehicleCount = driver.vehicles ? Object.keys(driver.vehicles).length : 0;
            allData.drivers.push({ driverId, ...driver, vehicleCount, serialNo: serialNo++ });
          }
        }
        applyDriversFilter();
      } catch (error) { showToast('Failed to load drivers: ' + error.message, 'danger'); }
      finally {
        document.getElementById('drivers-loading').style.display = 'none';
        document.getElementById('drivers-table').style.display = 'table';
      }
    }

    function applyDriversFilter() {
      const vehicleFilter = document.getElementById('driversVehicleFilter').value;
      
      const filtered = allData.drivers.filter(driver => {
        if (vehicleFilter === 'all') return true;
        if (vehicleFilter === '0') return driver.vehicleCount === 0;
        if (vehicleFilter === '1') return driver.vehicleCount === 1;
        if (vehicleFilter === '2+') return driver.vehicleCount >= 2;
        return true;
      });
      
      const table = tables['drivers-table'];
      table.clear();
      const rows = filtered.map(driver => [
        driver.serialNo,
        driver.driverId,
        escapeHtml(driver.name || ''),
        escapeHtml(driver.phone || ''),
        driver.vehicleCount,
        `<button class="btn btn-sm btn-danger" onclick="deleteDriver('${escapeHtml(driver.driverId)}')"><i class="bi bi-trash"></i> Delete</button>`
      ]);
      if (rows.length > 0) table.rows.add(rows).draw();
      
      document.getElementById('driversTotalCount').textContent = allData.drivers.length;
      document.getElementById('driversFilteredCount').textContent = filtered.length;
    }

    async function loadSearches() {
      document.getElementById('searches-table').style.display = 'none';
      document.getElementById('searches-loading').style.display = 'block';
      const table = initTable('searches-table', [9]);
      try {
        const searchesSnapshot = await get(ref(db, 'searches'));
        const usersSnapshot = await get(ref(db, 'users'));
        const users = usersSnapshot.exists() ? usersSnapshot.val() : {};
        
        allData.searches = [];
        let serialNo = 1;
        if (searchesSnapshot.exists()) {
          const searches = searchesSnapshot.val();
          for (const [searchId, search] of Object.entries(searches)) {
            const customerId = search.customerId || '';
            const customerName = customerId && users[customerId] ? users[customerId].name : customerId;
            const customerPhone = customerId && users[customerId] ? users[customerId].phone : '';
            allData.searches.push({ searchId, ...search, customerName, customerPhone, serialNo: serialNo++ });
          }
        }
        applySearchesFilter();
      } catch (error) { showToast('Failed to load searches: ' + error.message, 'danger'); }
      finally {
        document.getElementById('searches-loading').style.display = 'none';
        document.getElementById('searches-table').style.display = 'table';
      }
    }

    function applySearchesFilter() {
      const quickFilter = document.getElementById('searchesQuickFilter').value;
      const startDateInput = document.getElementById('searchesStartDate').value;
      const endDateInput = document.getElementById('searchesEndDate').value;
      const fallbackFilter = document.getElementById('searchesFallbackFilter').value;
      
      let startDate = startDateInput ? new Date(startDateInput) : null;
      let endDate = endDateInput ? new Date(endDateInput) : null;
      
      if (quickFilter !== 'all') {
        const range = getDateRange(quickFilter);
        if (range) {
          startDate = range.startDate;
          endDate = range.endDate;
        }
      }
      
      const filtered = allData.searches.filter(search => {
        const dateMatch = (quickFilter === 'all' && !startDate && !endDate) || isDateInRange(search.timestamp, startDate, endDate);
        const fallbackMatch = fallbackFilter === 'all' || 
          (fallbackFilter === 'yes' && search.fallbackUsed) ||
          (fallbackFilter === 'no' && !search.fallbackUsed);
        return dateMatch && fallbackMatch;
      });
      
      const table = tables['searches-table'];
      table.clear();
      const rows = filtered.map(search => {
        const timestamp = search.timestamp ? formatDateDDMMYY(new Date(search.timestamp)) : '';
        const searchDate = formatDateDDMMYY(search.date);
        const pickup = search.pickup || '';
        const dropoff = search.dropoff || '';
        
        return [
          search.serialNo,
          escapeHtml(search.customerName || 'Unknown'),
          escapeHtml(pickup),
          escapeHtml(dropoff),
          escapeHtml(searchDate),
          escapeHtml(search.seatsRequested || ''),
          escapeHtml(search.resultCount || 0),
          escapeHtml(timestamp),
          search.fallbackUsed ? 'Yes' : 'No',
          `<div class="btn-group">
            <button class="btn btn-sm btn-whatsapp" onclick="sendWhatsAppMessage('${escapeHtml(pickup)}', '${escapeHtml(dropoff)}', '${escapeHtml(search.date)}', '${escapeHtml(search.customerPhone)}')">
              <i class="bi bi-whatsapp"></i> WhatsApp
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteSearch('${escapeHtml(search.searchId)}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>`
        ];
      });
      if (rows.length > 0) table.rows.add(rows).draw();
      
      const avgResults = filtered.length > 0 ? (filtered.reduce((sum, s) => sum + (s.resultCount || 0), 0) / filtered.length).toFixed(1) : 0;
      document.getElementById('searchesTotalCount').textContent = allData.searches.length;
      document.getElementById('searchesFilteredCount').textContent = filtered.length;
      document.getElementById('searchesAvgResults').textContent = avgResults;
    }

    async function loadRideRequests() {
      document.getElementById('requests-table').style.display = 'none';
      document.getElementById('requests-loading').style.display = 'block';
      const table = initTable('requests-table', [12]);
      try {
        const snapshot = await get(ref(db, 'riderequest'));
        allData.requests = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const requests = snapshot.val();
          for (const [requestId, request] of Object.entries(requests)) {
            allData.requests.push({ requestId, ...request, serialNo: serialNo++ });
          }
        }
        applyRequestsFilter();
      } catch (error) { showToast('Failed to load ride requests: ' + error.message, 'danger'); }
      finally {
        document.getElementById('requests-loading').style.display = 'none';
        document.getElementById('requests-table').style.display = 'table';
      }
    }

    function applyRequestsFilter() {
      const quickFilter = document.getElementById('requestsQuickFilter').value;
      const startDateInput = document.getElementById('requestsStartDate').value;
      const endDateInput = document.getElementById('requestsEndDate').value;
      const statusFilter = document.getElementById('requestStatusFilter')?.value || 'pending';
      
      let startDate = startDateInput ? new Date(startDateInput) : null;
      let endDate = endDateInput ? new Date(endDateInput) : null;
      
      if (quickFilter !== 'all') {
        const range = getDateRange(quickFilter);
        if (range) {
          startDate = range.startDate;
          endDate = range.endDate;
        }
      }
      
      const filtered = allData.requests.filter(request => {
        const status = request.status || 'pending';
        const statusMatch = statusFilter === 'all' || status === statusFilter;
        const dateMatch = (quickFilter === 'all' && !startDate && !endDate) || isDateInRange(request.requestedAt, startDate, endDate);
        return statusMatch && dateMatch;
      });
      
      const table = tables['requests-table'];
      table.clear();
      const rows = filtered.map(request => {
        const status = request.status || 'pending';
        const requestedAt = request.requestedAt ? formatDateDDMMYY(new Date(request.requestedAt)) : '';
        const requestDate = formatDateDDMMYY(request.date);
        const statusBadge = status === 'approved' ? 'badge-paid' : status === 'rejected' ? 'badge-unpaid' : 'badge-processing';
        
        return [
          request.serialNo,
          request.requestId,
          escapeHtml(request.customerName || ''),
          escapeHtml(request.customerEmail || ''),
          escapeHtml(request.customerPhone || ''),
          escapeHtml(request.pickup || ''),
          escapeHtml(request.dropoff || ''),
          escapeHtml(requestDate),
          escapeHtml(request.tripType || ''),
          `<span class="${statusBadge}">${escapeHtml(status)}</span>`,
          escapeHtml((request.notes || '').substring(0, 100) + (request.notes?.length > 100 ? '...' : '')),
          escapeHtml(requestedAt),
          `<div class="btn-group">
            <button class="btn btn-sm btn-success" onclick="approveRideRequest('${escapeHtml(request.requestId)}')" ${status !== 'pending' ? 'disabled' : ''}>
              <i class="bi bi-check"></i> Approve
            </button>
            <button class="btn btn-sm btn-warning" onclick="rejectRideRequest('${escapeHtml(request.requestId)}')" ${status !== 'pending' ? 'disabled' : ''}>
              <i class="bi bi-x"></i> Reject
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteRideRequest('${escapeHtml(request.requestId)}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>`
        ];
      });
      if (rows.length > 0) table.rows.add(rows).draw();
      
      const pendingCount = allData.requests.filter(r => (r.status || 'pending') === 'pending').length;
      const approvedCount = allData.requests.filter(r => r.status === 'approved').length;
      const rejectedCount = allData.requests.filter(r => r.status === 'rejected').length;
      
      document.getElementById('requestsTotalCount').textContent = allData.requests.length;
      document.getElementById('requestsPendingCount').textContent = pendingCount;
      document.getElementById('requestsApprovedCount').textContent = approvedCount;
      document.getElementById('requestsRejectedCount').textContent = rejectedCount;
    }

    async function loadPendingCars() {
      document.getElementById('pending-table').style.display = 'none';
      document.getElementById('pending-loading').style.display = 'block';
      const table = initTable('pending-table', [9, 10, 12]);
      try {
        const snapshot = await get(ref(db, 'pendingcars'));
        allData.pendingCars = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const pendingCars = snapshot.val();
          for (const [driverId, cars] of Object.entries(pendingCars)) {
            for (const [carId, car] of Object.entries(cars)) {
              allData.pendingCars.push({ driverId, carId, ...car, serialNo: serialNo++ });
            }
          }
        }
        applyPendingCarsFilter();
      } catch (error) { showToast('Failed to load pending cars: ' + error.message, 'danger'); }
      finally {
        document.getElementById('pending-loading').style.display = 'none';
        document.getElementById('pending-table').style.display = 'table';
      }
    }

    function applyPendingCarsFilter() {
      const quickFilter = document.getElementById('pendingQuickFilter').value;
      const startDateInput = document.getElementById('pendingStartDate').value;
      const endDateInput = document.getElementById('pendingEndDate').value;
      
      let startDate = startDateInput ? new Date(startDateInput) : null;
      let endDate = endDateInput ? new Date(endDateInput) : null;
      
      if (quickFilter !== 'all') {
        const range = getDateRange(quickFilter);
        if (range) {
          startDate = range.startDate;
          endDate = range.endDate;
        }
      }
      
      const filtered = allData.pendingCars.filter(car => {
        if (quickFilter === 'all' && !startDate && !endDate) return true;
        return isDateInRange(car.submittedAt, startDate, endDate);
      });
      
      const table = tables['pending-table'];
      table.clear();
      const rows = filtered.map(car => {
        const imageGallery = createImageGallery(car.carImages || [], 'car');
        const licenseGallery = car.driverLicense ? createImageGallery([car.driverLicense], 'license') : '<span class="small-muted">No license</span>';
        const submittedAt = formatDateDDMMYY(car.submittedAt);
        
        return [
          car.serialNo,
          car.driverId,
          car.carId,
          escapeHtml(car.carBrand || ''),
          escapeHtml(car.carReg || ''),
          escapeHtml(car.driverName || ''),
          escapeHtml(car.driverNumber || ''),
          escapeHtml(car.ownerName || ''),
          escapeHtml(car.seats || ''),
          imageGallery,
          licenseGallery,
          escapeHtml(submittedAt),
          `<div class="btn-group">
            <button class="btn btn-sm btn-success" onclick="approveCar('${escapeHtml(car.driverId)}', '${escapeHtml(car.carId)}')"><i class="bi bi-check"></i> Approve</button>
            <button class="btn btn-sm btn-danger" onclick="deletePendingCar('${escapeHtml(car.driverId)}', '${escapeHtml(car.carId)}')"><i class="bi bi-trash"></i> Delete</button>
          </div>`
        ];
      });
      if (rows.length > 0) table.rows.add(rows).draw();
      
      document.getElementById('pendingTotalCount').textContent = allData.pendingCars.length;
      document.getElementById('pendingFilteredCount').textContent = filtered.length;
    }

    async function loadApprovedCars() {
      document.getElementById('approved-table').style.display = 'none';
      document.getElementById('approved-loading').style.display = 'block';
      const table = initTable('approved-table', [8]);
      try {
        const snapshot = await get(ref(db, 'approvedcars'));
        allData.approvedCars = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const approvedCars = snapshot.val();
          for (const [driverId, cars] of Object.entries(approvedCars)) {
            for (const [carId, car] of Object.entries(cars)) {
              allData.approvedCars.push({ driverId, carId, ...car, serialNo: serialNo++ });
            }
          }
        }
        applyApprovedCarsFilter();
      } catch (error) { showToast('Failed to load approved cars: ' + error.message, 'danger'); }
      finally {
        document.getElementById('approved-loading').style.display = 'none';
        document.getElementById('approved-table').style.display = 'table';
      }
    }

    function applyApprovedCarsFilter() {
      const seatsFilter = document.getElementById('approvedSeatsFilter').value;
      
      const filtered = allData.approvedCars.filter(car => {
        if (seatsFilter === 'all') return true;
        const seats = parseInt(car.seats) || 0;
        if (seatsFilter === '8+') return seats >= 8;
        return seats === parseInt(seatsFilter);
      });
      
      const table = tables['approved-table'];
      table.clear();
      const rows = filtered.map(car => [
        car.serialNo,
        escapeHtml(car.driverName || ''),
        escapeHtml(car.driverNumber || ''),
        car.carId,
        escapeHtml(car.carBrand || ''),
        escapeHtml(car.carReg || ''),
        escapeHtml(car.ownerName || ''),
        escapeHtml(car.seats || ''),
        `<button class="btn btn-sm btn-danger" onclick="deleteApprovedCar('${escapeHtml(car.driverId)}', '${escapeHtml(car.carId)}')"><i class="bi bi-trash"></i> Delete</button>`
      ]);
      if (rows.length > 0) table.rows.add(rows).draw();
      
      document.getElementById('approvedTotalCount').textContent = allData.approvedCars.length;
      document.getElementById('approvedFilteredCount').textContent = filtered.length;
    }

    async function loadSlots() {
      document.getElementById('slots-table').style.display = 'none';
      document.getElementById('slots-loading').style.display = 'block';
      const table = initTable('slots-table', [9]);
      try {
        const snapshot = await get(ref(db, 'availableslots'));
        allData.slots = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const slots = snapshot.val();
          for (const [driverId, driverSlots] of Object.entries(slots)) {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            const driver = driverSnapshot.exists() ? driverSnapshot.val() : {};
            for (const [slotId, slot] of Object.entries(driverSlots)) {
              allData.slots.push({ driverId, slotId, ...slot, driverName: driver.name || '', driverPhone: driver.phone || '', serialNo: serialNo++ });
            }
          }
        }
        applySlotsFilter();
      } catch (error) { showToast('Failed to load slots: ' + error.message, 'danger'); }
      finally {
        document.getElementById('slots-loading').style.display = 'none';
        document.getElementById('slots-table').style.display = 'table';
      }
    }

    function applySlotsFilter() {
      const quickFilter = document.getElementById('slotsQuickFilter').value;
      const startDateInput = document.getElementById('slotsStartDate').value;
      const endDateInput = document.getElementById('slotsEndDate').value;
      
      let startDate = startDateInput ? new Date(startDateInput) : null;
      let endDate = endDateInput ? new Date(endDateInput) : null;
      
      if (quickFilter !== 'all') {
        const range = getDateRange(quickFilter);
        if (range) {
          startDate = range.startDate;
          endDate = range.endDate;
        }
      }
      
      const filtered = allData.slots.filter(slot => {
        if (quickFilter === 'all' && !startDate && !endDate) return true;
        return isDateInRange(slot.date, startDate, endDate);
      });
      
      const table = tables['slots-table'];
      table.clear();
      const rows = filtered.map(slot => {
        const slotDate = formatDateDDMMYY(slot.date);
        return [
          slot.serialNo,
          escapeHtml(slot.driverName),
          escapeHtml(slot.driverPhone),
          slot.slotId,
          escapeHtml(slot.pickup || ''),
          escapeHtml(slot.dropoff || ''),
          escapeHtml(slotDate),
          escapeHtml(slot.time || ''),
          escapeHtml(slot.seats || ''),
          `<button class="btn btn-sm btn-danger" onclick="deleteSlot('${escapeHtml(slot.driverId)}', '${escapeHtml(slot.slotId)}')"><i class="bi bi-trash"></i> Delete</button>`
        ];
      });
      if (rows.length > 0) table.rows.add(rows).draw();
      
      document.getElementById('slotsTotalCount').textContent = allData.slots.length;
      document.getElementById('slotsFilteredCount').textContent = filtered.length;
    }

    async function loadBookings() {
      document.getElementById('bookings-table').style.display = 'none';
      document.getElementById('bookings-loading').style.display = 'block';
      const table = initTable('bookings-table', [9]);
      try {
        const snapshot = await get(ref(db, 'bookings'));
        allData.bookings = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const bookings = snapshot.val();
          function processBooking(bookingId, booking) {
            const customer = pickField(booking, ['customerName', 'userName', 'customer', 'name']) || '';
            let vehicle = pickField(booking, ['vehicle', 'car', 'vehicleInfo', 'carBrand']) || '';
            if (typeof vehicle === 'object') {
              vehicle = vehicle.brand ? `${vehicle.brand}${vehicle.reg ? ' (' + vehicle.reg + ')' : ''}` : (vehicle.reg || JSON.stringify(vehicle));
            }
            const pickup = pickField(booking, ['pickup', 'from', 'start']) || '';
            const dropoff = pickField(booking, ['dropoff', 'to', 'end']) || '';
            const duration = pickField(booking, ['duration', 'tripDuration']) || '';
            const fare = pickField(booking, ['fare', 'amount', 'price']) || 0;
            const status = pickField(booking, ['status', 'paymentStatus', 'state']) || '';
            const bookingDate = pickField(booking, ['bookingDate', 'createdAt', 'timestamp', 'date']) || null;
            
            allData.bookings.push({
              bookingId, customer, vehicle, pickup, dropoff, duration, fare: parseFloat(fare) || 0,
              status, bookingDate, serialNo: serialNo++
            });
          }
          const values = Object.values(bookings);
          const isFlat = values.some(v => v && (v.pickup || v.fare || v.customerName));
          if (isFlat) {
            for (const [bookingId, booking] of Object.entries(bookings)) processBooking(bookingId, booking);
          } else {
            for (const [groupKey, group] of Object.entries(bookings)) {
              if (group && typeof group === 'object') {
                for (const [bookingId, booking] of Object.entries(group)) processBooking(bookingId, booking);
              }
            }
          }
        }
        applyBookingsFilter();
      } catch (error) { showToast('Failed to load bookings: ' + error.message, 'danger'); }
      finally {
        document.getElementById('bookings-loading').style.display = 'none';
        document.getElementById('bookings-table').style.display = 'table';
      }
    }

    function applyBookingsFilter() {
      const quickFilter = document.getElementById('bookingsQuickFilter').value;
      const startDateInput = document.getElementById('bookingsStartDate').value;
      const endDateInput = document.getElementById('bookingsEndDate').value;
      const statusFilter = document.getElementById('bookingsStatusFilter').value;
      
      let startDate = startDateInput ? new Date(startDateInput) : null;
      let endDate = endDateInput ? new Date(endDateInput) : null;
      
      if (quickFilter !== 'all') {
        const range = getDateRange(quickFilter);
        if (range) {
          startDate = range.startDate;
          endDate = range.endDate;
        }
      }
      
      const filtered = allData.bookings.filter(booking => {
        const dateMatch = (quickFilter === 'all' && !startDate && !endDate) || isDateInRange(booking.bookingDate, startDate, endDate);
        const statusMatch = statusFilter === 'all' || String(booking.status).toLowerCase().includes(statusFilter.toLowerCase());
        return dateMatch && statusMatch;
      });
      
      const table = tables['bookings-table'];
      table.clear();
      const rows = filtered.map(booking => [
        booking.serialNo,
        booking.bookingId,
        escapeHtml(safeDisplay(booking.customer)),
        escapeHtml(safeDisplay(booking.vehicle)),
        escapeHtml(safeDisplay(booking.pickup)),
        escapeHtml(safeDisplay(booking.dropoff)),
        escapeHtml(safeDisplay(booking.duration)),
        escapeHtml(safeDisplay(booking.fare)),
        escapeHtml(safeDisplay(booking.status)),
        `<button class="btn btn-sm btn-danger" onclick="deleteBooking('${escapeHtml(booking.bookingId)}')"><i class="bi bi-trash"></i> Delete</button>`
      ]);
      if (rows.length > 0) table.rows.add(rows).draw();
      
      const totalRevenue = filtered.reduce((sum, b) => sum + (b.fare || 0), 0);
      document.getElementById('bookingsTotalCount').textContent = allData.bookings.length;
      document.getElementById('bookingsFilteredCount').textContent = filtered.length;
      document.getElementById('bookingsTotalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
    }

    async function loadWallets() {
      document.getElementById('driver-wallets-container').style.display = 'none';
      document.getElementById('wallets-loading').style.display = 'block';
      const container = document.getElementById('driver-wallets-container');
      container.innerHTML = '';
      const statusFilter = (document.getElementById('walletStatusFilter')?.value || 'processing').toLowerCase();
      try {
        const snapshot = await get(ref(db, 'driverWallet'));
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No wallet entries found.</p></div>';
          return;
        }
        const allDriverWallets = snapshot.val();
        for (const [driverId, entries] of Object.entries(allDriverWallets)) {
          const matchingEntries = {};
          for (const [bookingId, entry] of Object.entries(entries)) {
            const effectiveStatus = getEffectiveStatusFromWalletEntry(entry);
            if (effectiveStatus === statusFilter) matchingEntries[bookingId] = { entry, effectiveStatus };
          }
          if (Object.keys(matchingEntries).length === 0) continue;
          
          let driverName = null, upiId = null;
          try {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            if (driverSnapshot.exists()) {
              const driver = driverSnapshot.val();
              driverName = driver.name || null;
              upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
            }
          } catch (e) {}
          
          let totalFiltered = 0, totalProcessing = 0;
          for (const [bookingId, obj] of Object.entries(matchingEntries)) {
            const amount = parseFloat(obj.entry.amount) || 0;
            totalFiltered += amount;
            if (obj.effectiveStatus === 'processing') totalProcessing += amount;
          }
          
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card';
          const sanitizedId = sanitizeId(driverId);
          driverCard.innerHTML = `
            <div class="driver-header">
              <div class="driver-info">
                <div class="driver-meta">
                  <strong>${driverName ? escapeHtml(driverName) : escapeHtml(driverId)}</strong>
                  <div class="small-muted">ID: ${escapeHtml(driverId)}</div>
                  <div class="small-muted">UPI: <span id="upi-${sanitizedId}">${upiId ? escapeHtml(upiId) : '—'}</span></div>
                </div>
              </div>
              <div class="d-flex align-items-center gap-3">
                <div class="text-end">
                  <h4 class="m-0 text-primary">₹${totalFiltered.toFixed(2)}</h4>
                  <div class="small-muted">Total (${escapeHtml(statusFilter)})</div>
                </div>
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="copy-upi-${sanitizedId}" ${!upiId ? 'disabled' : ''}><i class="bi bi-clipboard"></i> Copy UPI</button>
                    <button class="btn btn-sm btn-primary" id="qr-total-${sanitizedId}" ${(!upiId || totalProcessing <= 0) ? 'disabled' : ''}><i class="bi bi-qr-code"></i> Show QR</button>
                    <button class="btn btn-sm btn-success" id="mark-all-paid-${sanitizedId}"><i class="bi bi-cash-stack"></i> Mark All Paid</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <table class="table table-sm table-hover">
                <thead><tr><th>SL</th><th>Booking ID</th><th>Amount</th><th>Fare</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="entries-${sanitizedId}"></tbody>
              </table>
            </div>`;
          
          const tbody = driverCard.querySelector(`#entries-${sanitizedId}`);
          let entryIndex = 1;
          for (const [bookingId, obj] of Object.entries(matchingEntries)) {
            const entry = obj.entry;
            const effectiveStatus = obj.effectiveStatus;
            const amount = Number(entry.amount) || 0;
            const fare = entry.fare ?? entry.booking?.fare ?? 'N/A';
            const isPaid = entry.paidout === true || effectiveStatus === 'paid';
            const pickup = entry.booking?.pickup || entry.pickup || 'N/A';
            const dropoff = entry.booking?.dropoff || entry.dropoff || 'N/A';
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${entryIndex++}</td>
              <td style="min-width: 200px;">
                <div><strong>${escapeHtml(bookingId)}</strong></div>
                <small class="text-muted">${escapeHtml(pickup)} → ${escapeHtml(dropoff)}</small>
              </td>
              <td>₹${amount.toFixed(2)}</td>
              <td>₹${escapeHtml(String(fare))}</td>
              <td>${isPaid ? '<span class="badge-paid">Paid</span>' : effectiveStatus === 'processing' ? '<span class="badge-processing">Processing</span>' : '<span class="badge-unpaid">Unpaid</span>'}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${amount}, '${escapeHtml(bookingId)}')" ${(!upiId || isPaid) ? 'disabled' : ''}><i class="bi bi-qr-code"></i></button>
                  <button class="btn btn-sm btn-success" onclick="markPaidEntry('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')"><i class="bi bi-check"></i></button>
                </div>
              </td>`;
            tbody.appendChild(row);
          }
          container.appendChild(driverCard);
          
          setTimeout(() => {
            const copyBtn = document.getElementById(`copy-upi-${sanitizedId}`);
            if (copyBtn && upiId) {
              copyBtn.addEventListener('click', async () => {
                try {
                  await navigator.clipboard.writeText(upiId);
                  showToast('UPI ID copied to clipboard', 'success');
                } catch (error) { showToast('Failed to copy UPI ID', 'danger'); }
              });
            }
            const qrTotalBtn = document.getElementById(`qr-total-${sanitizedId}`);
            if (qrTotalBtn && upiId && totalProcessing > 0) {
              qrTotalBtn.addEventListener('click', () => showQrModal(driverId, totalProcessing, 'Total Processing Amount'));
            }
            const markAllPaidBtn = document.getElementById(`mark-all-paid-${sanitizedId}`);
            if (markAllPaidBtn) {
              markAllPaidBtn.addEventListener('click', async () => {
                if (!confirm(`Mark all ${Object.keys(matchingEntries).length} entries as paid for ${driverName || driverId}?`)) return;
                try {
                  const updates = {};
                  for (const bookingId of Object.keys(matchingEntries)) {
                    updates[`driverWallet/${driverId}/${bookingId}/paidout`] = true;
                    updates[`driverWallet/${driverId}/${bookingId}/paidAt`] = Date.now();
                    updates[`driverWallet/${driverId}/${bookingId}/status`] = 'paid';
                  }
                  await update(ref(db), updates);
                  showToast(`Marked ${Object.keys(matchingEntries).length} entries as paid`, 'success');
                  loadWallets();
                } catch (error) { showToast('Failed to mark entries as paid: ' + error.message, 'danger'); }
              });
            }
          }, 0);
        }
        if (container.innerHTML === '') {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No matching wallet entries found.</p></div>';
        }
      } catch (error) { showToast('Failed to load wallets: ' + error.message, 'danger'); }
      finally {
        document.getElementById('wallets-loading').style.display = 'none';
        document.getElementById('driver-wallets-container').style.display = 'grid';
      }
    }

    window.showQrModal = async function(driverId, amount, label) {
      try {
        const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
        if (!driverSnapshot.exists()) { showToast('Driver not found', 'danger'); return; }
        const driver = driverSnapshot.val();
        const upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
        if (!upiId) { showToast('No UPI ID found for this driver', 'danger'); return; }
        
        const upiUri = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(driver.name || 'Driver')}&am=${amount.toFixed(2)}&cu=INR&tn=${encodeURIComponent('WaveTravel Payment')}`;
        const qrContainer = document.getElementById('qrCode');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, { text: upiUri, width: 200, height: 200 });
        document.getElementById('qrInfo').innerHTML = `
          <strong>${escapeHtml(label)}</strong><br>
          Amount: ₹${amount.toFixed(2)}<br>
          UPI: ${escapeHtml(upiId)}`;
        document.getElementById('copyUpiUriBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(upiUri);
            showToast('UPI URI copied to clipboard', 'success');
          } catch (error) { showToast('Failed to copy UPI URI', 'danger'); }
        };
        new bootstrap.Modal(document.getElementById('qrModal')).show();
      } catch (error) { showToast('Failed to generate QR: ' + error.message, 'danger'); }
    };

    window.markPaidEntry = async function(driverId, bookingId) {
      if (!confirm(`Mark this entry as paid?`)) return;
      try {
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), {
          paidout: true, paidAt: Date.now(), status: 'paid'
        });
        showToast('Entry marked as paid', 'success');
        loadWallets();
      } catch (error) { showToast('Failed to mark as paid: ' + error.message, 'danger'); }
    };

    async function loadPendingWithdrawals() {
      document.getElementById('withdrawals-container').style.display = 'none';
      document.getElementById('withdrawals-loading').style.display = 'block';
      const container = document.getElementById('withdrawals-container');
      container.innerHTML = '';
      try {
        const snapshot = await get(ref(db, 'driverWallet'));
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No pending withdrawals found.</p></div>';
          return;
        }
        const allDriverWallets = snapshot.val();
        const pendingWithdrawals = [];
        for (const [driverId, entries] of Object.entries(allDriverWallets)) {
          for (const [bookingId, entry] of Object.entries(entries)) {
            const effectiveStatus = getEffectiveStatusFromWalletEntry(entry);
            if (effectiveStatus === 'processing') {
              let driverName = null, upiId = null;
              try {
                const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
                if (driverSnapshot.exists()) {
                  const driver = driverSnapshot.val();
                  driverName = driver.name || null;
                  upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
                }
              } catch (e) {}
              pendingWithdrawals.push({ driverId, bookingId, entry, driverName, upiId });
            }
          }
        }
        if (pendingWithdrawals.length === 0) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No pending withdrawals found.</p></div>';
          return;
        }
        pendingWithdrawals.forEach((withdrawal, index) => {
          const { driverId, bookingId, entry, driverName, upiId } = withdrawal;
          const amount = Number(entry.amount) || 0;
          const fare = entry.fare ?? entry.booking?.fare ?? 'N/A';
          const pickup = entry.booking?.pickup || entry.pickup || 'N/A';
          const dropoff = entry.booking?.dropoff || entry.dropoff || 'N/A';
          const sanitizedDriverId = sanitizeId(driverId);
          const sanitizedBookingId = sanitizeId(bookingId);
          
          const card = document.createElement('div');
          card.className = 'driver-card mb-3';
          card.innerHTML = `
            <div class="driver-header">
              <div>
                <strong>${driverName ? escapeHtml(driverName) : escapeHtml(driverId)}</strong>
                <div class="small-muted">Driver ID: ${escapeHtml(driverId)}</div>
                <div class="small-muted">Booking ID: ${escapeHtml(bookingId)}</div>
                <div class="small-muted">Route: ${escapeHtml(pickup)} → ${escapeHtml(dropoff)}</div>
                <div class="small-muted">UPI: ${upiId ? escapeHtml(upiId) : '—'}</div>
              </div>
              <div class="text-end">
                <h4 class="m-0 text-warning">₹${amount.toFixed(2)}</h4>
                <div class="small-muted">Fare: ₹${escapeHtml(String(fare))}</div>
                <div class="mt-2 d-flex gap-2">
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${amount}, '${escapeHtml(bookingId)}')" ${!upiId ? 'disabled' : ''}><i class="bi bi-qr-code"></i> Show QR</button>
                  <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')"><i class="bi bi-check"></i> Approve</button>
                  <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')"><i class="bi bi-x"></i> Reject</button>
                </div>
              </div>
            </div>`;
          container.appendChild(card);
        });
      } catch (error) { showToast('Failed to load pending withdrawals: ' + error.message, 'danger'); }
      finally {
        document.getElementById('withdrawals-loading').style.display = 'none';
        document.getElementById('withdrawals-container').style.display = 'block';
      }
    }

    window.approveWithdrawal = async function(driverId, bookingId) {
      if (!confirm('Approve this withdrawal and mark as paid?')) return;
      try {
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), {
          paidout: true, paidAt: Date.now(), status: 'paid'
        });
        showToast('Withdrawal approved and marked as paid', 'success');
        loadPendingWithdrawals();
      } catch (error) { showToast('Failed to approve withdrawal: ' + error.message, 'danger'); }
    };

    window.rejectWithdrawal = async function(driverId, bookingId) {
      if (!confirm('Reject this withdrawal request?')) return;
      try {
        const updates = {};
        updates[`driverWallet/${driverId}/${bookingId}/withdrawalRequested`] = false;
        updates[`driverWallet/${driverId}/${bookingId}/status`] = 'unpaid';
        updates[`driverWallet/${driverId}/${bookingId}/rejectedAt`] = Date.now();
        await update(ref(db), updates);
        showToast('Withdrawal request rejected', 'success');
        loadPendingWithdrawals();
      } catch (error) { showToast('Failed to reject withdrawal: ' + error.message, 'danger'); }
    };

    document.getElementById('exportWithdrawalsBtn')?.addEventListener('click', async () => {
      try {
        const snapshot = await get(ref(db, 'driverWallet'));
        if (!snapshot.exists()) { showToast('No data to export', 'warning'); return; }
        const allDriverWallets = snapshot.val();
        const rows = [['Driver ID', 'Driver Name', 'UPI ID', 'Booking ID', 'Amount', 'Fare', 'Pickup', 'Dropoff', 'Status']];
        for (const [driverId, entries] of Object.entries(allDriverWallets)) {
          for (const [bookingId, entry] of Object.entries(entries)) {
            const effectiveStatus = getEffectiveStatusFromWalletEntry(entry);
            if (effectiveStatus === 'processing') {
              let driverName = '', upiId = '';
              try {
                const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
                if (driverSnapshot.exists()) {
                  const driver = driverSnapshot.val();
                  driverName = driver.name || '';
                  upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || '');
                }
              } catch (e) {}
              const amount = Number(entry.amount) || 0;
              const fare = entry.fare ?? entry.booking?.fare ?? 'N/A';
              const pickup = entry.booking?.pickup || entry.pickup || 'N/A';
              const dropoff = entry.booking?.dropoff || entry.dropoff || 'N/A';
              rows.push([driverId, driverName, upiId, bookingId, amount.toFixed(2), String(fare), pickup, dropoff, effectiveStatus]);
            }
          }
        }
        const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pending-withdrawals-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('CSV exported successfully', 'success');
      } catch (error) { showToast('Failed to export CSV: ' + error.message, 'danger'); }
    });

    async function loadProfile() {
      document.getElementById('profile-table').style.display = 'none';
      document.getElementById('profile-loading').style.display = 'block';
      const table = initTable('profile-table', []);
      try {
        if (!currentUser) { showToast('No user logged in', 'danger'); return; }
        table.clear();
        const rows = [
          ['Email', escapeHtml(currentUser.email || '')],
          ['UID', escapeHtml(currentUser.uid || '')],
          ['Email Verified', currentUser.emailVerified ? 'Yes' : 'No'],
          ['Last Sign In', currentUser.metadata?.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleString() : 'N/A']
        ];
        table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load profile: ' + error.message, 'danger'); }
      finally {
        document.getElementById('profile-loading').style.display = 'none';
        document.getElementById('profile-table').style.display = 'table';
      }
    }

    window.deleteUser = (uid) => safeDelete(`users/${uid}`, 'Delete this user?', 'User deleted successfully', loadUsers);
    window.deleteDriver = (driverId) => safeDelete(`driverdetails/${driverId}`, 'Delete this driver?', 'Driver deleted successfully', loadDrivers);
    window.deleteSearch = (searchId) => safeDelete(`searches/${searchId}`, 'Delete this search?', 'Search deleted successfully', loadSearches);
    window.deleteRideRequest = (requestId) => safeDelete(`riderequest/${requestId}`, 'Delete this ride request?', 'Ride request deleted successfully', loadRideRequests);
    window.deletePendingCar = (driverId, carId) => safeDelete(`pendingcars/${driverId}/${carId}`, 'Delete this pending car?', 'Pending car deleted successfully', loadPendingCars);
    window.deleteApprovedCar = (driverId, carId) => safeDelete(`approvedcars/${driverId}/${carId}`, 'Delete this approved car?', 'Approved car deleted successfully', loadApprovedCars);
    window.deleteSlot = (driverId, slotId) => safeDelete(`availableslots/${driverId}/${slotId}`, 'Delete this slot?', 'Slot deleted successfully', loadSlots);
    window.deleteBooking = (bookingId) => safeDelete(`bookings/${bookingId}`, 'Delete this booking?', 'Booking deleted successfully', loadBookings);

    window.approveCar = async function(driverId, carId) {
      if (!confirm('Approve this car?')) return;
      try {
        const snapshot = await get(ref(db, `pendingcars/${driverId}/${carId}`));
        if (!snapshot.exists()) { showToast('Car not found', 'danger'); return; }
        const car = snapshot.val();
        await set(ref(db, `approvedcars/${driverId}/${carId}`), car);
        await set(ref(db, `driverdetails/${driverId}/vehicles/${carId}`), car);
        await remove(ref(db, `pendingcars/${driverId}/${carId}`));
        showToast('Car approved successfully', 'success');
        loadPendingCars();
      } catch (error) { showToast('Failed to approve car: ' + error.message, 'danger'); }
    };

    window.approveRideRequest = async function(requestId) {
      if (!confirm('Approve this ride request?')) return;
      try {
        await update(ref(db, `riderequest/${requestId}`), { status: 'approved', approvedAt: Date.now() });
        showToast('Ride request approved', 'success');
        loadRideRequests();
      } catch (error) { showToast('Failed to approve ride request: ' + error.message, 'danger'); }
    };

    window.rejectRideRequest = async function(requestId) {
      if (!confirm('Reject this ride request?')) return;
      try {
        await update(ref(db, `riderequest/${requestId}`), { status: 'rejected', rejectedAt: Date.now() });
        showToast('Ride request rejected', 'success');
        loadRideRequests();
      } catch (error) { showToast('Failed to reject ride request: ' + error.message, 'danger'); }
    };

    window.openTab = function(tabName) {
      document.querySelectorAll('.tab-pane').forEach(el => el.hidden = true);
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      document.querySelector(`a[onclick="openTab('${tabName}')"]`)?.classList.add('active');
      const tabElement = document.getElementById(`${tabName}-tab`);
      if (tabElement) tabElement.hidden = false;
      
      const loaders = {
        'users': loadUsers, 'drivers': loadDrivers, 'searches': loadSearches,
        'ride-requests': loadRideRequests, 'pending-cars': loadPendingCars,
        'approved-cars': loadApprovedCars, 'slots': loadSlots, 'bookings': loadBookings,
        'driver-wallets': loadWallets, 'pending-withdrawals': loadPendingWithdrawals, 'profile': loadProfile
      };
      if (loaders[tabName]) loaders[tabName]();
    };

    document.getElementById('refreshAllBtn')?.addEventListener('click', () => {
      const activeTab = document.querySelector('.nav-link.active')?.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
      if (activeTab) openTab(activeTab);
    });

    // Filter event listeners
    document.getElementById('usersFilterBtn')?.addEventListener('click', applyUsersFilter);
    document.getElementById('usersResetBtn')?.addEventListener('click', () => {
      document.getElementById('usersStartDate').value = '';
      document.getElementById('usersEndDate').value = '';
      document.getElementById('usersQuickFilter').value = 'month';
      applyUsersFilter();
    });
    
    document.getElementById('driversFilterBtn')?.addEventListener('click', applyDriversFilter);
    document.getElementById('driversResetBtn')?.addEventListener('click', () => {
      document.getElementById('driversVehicleFilter').value = 'all';
      applyDriversFilter();
    });
    
    document.getElementById('searchesFilterBtn')?.addEventListener('click', applySearchesFilter);
    document.getElementById('searchesResetBtn')?.addEventListener('click', () => {
      document.getElementById('searchesStartDate').value = '';
      document.getElementById('searchesEndDate').value = '';
      document.getElementById('searchesQuickFilter').value = 'month';
      document.getElementById('searchesFallbackFilter').value = 'all';
      applySearchesFilter();
    });
    
    document.getElementById('requestFilterBtn')?.addEventListener('click', applyRequestsFilter);
    document.getElementById('requestsResetBtn')?.addEventListener('click', () => {
      document.getElementById('requestsStartDate').value = '';
      document.getElementById('requestsEndDate').value = '';
      document.getElementById('requestsQuickFilter').value = 'month';
      document.getElementById('requestStatusFilter').value = 'pending';
      applyRequestsFilter();
    });
    
    document.getElementById('pendingFilterBtn')?.addEventListener('click', applyPendingCarsFilter);
    document.getElementById('pendingResetBtn')?.addEventListener('click', () => {
      document.getElementById('pendingStartDate').value = '';
      document.getElementById('pendingEndDate').value = '';
      document.getElementById('pendingQuickFilter').value = 'month';
      applyPendingCarsFilter();
    });
    
    document.getElementById('approvedFilterBtn')?.addEventListener('click', applyApprovedCarsFilter);
    document.getElementById('approvedResetBtn')?.addEventListener('click', () => {
      document.getElementById('approvedSeatsFilter').value = 'all';
      applyApprovedCarsFilter();
    });
    
    document.getElementById('slotsFilterBtn')?.addEventListener('click', applySlotsFilter);
    document.getElementById('slotsResetBtn')?.addEventListener('click', () => {
      document.getElementById('slotsStartDate').value = '';
      document.getElementById('slotsEndDate').value = '';
      document.getElementById('slotsQuickFilter').value = 'month';
      applySlotsFilter();
    });
    
    document.getElementById('bookingsFilterBtn')?.addEventListener('click', applyBookingsFilter);
    document.getElementById('bookingsResetBtn')?.addEventListener('click', () => {
      document.getElementById('bookingsStartDate').value = '';
      document.getElementById('bookingsEndDate').value = '';
      document.getElementById('bookingsQuickFilter').value = 'month';
      document.getElementById('bookingsStatusFilter').value = 'all';
      applyBookingsFilter();
    });
    
    document.getElementById('walletFilterApplyBtn')?.addEventListener('click', loadWallets);

    onAuthStateChanged(auth, user => {
      if (!user) { window.location.href = 'adminlogin.html'; return; }
      currentUser = user;
      openTab('users');
    });

    document.getElementById('globalSearch')?.addEventListener('keyup', function(e) {
      if (e.key === '/') { this.focus(); e.preventDefault(); }
    });
  </script>
</body>
</html>
