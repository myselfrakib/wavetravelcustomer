<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WaveTravel — Admin Dashboard</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --primary: #2563eb; --success: #059669; --danger: #dc2626; --warning: #d97706; --info: #0891b2;
      --light: #f8fafc; --dark: #1e293b; --muted: #64748b; --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Inter', system-ui, -apple-system, Arial, sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: var(--dark); line-height: 1.6; }
    
    .topbar { position: sticky; top: 0; z-index: 1030; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); box-shadow: var(--shadow); }
    .brand { display: flex; gap: 12px; align-items: center; color: var(--dark); font-weight: 700; text-decoration: none; }
    .brand img { height: 40px; width: 40px; object-fit: cover; border-radius: 10px; box-shadow: var(--shadow); }
    .brand-text { font-size: 1.5rem; color: var(--primary); }
    .brand-subtitle { font-size: 0.875rem; color: var(--muted); font-weight: 400; }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--dark); transition: all 0.2s; }
    .btn-ghost:hover { background: var(--light); border-color: var(--primary); color: var(--primary); }
    
    .container-main { display: grid; grid-template-columns: 280px 1fr; gap: 24px; padding: 24px; min-height: calc(100vh - 80px); }
    .sidebar { background: white; padding: 20px; border-radius: 16px; height: fit-content; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
    .sidebar .nav-link { color: var(--muted); font-weight: 500; border-radius: 10px; padding: 12px 16px; margin-bottom: 4px; text-decoration: none; display: flex; align-items: center; gap: 10px; transition: all 0.2s; }
    .sidebar .nav-link:hover { background: var(--light); color: var(--primary); }
    .sidebar .nav-link.active { background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); color: white; box-shadow: var(--shadow); }
    
    .panel { background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
    .panel h2 { font-size: 1.5rem; margin: 0 0 20px 0; color: var(--dark); font-weight: 600; }
    
    table.dataTable { background: white !important; color: var(--dark) !important; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    table.dataTable thead th { background: var(--light) !important; color: var(--dark) !important; font-weight: 600; border-bottom: 2px solid var(--border) !important; }
    table.dataTable tbody tr:hover { background: var(--light) !important; }
    
    .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); border: none; box-shadow: var(--shadow); }
    .btn-success { background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); border: none; box-shadow: var(--shadow); }
    .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); border: none; box-shadow: var(--shadow); }
    .btn-info { background: linear-gradient(135deg, var(--info) 0%, #06b6d4 100%); border: none; box-shadow: var(--shadow); }
    .btn-warning { background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%); border: none; box-shadow: var(--shadow); }
    
    .driver-wallets-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
    .driver-card { background: white; border-radius: 16px; padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-lg); transition: all 0.3s ease; }
    .driver-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    .driver-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .small-muted { color: var(--muted); font-size: 0.875rem; }
    
    .badge-paid { background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
    .badge-unpaid { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
    .badge-processing { background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%); color: white; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; }
    .badge-verified { background: linear-gradient(135deg, var(--success) 0%, #10b981 100%); color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 0.7rem; }
    .badge-unverified { background: linear-gradient(135deg, var(--danger) 0%, #ef4444 100%); color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 0.7rem; }
    .badge-pending { background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%); color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 0.7rem; }
    
    .image-gallery { display: flex; gap: 8px; flex-wrap: wrap; }
    .image-thumbnail { width: 80px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; }
    .image-thumbnail:hover { border-color: var(--primary); transform: scale(1.05); }
    
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 37%, #f1f5f9 63%); background-size: 400% 100%; animation: skeleton 1.5s ease-in-out infinite; border-radius: 8px; }
    @keyframes skeleton { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
    
    .form-control { border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.875rem; }
    .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .form-select { border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.875rem; }
    
    .modal-content { border: none; border-radius: 16px; box-shadow: var(--shadow-lg); }
    .modal-header { background: var(--light); border-bottom: 1px solid var(--border); border-radius: 16px 16px 0 0; }
    .toast { border: none; border-radius: 12px; box-shadow: var(--shadow-lg); }
    
    .payment-verification-status { margin: 10px 0; padding: 10px; border-radius: 8px; font-size: 0.875rem; }
    .payment-verification-status.verified { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
    .payment-verification-status.unverified { background: #fee2e2; border: 1px solid #dc2626; color: #991b1b; }
    .payment-verification-status.loading { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
    
    @media (max-width: 1024px) { .container-main { grid-template-columns: 1fr; padding: 16px; } .sidebar { order: 2; height: auto; } .driver-wallets-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <nav class="topbar py-3 px-4 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-4">
      <div class="brand">
        <img src="https://wavetravel-3c4c4.web.app/logo192.png" alt="WaveTravel Logo" onerror="this.style.display='none'">
        <div>
          <div class="brand-text">WaveTravel</div>
          <div class="brand-subtitle">Admin Dashboard</div>
        </div>
      </div>
      <div class="d-none d-md-flex">
        <div class="input-group">
          <span class="input-group-text bg-transparent border-0 text-muted"><i class="bi bi-search"></i></span>
          <input id="globalSearch" class="form-control bg-transparent border-0" placeholder="Quick search (press /)" />
        </div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button id="refreshAllBtn" class="btn btn-sm btn-ghost" title="Refresh current tab"><i class="bi bi-arrow-clockwise"></i></button>
      <button class="btn btn-sm btn-ghost" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </nav>

  <div class="container-main">
    <aside class="sidebar">
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" onclick="openTab('users')"><i class="bi bi-people"></i> Users</a>
        <a class="nav-link" href="#" onclick="openTab('drivers')"><i class="bi bi-person-badge"></i> Drivers</a>
        <a class="nav-link" href="#" onclick="openTab('searches')"><i class="bi bi-search"></i> Searches</a>
        <a class="nav-link" href="#" onclick="openTab('ride-requests')"><i class="bi bi-car-front"></i> Ride Requests</a>
        <a class="nav-link" href="#" onclick="openTab('pending-cars')"><i class="bi bi-hourglass-split"></i> Pending Cars</a>
        <a class="nav-link" href="#" onclick="openTab('approved-cars')"><i class="bi bi-check2-square"></i> Approved Cars</a>
        <a class="nav-link" href="#" onclick="openTab('slots')"><i class="bi bi-calendar2-day"></i> Slots</a>
        <a class="nav-link" href="#" onclick="openTab('bookings')"><i class="bi bi-journal-check"></i> Bookings</a>
        <a class="nav-link" href="#" onclick="openTab('driver-wallets')"><i class="bi bi-wallet2"></i> Driver Wallets</a>
        <a class="nav-link" href="#" onclick="openTab('pending-withdrawals')"><i class="bi bi-credit-card"></i> Pending Withdrawals</a>
        <a class="nav-link" href="#" onclick="openTab('profile')"><i class="bi bi-person-circle"></i> Profile</a>
        <div style="height: 20px;"></div>
        <button class="btn btn-danger w-100" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i> Sign out</button>
      </nav>
    </aside>

    <main>
      <section id="users-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-people me-2 text-primary"></i>Users</h2>
        <div id="users-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="users-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>User ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Created On</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="drivers-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-person-badge me-2 text-primary"></i>Drivers</h2>
        <div id="drivers-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="drivers-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver ID</th><th>Name</th><th>Phone</th><th>Vehicle Count</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="searches-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-search me-2 text-info"></i>User Searches</h2>
        <div id="searches-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="searches-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Customer ID</th><th>Pickup</th><th>Dropoff</th><th>Date</th><th>Seats</th><th>Result Count</th><th>Timestamp</th><th>Fallback Used</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="ride-requests-tab" class="tab-pane panel" hidden>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-car-front me-2 text-warning"></i>Ride Requests</h2>
          <div class="d-flex gap-2">
            <select id="requestStatusFilter" class="form-select form-select-sm">
              <option value="all">All Status</option>
              <option value="pending" selected>Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
            <button id="requestFilterBtn" class="btn btn-sm btn-primary">Apply</button>
          </div>
        </div>
        <div id="requests-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="requests-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Request ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Pickup</th><th>Dropoff</th><th>Date</th><th>Trip Type</th><th>Status</th><th>Notes</th><th>Requested At</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="pending-cars-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-hourglass-split me-2 text-warning"></i>Pending Cars</h2>
        <div id="pending-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="pending-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver ID</th><th>Car ID</th><th>Brand</th><th>Reg No</th><th>Driver Name</th><th>Driver Number</th><th>Owner Name</th><th>Seats</th><th>Images</th><th>License</th><th>Submitted At</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="approved-cars-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-check2-square me-2 text-success"></i>Approved Cars</h2>
        <div id="approved-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="approved-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver Name</th><th>Phone</th><th>Car ID</th><th>Brand</th><th>Reg No</th><th>Owner</th><th>Seats</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="slots-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-calendar2-day me-2 text-info"></i>Slots</h2>
        <div id="slots-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="slots-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Driver Name</th><th>Phone</th><th>Slot ID</th><th>Pickup</th><th>Dropoff</th><th>Date</th><th>Time</th><th>Seats</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="bookings-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-journal-check me-2 text-primary"></i>Bookings</h2>
        <div id="bookings-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="bookings-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>SL</th><th>Booking ID</th><th>Customer</th><th>Vehicle</th><th>Pickup</th><th>Dropoff</th><th>Duration</th><th>Fare</th><th>Status</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="driver-wallets-tab" class="tab-pane panel" hidden>
        <div class="d-flex align-items-center justify-content-between mb-4">
          <h2><i class="bi bi-wallet2 me-2 text-success"></i>Driver Wallets</h2>
          <div class="d-flex align-items-center gap-3">
            <select id="walletStatusFilter" class="form-select form-select-sm" style="width: auto;">
              <option value="processing" selected>Processing</option>
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
            <button id="walletFilterApplyBtn" class="btn btn-sm btn-primary">Apply</button>
          </div>
        </div>
        <div id="wallets-loading" class="skeleton" style="height:80px;"></div>
        <div id="driver-wallets-container" class="driver-wallets-container" style="display:none;"></div>
      </section>

      <section id="pending-withdrawals-tab" class="tab-pane panel" hidden>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-credit-card me-2 text-warning"></i>Pending Withdrawals</h2>
          <button id="exportWithdrawalsBtn" class="btn btn-primary"><i class="bi bi-download me-2"></i>Export CSV</button>
        </div>
        <div id="withdrawals-loading" class="skeleton" style="height:60px;"></div>
        <div id="withdrawals-container" style="display:none;"></div>
      </section>

      <section id="profile-tab" class="tab-pane panel" hidden>
        <h2><i class="bi bi-person-circle me-2 text-info"></i>My Profile</h2>
        <div id="profile-loading" class="skeleton" style="height:60px;"></div>
        <div class="table-responsive mt-3">
          <table id="profile-table" class="display responsive nowrap table table-hover" style="width:100%;display:none">
            <thead><tr><th>Field</th><th>Value</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="imageViewerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageViewerTitle">Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img id="imageViewerImg" src="" alt="Image" style="max-width:100%;height:auto;border-radius:8px">
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <h5 class="text-primary mb-3">UPI Payment QR</h5>
        <div id="paymentVerificationStatus" class="payment-verification-status" style="display: none;"></div>
        <div id="qrCode" class="my-3 d-flex justify-content-center"></div>
        <div id="qrInfo" class="mb-3 small-muted"></div>
        <div class="d-flex gap-2 justify-content-center">
          <button id="copyUpiUriBtn" class="btn btn-sm btn-outline-primary">Copy URI</button>
          <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast-container" style="position:fixed;right:20px;bottom:20px;z-index:1200;"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, update, remove, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const tables = {};
    let currentUser = null;

    // Backend API URL - Update this to match your backend
    const BACKEND_URL = 'https://wavetravel-razorpay-backend.onrender.com';

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function sanitizeId(id) { return String(id).replace(/[^a-z0-9\-_]/gi, '-'); }

    function showToast(message, type = 'info', timeout = 3500) {
      const toastId = 'toast-' + Date.now();
      const bgClass = type === 'success' ? 'text-bg-success' : type === 'danger' ? 'text-bg-danger' : type === 'warning' ? 'text-bg-warning' : 'text-bg-info';
      const toastHtml = `<div id="${toastId}" class="toast ${bgClass} border-0 mb-2" role="alert"><div class="d-flex"><div class="toast-body">${escapeHtml(message)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
      document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHtml);
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: timeout });
      toast.show();
      toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    // Payment verification function
    async function verifyPayment(paymentId) {
      try {
        console.log('Verifying payment:', paymentId);
        
        const response = await fetch(`${BACKEND_URL}/payment/${paymentId}`);
        const data = await response.json();
        
        if (data.success && data.payment) {
          const payment = data.payment;
          console.log('Payment verification result:', payment);
          
          return {
            success: true,
            verified: payment.status === 'captured' || payment.status === 'authorized',
            payment: payment,
            status: payment.status,
            amount: payment.amount / 100, // Convert from paise to rupees
            method: payment.method,
            created_at: payment.created_at
          };
        } else {
          return {
            success: false,
            verified: false,
            error: data.error || 'Payment not found'
          };
        }
      } catch (error) {
        console.error('Payment verification failed:', error);
        return {
          success: false,
          verified: false,
          error: 'Network error or payment service unavailable'
        };
      }
    }

    function initTable(id, nonSortableCols = []) {
      if (tables[id]) { tables[id].clear(); tables[id].destroy(); }
      tables[id] = $(`#${id}`).DataTable({
        responsive: true, dom: 'Bfrtip', buttons: ['copy', 'csv', 'excel', 'print'],
        pageLength: 25, lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        columnDefs: nonSortableCols.map(col => ({ orderable: false, targets: col })),
        language: { emptyTable: 'No records found.', loadingRecords: 'Loading...', processing: 'Processing...' },
        order: [[0, 'asc']]
      });
      return tables[id];
    }

    window.showImage = function(imageUrl, title = 'Image') {
      document.getElementById('imageViewerTitle').textContent = title;
      document.getElementById('imageViewerImg').src = imageUrl;
      new bootstrap.Modal(document.getElementById('imageViewerModal')).show();
    };

    function createImageGallery(images, type = 'car') {
      if (!images || !Array.isArray(images) || images.length === 0) return '<span class="small-muted">No images</span>';
      let html = '<div class="image-gallery">';
      images.forEach((imageUrl, index) => {
        const title = type === 'license' ? 'Driver License' : `Car Image ${index + 1}`;
        html += `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title)}" class="image-thumbnail" onclick="showImage('${escapeHtml(imageUrl)}', '${escapeHtml(title)}')">`;
      });
      return html + '</div>';
    }

    function pickField(obj, candidates) {
      for (const key of candidates) {
        if (key.includes('.')) {
          const parts = key.split('.');
          let current = obj;
          let valid = true;
          for (const part of parts) {
            if (current && typeof current === 'object' && part in current) { current = current[part]; } else { valid = false; break; }
          }
          if (valid && current !== undefined && current !== null && current !== '') return current;
        } else {
          if (obj && typeof obj === 'object' && key in obj && obj[key] !== undefined && obj[key] !== null && obj[key] !== '') return obj[key];
        }
      }
      return null;
    }

    function safeDisplay(value) {
      if (value === null || value === undefined) return '';
      if (typeof value === 'object') {
        try {
          const str = JSON.stringify(value);
          return str.length > 100 ? str.substring(0, 100) + '...' : str;
        } catch (e) { return String(value); }
      }
      return String(value);
    }

    function getEffectiveStatusFromWalletEntry(entry) {
      if (!entry) return 'unpaid';
      if (entry.status) {
        const status = String(entry.status).toLowerCase();
        if (['paid', 'approved', 'completed'].includes(status)) return 'paid';
        if (['processing', 'pending', 'requested'].includes(status)) return 'processing';
      }
      if (entry.paidout === true) return 'paid';
      const withdrawalFlags = ['withdrawalRequested', 'withdrawal_requested', 'requested', 'pendingWithdrawal'];
      for (const flag of withdrawalFlags) {
        if (entry[flag] === true) return 'processing';
      }
      const timestampFields = ['requestedAt', 'requestedOn', 'requestTimestamp'];
      for (const field of timestampFields) { if (entry[field]) return 'processing'; }
      return 'unpaid';
    }

    window.logout = () => signOut(auth).then(() => window.location.href = 'adminlogin.html').catch(e => showToast('Logout failed: ' + e.message, 'danger'));

    async function safeDelete(path, confirmMsg, successMsg, reloadFn) {
      if (!confirm(confirmMsg)) return;
      try {
        await remove(ref(db, path));
        showToast(successMsg, 'success');
        if (typeof reloadFn === 'function') reloadFn();
      } catch (error) { showToast('Delete failed: ' + error.message, 'danger'); }
    }

    async function loadUsers() {
      document.getElementById('users-table').style.display = 'none';
      document.getElementById('users-loading').style.display = 'block';
      const table = initTable('users-table', [7]);
      try {
        const snapshot = await get(ref(db, 'users'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const users = snapshot.val();
          for (const [uid, user] of Object.entries(users)) {
            rows.push([
              serialNo++, uid, escapeHtml(user.name || ''), escapeHtml(user.email || ''), 
              escapeHtml(user.phone || ''), escapeHtml(user.address || ''), escapeHtml(user.createdOn || ''),
              `<button class="btn btn-sm btn-danger" onclick="deleteUser('${escapeHtml(uid)}')"><i class="bi bi-trash"></i> Delete</button>`
            ]);
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load users: ' + error.message, 'danger'); }
      finally {
        document.getElementById('users-loading').style.display = 'none';
        document.getElementById('users-table').style.display = 'table';
      }
    }

    async function loadDrivers() {
      document.getElementById('drivers-table').style.display = 'none';
      document.getElementById('drivers-loading').style.display = 'block';
      const table = initTable('drivers-table', [5]);
      try {
        const snapshot = await get(ref(db, 'driverdetails'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const drivers = snapshot.val();
          for (const [driverId, driver] of Object.entries(drivers)) {
            const vehicleCount = driver.vehicles ? Object.keys(driver.vehicles).length : 0;
            rows.push([
              serialNo++, driverId, escapeHtml(driver.name || ''), escapeHtml(driver.phone || ''), vehicleCount,
              `<button class="btn btn-sm btn-danger" onclick="deleteDriver('${escapeHtml(driverId)}')"><i class="bi bi-trash"></i> Delete</button>`
            ]);
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load drivers: ' + error.message, 'danger'); }
      finally {
        document.getElementById('drivers-loading').style.display = 'none';
        document.getElementById('drivers-table').style.display = 'table';
      }
    }

    async function loadSearches() {
      document.getElementById('searches-table').style.display = 'none';
      document.getElementById('searches-loading').style.display = 'block';
      const table = initTable('searches-table', [9]);
      try {
        const snapshot = await get(ref(db, 'searches'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const searches = snapshot.val();
          for (const [searchId, search] of Object.entries(searches)) {
            const timestamp = search.timestamp ? new Date(search.timestamp).toLocaleString() : '';
            rows.push([
              serialNo++,
              escapeHtml(search.customerId || ''),
              escapeHtml(search.pickup || ''),
              escapeHtml(search.dropoff || ''),
              escapeHtml(search.date || ''),
              escapeHtml(search.seatsRequested || ''),
              escapeHtml(search.resultCount || 0),
              escapeHtml(timestamp),
              search.fallbackUsed ? 'Yes' : 'No',
              `<button class="btn btn-sm btn-danger" onclick="deleteSearch('${escapeHtml(searchId)}')"><i class="bi bi-trash"></i> Delete</button>`
            ]);
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load searches: ' + error.message, 'danger'); }
      finally {
        document.getElementById('searches-loading').style.display = 'none';
        document.getElementById('searches-table').style.display = 'table';
      }
    }

    async function loadRideRequests() {
      document.getElementById('requests-table').style.display = 'none';
      document.getElementById('requests-loading').style.display = 'block';
      const table = initTable('requests-table', [12]);
      const statusFilter = document.getElementById('requestStatusFilter')?.value || 'pending';
      try {
        const snapshot = await get(ref(db, 'riderequest'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const requests = snapshot.val();
          for (const [requestId, request] of Object.entries(requests)) {
            const status = request.status || 'pending';
            if (statusFilter !== 'all' && status !== statusFilter) continue;
            
            const requestedAt = request.requestedAt ? new Date(request.requestedAt).toLocaleString() : '';
            const statusBadge = status === 'approved' ? 'badge-paid' : status === 'rejected' ? 'badge-unpaid' : 'badge-processing';
            
            rows.push([
              serialNo++,
              requestId,
              escapeHtml(request.customerName || ''),
              escapeHtml(request.customerEmail || ''),
              escapeHtml(request.customerPhone || ''),
              escapeHtml(request.pickup || ''),
              escapeHtml(request.dropoff || ''),
              escapeHtml(request.date || ''),
              escapeHtml(request.tripType || ''),
              `<span class="${statusBadge}">${escapeHtml(status)}</span>`,
              escapeHtml((request.notes || '').substring(0, 100) + (request.notes?.length > 100 ? '...' : '')),
              escapeHtml(requestedAt),
              `<div class="btn-group">
                <button class="btn btn-sm btn-success" onclick="approveRideRequest('${escapeHtml(requestId)}')" ${status !== 'pending' ? 'disabled' : ''}>
                  <i class="bi bi-check"></i> Approve
                </button>
                <button class="btn btn-sm btn-warning" onclick="rejectRideRequest('${escapeHtml(requestId)}')" ${status !== 'pending' ? 'disabled' : ''}>
                  <i class="bi bi-x"></i> Reject
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteRideRequest('${escapeHtml(requestId)}')">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>`
            ]);
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load ride requests: ' + error.message, 'danger'); }
      finally {
        document.getElementById('requests-loading').style.display = 'none';
        document.getElementById('requests-table').style.display = 'table';
      }
    }

    async function loadPendingCars() {
      document.getElementById('pending-table').style.display = 'none';
      document.getElementById('pending-loading').style.display = 'block';
      const table = initTable('pending-table', [9, 10, 12]);
      try {
        const snapshot = await get(ref(db, 'pendingcars'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const pendingCars = snapshot.val();
          for (const [driverId, cars] of Object.entries(pendingCars)) {
            for (const [carId, car] of Object.entries(cars)) {
              const imageGallery = createImageGallery(car.carImages || [], 'car');
              const licenseGallery = car.driverLicense ? createImageGallery([car.driverLicense], 'license') : '<span class="small-muted">No license</span>';
              rows.push([
                serialNo++, driverId, carId, escapeHtml(car.carBrand || ''), escapeHtml(car.carReg || ''),
                escapeHtml(car.driverName || ''), escapeHtml(car.driverNumber || ''), escapeHtml(car.ownerName || ''),
                escapeHtml(car.seats || ''), imageGallery, licenseGallery, escapeHtml(car.submittedAt || ''),
                `<div class="btn-group">
                  <button class="btn btn-sm btn-success" onclick="approveCar('${escapeHtml(driverId)}', '${escapeHtml(carId)}')"><i class="bi bi-check"></i> Approve</button>
                  <button class="btn btn-sm btn-danger" onclick="deletePendingCar('${escapeHtml(driverId)}', '${escapeHtml(carId)}')"><i class="bi bi-trash"></i> Delete</button>
                </div>`
              ]);
            }
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load pending cars: ' + error.message, 'danger'); }
      finally {
        document.getElementById('pending-loading').style.display = 'none';
        document.getElementById('pending-table').style.display = 'table';
      }
    }

    async function loadApprovedCars() {
      document.getElementById('approved-table').style.display = 'none';
      document.getElementById('approved-loading').style.display = 'block';
      const table = initTable('approved-table', [8]);
      try {
        const snapshot = await get(ref(db, 'approvedcars'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const approvedCars = snapshot.val();
          for (const [driverId, cars] of Object.entries(approvedCars)) {
            for (const [carId, car] of Object.entries(cars)) {
              rows.push([
                serialNo++, escapeHtml(car.driverName || ''), escapeHtml(car.driverNumber || ''), carId,
                escapeHtml(car.carBrand || ''), escapeHtml(car.carReg || ''), escapeHtml(car.ownerName || ''),
                escapeHtml(car.seats || ''),
                `<button class="btn btn-sm btn-danger" onclick="deleteApprovedCar('${escapeHtml(driverId)}', '${escapeHtml(carId)}')"><i class="bi bi-trash"></i> Delete</button>`
              ]);
            }
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load approved cars: ' + error.message, 'danger'); }
      finally {
        document.getElementById('approved-loading').style.display = 'none';
        document.getElementById('approved-table').style.display = 'table';
      }
    }

    async function loadSlots() {
      document.getElementById('slots-table').style.display = 'none';
      document.getElementById('slots-loading').style.display = 'block';
      const table = initTable('slots-table', [9]);
      try {
        const snapshot = await get(ref(db, 'availableslots'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const slots = snapshot.val();
          for (const [driverId, driverSlots] of Object.entries(slots)) {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            const driver = driverSnapshot.exists() ? driverSnapshot.val() : {};
            for (const [slotId, slot] of Object.entries(driverSlots)) {
              rows.push([
                serialNo++, escapeHtml(driver.name || ''), escapeHtml(driver.phone || ''), slotId,
                escapeHtml(slot.pickup || ''), escapeHtml(slot.dropoff || ''), escapeHtml(slot.date || ''),
                escapeHtml(slot.time || ''), escapeHtml(slot.seats || ''),
                `<button class="btn btn-sm btn-danger" onclick="deleteSlot('${escapeHtml(driverId)}', '${escapeHtml(slotId)}')"><i class="bi bi-trash"></i> Delete</button>`
              ]);
            }
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load slots: ' + error.message, 'danger'); }
      finally {
        document.getElementById('slots-loading').style.display = 'none';
        document.getElementById('slots-table').style.display = 'table';
      }
    }

    async function loadBookings() {
      document.getElementById('bookings-table').style.display = 'none';
      document.getElementById('bookings-loading').style.display = 'block';
      const table = initTable('bookings-table', [9]);
      try {
        const snapshot = await get(ref(db, 'bookings'));
        const rows = [];
        let serialNo = 1;
        if (snapshot.exists()) {
          const bookings = snapshot.val();
          function processBooking(bookingId, booking) {
            const customer = pickField(booking, ['customerName', 'userName', 'customer', 'name']) || '';
            let vehicle = pickField(booking, ['vehicle', 'car', 'vehicleInfo', 'carBrand']) || '';
            if (typeof vehicle === 'object') {
              vehicle = vehicle.brand ? `${vehicle.brand}${vehicle.reg ? ' (' + vehicle.reg + ')' : ''}` : (vehicle.reg || JSON.stringify(vehicle));
            }
            const pickup = pickField(booking, ['pickup', 'from', 'start']) || '';
            const dropoff = pickField(booking, ['dropoff', 'to', 'end']) || '';
            const duration = pickField(booking, ['duration', 'tripDuration']) || '';
            const fare = pickField(booking, ['fare', 'amount', 'price']) || '';
            const status = pickField(booking, ['status', 'paymentStatus', 'state']) || '';
            rows.push([
              serialNo++, bookingId, escapeHtml(safeDisplay(customer)), escapeHtml(safeDisplay(vehicle)),
              escapeHtml(safeDisplay(pickup)), escapeHtml(safeDisplay(dropoff)), escapeHtml(safeDisplay(duration)),
              escapeHtml(safeDisplay(fare)), escapeHtml(safeDisplay(status)),
              `<button class="btn btn-sm btn-danger" onclick="deleteBooking('${escapeHtml(bookingId)}')"><i class="bi bi-trash"></i> Delete</button>`
            ]);
          }
          const values = Object.values(bookings);
          const isFlat = values.some(v => v && (v.pickup || v.fare || v.customerName));
          if (isFlat) {
            for (const [bookingId, booking] of Object.entries(bookings)) processBooking(bookingId, booking);
          } else {
            for (const [groupKey, group] of Object.entries(bookings)) {
              if (group && typeof group === 'object') {
                for (const [bookingId, booking] of Object.entries(group)) processBooking(bookingId, booking);
              }
            }
          }
        }
        if (rows.length > 0) table.rows.add(rows).draw();
      } catch (error) { showToast('Failed to load bookings: ' + error.message, 'danger'); }
      finally {
        document.getElementById('bookings-loading').style.display = 'none';
        document.getElementById('bookings-table').style.display = 'table';
      }
    }

    async function loadWallets() {
      document.getElementById('driver-wallets-container').style.display = 'none';
      document.getElementById('wallets-loading').style.display = 'block';
      const container = document.getElementById('driver-wallets-container');
      container.innerHTML = '';
      const statusFilter = (document.getElementById('walletStatusFilter')?.value || 'processing').toLowerCase();
      try {
        const snapshot = await get(ref(db, 'driverWallet'));
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No wallet entries found.</p></div>';
          return;
        }
        const allDriverWallets = snapshot.val();
        for (const [driverId, entries] of Object.entries(allDriverWallets)) {
          const matchingEntries = {};
          for (const [bookingId, entry] of Object.entries(entries)) {
            const effectiveStatus = getEffectiveStatusFromWalletEntry(entry);
            if (effectiveStatus === statusFilter) matchingEntries[bookingId] = { entry, effectiveStatus };
          }
          if (Object.keys(matchingEntries).length === 0) continue;
          
          let driverName = null, upiId = null;
          try {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            if (driverSnapshot.exists()) {
              const driver = driverSnapshot.val();
              driverName = driver.name || null;
              upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
            }
          } catch (e) {}
          
          let totalFiltered = 0, totalProcessing = 0;
          for (const [bookingId, obj] of Object.entries(matchingEntries)) {
            const amount = parseFloat(obj.entry.amount) || 0;
            totalFiltered += amount;
            if (obj.effectiveStatus === 'processing') totalProcessing += amount;
          }
          
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card';
          const sanitizedId = sanitizeId(driverId);
          driverCard.innerHTML = `
            <div class="driver-header">
              <div class="driver-info">
                <div class="driver-meta">
                  <strong>${driverName ? escapeHtml(driverName) : escapeHtml(driverId)}</strong>
                  <div class="small-muted">ID: ${escapeHtml(driverId)}</div>
                  <div class="small-muted">UPI: <span id="upi-${sanitizedId}">${upiId ? escapeHtml(upiId) : '—'}</span></div>
                </div>
              </div>
              <div class="d-flex align-items-center gap-3">
                <div class="text-end">
                  <h4 class="m-0 text-primary">₹${totalFiltered.toFixed(2)}</h4>
                  <div class="small-muted">Total (${escapeHtml(statusFilter)})</div>
                </div>
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="copy-upi-${sanitizedId}" ${!upiId ? 'disabled' : ''}><i class="bi bi-clipboard"></i> Copy UPI</button>
                    <button class="btn btn-sm btn-primary" id="qr-total-${sanitizedId}" ${(!upiId || totalProcessing <= 0) ? 'disabled' : ''}><i class="bi bi-qr-code"></i> Show QR</button>
                    <button class="btn btn-sm btn-success" id="mark-all-paid-${sanitizedId}"><i class="bi bi-cash-stack"></i> Mark All Paid</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <table class="table table-sm table-hover">
                <thead><tr><th>SL</th><th>Booking</th><th>Amount</th><th>Fare</th><th>Payment ID</th><th>Payment Status</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="entries-${sanitizedId}"></tbody>
              </table>
            </div>`;
          
          const tbody = driverCard.querySelector(`#entries-${sanitizedId}`);
          let entryIndex = 1;
          for (const [bookingId, obj] of Object.entries(matchingEntries)) {
            const entry = obj.entry;
            const effectiveStatus = obj.effectiveStatus;
            const amount = Number(entry.amount) || 0;
            const fare = entry.fare ?? entry.booking?.fare ?? 'N/A';
            const isPaid = entry.paidout === true || effectiveStatus === 'paid';
            const pickup = entry.booking?.pickup || entry.pickup || 'N/A';
            const dropoff = entry.booking?.dropoff || entry.dropoff || 'N/A';
            const paymentId = entry.booking?.paymentId || entry.paymentId || 'N/A';
            
            // DEBUG: Log the entry structure
            console.log('Entry for booking:', bookingId);
            console.log('Full entry object:', entry);
            console.log('entry.booking:', entry.booking);
            console.log('entry.booking?.paymentId:', entry.booking?.paymentId);
            console.log('entry.paymentId:', entry.paymentId);
            console.log('Final paymentId:', paymentId);
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${entryIndex++}</td>
              <td style="min-width: 200px;">
                <div><strong>${escapeHtml(bookingId)}</strong></div>
                <small class="text-muted">${escapeHtml(pickup)} → ${escapeHtml(dropoff)}</small>
              </td>
              <td>₹${amount.toFixed(2)}</td>
              <td>₹${escapeHtml(String(fare))}</td>
              <td style="font-family: monospace; font-size: 0.8em;">${paymentId !== 'N/A' ? escapeHtml(paymentId) : '<span class="text-muted">N/A</span>'}</td>
              <td><span class="badge-pending" id="payment-status-${sanitizeId(bookingId)}">Checking...</span></td>
              <td>${isPaid ? '<span class="badge-paid">Paid</span>' : effectiveStatus === 'processing' ? '<span class="badge-processing">Processing</span>' : '<span class="badge-unpaid">Unpaid</span>'}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${amount}, '${escapeHtml(bookingId)}')" ${(!upiId || isPaid) ? 'disabled' : ''}><i class="bi bi-qr-code"></i></button>
                  <button class="btn btn-sm btn-success" onclick="markPaidEntry('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')"><i class="bi bi-check"></i></button>
                </div>
              </td>`;
            tbody.appendChild(row);

            // Verify payment status if paymentId exists
            if (paymentId !== 'N/A') {
              setTimeout(async () => {
                const statusElement = document.getElementById(`payment-status-${sanitizeId(bookingId)}`);
                if (statusElement) {
                  try {
                    const verificationResult = await verifyPayment(paymentId);
                    if (verificationResult.success && verificationResult.verified) {
                      statusElement.className = 'badge-verified';
                      statusElement.textContent = 'Verified';
                      statusElement.title = `Amount: ₹${verificationResult.amount}, Status: ${verificationResult.status}`;
                    } else {
                      statusElement.className = 'badge-unverified';
                      statusElement.textContent = 'Unverified';
                      statusElement.title = verificationResult.error || 'Payment verification failed';
                    }
                  } catch (error) {
                    statusElement.className = 'badge-unverified';
                    statusElement.textContent = 'Error';
                    statusElement.title = 'Payment verification error';
                  }
                }
              }, 100 * entryIndex); // Stagger the API calls
            } else {
              setTimeout(() => {
                const statusElement = document.getElementById(`payment-status-${sanitizeId(bookingId)}`);
                if (statusElement) {
                  statusElement.className = 'badge-unverified';
                  statusElement.textContent = 'No Payment ID';
                  statusElement.title = 'No payment ID found for this entry';
                }
              }, 100);
            }
          }
          container.appendChild(driverCard);
          
          setTimeout(() => {
            const copyBtn = document.getElementById(`copy-upi-${sanitizedId}`);
            if (copyBtn && upiId) {
              copyBtn.addEventListener('click', async () => {
                try {
                  await navigator.clipboard.writeText(upiId);
                  showToast('UPI ID copied to clipboard', 'success');
                } catch (error) { showToast('Failed to copy UPI ID', 'danger'); }
              });
            }
            const qrTotalBtn = document.getElementById(`qr-total-${sanitizedId}`);
            if (qrTotalBtn && upiId && !qrTotalBtn.disabled) {
              qrTotalBtn.addEventListener('click', () => showQrModal(driverId, totalProcessing, ''));
            }
            const markAllBtn = document.getElementById(`mark-all-paid-${sanitizedId}`);
            if (markAllBtn) {
              markAllBtn.addEventListener('click', () => markAllPaidForDriver(driverId));
            }
          }, 100);
        }
      } catch (error) { showToast('Failed to load wallets: ' + error.message, 'danger'); }
      finally {
        document.getElementById('wallets-loading').style.display = 'none';
        document.getElementById('driver-wallets-container').style.display = 'grid';
      }
    }

    async function loadWithdrawals() {
      document.getElementById('withdrawals-container').style.display = 'none';
      document.getElementById('withdrawals-loading').style.display = 'block';
      const container = document.getElementById('withdrawals-container');
      container.innerHTML = '';
      try {
        const snapshot = await get(ref(db, 'pendingWithdrawals'));
        if (!snapshot.exists()) {
          container.innerHTML = '<div class="text-center p-4"><p class="text-muted">No pending withdrawals found.</p></div>';
          return;
        }
        const withdrawalsByDriver = snapshot.val();
        for (const [driverId, bookingsObj] of Object.entries(withdrawalsByDriver)) {
          let totalAmount = 0;
          for (const booking of Object.values(bookingsObj)) totalAmount += Number(booking.amount) || 0;
          
          let driverName = null, upiId = null;
          try {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            if (driverSnapshot.exists()) {
              const driver = driverSnapshot.val();
              driverName = driver.name || null;
              upiId = typeof driver.upiId === 'string' ? driver.upiId.trim() : (driver.upiId || null);
            }
          } catch (e) {}
          
          const driverCard = document.createElement('div');
          driverCard.className = 'driver-card mb-4';
          driverCard.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="m-0 text-primary">Driver: ${escapeHtml(driverId)} ${driverName ? `— ${escapeHtml(driverName)}` : ''}</h5>
                <small class="text-muted">UPI: ${upiId ? escapeHtml(upiId) : '—'}</small>
              </div>
              <div class="text-end">
                <h5 class="m-0">Total: ₹${totalAmount.toFixed(2)}</h5>
                <div class="mt-2 d-flex gap-2 justify-content-end">
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${totalAmount}, '')" ${!upiId ? 'disabled' : ''}><i class="bi bi-qr-code"></i> Show QR</button>
                  <button class="btn btn-sm btn-success" onclick="markAllPaidForDriver('${escapeHtml(driverId)}')"><i class="bi bi-cash-stack"></i> Mark All Paid</button>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead><tr><th>SL</th><th>Booking</th><th>Amount</th><th>Fare</th><th>Payment ID</th><th>Payment Status</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>`;
          
          const tbody = driverCard.querySelector('tbody');
          let serialNo = 1;
          for (const [bookingId, data] of Object.entries(bookingsObj)) {
            const pickup = data.booking?.pickup || data.pickup || 'N/A';
            const dropoff = data.booking?.dropoff || data.dropoff || 'N/A';
            const amount = Number(data.amount) ? Number(data.amount).toFixed(2) : '0.00';
            const fare = data.fare ?? 'N/A';
            const status = data.status ?? 'pending';
            const isPaid = data.paidout === true || ['paid', 'approved'].includes(String(status).toLowerCase());
            const paymentId = data.booking?.paymentId || data.paymentId || 'N/A';
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${serialNo++}</td>
              <td style="min-width: 180px;">
                <div><strong>${escapeHtml(bookingId)}</strong></div>
                <small class="text-muted">${escapeHtml(pickup)} → ${escapeHtml(dropoff)}</small>
              </td>
              <td>₹${amount}</td>
              <td>₹${escapeHtml(String(fare))}</td>
              <td style="font-family: monospace; font-size: 0.8em;">${paymentId !== 'N/A' ? escapeHtml(paymentId) : '<span class="text-muted">N/A</span>'}</td>
              <td><span class="badge-pending" id="withdrawal-payment-status-${sanitizeId(bookingId)}">Checking...</span></td>
              <td>${isPaid ? '<span class="badge-paid">Paid</span>' : '<span class="badge-unpaid">Unpaid</span>'}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-info" onclick="showBookingModal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-primary" onclick="showQrModal('${escapeHtml(driverId)}', ${Number(amount) || 0}, '${escapeHtml(bookingId)}')"
                          ${(!upiId || isPaid) ? 'disabled' : ''}>
                    <i class="bi bi-qr-code"></i>
                  </button>
                  <button class="btn btn-sm btn-success" onclick="approveWithdrawal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-check"></i> Approve
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="rejectWithdrawal('${escapeHtml(driverId)}', '${escapeHtml(bookingId)}')">
                    <i class="bi bi-x"></i> Reject
                  </button>
                </div>
              </td>`;
            tbody.appendChild(row);

            // Verify payment status if paymentId exists
            if (paymentId !== 'N/A') {
              setTimeout(async () => {
                const statusElement = document.getElementById(`withdrawal-payment-status-${sanitizeId(bookingId)}`);
                if (statusElement) {
                  try {
                    const verificationResult = await verifyPayment(paymentId);
                    if (verificationResult.success && verificationResult.verified) {
                      statusElement.className = 'badge-verified';
                      statusElement.textContent = 'Verified';
                      statusElement.title = `Amount: ₹${verificationResult.amount}, Status: ${verificationResult.status}`;
                    } else {
                      statusElement.className = 'badge-unverified';
                      statusElement.textContent = 'Unverified';
                      statusElement.title = verificationResult.error || 'Payment verification failed';
                    }
                  } catch (error) {
                    statusElement.className = 'badge-unverified';
                    statusElement.textContent = 'Error';
                    statusElement.title = 'Payment verification error';
                  }
                }
              }, 100 * serialNo); // Stagger the API calls
            } else {
              setTimeout(() => {
                const statusElement = document.getElementById(`withdrawal-payment-status-${sanitizeId(bookingId)}`);
                if (statusElement) {
                  statusElement.className = 'badge-unverified';
                  statusElement.textContent = 'No Payment ID';
                  statusElement.title = 'No payment ID found for this entry';
                }
              }, 100);
            }
          }
          container.appendChild(driverCard);
        }
      } catch (error) {
        showToast('Failed to load withdrawals: ' + error.message, 'danger');
      } finally {
        document.getElementById('withdrawals-loading').style.display = 'none';
        document.getElementById('withdrawals-container').style.display = 'block';
      }
    }

    async function loadProfile() {
      document.getElementById('profile-table').style.display = 'none';
      document.getElementById('profile-loading').style.display = 'block';
      const table = initTable('profile-table');
      
      try {
        if (currentUser) {
          const rows = [
            ['User ID', escapeHtml(currentUser.uid)],
            ['Email', escapeHtml(currentUser.email || '')],
            ['Display Name', escapeHtml(currentUser.displayName || '')],
            ['Email Verified', currentUser.emailVerified ? 'Yes' : 'No'],
            ['Last Sign In', currentUser.metadata.lastSignInTime ? new Date(currentUser.metadata.lastSignInTime).toLocaleString() : ''],
            ['Creation Time', currentUser.metadata.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleString() : '']
          ];
          table.rows.add(rows).draw();
        }
      } catch (error) {
        showToast('Failed to load profile: ' + error.message, 'danger');
      } finally {
        document.getElementById('profile-loading').style.display = 'none';
        document.getElementById('profile-table').style.display = 'table';
      }
    }

    // Action functions
    window.deleteUser = (uid) => safeDelete(`users/${uid}`, 'Are you sure you want to delete this user?', 'User deleted successfully', loadUsers);
    window.deleteDriver = (driverId) => safeDelete(`driverdetails/${driverId}`, 'Are you sure you want to delete this driver?', 'Driver deleted successfully', loadDrivers);
    window.deleteSearch = (searchId) => safeDelete(`searches/${searchId}`, 'Are you sure you want to delete this search?', 'Search deleted successfully', loadSearches);
    window.deleteBooking = (bookingId) => safeDelete(`bookings/${bookingId}`, 'Are you sure you want to delete this booking?', 'Booking deleted successfully', loadBookings);
    window.deleteSlot = (driverId, slotId) => safeDelete(`availableslots/${driverId}/${slotId}`, 'Are you sure you want to delete this slot?', 'Slot deleted successfully', loadSlots);
    window.deletePendingCar = (driverId, carId) => safeDelete(`pendingcars/${driverId}/${carId}`, 'Are you sure you want to delete this pending car?', 'Pending car deleted successfully', loadPendingCars);
    window.deleteApprovedCar = (driverId, carId) => safeDelete(`approvedcars/${driverId}/${carId}`, 'Are you sure you want to delete this approved car?', 'Approved car deleted successfully', loadApprovedCars);
    window.deleteRideRequest = (requestId) => safeDelete(`riderequest/${requestId}`, 'Are you sure you want to delete this ride request?', 'Ride request deleted successfully', loadRideRequests);

    window.approveRideRequest = async (requestId) => {
      try {
        await update(ref(db, `riderequest/${requestId}`), { status: 'approved', approvedAt: new Date().toISOString() });
        showToast('Ride request approved successfully', 'success');
        loadRideRequests();
      } catch (error) {
        showToast('Failed to approve ride request: ' + error.message, 'danger');
      }
    };

    window.rejectRideRequest = async (requestId) => {
      try {
        await update(ref(db, `riderequest/${requestId}`), { status: 'rejected', rejectedAt: new Date().toISOString() });
        showToast('Ride request rejected successfully', 'success');
        loadRideRequests();
      } catch (error) {
        showToast('Failed to reject ride request: ' + error.message, 'danger');
      }
    };

    window.approveCar = async (driverId, carId) => {
      try {
        const pendingCarSnapshot = await get(ref(db, `pendingcars/${driverId}/${carId}`));
        if (!pendingCarSnapshot.exists()) {
          showToast('Pending car not found', 'danger');
          return;
        }
        const carData = pendingCarSnapshot.val();
        await set(ref(db, `approvedcars/${driverId}/${carId}`), { ...carData, approvedAt: new Date().toISOString() });
        await remove(ref(db, `pendingcars/${driverId}/${carId}`));
        showToast('Car approved successfully', 'success');
        loadPendingCars();
        loadApprovedCars();
      } catch (error) {
        showToast('Failed to approve car: ' + error.message, 'danger');
      }
    };

    window.markPaidEntry = async (driverId, bookingId) => {
      try {
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), { 
          paidout: true, 
          status: 'paid',
          paidAt: new Date().toISOString()
        });
        showToast('Entry marked as paid', 'success');
        loadWallets();
      } catch (error) {
        showToast('Failed to mark as paid: ' + error.message, 'danger');
      }
    };

    window.markAllPaidForDriver = async (driverId) => {
      if (!confirm(`Are you sure you want to mark all entries as paid for driver ${driverId}?`)) return;
      try {
        const walletSnapshot = await get(ref(db, `driverWallet/${driverId}`));
        if (walletSnapshot.exists()) {
          const entries = walletSnapshot.val();
          const updates = {};
          for (const bookingId of Object.keys(entries)) {
            updates[`${bookingId}/paidout`] = true;
            updates[`${bookingId}/status`] = 'paid';
            updates[`${bookingId}/paidAt`] = new Date().toISOString();
          }
          await update(ref(db, `driverWallet/${driverId}`), updates);
        }
        
        // Also remove from pending withdrawals
        await remove(ref(db, `pendingWithdrawals/${driverId}`));
        
        showToast('All entries marked as paid', 'success');
        loadWallets();
        loadWithdrawals();
      } catch (error) {
        showToast('Failed to mark all as paid: ' + error.message, 'danger');
      }
    };

    window.approveWithdrawal = async (driverId, bookingId) => {
      try {
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), { 
          paidout: true, 
          status: 'paid',
          paidAt: new Date().toISOString()
        });
        await remove(ref(db, `pendingWithdrawals/${driverId}/${bookingId}`));
        showToast('Withdrawal approved', 'success');
        loadWithdrawals();
        loadWallets();
      } catch (error) {
        showToast('Failed to approve withdrawal: ' + error.message, 'danger');
      }
    };

    window.rejectWithdrawal = async (driverId, bookingId) => {
      if (!confirm('Are you sure you want to reject this withdrawal request?')) return;
      try {
        await remove(ref(db, `pendingWithdrawals/${driverId}/${bookingId}`));
        await update(ref(db, `driverWallet/${driverId}/${bookingId}`), { 
          status: 'rejected',
          rejectedAt: new Date().toISOString()
        });
        showToast('Withdrawal rejected', 'success');
        loadWithdrawals();
        loadWallets();
      } catch (error) {
        showToast('Failed to reject withdrawal: ' + error.message, 'danger');
      }
    };

    window.showQrModal = async (driverId, amount, bookingId) => {
      try {
        const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
        if (!driverSnapshot.exists()) {
          showToast('Driver not found', 'danger');
          return;
        }
        
        const driver = driverSnapshot.val();
        const upiId = driver.upiId;
        if (!upiId) {
          showToast('Driver UPI ID not found', 'danger');
          return;
        }

        // Show verification status
        const verificationStatus = document.getElementById('paymentVerificationStatus');
        verificationStatus.style.display = 'block';
        verificationStatus.className = 'payment-verification-status loading';
        verificationStatus.innerHTML = '<i class="bi bi-hourglass-split"></i> Verifying payment...';

        // If there's a specific booking ID, verify the payment
        if (bookingId) {
          try {
            const walletSnapshot = await get(ref(db, `driverWallet/${driverId}/${bookingId}`));
            if (walletSnapshot.exists()) {
              const entry = walletSnapshot.val();
              const paymentId = entry.booking?.paymentId || entry.paymentId;
              
              if (paymentId) {
                const verificationResult = await verifyPayment(paymentId);
                
                if (verificationResult.success && verificationResult.verified) {
                  verificationStatus.className = 'payment-verification-status verified';
                  verificationStatus.innerHTML = `
                    <i class="bi bi-check-circle"></i> Payment Verified
                    <br><small>Amount: ₹${verificationResult.amount}, Status: ${verificationResult.status}</small>
                  `;
                } else {
                  verificationStatus.className = 'payment-verification-status unverified';
                  verificationStatus.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i> Payment Not Verified
                    <br><small>${verificationResult.error || 'Payment verification failed'}</small>
                  `;
                  
                  if (!confirm('Payment verification failed. Are you sure you want to generate QR code for payout?')) {
                    return;
                  }
                }
              } else {
                verificationStatus.className = 'payment-verification-status unverified';
                verificationStatus.innerHTML = '<i class="bi bi-exclamation-triangle"></i> No Payment ID found for this booking';
                
                if (!confirm('No payment ID found for this booking. This might be a fake entry. Are you sure you want to generate QR code for payout?')) {
                  return;
                }
              }
            }
          } catch (error) {
            verificationStatus.className = 'payment-verification-status unverified';
            verificationStatus.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Verification error: ${error.message}`;
            
            if (!confirm('Payment verification encountered an error. Are you sure you want to generate QR code for payout?')) {
              return;
            }
          }
        } else {
          verificationStatus.className = 'payment-verification-status loading';
          verificationStatus.innerHTML = '<i class="bi bi-info-circle"></i> Bulk payout - individual payment verification not performed';
        }

        const upiUri = `upi://pay?pa=${encodeURIComponent(upiId)}&am=${amount}&cu=INR&tn=${encodeURIComponent('WaveTravel Payment' + (bookingId ? ' - ' + bookingId : ''))}`;
        
        document.getElementById('qrCode').innerHTML = '';
        new QRCode(document.getElementById('qrCode'), {
          text: upiUri,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#ffffff'
        });
        
        document.getElementById('qrInfo').innerHTML = `
          <strong>Driver:</strong> ${escapeHtml(driver.name || driverId)}<br>
          <strong>UPI ID:</strong> ${escapeHtml(upiId)}<br>
          <strong>Amount:</strong> ₹${amount.toFixed(2)}${bookingId ? `<br><strong>Booking:</strong> ${escapeHtml(bookingId)}` : ''}
        `;
        
        document.getElementById('copyUpiUriBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(upiUri);
            showToast('UPI URI copied to clipboard', 'success');
          } catch (error) {
            showToast('Failed to copy UPI URI', 'danger');
          }
        };
        
        new bootstrap.Modal(document.getElementById('qrModal')).show();
      } catch (error) {
        showToast('Failed to generate QR code: ' + error.message, 'danger');
      }
    };

    // Export functionality
    window.exportWithdrawals = async () => {
      try {
        const snapshot = await get(ref(db, 'pendingWithdrawals'));
        if (!snapshot.exists()) {
          showToast('No data to export', 'info');
          return;
        }
        
        const withdrawals = snapshot.val();
        const csvData = [];
        csvData.push(['Driver ID', 'Driver Name', 'UPI ID', 'Booking ID', 'Amount', 'Pickup', 'Dropoff', 'Payment ID', 'Payment Status', 'Status']);
        
        for (const [driverId, bookingsObj] of Object.entries(withdrawals)) {
          let driverName = '', upiId = '';
          try {
            const driverSnapshot = await get(ref(db, `driverdetails/${driverId}`));
            if (driverSnapshot.exists()) {
              const driver = driverSnapshot.val();
              driverName = driver.name || '';
              upiId = driver.upiId || '';
            }
          } catch (e) {}
          
          for (const [bookingId, data] of Object.entries(bookingsObj)) {
            const paymentId = data.booking?.paymentId || data.paymentId || 'N/A';
            let paymentStatus = 'Not Checked';
            
            // You could add payment verification here for CSV export if needed
            
            csvData.push([
              driverId,
              driverName,
              upiId,
              bookingId,
              data.amount || 0,
              data.booking?.pickup || data.pickup || '',
              data.booking?.dropoff || data.dropoff || '',
              paymentId,
              paymentStatus,
              data.status || 'pending'
            ]);
          }
        }
        
        const csvContent = csvData.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `pending_withdrawals_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('CSV exported successfully', 'success');
      } catch (error) {
        showToast('Failed to export CSV: ' + error.message, 'danger');
      }
    };

    // Tab management
    window.openTab = (tabName) => {
      document.querySelectorAll('.tab-pane').forEach(tab => tab.hidden = true);
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      
      const targetTab = document.getElementById(`${tabName}-tab`);
      if (targetTab) {
        targetTab.hidden = false;
        document.querySelector(`[onclick="openTab('${tabName}')"]`)?.classList.add('active');
        
        // Load data for the active tab
        switch (tabName) {
          case 'users': loadUsers(); break;
          case 'drivers': loadDrivers(); break;
          case 'searches': loadSearches(); break;
          case 'ride-requests': loadRideRequests(); break;
          case 'pending-cars': loadPendingCars(); break;
          case 'approved-cars': loadApprovedCars(); break;
          case 'slots': loadSlots(); break;
          case 'bookings': loadBookings(); break;
          case 'driver-wallets': loadWallets(); break;
          case 'pending-withdrawals': loadWithdrawals(); break;
          case 'profile': loadProfile(); break;
        }
      }
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Global search functionality
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch) {
        globalSearch.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const searchTerm = globalSearch.value.toLowerCase();
            // Search across all visible tables
            Object.values(tables).forEach(table => {
              if (table && typeof table.search === 'function') {
                table.search(searchTerm).draw();
              }
            });
          }
        });
        
        // Quick search shortcut
        document.addEventListener('keydown', (e) => {
          if (e.key === '/' && !e.ctrlKey && !e.altKey && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            globalSearch.focus();
          }
        });
      }

      // Refresh button
      document.getElementById('refreshAllBtn')?.addEventListener('click', () => {
        const activeTab = document.querySelector('.nav-link.active');
        if (activeTab) {
          const tabName = activeTab.getAttribute('onclick')?.match(/openTab\('(.+?)'\)/)?.[1];
          if (tabName) openTab(tabName);
        }
      });

      // Filter buttons
      document.getElementById('requestFilterBtn')?.addEventListener('click', loadRideRequests);
      document.getElementById('walletFilterApplyBtn')?.addEventListener('click', loadWallets);
      document.getElementById('exportWithdrawalsBtn')?.addEventListener('click', exportWithdrawals);
    });

    // Authentication state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        // Load initial tab (users)
        openTab('users');
      } else {
        window.location.href = 'adminlogin.html';
      }
    });

    // Make functions available globally
    window.loadUsers = loadUsers;
    window.loadDrivers = loadDrivers;
    window.loadSearches = loadSearches;
    window.loadRideRequests = loadRideRequests;
    window.loadPendingCars = loadPendingCars;
    window.loadApprovedCars = loadApprovedCars;
    window.loadSlots = loadSlots;
    window.loadBookings = loadBookings;
    window.loadWallets = loadWallets;
    window.loadWithdrawals = loadWithdrawals;
    window.loadProfile = loadProfile;
    window.verifyPayment = verifyPayment;

  </script>
</body>
</html>
