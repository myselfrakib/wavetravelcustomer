<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Slots</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .card {
      background-color: #1e3a5f;
      border: none;
      border-radius: 1rem;
      color: #fff;
    }
    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #0f2027;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }
    .navbar a {
      color: white;
      text-align: center;
      font-size: 0.9rem;
      text-decoration: none;
    }
    .navbar a:hover {
      color: #1abc9c;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="text-center mb-4">Add Slot</h2>
    <div class="card p-3 mb-4">
      <form id="slotForm">
        <div class="mb-2">
          <label class="form-label">Pickup Location</label>
          <select class="form-select" id="pickup"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Drop-off Location</label>
          <select class="form-select" id="dropoff"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Car</label>
          <select class="form-select" id="carSelect"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" id="date" required />
        </div>
        <div class="mb-2">
          <label class="form-label">Time</label>
          <input type="time" class="form-control" id="time" required />
        </div>
        <div class="mb-2">
          <label class="form-label">Seats (max based on car)</label>
          <input type="number" class="form-control" id="seats" required min="1" />
        </div>
        <button type="submit" class="btn btn-primary w-100">Add Slot</button>
      </form>
    </div>

    <div class="mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by location, car or date" />
    </div>

    <h4 class="mb-3">Available Slots</h4>
    <div id="slotList" class="d-grid gap-2"></div>
  </div>

  <div class="navbar">
    <a href="driverdashboard.html">Home</a>
    <a href="drivermybookings.html">My Bookings</a>
    <a href="slots.html">Slots</a>
    <a href="mycars.html">My Cars</a>
    <a href="driverprofile.html">Profile</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const auth = getAuth();

    const pickupEl = document.getElementById("pickup");
    const dropoffEl = document.getElementById("dropoff");
    const carSelect = document.getElementById("carSelect");
    const seatsInput = document.getElementById("seats");
    const timeInput = document.getElementById("time");
    const dateInput = document.getElementById("date");
    let carSeatMap = {};

    // Disable past times for today
    dateInput.addEventListener("change", () => {
      if (dateInput.value === new Date().toISOString().split('T')[0]) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        timeInput.min = `${hours}:${minutes}`;
      } else {
        timeInput.removeAttribute("min");
      }
    });

    function loadOptions() {
      const locRef = ref(db, 'locations');
      onValue(locRef, snapshot => {
        pickupEl.innerHTML = '';
        dropoffEl.innerHTML = '';
        snapshot.forEach(child => {
          pickupEl.innerHTML += `<option value="${child.val()}">${child.val()}</option>`;
          dropoffEl.innerHTML += `<option value="${child.val()}">${child.val()}</option>`;
        });
      });

      const user = auth.currentUser;
      const carRef = ref(db, `approvedcars`);
      onValue(carRef, snapshot => {
        carSelect.innerHTML = '';
        carSeatMap = {};
        snapshot.forEach(child => {
          const car = child.val();
          if (car.driverId === user.uid) {
            carSelect.innerHTML += `<option value="${car.name}">${car.name}</option>`;
            carSeatMap[car.name] = parseInt(car.seats);
          }
        });
      });
    }

    auth.onAuthStateChanged(user => {
      if (!user) return;
      loadOptions();

      const slotForm = document.getElementById("slotForm");
      const searchInput = document.getElementById("searchInput");

      slotForm.addEventListener("submit", async e => {
        e.preventDefault();

        const date = dateInput.value;
        const time = timeInput.value;
        const key = `${date}_${time}_${pickupEl.value}_${dropoffEl.value}_${carSelect.value}`;

        const snapshot = await get(ref(db, `availableslots/${user.uid}`));
        for (const child of Object.values(snapshot.val() || {})) {
          if (`${child.date}_${child.time}_${child.pickup}_${child.dropoff}_${child.car}` === key) {
            alert("Duplicate slot detected. Choose another time or details.");
            return;
          }
        }

        const data = {
          pickup: pickupEl.value,
          dropoff: dropoffEl.value,
          car: carSelect.value,
          date,
          time,
          seats: seatsInput.value,
          driverId: user.uid
        };

        if (parseInt(data.seats) > carSeatMap[data.car]) {
          alert("Seats exceed car capacity.");
          return;
        }

        push(ref(db, `availableslots/${user.uid}`), data).then(() => {
          alert("Slot added.");
          slotForm.reset();
        });
      });

      const slotList = document.getElementById("slotList");

      onValue(ref(db, `availableslots/${user.uid}`), snapshot => {
        let slots = [];
        slotList.innerHTML = '';

        snapshot.forEach(child => {
          slots.push({ id: child.key, ...child.val() });
        });

        searchInput.addEventListener("input", () => {
          const searchTerm = searchInput.value.toLowerCase();
          renderSlots(slots.filter(slot =>
            slot.pickup.toLowerCase().includes(searchTerm) ||
            slot.dropoff.toLowerCase().includes(searchTerm) ||
            slot.car.toLowerCase().includes(searchTerm) ||
            slot.date.includes(searchTerm)
          ));
        });

        renderSlots(slots);
      });

      function renderSlots(slots) {
        slotList.innerHTML = '';
        const now = new Date();

        slots.sort((a, b) => new Date(`${b.date}T${b.time}`) - new Date(`${a.date}T${a.time}`));

        slots.forEach(slot => {
          const slotTime = new Date(`${slot.date}T${slot.time}`);
          const statusColor = slotTime > now ? 'text-success' : 'text-secondary';

          slotList.innerHTML += `
            <div class="card p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong class="${statusColor}">${slot.date} ${slot.time}</strong><br />
                  ${slot.pickup} â†’ ${slot.dropoff} | Car: ${slot.car} | Seats: ${slot.seats}
                </div>
                <button class="btn btn-sm btn-danger" onclick="deleteSlot('${user.uid}', '${slot.id}')">Delete</button>
              </div>
            </div>
          `;
        });
      }
    });
     window.onload = () => {
      generateTimeSlots();
      populateDropdown('/locations', 'pickup');
      populateDropdown('/locations', 'dropoff');
      populateDropdown('/cars', 'car');

    window.deleteSlot = (userId, slotId) => {
      if (confirm("Are you sure you want to delete this slot?")) {
        import("https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js").then(({ getDatabase, ref, remove }) => {
          remove(ref(getDatabase(), `availableslots/${userId}/${slotId}`));
        });
      }
    }
  </script>
</body>
</html>
