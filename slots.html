<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Slot</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #8e2de2, #4a00e0);
      color: white;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    .container {
      padding: 20px;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }

    button {
      background-color: #ffd700;
      color: black;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }

    .slot-item {
      background-color: rgba(255,255,255,0.1);
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
    }

    .slot-item button {
      background: red;
      color: white;
      width: auto;
      margin-top: 10px;
    }

    .navbar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      z-index: 999;
    }

    .navbar a {
      color: #fff;
      text-decoration: none;
      font-weight: bold;
      font-size: 16px;
      padding: 10px 15px;
      border-radius: 10px;
      transition: background 0.3s, color 0.3s;
    }

    .navbar a:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #ffd700;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Add Available Slot</h1>
    <form id="slotForm">
      <label for="pickup">Pickup Location:</label>
      <select id="pickup" required></select>

      <label for="dropoff">Dropoff Location:</label>
      <select id="dropoff" required></select>

      <label for="date">Date:</label>
      <input type="date" id="date" required min="">

      <label for="time">Time:</label>
      <div style="display: flex; gap: 10px;">
        <select id="hour" required>
          <option value="">Hour</option>
          ${[...Array(12).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join('')}
        </select>
        <select id="minute" required>
          <option value="00">00</option>
          <option value="30">30</option>
        </select>
        <select id="ampm" required>
          <option value="AM">AM</option>
          <option value="PM">PM</option>
        </select>
      </div>

      <label for="seats">Available Seats (max 6):</label>
      <input type="number" id="seats" required min="1" max="6">

      <label for="car">Select Car:</label>
      <select id="car" required></select>

      <button type="submit">Submit Slot</button>
    </form>

    <h2>My Slots</h2>
    <div id="slotsList"></div>
  </div>

  <div class="navbar">
    <a href="driverhome.html">Home</a>
    <a href="drivermybookings.html">My Orders</a>
    <a href="driverslots.html">Slots</a>
    <a href="drivermycars.html">My Cars</a>
    <a href="driverprofile.html">Profile</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const pickupSelect = document.getElementById("pickup");
    const dropoffSelect = document.getElementById("dropoff");
    const carSelect = document.getElementById("car");
    const slotForm = document.getElementById("slotForm");
    const slotsList = document.getElementById("slotsList");

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").min = today;

    onAuthStateChanged(auth, user => {
      if (user) {
        const uid = user.uid;

        // Fetch locations
        onValue(ref(db, "locations"), (snapshot) => {
          pickupSelect.innerHTML = dropoffSelect.innerHTML = "";
          snapshot.forEach(child => {
            const name = child.val().name;
            pickupSelect.innerHTML += `<option value="${name}">${name}</option>`;
            dropoffSelect.innerHTML += `<option value="${name}">${name}</option>`;
          });
        });

        // Fetch cars
        onValue(ref(db, `approvedcars/${uid}`), (snapshot) => {
          carSelect.innerHTML = "";
          snapshot.forEach(child => {
            const data = child.val();
            carSelect.innerHTML += `<option value="${data.model} (${data.plateNumber})">${data.model} (${data.plateNumber})</option>`;
          });
        });

        // Handle form submission
        slotForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const pickup = pickupSelect.value;
          const dropoff = dropoffSelect.value;
          const date = document.getElementById("date").value;
          const hour = document.getElementById("hour").value;
          const minute = document.getElementById("minute").value;
          const ampm = document.getElementById("ampm").value;
          const time = `${hour}:${minute} ${ampm}`;
          const seats = document.getElementById("seats").value;
          const car = carSelect.value;

          const slotData = { pickup, dropoff, date, time, seats, car };
          const newSlotRef = push(ref(db, `availableslots/${uid}`));
          set(newSlotRef, slotData).then(() => {
            alert("Slot added!");
            slotForm.reset();
            document.getElementById("date").min = today;
          });
        });

        // Fetch and display existing slots
        onValue(ref(db, `availableslots/${uid}`), (snapshot) => {
          slotsList.innerHTML = "";
          snapshot.forEach(child => {
            const slot = child.val();
            const key = child.key;
            const div = document.createElement("div");
            div.className = "slot-item";
            div.innerHTML = `
              <strong>${slot.pickup} â†’ ${slot.dropoff}</strong><br>
              Date: ${slot.date} | Time: ${slot.time}<br>
              Seats: ${slot.seats} | Car: ${slot.car}<br>
              <button data-key="${key}">Delete</button>
            `;
            div.querySelector("button").onclick = () => {
              remove(ref(db, `availableslots/${uid}/${key}`));
            };
            slotsList.appendChild(div);
          });
        });

      } else {
        alert("Please login first.");
        window.location.href = "driverlogin.html";
      }
    });
  </script>
</body>
</html>
