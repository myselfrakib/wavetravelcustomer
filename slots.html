<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create New Slot</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 15px; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 10px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Create New Slot</h2>
    <form id="slotForm">
      <label for="pickup">Pickup Location:</label>
      <select id="pickup" required></select>

      <label for="dropoff">Drop-off Location:</label>
      <select id="dropoff" required></select>

      <label for="date">Date:</label>
      <input type="date" id="date" required min="<?= date('Y-m-d') ?>">

      <label for="time">Time:</label>
      <input type="time" id="time" required>

      <label for="car">Select Car:</label>
      <select id="car" required></select>

      <label for="seats">Available Seats:</label>
      <input type="number" id="seats" required min="1" max="6">

      <button type="submit">Create Slot</button>
    </form>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const pickupSelect = document.getElementById("pickup");
    const dropoffSelect = document.getElementById("dropoff");
    const carSelect = document.getElementById("car");
    const slotForm = document.getElementById("slotForm");

    let driverId = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        driverId = user.uid;
        await loadLocations();
        await loadCars(driverId);
      } else {
        alert("Please log in as driver");
        window.location.href = "/login.html";
      }
    });

    async function loadLocations() {
      const locationsRef = db.ref("locations");
      const snapshot = await locationsRef.once("value");
      snapshot.forEach(loc => {
        const name = loc.val().name;
        const opt = new Option(name, name);
        pickupSelect.append(opt.cloneNode(true));
        dropoffSelect.append(opt.cloneNode(true));
      });
    }

    async function loadCars(driverId) {
      const carsRef = db.ref("approvedcars/" + driverId);
      const snapshot = await carsRef.once("value");
      snapshot.forEach(carSnap => {
        const car = carSnap.val();
        const opt = new Option(`${car.model} (${car.plateNumber})`, carSnap.key);
        carSelect.append(opt);
      });
    }

    slotForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const pickup = pickupSelect.value;
      const dropoff = dropoffSelect.value;
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const carId = carSelect.value;
      const seats = parseInt(document.getElementById("seats").value);

      if (!pickup || !dropoff || !date || !time || !carId || isNaN(seats)) {
        alert("All fields are required.");
        return;
      }

      const slotData = {
        pickup,
        dropoff,
        date,
        time,
        carId,
        seats
      };

      try {
        await db.ref("availableslots/" + driverId).push(slotData);
        alert("Slot created successfully!");
        slotForm.reset();
      } catch (err) {
        console.error(err);
        alert("Error creating slot. Try again.");
      }
    });
  </script>
</body>
</html>
