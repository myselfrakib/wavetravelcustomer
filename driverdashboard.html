<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Driver Dashboard - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      color: #1e293b;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: white;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 20px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .hamburger-btn {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .hamburger-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    .hamburger-btn:active {
      transform: scale(0.95);
    }
    
    .hamburger-line {
      width: 20px;
      height: 2.5px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(1) {
      transform: translateY(7.5px) rotate(45deg);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(2) {
      opacity: 0;
      transform: translateX(-10px);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(3) {
      transform: translateY(-7.5px) rotate(-45deg);
    }
    
    .driver-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .driver-avatar {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 700;
      border: 2px solid rgba(255, 255, 255, 0.5);
    }
    
    .driver-details h2 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 2px;
    }
    
    .driver-details p {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    
    .status-toggle {
      background: rgba(255, 255, 255, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 30px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .status-toggle:hover {
      background: rgba(255, 255, 255, 0.35);
    }
    
    .status-toggle.online {
      background: rgba(255, 255, 255, 0.95);
      color: #10b981;
      border-color: white;
    }
    
    .status-toggle.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
    }
    
    .status-toggle.online .status-dot {
      background: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    .stat-value {
      font-size: 1.3rem;
      font-weight: 800;
      display: block;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 0.7rem;
      opacity: 0.9;
      font-weight: 600;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .loading-spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #10b981;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1rem;
      color: #64748b;
      font-weight: 600;
    }
    
    /* Ride Request Card */
    .ride-request-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(251, 191, 36, 0.4);
      border: 2px solid #fbbf24;
      animation: slideIn 0.4s ease;
      display: none;
    }
    
    .ride-request-card.show {
      display: block;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .request-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .request-badge {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .request-time {
      font-size: 0.8rem;
      color: #78350f;
      font-weight: 600;
    }
    
    .customer-info {
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .customer-avatar {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .customer-details h3 {
      font-size: 0.95rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 2px;
    }
    
    .customer-details p {
      font-size: 0.75rem;
      color: #64748b;
    }
    
    .ride-details {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .location-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 14px;
    }
    
    .location-row:last-child {
      margin-bottom: 0;
    }
    
    .location-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .location-icon.pickup {
      background: #d1fae5;
      color: #059669;
    }
    
    .location-icon.dropoff {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .location-text {
      flex: 1;
    }
    
    .location-label {
      font-size: 0.7rem;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .location-address {
      font-size: 0.85rem;
      color: #1e293b;
      font-weight: 500;
      line-height: 1.4;
    }
    
    .ride-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .ride-stat {
      background: white;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      border: 2px solid #e5e7eb;
    }
    
    .ride-stat-value {
      font-size: 1rem;
      font-weight: 700;
      color: #10b981;
      display: block;
      margin-bottom: 4px;
    }
    
    .ride-stat-label {
      font-size: 0.7rem;
      color: #64748b;
      font-weight: 600;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .btn {
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-reject {
      background: white;
      color: #ef4444;
      border: 2px solid #ef4444;
    }
    
    .btn-reject:hover {
      background: #fef2f2;
    }
    
    .btn-accept {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .btn-accept:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    /* Active Ride Card */
    .active-ride-card {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
      border: 2px solid #3b82f6;
      display: none;
    }
    
    .active-ride-card.show {
      display: block;
    }
    
    .ride-status-header {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .status-icon {
      width: 64px;
      height: 64px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
      font-size: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .ride-status-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: #1e40af;
      margin-bottom: 4px;
    }
    
    .ride-status-subtitle {
      font-size: 0.85rem;
      color: #1e40af;
      opacity: 0.8;
    }
    
    .map-preview {
      background: white;
      border-radius: 16px;
      height: 200px;
      margin-bottom: 16px;
      overflow: hidden;
      position: relative;
    }
    
    #active-ride-map {
      width: 100%;
      height: 100%;
    }
    
    .navigation-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .progress-steps {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .step:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      background: #e5e7eb;
      color: #9ca3af;
    }
    
    .step.completed .step-icon {
      background: #d1fae5;
      color: #059669;
    }
    
    .step.active .step-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }
    
    .step-text {
      flex: 1;
    }
    
    .step-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }
    
    .step-time {
      font-size: 0.75rem;
      color: #64748b;
    }
    
    .step.active .step-label {
      color: #3b82f6;
    }
    
    .primary-action-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: 'Inter', sans-serif;
    }
    
    .primary-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(16, 185, 129, 0.5);
    }
    
    .primary-action-btn:active {
      transform: scale(0.95);
    }
    
    .primary-action-btn.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      display: none;
    }
    
    .empty-state.show {
      display: block;
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .empty-subtitle {
      font-size: 0.9rem;
      color: #64748b;
      line-height: 1.6;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: #1e293b;
      color: white;
      padding: 14px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 3000;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      font-size: 0.9rem;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.error {
      background: #ef4444;
    }
    
    .toast.success {
      background: #10b981;
    }
    
    /* Loading Spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 0.8s linear infinite;
    }
    
    /* Sidebar Navigation */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: white;
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
    }
    
    .sidebar.active {
      transform: translateX(0);
    }
    
    .sidebar-header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 24px 20px;
      color: white;
    }
    
    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .sidebar-avatar {
      width: 56px;
      height: 56px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      border: 3px solid rgba(255, 255, 255, 0.5);
    }
    
    .sidebar-user-info {
      flex: 1;
      min-width: 0;
    }
    
    .sidebar-user-name {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .sidebar-user-phone {
      font-size: 0.8rem;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .sidebar-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    
    .sidebar-stat {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }
    
    .sidebar-stat-value {
      font-size: 1.2rem;
      font-weight: 800;
      display: block;
      margin-bottom: 2px;
    }
    
    .sidebar-stat-label {
      font-size: 0.7rem;
      opacity: 0.9;
      font-weight: 600;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 12px 0;
      overflow-y: auto;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 20px;
      color: #334155;
      text-decoration: none;
      transition: all 0.2s ease;
      font-weight: 600;
      font-size: 0.95rem;
      border-left: 3px solid transparent;
      cursor: pointer;
    }
    
    .nav-item:hover {
      background: #f8fafc;
      border-left-color: #10b981;
    }
    
    .nav-item.active {
      background: #f0fdf4;
      border-left-color: #10b981;
      color: #059669;
    }
    
    .nav-item i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }
    
    .nav-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 8px 20px;
    }
    
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid #e2e8f0;
    }
    
    .logout-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
    }
    
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    
    .logout-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-user">
          <div class="sidebar-avatar" id="sidebar-avatar">D</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="sidebar-user-name">Driver Name</div>
            <div class="sidebar-user-phone" id="sidebar-user-phone">+91 00000 00000</div>
          </div>
        </div>
        
        <div class="sidebar-stats">
          <div class="sidebar-stat">
            <span class="sidebar-stat-value" id="sidebar-earnings">‚Çπ0</span>
            <span class="sidebar-stat-label">Today</span>
          </div>
          <div class="sidebar-stat">
            <span class="sidebar-stat-value" id="sidebar-rides">0</span>
            <span class="sidebar-stat-label">Rides</span>
          </div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" onclick="navigateTo('home')">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="drivermybookings.html" class="nav-item">
          <i class="fas fa-history"></i>
          <span>My Rides</span>
        </a>
        <div class="nav-divider"></div>
        <a href="driverprofile.html" class="nav-item">
          <i class="fas fa-user-circle"></i>
          <span>Profile</span>
        </a>
        <a href="#" class="nav-item" onclick="showEarnings()">
          <i class="fas fa-wallet"></i>
          <span>Earnings</span>
        </a>
        <a href="#" class="nav-item" onclick="showSettings()">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="handleLogout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
    
    <!-- Header -->
    <div class="header">
      <div class="header-top">
        <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        
        <div class="driver-info">
          <div class="driver-avatar" id="driver-avatar">D</div>
          <div class="driver-details">
            <h2 id="driver-name">Driver Name</h2>
            <p id="driver-vehicle">Vehicle Info</p>
          </div>
        </div>
        <div class="status-toggle" id="status-toggle" onclick="toggleOnlineStatus()">
          <span class="status-dot"></span>
          <span id="status-text">Offline</span>
        </div>
      </div>
      
      <div class="stats-row">
        <div class="stat-card">
          <span class="stat-value" id="today-earnings">‚Çπ0</span>
          <span class="stat-label">Today</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="total-rides">0</span>
          <span class="stat-label">Rides</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="rating">5.0</span>
          <span class="stat-label">Rating</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
      <!-- Loading State -->
      <div class="loading-state" id="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">üöó</div>
        <div class="empty-title">Ready to Drive?</div>
        <div class="empty-subtitle">
          Go online to start receiving ride requests from customers
        </div>
      </div>

      <!-- Ride Request Card -->
      <div class="ride-request-card" id="ride-request-card">
        <div class="request-header">
          <div class="request-badge">
            <i class="fas fa-bell"></i>
            NEW REQUEST
          </div>
          <div class="request-time" id="request-time">Just now</div>
        </div>
        
        <div class="customer-info">
          <div class="customer-avatar" id="customer-avatar">C</div>
          <div class="customer-details">
            <h3 id="customer-name">Customer Name</h3>
            <p id="trip-type">One Way Trip</p>
          </div>
        </div>
        
        <div class="ride-details">
          <div class="location-row">
            <div class="location-icon pickup">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="location-text">
              <div class="location-label">PICKUP LOCATION</div>
              <div class="location-address" id="request-pickup">Loading...</div>
            </div>
          </div>
          
          <div class="location-row">
            <div class="location-icon dropoff">
              <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="location-text">
              <div class="location-label">DROP-OFF LOCATION</div>
              <div class="location-address" id="request-dropoff">Loading...</div>
            </div>
          </div>
        </div>
        
        <div class="ride-stats">
          <div class="ride-stat">
            <span class="ride-stat-value" id="request-distance">--</span>
            <span class="ride-stat-label">Distance</span>
          </div>
          <div class="ride-stat">
            <span class="ride-stat-value" id="request-duration">--</span>
            <span class="ride-stat-label">Duration</span>
          </div>
          <div class="ride-stat">
            <span class="ride-stat-value" id="request-fare">--</span>
            <span class="ride-stat-label">Fare</span>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-reject" onclick="rejectRide()">
            <i class="fas fa-times"></i>
            Reject
          </button>
          <button class="btn btn-accept" onclick="acceptRide()">
            <i class="fas fa-check"></i>
            Accept
          </button>
        </div>
      </div>

      <!-- Active Ride Card -->
      <div class="active-ride-card" id="active-ride-card">
        <div class="ride-status-header">
          <div class="status-icon" id="status-icon">üìç</div>
          <div class="ride-status-title" id="ride-status-title">Going to Pickup</div>
          <div class="ride-status-subtitle" id="ride-status-subtitle">Navigate to customer location</div>
        </div>
        
        <div class="map-preview">
          <div id="active-ride-map"></div>
          <button class="navigation-btn" onclick="openNavigation()">
            <i class="fas fa-directions"></i>
            Navigate
          </button>
        </div>
        
        <div class="progress-steps">
          <div class="step active" id="step-pickup">
            <div class="step-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="step-text">
              <div class="step-label">Reach Pickup Point</div>
              <div class="step-time" id="pickup-address">Loading...</div>
            </div>
          </div>
          
          <div class="step" id="step-journey">
            <div class="step-icon">
              <i class="fas fa-car"></i>
            </div>
            <div class="step-text">
              <div class="step-label">Start Journey</div>
              <div class="step-time">Pick up customer</div>
            </div>
          </div>
          
          <div class="step" id="step-complete">
            <div class="step-icon">
              <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="step-text">
              <div class="step-label">Complete Ride</div>
              <div class="step-time" id="dropoff-address">Loading...</div>
            </div>
          </div>
        </div>
        
        <button class="primary-action-btn" id="primary-action-btn" onclick="handlePrimaryAction()">
          <i class="fas fa-check-circle"></i>
          <span id="action-btn-text">Reached Pickup</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc&libraries=places"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.firebasestorage.app",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    // Initialize Firebase
    let app, auth, database, currentDriver = null;
    let activeRideMap, directionsService, directionsRenderer;
    let isOnline = false;
    let currentRideRequest = null;
    let currentRideRequestRef = null;
    let currentRideId = null;
    let rideState = 'idle'; // idle, going_to_pickup, at_pickup, in_journey, completed
    let activeRideListener = null;
    let rideRequestsListener = null;
    
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      database = firebase.database();
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization error:', error);
      showToast('‚ö†Ô∏è Firebase initialization failed', 'error');
    }

    // Driver data
    const driverData = {
      id: '2VmOFuuliNb4ne1Ad796NCUbklo2',
      name: 'Rakib sk',
      phone: '+919907718066',
      vehicle: 'Dzire ‚Ä¢ WB02AJ7678',
      vehicleType: 'sedan',
      rating: 4.8,
      todayEarnings: 0,
      totalRides: 0,
      currentLocation: {
        lat: 22.5954176,
        lng: 88.4385091
      }
    };

    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const hamburger = document.getElementById('hamburger-btn');
      
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      hamburger.classList.toggle('active');
      
      if (sidebar.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const hamburger = document.getElementById('hamburger-btn');
      
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      hamburger.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    function navigateTo(page) {
      closeSidebar();
      if (page === 'home') {
        showToast('Already on home page', 'success');
      }
    }
    
    function showEarnings() {
      closeSidebar();
      showToast('üìä Earnings page coming soon', 'success');
    }
    
    function showSettings() {
      closeSidebar();
      showToast('‚öôÔ∏è Settings page coming soon', 'success');
    }
    
    async function handleLogout() {
      if (!confirm('Are you sure you want to logout?')) {
        return;
      }
      
      closeSidebar();
      
      if (!auth) {
        showToast('Authentication not available', 'error');
        return;
      }

      try {
        if (database && isOnline) {
          await database.ref(`evplan/drivers/${driverData.id}`).update({
            isOnline: false,
            lastSeen: firebase.database.ServerValue.TIMESTAMP
          });
        }
        
        await auth.signOut();
        showToast('‚úì Logged out successfully', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1000);
      } catch (error) {
        console.error('Logout error:', error);
        showToast('Error logging out: ' + error.message, 'error');
      }
    }

    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger-btn');
      
      if (sidebar.classList.contains('active') && 
          !sidebar.contains(e.target) && 
          !hamburger.contains(e.target)) {
        closeSidebar();
      }
    });

    // Initialize on load
    window.addEventListener('load', () => {
      showLoadingState();
      initializeDriver();
      initMap();
      
      // Check for active ride first, then listen for new requests
      setTimeout(() => {
        checkForActiveRide();
      }, 1000);
    });
    
    // Show/hide loading state
    function showLoadingState() {
      document.getElementById('loading-state').style.display = 'block';
      document.getElementById('empty-state').classList.remove('show');
      document.getElementById('ride-request-card').classList.remove('show');
      document.getElementById('active-ride-card').classList.remove('show');
    }
    
    function hideLoadingState() {
      document.getElementById('loading-state').style.display = 'none';
    }

    // Check for active ride on page load
    async function checkForActiveRide() {
      if (!database) {
        hideLoadingState();
        document.getElementById('empty-state').classList.add('show');
        return;
      }

      try {
        // Check for any ride assigned to this driver that's not completed
        const rideRequestsRef = database.ref('evplan/rideRequests');
        const snapshot = await rideRequestsRef
          .orderByChild('assignedDriverId')
          .equalTo(driverData.id)
          .once('value');

        let foundActiveRide = false;

        snapshot.forEach((childSnapshot) => {
          const ride = childSnapshot.val();
          
          // Check if ride is still active (accepted or in progress)
          if (ride.status === 'accepted' && ride.tripStage !== 'completed') {
            foundActiveRide = true;
            currentRideId = childSnapshot.key;
            currentRideRequest = ride;
            currentRideRequestRef = childSnapshot.ref;
            
            // Restore ride state
            const stage = ride.tripStage || 'going_to_pickup';
            rideState = stage;
            
            // Set driver online automatically
            isOnline = true;
            updateOnlineStatus(true);
            
            // Show the active ride
            restoreActiveRide(ride, stage);
            
            // Listen for changes to this ride
            listenToActiveRide(childSnapshot.ref);
            
            console.log('Restored active ride:', currentRideId, 'Stage:', stage);
          }
        });

        if (!foundActiveRide) {
          // No active ride, start listening for new requests
          hideLoadingState();
          document.getElementById('empty-state').classList.add('show');
          listenForRideRequests();
        }

      } catch (error) {
        console.error('Error checking for active ride:', error);
        hideLoadingState();
        document.getElementById('empty-state').classList.add('show');
        listenForRideRequests();
      }
    }

    // Restore active ride UI
    function restoreActiveRide(ride, stage) {
      hideLoadingState();
      
      // Update ride request data
      currentRideRequest = ride;
      
      // Set addresses
      document.getElementById('pickup-address').textContent = ride.pickup.address;
      document.getElementById('dropoff-address').textContent = ride.dropoff.address;
      
      // Show active ride card
      document.getElementById('active-ride-card').classList.add('show');
      document.getElementById('empty-state').classList.remove('show');
      
      // Update ride state UI
      updateRideState(stage);
      
      // Show route on map
      setTimeout(() => {
        google.maps.event.trigger(activeRideMap, 'resize');
        if (stage === 'going_to_pickup' || stage === 'at_pickup') {
          showRouteOnMap();
        } else {
          showRouteToDestination();
        }
      }, 100);
      
      showToast('üöó Active ride restored', 'success');
    }

    // Listen to active ride changes
    function listenToActiveRide(rideRef) {
      // Remove previous listener if exists
      if (activeRideListener) {
        activeRideListener.off();
      }
      
      activeRideListener = rideRef;
      
      rideRef.on('value', (snapshot) => {
        const ride = snapshot.val();
        
        if (!ride) {
          // Ride was deleted
          resetToIdle();
          return;
        }
        
        // Update current ride data
        currentRideRequest = ride;
        
        // Check if ride was cancelled or completed
        if (ride.status === 'cancelled') {
          showToast('Ride was cancelled by customer', 'error');
          resetToIdle();
          return;
        }
        
        if (ride.status === 'completed' || ride.tripStage === 'completed') {
          // Ride completed from another source
          if (rideState !== 'idle') {
            showToast('üéâ Ride completed!', 'success');
            setTimeout(() => {
              resetToIdle();
            }, 2000);
          }
        }
      });
    }

    // Reset to idle state
    function resetToIdle() {
      rideState = 'idle';
      currentRideRequest = null;
      currentRideRequestRef = null;
      currentRideId = null;
      
      // Remove active ride listener
      if (activeRideListener) {
        activeRideListener.off();
        activeRideListener = null;
      }
      
      // Hide active ride card
      document.getElementById('active-ride-card').classList.remove('show');
      
      // Show appropriate state
      if (isOnline) {
        document.getElementById('empty-state').classList.add('show');
        // Restart listening for new requests
        listenForRideRequests();
      } else {
        document.getElementById('empty-state').classList.add('show');
      }
    }

    // Update driver location periodically
    function updateDriverLocation() {
      if (!isOnline || !database) return;
      
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            driverData.currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            
            database.ref(`evplan/drivers/${driverData.id}`).update({
              location: driverData.currentLocation,
              lastLocationUpdate: firebase.database.ServerValue.TIMESTAMP
            });
            
            // If in active ride, update ride request location too
            if (currentRideRequestRef && rideState !== 'idle') {
              currentRideRequestRef.update({
                driverLocation: driverData.currentLocation
              });
            }
          },
          (error) => {
            console.log('Location error:', error);
          },
          { enableHighAccuracy: true, timeout: 5000 }
        );
      }
    }
    
    setInterval(() => {
      if (isOnline) {
        updateDriverLocation();
      }
    }, 10000);

    // Initialize driver info
    function initializeDriver() {
      document.getElementById('driver-name').textContent = driverData.name;
      document.getElementById('driver-vehicle').textContent = driverData.vehicle;
      document.getElementById('driver-avatar').textContent = driverData.name.charAt(0);
      document.getElementById('rating').textContent = driverData.rating;
      
      document.getElementById('sidebar-avatar').textContent = driverData.name.charAt(0);
      document.getElementById('sidebar-user-name').textContent = driverData.name;
      document.getElementById('sidebar-user-phone').textContent = driverData.phone;
      
      updateStats();
    }

    function updateStats() {
      document.getElementById('today-earnings').textContent = '‚Çπ' + driverData.todayEarnings;
      document.getElementById('total-rides').textContent = driverData.totalRides;
      document.getElementById('sidebar-earnings').textContent = '‚Çπ' + driverData.todayEarnings;
      document.getElementById('sidebar-rides').textContent = driverData.totalRides;
    }

    // Initialize Map
    function initMap() {
      const kolkata = { lat: 22.5726, lng: 88.3639 };
      
      activeRideMap = new google.maps.Map(document.getElementById('active-ride-map'), {
        center: kolkata,
        zoom: 14,
        disableDefaultUI: true,
        zoomControl: false,
        gestureHandling: 'greedy',
        styles: [
          {
            featureType: "poi",
            elementType: "labels",
            stylers: [{ visibility: "off" }]
          }
        ]
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: activeRideMap,
        suppressMarkers: false,
        polylineOptions: {
          strokeColor: '#10b981',
          strokeWeight: 4
        }
      });
    }

    // Update online status UI
    function updateOnlineStatus(online) {
      const statusToggle = document.getElementById('status-toggle');
      const statusText = document.getElementById('status-text');
      
      if (online) {
        statusToggle.classList.add('online');
        statusText.textContent = 'Online';
      } else {
        statusToggle.classList.remove('online');
        statusText.textContent = 'Offline';
      }
    }

    // Toggle online status
    function toggleOnlineStatus() {
      // Don't allow going offline if there's an active ride
      if (isOnline && rideState !== 'idle') {
        showToast('Cannot go offline during active ride', 'error');
        return;
      }
      
      isOnline = !isOnline;
      updateOnlineStatus(isOnline);
      
      if (isOnline) {
        showToast('‚úì You are now online', 'success');
        document.getElementById('empty-state').classList.remove('show');
        listenForRideRequests();
      } else {
        showToast('You are now offline', 'error');
        if (rideState === 'idle') {
          document.getElementById('empty-state').classList.add('show');
          // Stop listening for ride requests
          if (rideRequestsListener) {
            rideRequestsListener.off();
            rideRequestsListener = null;
          }
        }
      }
      
      if (database) {
        database.ref(`evplan/drivers/${driverData.id}`).update({
          isOnline: isOnline,
          lastSeen: firebase.database.ServerValue.TIMESTAMP,
          location: driverData.currentLocation
        });
        
        if (isOnline) {
          updateDriverLocation();
        }
      }
    }

    // Listen for ride requests
    function listenForRideRequests() {
      if (!database || rideState !== 'idle') return;
      
      // Don't create duplicate listeners
      if (rideRequestsListener) {
        return;
      }
      
      const rideRequestsRef = database.ref('evplan/rideRequests');
      rideRequestsListener = rideRequestsRef;
      
      rideRequestsRef.on('child_added', (snapshot) => {
        if (!isOnline || rideState !== 'idle') return;
        
        const request = snapshot.val();
        
        if (request.status === 'searching' && 
            request.vehicleType === driverData.vehicleType &&
            !request.assignedDriverId) {
          
          currentRideRequest = request;
          currentRideRequestRef = snapshot.ref;
          currentRideId = snapshot.key;
          
          displayRideRequest(request);
        }
      });
      
      rideRequestsRef.on('child_changed', (snapshot) => {
        const request = snapshot.val();
        
        if (request.status === 'cancelled' && snapshot.key === currentRideId) {
          hideRideRequest();
          showToast('Ride request was cancelled', 'error');
        }
      });
    }

    function displayRideRequest(request) {
      document.getElementById('empty-state').classList.remove('show');
      
      const customerName = request.riderName || 'Customer';
      document.getElementById('customer-name').textContent = customerName;
      document.getElementById('customer-avatar').textContent = customerName.charAt(0).toUpperCase();
      
      const tripTypeText = request.tripType === 'roundtrip' ? 'Round Trip' : 'One Way Trip';
      document.getElementById('trip-type').textContent = tripTypeText;
      
      document.getElementById('request-pickup').textContent = request.pickup.address;
      document.getElementById('request-dropoff').textContent = request.dropoff.address;
      
      document.getElementById('request-distance').textContent = request.distance + ' km';
      document.getElementById('request-duration').textContent = request.duration + ' hrs';
      document.getElementById('request-fare').textContent = '‚Çπ' + request.fareEstimate;
      
      document.getElementById('ride-request-card').classList.add('show');
      
      playNotificationSound();
    }

    function hideRideRequest() {
      document.getElementById('ride-request-card').classList.remove('show');
      currentRideRequest = null;
      currentRideRequestRef = null;
      currentRideId = null;
      
      if (isOnline && rideState === 'idle') {
        document.getElementById('empty-state').classList.add('show');
      }
    }

    async function acceptRide() {
      if (!currentRideRequestRef || !currentRideRequest) {
        showToast('No ride request to accept', 'error');
        return;
      }

      try {
        await currentRideRequestRef.update({
          status: 'accepted',
          assignedDriverId: driverData.id,
          assignedDriverName: driverData.name,
          assignedDriverPhone: driverData.phone,
          assignedDriverVehicle: driverData.vehicle,
          driverLocation: driverData.currentLocation,
          tripStage: 'going_to_pickup',
          acceptedAt: firebase.database.ServerValue.TIMESTAMP
        });

        showToast('‚úì Ride accepted!', 'success');
        
        document.getElementById('ride-request-card').classList.remove('show');
        
        rideState = 'going_to_pickup';
        
        // Stop listening for new ride requests
        if (rideRequestsListener) {
          rideRequestsListener.off();
          rideRequestsListener = null;
        }
        
        // Start listening to this specific ride
        listenToActiveRide(currentRideRequestRef);
        
        showActiveRide();
        
      } catch (error) {
        console.error('Error accepting ride:', error);
        showToast('Error accepting ride: ' + error.message, 'error');
      }
    }

    async function rejectRide() {
      if (!currentRideRequestRef) {
        showToast('No ride request to reject', 'error');
        return;
      }

      try {
        showToast('Ride rejected', 'success');
        hideRideRequest();
      } catch (error) {
        console.error('Error rejecting ride:', error);
        showToast('Error rejecting ride: ' + error.message, 'error');
      }
    }

    function showActiveRide() {
      document.getElementById('active-ride-card').classList.add('show');
      document.getElementById('empty-state').classList.remove('show');
      
      updateRideState('going_to_pickup');
      
      setTimeout(() => {
        google.maps.event.trigger(activeRideMap, 'resize');
        showRouteOnMap();
      }, 100);
    }

    function updateRideState(state) {
      rideState = state;
      
      document.getElementById('step-pickup').classList.remove('active', 'completed');
      document.getElementById('step-journey').classList.remove('active', 'completed');
      document.getElementById('step-complete').classList.remove('active', 'completed');
      
      const actionBtn = document.getElementById('primary-action-btn');
      const actionText = document.getElementById('action-btn-text');
      const statusIcon = document.getElementById('status-icon');
      const statusTitle = document.getElementById('ride-status-title');
      const statusSubtitle = document.getElementById('ride-status-subtitle');
      
      if (currentRideRequest) {
        document.getElementById('pickup-address').textContent = currentRideRequest.pickup.address;
        document.getElementById('dropoff-address').textContent = currentRideRequest.dropoff.address;
      }
      
      // Disable online/offline toggle during active ride
      const statusToggle = document.getElementById('status-toggle');
      if (state !== 'idle') {
        statusToggle.classList.add('disabled');
      } else {
        statusToggle.classList.remove('disabled');
      }
      
      switch (state) {
        case 'going_to_pickup':
          document.getElementById('step-pickup').classList.add('active');
          statusIcon.textContent = 'üìç';
          statusTitle.textContent = 'Going to Pickup';
          statusSubtitle.textContent = 'Navigate to customer location';
          actionText.textContent = 'Reached Pickup Point';
          actionBtn.className = 'primary-action-btn';
          break;
          
        case 'at_pickup':
          document.getElementById('step-pickup').classList.add('completed');
          document.getElementById('step-journey').classList.add('active');
          statusIcon.textContent = 'üöó';
          statusTitle.textContent = 'At Pickup Point';
          statusSubtitle.textContent = 'Customer is boarding';
          actionText.textContent = 'Start Journey';
          actionBtn.className = 'primary-action-btn';
          break;
          
        case 'in_journey':
          document.getElementById('step-pickup').classList.add('completed');
          document.getElementById('step-journey').classList.add('completed');
          document.getElementById('step-complete').classList.add('active');
          statusIcon.textContent = 'üéØ';
          statusTitle.textContent = 'In Journey';
          statusSubtitle.textContent = 'Heading to destination';
          actionText.textContent = 'Complete Ride';
          actionBtn.className = 'primary-action-btn';
          break;
      }
    }

    async function handlePrimaryAction() {
      const actionBtn = document.getElementById('primary-action-btn');
      
      actionBtn.disabled = true;
      const originalHTML = actionBtn.innerHTML;
      actionBtn.innerHTML = '<div class="spinner"></div> Processing...';
      
      try {
        switch (rideState) {
          case 'going_to_pickup':
            if (currentRideRequestRef) {
              await currentRideRequestRef.update({
                tripStage: 'at_pickup',
                reachedPickupAt: firebase.database.ServerValue.TIMESTAMP
              });
            }
            showToast('‚úì Marked as reached pickup', 'success');
            updateRideState('at_pickup');
            break;
            
          case 'at_pickup':
            if (currentRideRequestRef) {
              await currentRideRequestRef.update({
                tripStage: 'in_journey',
                journeyStartedAt: firebase.database.ServerValue.TIMESTAMP
              });
            }
            showToast('‚úì Journey started', 'success');
            updateRideState('in_journey');
            showRouteToDestination();
            break;
            
          case 'in_journey':
            await completeRide();
            break;
        }
      } catch (error) {
        console.error('Error handling action:', error);
        showToast('Error: ' + error.message, 'error');
      } finally {
        actionBtn.disabled = false;
        actionBtn.innerHTML = originalHTML;
      }
    }

    async function completeRide() {
      if (!currentRideRequest || !database || !currentRideRequestRef) return;
      
      try {
        const snapshot = await currentRideRequestRef.once('value');
        const rideData = snapshot.val();
        const bookingId = rideData.bookingId;
        
        await currentRideRequestRef.update({
          status: 'completed',
          tripStage: 'completed',
          completedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        if (bookingId) {
          await database.ref(`evplan/bookings/${bookingId}`).update({
            status: 'completed',
            tripStage: 'completed',
            completedAt: firebase.database.ServerValue.TIMESTAMP
          });
        }
        
        driverData.todayEarnings += currentRideRequest.fareEstimate;
        driverData.totalRides += 1;
        updateStats();
        
        const earningsUpdate = {
          amount: currentRideRequest.fareEstimate,
          bookingId: bookingId || currentRideId,
          rideRequestId: currentRideId,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          status: 'unpaid'
        };
        
        await database.ref(`evplan/driverEarnings/${driverData.id}`).push(earningsUpdate);
        
        await database.ref(`evplan/drivers/${driverData.id}`).update({
          todayEarnings: driverData.todayEarnings,
          totalRides: driverData.totalRides,
          lastRideCompletedAt: firebase.database.ServerValue.TIMESTAMP
        });
        
        showToast('üéâ Ride completed! ‚Çπ' + currentRideRequest.fareEstimate + ' earned', 'success');
        
        setTimeout(() => {
          resetToIdle();
        }, 2000);
        
      } catch (error) {
        console.error('Error completing ride:', error);
        showToast('Error completing ride: ' + error.message, 'error');
      }
    }

    function showRouteOnMap() {
      if (!currentRideRequest || !driverData.currentLocation) return;
      
      const origin = driverData.currentLocation;
      const destination = {
        lat: currentRideRequest.pickup.lat,
        lng: currentRideRequest.pickup.lng
      };
      
      directionsService.route({
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        } else {
          console.error('Directions request failed:', status);
        }
      });
    }

    function showRouteToDestination() {
      if (!currentRideRequest) return;
      
      const origin = {
        lat: currentRideRequest.pickup.lat,
        lng: currentRideRequest.pickup.lng
      };
      const destination = {
        lat: currentRideRequest.dropoff.lat,
        lng: currentRideRequest.dropoff.lng
      };
      
      directionsService.route({
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      }, (result, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(result);
        }
      });
    }

    function openNavigation() {
      if (!currentRideRequest) return;
      
      let lat, lng;
      
      if (rideState === 'going_to_pickup' || rideState === 'at_pickup') {
        lat = currentRideRequest.pickup.lat;
        lng = currentRideRequest.pickup.lng;
      } else {
        lat = currentRideRequest.dropoff.lat;
        lng = currentRideRequest.dropoff.lng;
      }
      
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
      window.open(url, '_blank');
    }

    function playNotificationSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (error) {
        console.log('Audio notification not supported');
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('Page visible - checking state...');
        
        // If we're in an active ride, refresh the map
        if (rideState !== 'idle' && activeRideMap) {
          setTimeout(() => {
            google.maps.event.trigger(activeRideMap, 'resize');
            if (rideState === 'going_to_pickup' || rideState === 'at_pickup') {
              showRouteOnMap();
            } else if (rideState === 'in_journey') {
              showRouteToDestination();
            }
          }, 300);
        }
        
        // Update location if online
        if (isOnline) {
          updateDriverLocation();
        }
      }
    });

    // Handle beforeunload to warn about active rides
    window.addEventListener('beforeunload', (e) => {
      if (rideState !== 'idle') {
        e.preventDefault();
        e.returnValue = 'You have an active ride. Are you sure you want to leave?';
        return e.returnValue;
      }
    });
  </script>
</body>
</html>
