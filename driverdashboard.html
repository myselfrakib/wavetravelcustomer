<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Driver Dashboard - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #10b981;
      --primary-dark: #059669;
      --success: #10b981;
      --success-dark: #059669;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --dark: #0f172a;
      --dark-light: #1e293b;
      --gray: #64748b;
      --gray-light: #e2e8f0;
      --white: #ffffff;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
      min-height: 100vh;
      color: var(--dark);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      position: relative;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--white);
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.3);
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 24px 20px;
      color: var(--white);
      box-shadow: var(--shadow-xl);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
    }
    
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 12px;
    }
    
    .hamburger-btn {
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: all var(--transition-base);
      flex-shrink: 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .hamburger-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .hamburger-btn:active {
      transform: scale(0.95);
    }
    
    .hamburger-line {
      width: 20px;
      height: 2.5px;
      background: var(--white);
      border-radius: 2px;
      transition: all var(--transition-base);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(1) {
      transform: translateY(7.5px) rotate(45deg);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(2) {
      opacity: 0;
      transform: translateX(-10px);
    }
    
    .hamburger-btn.active .hamburger-line:nth-child(3) {
      transform: translateY(-7.5px) rotate(-45deg);
    }
    
    .driver-info {
      display: flex;
      align-items: center;
      gap: 14px;
      flex: 1;
      min-width: 0;
    }
    
    .driver-avatar {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 800;
      border: 2px solid rgba(255, 255, 255, 0.5);
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .driver-details {
      flex: 1;
      min-width: 0;
    }
    
    .driver-details h2 {
      font-size: 1.15rem;
      font-weight: 800;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .driver-details p {
      font-size: 0.8rem;
      opacity: 0.9;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .status-toggle {
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 30px;
      padding: 10px 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-base);
      flex-shrink: 0;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    
    .status-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
      opacity: 0;
      transition: opacity var(--transition-base);
    }
    
    .status-toggle:hover::before {
      opacity: 1;
    }
    
    .status-toggle:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    
    .status-toggle.online {
      background: var(--white);
      color: var(--success);
      border-color: var(--white);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .status-toggle.online:hover {
      background: #f0fdf4;
    }
    
    .status-toggle.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .status-dot {
      width: 11px;
      height: 11px;
      border-radius: 50%;
      background: var(--white);
      transition: all var(--transition-base);
    }
    
    .status-toggle.online .status-dot {
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
      animation: pulse-dot 2s infinite;
    }
    
    @keyframes pulse-dot {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 14px 12px;
      text-align: center;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all var(--transition-base);
    }
    
    .stat-card:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stat-value {
      font-size: 1.4rem;
      font-weight: 900;
      display: block;
      margin-bottom: 4px;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .stat-label {
      font-size: 0.7rem;
      opacity: 0.95;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      position: relative;
    }
    
    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 80px 20px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading-spinner {
      border: 4px solid var(--gray-light);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    /* Permission Banner */
    .permission-banner {
      background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      border: 2px solid #fbbf24;
      display: none;
      animation: slideDown 0.3s ease;
    }
    
    .permission-banner.show {
      display: block;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .permission-banner h3 {
      font-size: 1.1rem;
      font-weight: 800;
      color: #78350f;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .permission-banner p {
      font-size: 0.9rem;
      color: #78350f;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .permission-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .permission-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    /* Connection Banner */
    .connection-banner {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 2px solid #ef4444;
      position: sticky;
      top: 0;
      z-index: 90;
      display: none;
    }
    
    .connection-banner.show {
      display: flex;
      animation: slideDown 0.3s ease;
    }
    
    .connection-banner i {
      font-size: 1.2rem;
      color: #dc2626;
    }
    
    .connection-banner p {
      flex: 1;
      font-size: 0.875rem;
      font-weight: 700;
      color: #dc2626;
    }
    
    /* Ride Request Card */
    .ride-request-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde047 100%);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 30px rgba(251, 191, 36, 0.4);
      border: 2px solid #fbbf24;
      animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      display: none;
      position: relative;
      overflow: hidden;
    }
    
    .ride-request-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .ride-request-card.show {
      display: block;
    }
    
    @keyframes slideInBounce {
      0% { opacity: 0; transform: translateY(30px) scale(0.95); }
      60% { transform: translateY(-5px) scale(1.02); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .request-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    
    .request-badge {
      background: var(--danger);
      color: var(--white);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: pulse-badge 2s infinite;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .request-time {
      font-size: 0.8rem;
      color: #78350f;
      font-weight: 700;
    }
    
    .customer-info {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--white);
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      position: relative;
      z-index: 1;
    }
    
    .customer-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 1.3rem;
      font-weight: 800;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .customer-details {
      flex: 1;
      min-width: 0;
    }
    
    .customer-details h3 {
      font-size: 1rem;
      font-weight: 800;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .customer-details p {
      font-size: 0.75rem;
      color: var(--gray);
      font-weight: 600;
    }
    
    .ride-details {
      background: var(--white);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
      position: relative;
      z-index: 1;
    }
    
    .location-row {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 16px;
      position: relative;
    }
    
    .location-row:last-child {
      margin-bottom: 0;
    }
    
    .location-row:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 15px;
      top: 40px;
      bottom: -16px;
      width: 2px;
      background: linear-gradient(to bottom, var(--success) 0%, var(--danger) 100%);
      opacity: 0.3;
    }
    
    .location-icon {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 1.1rem;
      box-shadow: var(--shadow-sm);
    }
    
    .location-icon.pickup {
      background: #d1fae5;
      color: var(--success-dark);
    }
    
    .location-icon.dropoff {
      background: #fee2e2;
      color: var(--danger-dark);
    }
    
    .location-text {
      flex: 1;
      min-width: 0;
    }
    
    .location-label {
      font-size: 0.7rem;
      color: var(--gray);
      font-weight: 700;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .location-address {
      font-size: 0.875rem;
      color: var(--dark);
      font-weight: 600;
      line-height: 1.5;
    }
    
    .ride-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    
    .ride-stat {
      background: var(--white);
      border-radius: 14px;
      padding: 14px 12px;
      text-align: center;
      border: 2px solid var(--gray-light);
      transition: all var(--transition-base);
    }
    
    .ride-stat:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .ride-stat-value {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--primary);
      display: block;
      margin-bottom: 4px;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .ride-stat-label {
      font-size: 0.7rem;
      color: var(--gray);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    
    .btn {
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 0.95rem;
      font-weight: 800;
      font-family: 'Outfit', sans-serif;
      cursor: pointer;
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .btn-reject {
      background: var(--white);
      color: var(--danger);
      border: 2px solid var(--danger);
    }
    
    .btn-reject:hover {
      background: #fef2f2;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3);
    }
    
    .btn-accept {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: var(--white);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    .btn-accept:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 24px rgba(16, 185, 129, 0.5);
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    /* Active Ride Card */
    .active-ride-card {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
      border: 2px solid var(--primary);
      display: none;
      animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .active-ride-card.show {
      display: block;
    }
    
    .ride-status-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .status-icon {
      width: 72px;
      height: 72px;
      background: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 2.2rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    .ride-status-title {
      font-size: 1.3rem;
      font-weight: 900;
      color: #065f46;
      margin-bottom: 6px;
    }
    
    .ride-status-subtitle {
      font-size: 0.875rem;
      color: #065f46;
      opacity: 0.8;
      font-weight: 600;
    }
    
    .map-preview {
      background: var(--white);
      border-radius: 18px;
      height: 220px;
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
      box-shadow: var(--shadow-md);
    }
    
    #active-ride-map {
      width: 100%;
      height: 100%;
    }
    
    .navigation-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: var(--white);
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all var(--transition-base);
    }
    
    .navigation-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
    }
    
    .progress-steps {
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-md);
    }
    
    .step {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--gray-light);
      position: relative;
    }
    
    .step:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    
    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
      background: var(--gray-light);
      color: #9ca3af;
      transition: all var(--transition-base);
    }
    
    .step.completed .step-icon {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: var(--white);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      animation: checkmark 0.5s ease;
    }
    
    @keyframes checkmark {
      0% { transform: scale(0) rotate(-180deg); }
      50% { transform: scale(1.2) rotate(10deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    
    .step.active .step-icon {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.2);
      animation: pulse-step 2s infinite;
    }
    
    @keyframes pulse-step {
      0%, 100% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.2); }
      50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0.1); }
    }
    
    .step-text {
      flex: 1;
      min-width: 0;
    }
    
    .step-label {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 4px;
    }
    
    .step-time {
      font-size: 0.8rem;
      color: var(--gray);
      font-weight: 500;
      line-height: 1.4;
    }
    
    .step.active .step-label {
      color: var(--primary);
    }
    
    .primary-action-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: var(--white);
      border: none;
      border-radius: 16px;
      font-size: 1.05rem;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: 'Outfit', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .primary-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 32px rgba(16, 185, 129, 0.5);
    }
    
    .primary-action-btn:active {
      transform: scale(0.95);
    }
    
    .primary-action-btn.danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
    }
    
    .primary-action-btn.danger:hover {
      box-shadow: 0 12px 32px rgba(239, 68, 68, 0.5);
    }
    
    .primary-action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .empty-state.show {
      display: block;
    }
    
    .empty-icon {
      font-size: 5rem;
      margin-bottom: 24px;
      opacity: 0.6;
      animation: float 3s ease-in-out infinite;
    }
    
    .empty-title {
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--dark);
      margin-bottom: 12px;
    }
    
    .empty-subtitle {
      font-size: 0.95rem;
      color: var(--gray);
      line-height: 1.7;
      font-weight: 500;
      max-width: 300px;
      margin: 0 auto;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(-120px);
      background: var(--dark);
      color: var(--white);
      padding: 16px 24px;
      border-radius: 14px;
      box-shadow: 0 12px 48px rgba(0,0,0,0.4);
      z-index: 3000;
      font-weight: 700;
      opacity: 0;
      transition: all var(--transition-slow);
      max-width: 90%;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.error {
      background: var(--danger);
    }
    
    .toast.success {
      background: var(--success);
    }
    
    /* Loading Spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid var(--white);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    
    /* Sidebar Navigation */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
    }
    
    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 300px;
      max-width: 85vw;
      background: var(--white);
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform var(--transition-slow) cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: 6px 0 32px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar.active {
      transform: translateX(0);
    }
    
    .sidebar-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 28px 24px;
      color: var(--white);
    }
    
    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }
    
    .sidebar-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      font-weight: 900;
      border: 3px solid rgba(255, 255, 255, 0.4);
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    .sidebar-user-info {
      flex: 1;
      min-width: 0;
    }
    
    .sidebar-user-name {
      font-size: 1.15rem;
      font-weight: 800;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .sidebar-user-phone {
      font-size: 0.8rem;
      opacity: 0.95;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .sidebar-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 16px;
    }
    
    .sidebar-stat {
      background: rgba(255, 255, 255, 0.15);
      padding: 12px;
      border-radius: 12px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-stat-value {
      font-size: 1.3rem;
      font-weight: 900;
      display: block;
      margin-bottom: 4px;
      font-family: 'JetBrains Mono', monospace;
    }
    
    .sidebar-stat-label {
      font-size: 0.7rem;
      opacity: 0.95;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 16px 0;
      overflow-y: auto;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      color: #334155;
      text-decoration: none;
      transition: all var(--transition-base);
      font-weight: 700;
      font-size: 0.95rem;
      border-left: 4px solid transparent;
      cursor: pointer;
    }
    
    .nav-item:hover {
      background: #f8fafc;
      border-left-color: var(--primary);
      padding-left: 28px;
    }
    
    .nav-item.active {
      background: #f0fdf4;
      border-left-color: var(--primary);
      color: var(--primary);
    }
    
    .nav-item i {
      font-size: 1.3rem;
      width: 28px;
      text-align: center;
    }
    
    .nav-divider {
      height: 1px;
      background: var(--gray-light);
      margin: 12px 24px;
    }
    
    .sidebar-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--gray-light);
    }
    
    .logout-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: var(--white);
      border: none;
      border-radius: 14px;
      font-size: 0.95rem;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.3);
      transition: all var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-family: 'Outfit', sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }
    
    .logout-btn:active {
      transform: scale(0.95);
    }
    
    /* Responsive */
    @media (max-width: 400px) {
      .stat-value { font-size: 1.2rem; }
      .stat-label { font-size: 0.65rem; }
      .ride-status-title { font-size: 1.1rem; }
      .empty-icon { font-size: 4rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="connection-banner" id="connection-banner">
      <i class="fas fa-wifi"></i>
      <p>Reconnecting to server...</p>
    </div>
    
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-user">
          <div class="sidebar-avatar" id="sidebar-avatar">D</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="sidebar-user-name">Loading...</div>
            <div class="sidebar-user-phone" id="sidebar-user-phone">+91 00000 00000</div>
          </div>
        </div>
        
        <div class="sidebar-stats">
          <div class="sidebar-stat">
            <span class="sidebar-stat-value" id="sidebar-earnings">‚Çπ0</span>
            <span class="sidebar-stat-label">Today</span>
          </div>
          <div class="sidebar-stat">
            <span class="sidebar-stat-value" id="sidebar-rides">0</span>
            <span class="sidebar-stat-label">Rides</span>
          </div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" onclick="navigateTo('home')">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </a>
        <a href="drivermybookings.html" class="nav-item">
          <i class="fas fa-history"></i>
          <span>My Rides</span>
        </a>
        <div class="nav-divider"></div>
        <a href="driverprofile.html" class="nav-item">
          <i class="fas fa-user-circle"></i>
          <span>Profile</span>
        </a>
        <a href="#" class="nav-item" onclick="showEarnings()">
          <i class="fas fa-wallet"></i>
          <span>Earnings</span>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="handleLogout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
    
    <div class="header">
      <div class="header-top">
        <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        
        <div class="driver-info">
          <div class="driver-avatar" id="driver-avatar">D</div>
          <div class="driver-details">
            <h2 id="driver-name">Loading...</h2>
            <p id="driver-vehicle">Please wait...</p>
          </div>
        </div>
        <div class="status-toggle" id="status-toggle" onclick="toggleOnlineStatus()">
          <span class="status-dot"></span>
          <span id="status-text">Offline</span>
        </div>
      </div>
      
      <div class="stats-row">
        <div class="stat-card">
          <span class="stat-value" id="today-earnings">‚Çπ0</span>
          <span class="stat-label">Today</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="total-rides">0</span>
          <span class="stat-label">Rides</span>
        </div>
        <div class="stat-card">
          <span class="stat-value" id="rating">5.0</span>
          <span class="stat-label">Rating</span>
        </div>
      </div>
    </div>

    <div class="main-content" id="main-content">
      <div class="permission-banner" id="permission-banner">
        <h3><i class="fas fa-map-marker-alt"></i> Location Access Required</h3>
        <p>We need your location to match you with nearby riders and provide navigation.</p>
        <button class="permission-btn" onclick="requestLocationPermission()">
          <i class="fas fa-check-circle"></i> Grant Location Access
        </button>
      </div>
      
      <div class="loading-state" id="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Dashboard...</div>
      </div>

      <div class="empty-state" id="empty-state">
        <div class="empty-icon">üöó</div>
        <div class="empty-title">Ready to Drive?</div>
        <div class="empty-subtitle">
          Go online to start receiving ride requests from customers
        </div>
      </div>

      <div class="ride-request-card" id="ride-request-card">
        <div class="request-header">
          <div class="request-badge">
            <i class="fas fa-bell"></i>
            NEW REQUEST
          </div>
          <div class="request-time" id="request-time">Just now</div>
        </div>
        
        <div class="customer-info">
          <div class="customer-avatar" id="customer-avatar">C</div>
          <div class="customer-details">
            <h3 id="customer-name">Customer Name</h3>
            <p id="trip-type">One Way Trip</p>
          </div>
        </div>
        
        <div class="ride-details">
          <div class="location-row">
            <div class="location-icon pickup">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="location-text">
              <div class="location-label">PICKUP LOCATION</div>
              <div class="location-address" id="request-pickup">Loading...</div>
            </div>
          </div>
          
          <div class="location-row">
            <div class="location-icon dropoff">
              <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="location-text">
              <div class="location-label">DROP-OFF LOCATION</div>
              <div class="location-address" id="request-dropoff">Loading...</div>
            </div>
          </div>
        </div>
        
        <div class="ride-stats">
          <div class="ride-stat">
            <span class="ride-stat-value" id="request-distance">--</span>
            <span class="ride-stat-label">Distance</span>
          </div>
          <div class="ride-stat">
            <span class="ride-stat-value" id="request-duration">--</span>
            <span class="ride-stat-label">Duration</span>
          </div>
          <div class="ride-stat">
            <span class="ride-stat-value" id="request-fare">--</span>
            <span class="ride-stat-label">Fare</span>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-reject" onclick="rejectRide()">
            <i class="fas fa-times"></i>
            Reject
          </button>
          <button class="btn btn-accept" id="accept-btn" onclick="acceptRide()">
            <i class="fas fa-check"></i>
            Accept
          </button>
        </div>
      </div>

      <div class="active-ride-card" id="active-ride-card">
        <div class="ride-status-header">
          <div class="status-icon" id="status-icon">üìç</div>
          <div class="ride-status-title" id="ride-status-title">Going to Pickup</div>
          <div class="ride-status-subtitle" id="ride-status-subtitle">Navigate to customer location</div>
        </div>
        
        <div class="map-preview">
          <div id="active-ride-map"></div>
          <button class="navigation-btn" onclick="openNavigation()">
            <i class="fas fa-directions"></i>
            Navigate
          </button>
        </div>
        
        <div class="progress-steps">
          <div class="step active" id="step-pickup">
            <div class="step-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="step-text">
              <div class="step-label">Reach Pickup Point</div>
              <div class="step-time" id="pickup-address">Loading...</div>
            </div>
          </div>
          
          <div class="step" id="step-journey">
            <div class="step-icon">
              <i class="fas fa-car"></i>
            </div>
            <div class="step-text">
              <div class="step-label">Start Journey</div>
              <div class="step-time">Pick up customer</div>
            </div>
          </div>
          
          <div class="step" id="step-complete">
            <div class="step-icon">
              <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="step-text">
              <div class="step-label">Complete Ride</div>
              <div class="step-time" id="dropoff-address">Loading...</div>
            </div>
          </div>
        </div>
        
        <button class="primary-action-btn" id="primary-action-btn" onclick="handlePrimaryAction()">
          <i class="fas fa-check-circle"></i>
          <span id="action-btn-text">Reached Pickup</span>
        </button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc&libraries=places&loading=async&callback=initMap"></script>
  
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    let app, auth, database;
    let activeRideMap, directionsService, directionsRenderer;
    let isOnline = false;
    let currentRideRequest = null;
    let currentRideRequestRef = null;
    let currentRideId = null;
    let rideState = 'idle';
    let activeRideListener = null;
    let rideRequestsListener = null;
    let driverStatusRef = null;
    let locationWatchId = null;
    let locationPermissionGranted = false;
    let isAcceptingRide = false; // NEW: Prevent multiple accept clicks

    // Driver Data Object
    const driverData = {
      id: null,
      name: '',
      phone: '',
      email: '',
      vehicle: '',
      vehicleReg: '',
      vehicleType: '',
      rating: 5.0,
      todayEarnings: 0,
      totalRides: 0,
      currentLocation: { lat: 22.5954, lng: 88.4385 }
    };

    function showLoadingState() {
      const loadingEl = document.getElementById('loading-state');
      const emptyEl = document.getElementById('empty-state');
      const requestEl = document.getElementById('ride-request-card');
      const activeEl = document.getElementById('active-ride-card');

      if (loadingEl) loadingEl.style.display = 'block';
      if (emptyEl) emptyEl.classList.remove('show');
      if (requestEl) requestEl.classList.remove('show');
      if (activeEl) activeEl.classList.remove('show');
    }

    function hideLoadingState() {
      const loadingEl = document.getElementById('loading-state');
      if (loadingEl) loadingEl.style.display = 'none';
    }

    // Initialize Firebase and Map
    window.initMap = function() {
      if (typeof google === 'undefined') return;
      
      activeRideMap = new google.maps.Map(document.getElementById('active-ride-map'), {
        center: { lat: 22.5726, lng: 88.3639 },
        zoom: 14,
        disableDefaultUI: true,
        styles: [ { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] } ]
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: activeRideMap,
        suppressMarkers: false,
        polylineOptions: { strokeColor: '#10b981', strokeWeight: 5 }
      });
      
      console.log('‚úÖ Google Maps initialized');
    };

    // Initialize on Load
    window.addEventListener('load', async () => {
      showLoadingState();
      
      try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        database = firebase.database();
        console.log('‚úÖ Firebase initialized');

        auth.onAuthStateChanged(async (user) => {
          if (user) {
            driverData.id = user.uid;
            driverData.email = user.email;
            await loadDriverFromDatabase();
            setupConnectionMonitoring();
            checkLocationPermission();
            setupVisibilityHandlers();
          } else {
            console.log('No user signed in');
            const params = new URLSearchParams(window.location.search);
            const urlDriverId = params.get('driverId');
            if (urlDriverId) {
                driverData.id = urlDriverId;
                console.log('Using URL Driver ID:', driverData.id);
                await loadDriverFromDatabase();
                setupConnectionMonitoring();
                setupVisibilityHandlers();
            } else {
                window.location.href = 'driverlogin.html';
            }
          }
        });

      } catch (error) {
        console.error('Initialization error:', error);
        showToast('Error connecting to server', 'error');
        hideLoadingState();
      }
    });

    // Handle app visibility changes (when driver returns from map app)
    function setupVisibilityHandlers() {
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('focus', handleAppFocus);
      window.addEventListener('pageshow', handlePageShow);
      
      console.log('üëÅÔ∏è Visibility handlers setup');
    }

    function handleVisibilityChange() {
      if (document.hidden) {
        console.log('üì± App went to background');
      } else {
        console.log('üì± App came to foreground');
        handleAppReturn();
      }
    }

    function handleAppFocus() {
      console.log('üîÑ App gained focus');
      handleAppReturn();
    }

    function handlePageShow(event) {
      if (event.persisted) {
        console.log('üîÑ Page loaded from cache');
        handleAppReturn();
      }
    }

    async function handleAppReturn() {
      console.log('üîô Driver returned to dashboard');
      
      try {
        // 1. Re-sync online status from database
        if (driverStatusRef) {
          const statusSnap = await driverStatusRef.once('value');
          const status = statusSnap.val();
          
          if (status) {
            const dbIsOnline = status.isOnline === true;
            if (dbIsOnline !== isOnline) {
              isOnline = dbIsOnline;
              updateOnlineStatus(isOnline);
            }
            
            driverData.todayEarnings = parseFloat(status.todayEarnings) || 0;
            driverData.totalRides = parseInt(status.totalRides) || 0;
            updateStatsUI();
          }
        }
        
        // 2. Check for active ride
        if (rideState === 'idle' && !currentRideId) {
          await checkForActiveRide();
        } else if (currentRideId && currentRideRequestRef) {
          const rideSnap = await currentRideRequestRef.once('value');
          const rideData = rideSnap.val();
          
          if (rideData) {
            if (rideData.status === 'cancelled' || rideData.status === 'completed') {
              showToast('Ride status updated', 'success');
              document.getElementById('active-ride-card').classList.remove('show');
              rideState = 'idle';
              currentRideRequest = null;
              currentRideId = null;
              currentRideRequestRef = null;
              
              if (isOnline) {
                document.getElementById('empty-state').classList.remove('show');
                listenForRideRequests();
              } else {
                document.getElementById('empty-state').classList.add('show');
              }
            } else {
              currentRideRequest = rideData;
              const stage = rideData.tripStage || 'going_to_pickup';
              updateRideState(stage);
              
              setTimeout(() => {
                if (typeof google !== 'undefined' && activeRideMap) {
                  google.maps.event.trigger(activeRideMap, 'resize');
                  if (stage === 'in_journey') {
                    showRouteToDestination();
                  } else {
                    showRouteOnMap();
                  }
                }
              }, 300);
            }
          }
        }
        
        // 3. Restart location tracking if online
        if (isOnline && !locationWatchId && navigator.geolocation) {
          locationWatchId = navigator.geolocation.watchPosition(pos => {
            driverData.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            if(driverStatusRef) driverStatusRef.update({ location: driverData.currentLocation });
            if (rideState !== 'idle' && currentRideRequestRef) {
              currentRideRequestRef.update({ driverLocation: driverData.currentLocation });
            }
          }, null, { enableHighAccuracy: true });
        }
        
        // 4. Ensure ride listeners are active
        if (isOnline && rideState === 'idle' && !rideRequestsListener) {
          listenForRideRequests();
        }
        
        console.log('‚úÖ App state restored');
        
      } catch (error) {
        console.error('Error restoring app state:', error);
        showToast('Syncing data...', 'error');
      }
    }

    window.addEventListener('beforeunload', () => {
      if (activeRideListener) activeRideListener.off();
      if (rideRequestsListener) rideRequestsListener.off();
      if (locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
    });

    async function loadDriverFromDatabase() {
      if (!database || !driverData.id) return;

      try {
        console.log('üì• Loading driver data for:', driverData.id);
        
        const profileRef = database.ref(`driverdetails/${driverData.id}`);
        const profileSnap = await profileRef.once('value');
        const profile = profileSnap.val();

        const statusRef = database.ref(`evplan/drivers/${driverData.id}`);
        const statusSnap = await statusRef.once('value');
        const status = statusSnap.val();

        if (!profile && !status) {
          showToast('Driver profile not found.', 'error');
          hideLoadingState();
          return;
        }

        driverData.name = (profile && profile.name) || (status && status.name) || 'Driver';
        driverData.phone = (profile && profile.phone) || (status && status.phone) || '';
        
        if (status && status.car) {
          driverData.vehicle = status.car.name || 'Vehicle';
          driverData.vehicleType = status.car.vehicleType || 'sedan';
        } else if (status && status.assignedDriverVehicle) {
             const parts = status.assignedDriverVehicle.split('‚Ä¢');
             driverData.vehicle = parts[0] || 'Vehicle';
             driverData.vehicleType = 'sedan';
        } else {
            driverData.vehicle = 'Not Configured';
            driverData.vehicleType = 'sedan';
        }

        driverData.rating = (status && status.rating) || 5.0;
        driverData.todayEarnings = parseFloat(status && status.todayEarnings) || 0;
        driverData.totalRides = parseInt(status && status.totalRides) || 0;

        driverStatusRef = database.ref(`evplan/drivers/${driverData.id}`);

        if (status && status.isOnline === true) {
          isOnline = true;
          updateOnlineStatus(true);
        } else {
          isOnline = false;
          updateOnlineStatus(false);
        }

        syncOnlineStatusFromDB();

        initializeDriverUI();
        await checkForActiveRide();

      } catch (error) {
        console.error('Error loading driver:', error);
        showToast('Error loading profile', 'error');
        hideLoadingState();
      }
    }

    function syncOnlineStatusFromDB() {
      if (!driverStatusRef) return;
      
      driverStatusRef.child('isOnline').on('value', (snapshot) => {
        const dbOnlineStatus = snapshot.val();
        
        if (dbOnlineStatus !== isOnline) {
          isOnline = dbOnlineStatus === true;
          updateOnlineStatus(isOnline);
          
          console.log('üì° Online status synced from DB:', isOnline);
          
          if (isOnline && rideState === 'idle') {
            document.getElementById('empty-state').classList.remove('show');
            listenForRideRequests();
            
            if (navigator.geolocation && !locationWatchId) {
              locationWatchId = navigator.geolocation.watchPosition(pos => {
                driverData.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                if(driverStatusRef) driverStatusRef.update({ location: driverData.currentLocation });
                if (rideState !== 'idle' && currentRideRequestRef) {
                  currentRideRequestRef.update({ driverLocation: driverData.currentLocation });
                }
              }, null, { enableHighAccuracy: true });
            }
          } else if (!isOnline) {
            document.getElementById('empty-state').classList.add('show');
            if (rideRequestsListener) {
              rideRequestsListener.off();
              rideRequestsListener = null;
            }
            if (locationWatchId) {
              navigator.geolocation.clearWatch(locationWatchId);
              locationWatchId = null;
            }
          }
        }
      });
    }

    function initializeDriverUI() {
      document.getElementById('driver-name').textContent = driverData.name;
      document.getElementById('driver-vehicle').textContent = `${driverData.vehicle} (${driverData.vehicleType.toUpperCase()})`;
      document.getElementById('driver-avatar').textContent = driverData.name.charAt(0).toUpperCase();
      document.getElementById('rating').textContent = driverData.rating.toFixed(1);
      
      document.getElementById('sidebar-user-name').textContent = driverData.name;
      document.getElementById('sidebar-user-phone').textContent = driverData.phone;
      document.getElementById('sidebar-avatar').textContent = driverData.name.charAt(0).toUpperCase();
      
      updateStatsUI();
    }

    function updateStatsUI() {
      document.getElementById('today-earnings').textContent = '‚Çπ' + driverData.todayEarnings;
      document.getElementById('total-rides').textContent = driverData.totalRides;
      document.getElementById('sidebar-earnings').textContent = '‚Çπ' + driverData.todayEarnings;
      document.getElementById('sidebar-rides').textContent = driverData.totalRides;
    }

    async function checkForActiveRide() {
      if (!database) return;
      
      try {
        const rideRequestsRef = database.ref('evplan/rideRequests');
        const snapshot = await rideRequestsRef.orderByChild('assignedDriverId').equalTo(driverData.id).once('value');
        
        let foundActive = false;
        
        snapshot.forEach((child) => {
          const ride = child.val();
          if (ride.status === 'accepted' || ride.tripStage === 'going_to_pickup' || ride.tripStage === 'at_pickup' || ride.tripStage === 'in_journey') {
            if (ride.status !== 'completed' && ride.status !== 'cancelled') {
              foundActive = true;
              restoreActiveRide(child.key, ride);
            }
          }
        });
        
        if (!foundActive) {
          hideLoadingState();
          if (isOnline) {
             document.getElementById('empty-state').classList.remove('show');
             listenForRideRequests();
          } else {
             document.getElementById('empty-state').classList.add('show');
          }
        }
        
      } catch (error) {
        console.error('Error checking active rides:', error);
        hideLoadingState();
        document.getElementById('empty-state').classList.add('show');
      }
    }

    function restoreActiveRide(rideId, ride) {
      console.log('üîÑ Restoring active ride:', rideId, ride);
      
      currentRideId = rideId;
      currentRideRequest = ride;
      currentRideRequestRef = database.ref(`evplan/rideRequests/${rideId}`);
      
      hideLoadingState();
      
      if (!isOnline) {
          isOnline = true;
          updateOnlineStatus(true);
      }
      
      listenToActiveRide(currentRideRequestRef);
      
      const stage = ride.tripStage || 'going_to_pickup';
      updateRideState(stage);
      
      if (ride.pickup) {
        if (ride.pickup.address) {
          document.getElementById('pickup-address').textContent = ride.pickup.address;
        }
        console.log('Pickup location:', ride.pickup);
      } else {
        console.warn('‚ö†Ô∏è No pickup location in ride data');
      }
      
      if (ride.dropoff) {
        if (ride.dropoff.address) {
          document.getElementById('dropoff-address').textContent = ride.dropoff.address;
        }
        console.log('Dropoff location:', ride.dropoff);
      } else {
        console.warn('‚ö†Ô∏è No dropoff location in ride data');
      }
      
      document.getElementById('active-ride-card').classList.add('show');
      document.getElementById('empty-state').classList.remove('show');
      
      setTimeout(() => {
        if (typeof google !== 'undefined' && activeRideMap) {
            google.maps.event.trigger(activeRideMap, 'resize');
            
            if (stage === 'in_journey') {
                if (ride.pickup && ride.pickup.lat && ride.dropoff && ride.dropoff.lat) {
                  showRouteToDestination();
                } else {
                  console.warn('‚ö†Ô∏è Cannot show route - missing location coordinates');
                }
            } else {
                if (ride.pickup && ride.pickup.lat && driverData.currentLocation) {
                  showRouteOnMap();
                } else {
                  console.warn('‚ö†Ô∏è Cannot show route - missing pickup or driver location');
                }
            }
        }
      }, 500);
    }

    function listenForRideRequests() {
      if (!isOnline) return;
      if (rideRequestsListener) return;
      
      const rideRequestsRef = database.ref('evplan/rideRequests');
      rideRequestsListener = rideRequestsRef;
      
      console.log(`üéß Listening for ${driverData.vehicleType} requests...`);
      
      rideRequestsRef.on('child_added', (snapshot) => {
        if (!isOnline || rideState !== 'idle') return;
        
        const request = snapshot.val();
        
        if (request.status === 'searching' && 
            !request.assignedDriverId && 
            request.vehicleType === driverData.vehicleType) {
            
            currentRideRequest = request;
            currentRideRequestRef = snapshot.ref;
            currentRideId = snapshot.key;
            
            displayRideRequest(request);
            playNotificationSound();
        }
      });
      
      rideRequestsRef.on('child_changed', (snapshot) => {
         if (currentRideId === snapshot.key) {
             const val = snapshot.val();
             if (val.status === 'cancelled') {
                 hideRideRequest();
                 showToast('Request was cancelled by user', 'error');
             } else if (val.assignedDriverId && val.assignedDriverId !== driverData.id) {
                 // Another driver took this ride
                 console.log('‚ö†Ô∏è Ride assigned to another driver via listener');
                 hideRideRequest();
                 showToast('Request was accepted by another driver', 'error');
             } else if (val.bookingId && val.assignedDriverId !== driverData.id) {
                 // Booking exists for another driver
                 console.log('‚ö†Ô∏è Booking exists for another driver');
                 hideRideRequest();
             }
         }
      });
    }

    function displayRideRequest(request) {
      console.log('üìã Displaying ride request:', request);
      
      document.getElementById('empty-state').classList.remove('show');
      document.getElementById('customer-name').textContent = request.riderName || 'Customer';
      document.getElementById('customer-avatar').textContent = (request.riderName || 'C').charAt(0).toUpperCase();
      document.getElementById('trip-type').textContent = (request.tripType === 'roundtrip' ? 'Round Trip' : 'One Way') + ` ‚Ä¢ ${request.vehicleType.toUpperCase()}`;
      
      if (request.pickup && request.pickup.address) {
        document.getElementById('request-pickup').textContent = request.pickup.address;
        console.log('‚úì Pickup:', request.pickup);
      } else {
        document.getElementById('request-pickup').textContent = 'Location not available';
        console.warn('‚ö†Ô∏è Missing pickup location in request');
      }
      
      if (request.dropoff && request.dropoff.address) {
        document.getElementById('request-dropoff').textContent = request.dropoff.address;
        console.log('‚úì Dropoff:', request.dropoff);
      } else {
        document.getElementById('request-dropoff').textContent = 'Location not available';
        console.warn('‚ö†Ô∏è Missing dropoff location in request');
      }
      
      document.getElementById('request-distance').textContent = (request.distance || '--') + ' km';
      document.getElementById('request-duration').textContent = (request.duration || '--') + ' hrs';
      document.getElementById('request-fare').textContent = '‚Çπ' + (request.fareEstimate || 0);
      
      document.getElementById('ride-request-card').classList.add('show');
    }

    let lastAcceptAttempt = 0; // Global timestamp to track last accept attempt
    
    async function acceptRide() {
      if (!currentRideRequestRef || !currentRideRequest) return;
      
      // AGGRESSIVE DEBOUNCE: Prevent accepts within 5 seconds
      const now = Date.now();
      if (now - lastAcceptAttempt < 5000) {
        console.log('‚ö†Ô∏è Accept attempt too soon, ignoring (debounce)');
        return;
      }
      lastAcceptAttempt = now;
      
      // CRITICAL FIX: Prevent multiple clicks
      if (isAcceptingRide) {
        console.log('‚ö†Ô∏è Already processing accept request');
        return;
      }
      
      isAcceptingRide = true;
      const acceptBtn = document.getElementById('accept-btn');
      acceptBtn.disabled = true;
      acceptBtn.innerHTML = '<div class="spinner"></div> Accepting...';
      
      // Generate booking ID OUTSIDE transaction (so it's only generated once)
      const bookingId = database.ref('evplan/bookings').push().key;
      console.log('üìù Pre-generated booking ID:', bookingId);
      
      try {
        console.log('üîÑ Starting accept process for ride:', currentRideId);
        
        // CRITICAL CHECK: Verify this specific booking doesn't already exist
        const existingBookingCheck = await database.ref(`evplan/bookings/${bookingId}`).once('value');
        if (existingBookingCheck.exists()) {
          console.error('‚ö†Ô∏è Booking ID already exists in database!', bookingId);
          throw new Error('Booking collision detected, please try again');
        }
        
        // Use a transaction to atomically check and update the ride request
        const transactionResult = await currentRideRequestRef.transaction((currentData) => {
          if (currentData === null) {
            console.log('‚ö†Ô∏è Ride doesn\'t exist');
            return undefined; // Abort transaction
          }
          
          // Check if already assigned or has booking
          if (currentData.assignedDriverId || currentData.bookingId) {
            console.log('‚ö†Ô∏è Ride already assigned in transaction');
            return undefined; // Abort transaction
          }
          
          // Check if status is still searching
          if (currentData.status !== 'searching') {
            console.log('‚ö†Ô∏è Ride status changed in transaction:', currentData.status);
            return undefined; // Abort transaction
          }
          
          // Update the ride request data with pre-generated bookingId
          return {
            ...currentData,
            status: 'accepted',
            assignedDriverId: driverData.id,
            assignedDriverName: driverData.name,
            assignedDriverPhone: driverData.phone,
            assignedDriverVehicle: `${driverData.vehicle} ‚Ä¢ ${driverData.vehicleReg || 'WB02AJ7678'}`,
            driverLocation: driverData.currentLocation,
            tripStage: 'going_to_pickup',
            acceptedAt: firebase.database.ServerValue.TIMESTAMP,
            bookingId: bookingId  // Use pre-generated ID
          };
        });
        
        // Check if transaction was successful
        if (!transactionResult.committed) {
          console.log('‚ö†Ô∏è Transaction aborted - ride already taken');
          showToast('This ride was accepted by another driver', 'error');
          isAcceptingRide = false;
          lastAcceptAttempt = 0; // Reset debounce on failure
          hideRideRequest();
          return;
        }
        
        const updatedRideData = transactionResult.snapshot.val();
        console.log('‚úÖ Transaction committed successfully');
        
        // DOUBLE CHECK: Make sure booking doesn't exist before creating
        const finalBookingCheck = await database.ref(`evplan/bookings/${bookingId}`).once('value');
        if (finalBookingCheck.exists()) {
          console.error('‚ùå CRITICAL: Booking already exists! Aborting creation.');
          showToast('Ride already accepted', 'error');
          isAcceptingRide = false;
          lastAcceptAttempt = 0; // Reset debounce
          hideRideRequest();
          return;
        }
        
        console.log('‚úÖ Now creating booking record at:', `evplan/bookings/${bookingId}`);
        
        // Now create the booking record using the pre-generated bookingId
        const bookingData = {
            ...currentRideRequest,
            ...updatedRideData,
            rideRequestId: currentRideId,
            bookedAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        // Use .set() to create exactly ONE entry at this specific path
        await database.ref(`evplan/bookings/${bookingId}`).set(bookingData);
        console.log('‚úÖ Booking created successfully');
        
        // Clean up UI
        document.getElementById('ride-request-card').classList.remove('show');
        showToast('‚úì Ride Accepted!', 'success');
        
        if (rideRequestsListener) {
            rideRequestsListener.off(); 
            rideRequestsListener = null;
        }
        
        // Restore active ride with the updated data
        restoreActiveRide(currentRideId, updatedRideData);
        
      } catch (error) {
        console.error('‚ùå Error accepting ride:', error);
        showToast('Error accepting ride: ' + error.message, 'error');
        lastAcceptAttempt = 0; // Reset debounce on error
        
        // Re-enable button on error
        acceptBtn.disabled = false;
        acceptBtn.innerHTML = '<i class="fas fa-check"></i> Accept';
      } finally {
        isAcceptingRide = false;
      }
    }

    function openNavigation() {
        if (!currentRideRequest) return;
        
        let lat, lng;
        if (rideState === 'going_to_pickup' || rideState === 'at_pickup') {
            if (currentRideRequest.pickup && currentRideRequest.pickup.lat && currentRideRequest.pickup.lng) {
                lat = currentRideRequest.pickup.lat;
                lng = currentRideRequest.pickup.lng;
            } else {
                showToast('Pickup location not available', 'error');
                return;
            }
        } else {
            if (currentRideRequest.dropoff && currentRideRequest.dropoff.lat && currentRideRequest.dropoff.lng) {
                lat = currentRideRequest.dropoff.lat;
                lng = currentRideRequest.dropoff.lng;
            } else {
                showToast('Dropoff location not available', 'error');
                return;
            }
        }
        
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
        window.open(url, '_blank');
    }

    function showRouteOnMap() {
        if (!currentRideRequest || !driverData.currentLocation || !directionsService) return;
        
        if (!currentRideRequest.pickup || !currentRideRequest.pickup.lat || !currentRideRequest.pickup.lng) {
            console.warn('Pickup location not available for route');
            return;
        }
        
        const request = {
            origin: driverData.currentLocation,
            destination: { lat: currentRideRequest.pickup.lat, lng: currentRideRequest.pickup.lng },
            travelMode: 'DRIVING'
        };
        directionsService.route(request, (result, status) => {
            if (status === 'OK') directionsRenderer.setDirections(result);
        });
    }

    function showRouteToDestination() {
        if (!currentRideRequest || !directionsService) return;
        
        if (!currentRideRequest.pickup || !currentRideRequest.pickup.lat || !currentRideRequest.pickup.lng ||
            !currentRideRequest.dropoff || !currentRideRequest.dropoff.lat || !currentRideRequest.dropoff.lng) {
            console.warn('Pickup or dropoff location not available for route');
            return;
        }
        
        const request = {
            origin: { lat: currentRideRequest.pickup.lat, lng: currentRideRequest.pickup.lng },
            destination: { lat: currentRideRequest.dropoff.lat, lng: currentRideRequest.dropoff.lng },
            travelMode: 'DRIVING'
        };
        directionsService.route(request, (result, status) => {
            if (status === 'OK') directionsRenderer.setDirections(result);
        });
    }

    async function handlePrimaryAction() {
        const btn = document.getElementById('primary-action-btn');
        btn.disabled = true;
        document.getElementById('action-btn-text').textContent = 'Processing...';

        try {
            if (rideState === 'going_to_pickup') {
                await currentRideRequestRef.update({ tripStage: 'at_pickup', reachedPickupAt: firebase.database.ServerValue.TIMESTAMP });
                updateRideState('at_pickup');
                showToast('Reached Pickup Point');
            } else if (rideState === 'at_pickup') {
                await currentRideRequestRef.update({ tripStage: 'in_journey', journeyStartedAt: firebase.database.ServerValue.TIMESTAMP });
                updateRideState('in_journey');
                showToast('Journey Started');
                showRouteToDestination();
            } else if (rideState === 'in_journey') {
                await completeRide();
            }
        } catch (e) {
            console.error(e);
            showToast('Action failed', 'error');
        } finally {
            btn.disabled = false;
        }
    }

    function updateRideState(state) {
        rideState = state;
        const btnText = document.getElementById('action-btn-text');
        const statusTitle = document.getElementById('ride-status-title');
        
        ['step-pickup', 'step-journey', 'step-complete'].forEach(id => {
            document.getElementById(id).className = 'step';
        });

        if (state === 'going_to_pickup') {
            document.getElementById('step-pickup').classList.add('active');
            statusTitle.textContent = 'Going to Pickup';
            btnText.textContent = 'Reached Pickup';
        } else if (state === 'at_pickup') {
            document.getElementById('step-pickup').classList.add('completed');
            document.getElementById('step-journey').classList.add('active');
            statusTitle.textContent = 'At Pickup Point';
            btnText.textContent = 'Start Journey';
        } else if (state === 'in_journey') {
            document.getElementById('step-pickup').classList.add('completed');
            document.getElementById('step-journey').classList.add('completed');
            document.getElementById('step-complete').classList.add('active');
            statusTitle.textContent = 'In Journey';
            btnText.textContent = 'Complete Ride';
        }
    }

    async function completeRide() {
        try {
            await currentRideRequestRef.update({
                status: 'completed',
                tripStage: 'completed',
                completedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            const snapshot = await currentRideRequestRef.once('value');
            const rideData = snapshot.val();
            if (rideData.bookingId) {
                await database.ref(`evplan/bookings/${rideData.bookingId}`).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }

            const fareAmount = parseFloat(currentRideRequest.fareEstimate) || 0;
            driverData.todayEarnings += fareAmount;
            driverData.totalRides += 1;
            
            await driverStatusRef.update({
                todayEarnings: driverData.todayEarnings,
                totalRides: driverData.totalRides
            });
            
            updateStatsUI();
            showToast(`Ride Completed! ‚Çπ${fareAmount} added.`, 'success');
            
            document.getElementById('active-ride-card').classList.remove('show');
            rideState = 'idle';
            currentRideRequest = null;
            currentRideId = null;
            currentRideRequestRef = null;
            
            if (isOnline) {
                document.getElementById('empty-state').classList.remove('show');
                listenForRideRequests();
            } else {
                document.getElementById('empty-state').classList.add('show');
            }

        } catch (e) {
            console.error('Completion error', e);
            showToast('Error completing ride', 'error');
        }
    }

    function listenToActiveRide(ref) {
        if (activeRideListener) activeRideListener.off();
        activeRideListener = ref;
        
        ref.on('value', (snap) => {
            const val = snap.val();
            if (!val) return;
            if (val.status === 'cancelled') {
                showToast('Ride Cancelled by User', 'error');
                document.getElementById('active-ride-card').classList.remove('show');
                rideState = 'idle';
                currentRideRequest = null;
                if (isOnline) listenForRideRequests();
            }
        });
    }

    function toggleOnlineStatus() {
        if (!driverData.id) return;
        
        isOnline = !isOnline;
        updateOnlineStatus(isOnline);
        
        if (isOnline) {
            showToast(`You are now Online (${driverData.vehicleType.toUpperCase()})`, 'success');
            document.getElementById('empty-state').classList.remove('show');
            listenForRideRequests();
            if (driverStatusRef) driverStatusRef.update({ isOnline: true });
            
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(pos => {
                    driverData.currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    if(driverStatusRef) driverStatusRef.update({ location: driverData.currentLocation });
                    if (rideState !== 'idle' && currentRideRequestRef) {
                        currentRideRequestRef.update({ driverLocation: driverData.currentLocation });
                    }
                }, null, { enableHighAccuracy: true });
            }
        } else {
            showToast('You are Offline', 'error');
            document.getElementById('empty-state').classList.add('show');
            if (rideRequestsListener) rideRequestsListener.off();
            rideRequestsListener = null;
            if (driverStatusRef) driverStatusRef.update({ isOnline: false });
            if (locationWatchId) navigator.geolocation.clearWatch(locationWatchId);
        }
    }

    function updateOnlineStatus(online) {
        const el = document.getElementById('status-toggle');
        const txt = document.getElementById('status-text');
        if (online) {
            el.classList.add('online');
            txt.textContent = 'Online';
        } else {
            el.classList.remove('online');
            txt.textContent = 'Offline';
        }
    }

    function hideRideRequest() {
        document.getElementById('ride-request-card').classList.remove('show');
        currentRideRequest = null;
        
        // Reset accept button state
        const acceptBtn = document.getElementById('accept-btn');
        acceptBtn.disabled = false;
        acceptBtn.innerHTML = '<i class="fas fa-check"></i> Accept';
        isAcceptingRide = false;
        
        if (isOnline && rideState === 'idle') document.getElementById('empty-state').classList.remove('show');
    }
    
    function rejectRide() {
        hideRideRequest();
    }
    
    function checkLocationPermission() {
        if (navigator.permissions) {
            navigator.permissions.query({name:'geolocation'}).then(result => {
                if (result.state === 'granted') {
                    locationPermissionGranted = true;
                } else {
                    document.getElementById('permission-banner').classList.add('show');
                }
            });
        }
    }
    
    function requestLocationPermission() {
        navigator.geolocation.getCurrentPosition(() => {
            locationPermissionGranted = true;
            document.getElementById('permission-banner').classList.remove('show');
            showToast('Location Access Granted', 'success');
        });
    }
    
    function setupConnectionMonitoring() {
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                document.getElementById('connection-banner').classList.remove('show');
            } else {
                document.getElementById('connection-banner').classList.add('show');
            }
        });
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        if (t) {
            t.textContent = msg;
            t.className = `toast ${type || ''} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    }
    
    function playNotificationSound() {
        // Audio logic can be added here
    }
    
    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('active'); 
        document.getElementById('sidebar-overlay').classList.toggle('active'); 
        document.getElementById('hamburger-btn').classList.toggle('active');
    }
    
    function closeSidebar() { 
        document.getElementById('sidebar').classList.remove('active'); 
        document.getElementById('sidebar-overlay').classList.remove('active'); 
        document.getElementById('hamburger-btn').classList.remove('active');
    }
    
    function handleLogout() {
        if(confirm('Logout?')) {
            if (auth && auth.currentUser) {
                auth.signOut().then(() => window.location.href = 'driverlogin.html');
            } else {
                window.location.href = 'driverlogin.html';
            }
        }
    }
    
    function navigateTo(p) { 
        closeSidebar(); 
    }
    
    function showEarnings() { 
        closeSidebar(); 
        showToast('Earnings feature coming soon', 'success'); 
    }

</script>
</body>
</html>
