<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Driver Dashboard ‚Äî WaveTravel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{--accent-a:#8e2de2;--accent-b:#4a00e0;--card-bg:rgba(255,255,255,0.08)}
    html,body{height:100%}
    body{font-family:'Segoe UI',sans-serif;margin:0;padding:0;background:linear-gradient(to right,var(--accent-a),var(--accent-b));color:white;min-height:100vh;padding-bottom:92px}
    .container{padding:16px;max-width:600px;margin:0 auto}
    h1{font-size:1.4rem;text-align:center;margin:6px 0 14px}
    .dashboard-card{background:var(--card-bg);padding:14px;border-radius:10px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
    .wallet-card{position:sticky;top:8px;z-index:90;backdrop-filter:blur(6px)}
    #balance{font-size:1.4rem;font-weight:700;margin:6px 0}
    #withdraw-btn{margin-top:10px;padding:12px;width:100%;background:#ffd700;color:black;font-weight:700;border:none;border-radius:8px;cursor:pointer}
    #withdraw-btn:disabled{opacity:.6;cursor:not-allowed}
    .card-list{display:flex;flex-direction:column;gap:12px}
    .entry-card{background:rgba(255,255,255,0.04);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);display:flex;flex-direction:column;gap:8px}
    .entry-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .muted{opacity:0.85;font-size:0.9rem}
    .navbar{position:fixed;bottom:0;width:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px);display:flex;justify-content:space-around;align-items:center;padding:12px 0;z-index:999}
    .navbar a{color:#fff;text-decoration:none;font-size:0.75rem;display:flex;flex-direction:column;align-items:center}
    .navbar a i{font-size:1.15rem;margin-bottom:4px}
    .center-toast{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.85);color:#fff;padding:14px 18px;border-radius:10px;z-index:1200;min-width:240px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.4);display:none;font-weight:600}
    .center-toast.show{display:block}
    .ride-request-card{background:rgba(255,255,255,0.06);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);margin-bottom:12px}
    .ride-info-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:0.95rem}
    .ride-label{opacity:0.8;font-weight:500}
    .ride-value{font-weight:600}
    .location-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(16,185,129,0.15);padding:6px 10px;border-radius:8px;font-size:0.85rem;margin:4px 0}
    .ride-actions{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06)}
    .btn-accept{flex:1;padding:12px;background:#10b981;color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:all 0.2s}
    .btn-accept:hover{background:#059669;transform:translateY(-2px)}
    .btn-reject{flex:1;padding:12px;background:rgba(239,68,68,0.2);color:#fff;border:1px solid rgba(239,68,68,0.4);border-radius:8px;font-weight:700;cursor:pointer;transition:all 0.2s}
    .btn-reject:hover{background:rgba(239,68,68,0.3)}
    .btn-accept:disabled,.btn-reject:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Your Dashboard</h1>
    
    <div class="dashboard-card wallet-card">
      <h2>Wallet Balance</h2>
      <div id="balance">Loading‚Ä¶</div>
      <button id="withdraw-btn" disabled>Request Withdraw</button>
    </div>

    <div class="dashboard-card">
      <h2>Available Ride Requests</h2>
      <div class="card-list" id="rideRequestsList">
        <div class="entry-card muted">Loading ride requests...</div>
      </div>
    </div>

    <div class="dashboard-card">
      <h2>Wallet History</h2>
      <div class="card-list" id="cardList"></div>
    </div>
  </div>

  <div class="navbar">
    <a href="driverdashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="drivermybookings.html"><i class="fas fa-list"></i><span>My Bookings</span></a>
    <a href="driverslots.html"><i class="fas fa-calendar"></i><span>Slots</span></a>
    <a href="drivermycars.html"><i class="fas fa-car"></i><span>My Cars</span></a>
    <a href="driverprofile.html"><i class="fas fa-user"></i><span>Profile</span></a>
  </div>

  <div id="centerToast" class="center-toast"></div>

  <script type="module">
    import{initializeApp}from"https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import{getDatabase,ref,onValue,update,get,child}from"https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig={apiKey:"AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",authDomain:"wavetravel-3c4c4.firebaseapp.com",databaseURL:"https://wavetravel-3c4c4-default-rtdb.firebaseio.com",projectId:"wavetravel-3c4c4"};
    const app=initializeApp(firebaseConfig);
    const db=getDatabase(app);
    const auth=getAuth(app);

    const balanceEl=document.getElementById("balance");
    const withdrawBtn=document.getElementById("withdraw-btn");
    const cardList=document.getElementById("cardList");
    const centerToastEl=document.getElementById("centerToast");
    const rideRequestsList=document.getElementById("rideRequestsList");

    let driverId=null;
    let walletData={};
    let rideRequestsData={};

    function showToast(msg,dur=2800){centerToastEl.textContent=msg;centerToastEl.classList.add('show');clearTimeout(centerToastEl._t);centerToastEl._t=setTimeout(()=>centerToastEl.classList.remove('show'),dur)}

    function formatDate(ts){if(!ts)return'-';const d=new Date(typeof ts==='number'?ts*1000:ts);return isNaN(d)?'-':d.toLocaleString(undefined,{dateStyle:"medium",timeStyle:"short"})}

    function renderWallet(){const entries=Object.entries(walletData||{});if(!entries.length){balanceEl.textContent="‚Çπ0";cardList.innerHTML='<div class="entry-card muted">No wallet entries</div>';withdrawBtn.disabled=true;return}const unpaid=entries.filter(([_,e])=>!e.paidout||e.paidout==="false");const total=unpaid.reduce((s,[_,e])=>s+parseFloat(e.amount||0),0);balanceEl.textContent=`‚Çπ${total.toFixed(2)}`;withdrawBtn.disabled=total<=0;cardList.innerHTML="";entries.forEach(([id,e])=>{const div=document.createElement("div");div.className="entry-card";div.innerHTML=`<div class="entry-row"><div><strong>Booking</strong><div class="muted">${id}</div></div><div><strong>‚Çπ${Number(e.amount||0).toFixed(2)}</strong></div></div><div class="entry-row"><div class="muted">Date</div><div class="muted">${formatDate(e.date||e.bookedAt)}</div></div><div class="entry-row"><div class="muted">Status</div><div class="muted">${e.status||'unpaid'}</div></div>`;cardList.appendChild(div)})}

    function renderRideRequests(){const entries=Object.entries(rideRequestsData||{});const searching=entries.filter(([_,r])=>r.status==='searching');if(!searching.length){rideRequestsList.innerHTML='<div class="entry-card muted">No ride requests available</div>';return}rideRequestsList.innerHTML="";searching.forEach(([rideId,ride])=>{const pickup=(ride.pickup?.address||'Unknown').split(',')[0];const dropoff=(ride.dropoff?.address||'Unknown').split(',')[0];const dt=formatDate(ride.pickupTimestamp);const trip=ride.tripType||'oneway';const vehicle=ride.vehicleType||'sedan';const fare=ride.fareEstimate||0;const dist=ride.distance||0;const div=document.createElement("div");div.className="ride-request-card";div.innerHTML=`<div class="ride-info-row"><span class="ride-label">Request ID</span><span class="ride-value">${rideId.substring(0,8)}</span></div><div class="location-badge"><span>üìç</span><strong>${pickup}</strong></div><div style="text-align:center;margin:4px 0;opacity:0.7">‚Üì</div><div class="location-badge" style="background:rgba(239,68,68,0.15)"><span>üìç</span><strong>${dropoff}</strong></div><div class="ride-info-row" style="margin-top:12px"><span class="ride-label">Pickup Time</span><span class="ride-value">${dt}</span></div><div class="ride-info-row"><span class="ride-label">Trip Type</span><span class="ride-value" style="text-transform:capitalize">${trip}</span></div><div class="ride-info-row"><span class="ride-label">Vehicle</span><span class="ride-value" style="text-transform:capitalize">${vehicle}</span></div><div class="ride-info-row"><span class="ride-label">Distance</span><span class="ride-value">${dist.toFixed(0)} km</span></div><div class="ride-info-row"><span class="ride-label">Fare Estimate</span><span class="ride-value" style="color:#ffd700">‚Çπ${fare}</span></div><div class="ride-actions"><button class="btn-accept" data-ride="${rideId}">Accept Ride</button><button class="btn-reject" data-ride="${rideId}">Reject</button></div>`;rideRequestsList.appendChild(div)});document.querySelectorAll('.btn-accept').forEach(btn=>{btn.onclick=()=>acceptRide(btn.dataset.ride)});document.querySelectorAll('.btn-reject').forEach(btn=>{btn.onclick=()=>rejectRide(btn.dataset.ride)})}

    async function acceptRide(rideId){if(!driverId||!rideId){showToast("Invalid request");return}const ride=rideRequestsData[rideId];if(!ride){showToast("Ride request not found");return}try{const driverSnap=await get(child(ref(db),`driverdetails/${driverId}`));let driverName='Driver';let driverNumber='';if(driverSnap&&driverSnap.exists()){const d=driverSnap.val();driverName=d.name||d.fullName||'Driver';driverNumber=d.phone||d.phoneNumber||''}const booking={...ride,status:'booked',assignedDriverId:driverId,driverName:driverName,driverNumber:driverNumber,acceptedAt:Date.now(),bookingId:rideId};const updates={};updates[`evplan/bookings/${rideId}`]=booking;updates[`evplan/rideRequests/${rideId}/status`]='booked';updates[`evplan/rideRequests/${rideId}/assignedDriverId`]=driverId;await update(ref(db),updates);showToast("‚úì Ride accepted successfully!")}catch(err){console.error("Error accepting ride:",err);showToast("Failed to accept ride: "+(err.message||err))}}

    async function rejectRide(rideId){if(!driverId||!rideId)return;try{const updates={};updates[`evplan/rideRequests/${rideId}/status`]='rejected';await update(ref(db),updates);showToast("Ride rejected")}catch(err){console.error("Error rejecting ride:",err);showToast("Failed to reject ride")}}

    onAuthStateChanged(auth,async user=>{if(!user){balanceEl.textContent="Please log in.";cardList.innerHTML='<div class="entry-card muted">Log in to see data</div>';rideRequestsList.innerHTML='<div class="entry-card muted">Log in to see ride requests</div>';driverId=null;withdrawBtn.disabled=true;return}driverId=user.uid;const walletRef=ref(db,`driverWallet/${driverId}`);onValue(walletRef,snap=>{walletData=snap.val()||{};renderWallet()},err=>{console.error("wallet onValue error:",err)});const rideRequestsRef=ref(db,`evplan/rideRequests`);onValue(rideRequestsRef,snap=>{rideRequestsData=snap.val()||{};renderRideRequests()},err=>{console.error("ride requests onValue error:",err)})});
  </script>
</body>
</html>
