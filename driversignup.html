<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Driver Signup — WaveTravel (Modular v12)</title>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{ --brand:#0b67f3; --accent:#15a45a; --muted:#6b7280; --card-radius:14px }
    *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, Arial}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#eef6ff,#fff);padding:18px}
    .card{width:100%;max-width:420px;background:#fff;border-radius:var(--card-radius);padding:18px;box-shadow:0 10px 30px rgba(10,30,80,0.06);position:relative}
    .top-right{position:absolute;right:14px;top:12px}
    .top-right a{color:var(--brand);text-decoration:none;font-weight:600;font-size:13px}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#003db3);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:18px;color:#0b254a}
    .lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
    .field{display:flex;align-items:center;gap:10px;background:#f6fafc;border-radius:10px;padding:10px;margin-bottom:12px;border:1px solid rgba(11,103,243,0.03)}
    .field i{color:var(--brand);width:22px;text-align:center;font-size:16px}
    .field input{border:0;outline:0;background:transparent;font-size:15px;flex:1;padding:6px 0}
    .btn{width:100%;padding:12px;border-radius:10px;border:0;color:#fff;font-weight:700;font-size:15px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:10px}
    .btn-primary{background:var(--brand)}
    .btn-ghost{background:transparent;color:var(--brand);border:1px solid rgba(11,103,243,0.08)}
    .btn-success{background:var(--accent)}
    #otpArea{display:none;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .grow{flex:1}
    .tiny{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(11,18,32,0.95);color:#fff;padding:10px 14px;border-radius:10px;display:none;font-weight:700;z-index:9999}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.6);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:420px){ .logo{width:46px;height:46px} .top-right{right:8px;top:8px} }
  </style>
</head>
<body>

  <main class="card" role="main" aria-labelledby="title">
    <div class="top-right"><a href="driverlogin.html">Login</a></div>

    <div class="brand" aria-hidden="true">
      <div class="logo">WT</div>
      <div>
        <h1 id="title">Driver Signup</h1>
        <div class="lead">Enter name and mobile to receive OTP</div>
      </div>
    </div>

    <div class="field">
      <i class="fa-solid fa-user"></i>
      <input id="name" type="text" placeholder="Full name" autocomplete="name" />
    </div>

    <div class="field">
      <i class="fa-regular fa-envelope"></i>
      <input id="email" type="email" placeholder="Email (optional)" autocomplete="email" />
    </div>

    <div class="field">
      <i class="fa-solid fa-phone"></i>
      <input id="phone" type="tel" placeholder="Mobile (10 digits)" inputmode="tel" maxlength="12" />
    </div>

    <button id="sendBtn" class="btn btn-primary" aria-live="polite">
      <i class="fa-regular fa-paper-plane"></i><span>Send OTP</span>
    </button>

    <section id="otpArea" aria-hidden="true">
      <div class="field">
        <i class="fa-solid fa-key"></i>
        <input id="otp" type="text" placeholder="Enter OTP" inputmode="numeric" maxlength="6"/>
      </div>

      <div class="row">
        <button id="verifyBtn" class="btn btn-success grow"><i class="fa-regular fa-circle-check"></i><span>Verify</span></button>
        <button id="resendBtn" class="btn btn-ghost" style="width:120px" disabled>Resend (30s)</button>
      </div>
    </section>

    <div id="recaptcha-container" style="height:0;overflow:hidden"></div>
    <p class="tiny">We save phone as +91xxxxxxxxxx</p>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modular Firebase v12 SDKs -->
  <script type="module">
    // imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      RecaptchaVerifier,
      signInWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      query,
      orderByChild,
      equalTo,
      get,
      set
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // ---------- Firebase config (your project) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    // initialize (only once)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM
    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const phoneEl = document.getElementById('phone');
    const sendBtn = document.getElementById('sendBtn');
    const otpArea = document.getElementById('otpArea');
    const otpInput = document.getElementById('otp');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const toast = document.getElementById('toast');

    // state
    let confirmationResult = null;
    let lastE164 = '';
    let resendTimer = null;
    let countdown = 30;

    // recaptcha singletons
    window.recaptchaVerifier = null;
    window.recaptchaRenderPromise = null;

    function showToast(msg, ms=3000){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toast.style.display = 'none', ms);
    }

    // E.164 normalization for India
    function normalizeToE164(raw){
      if(!raw) return '';
      const cleaned = String(raw).replace(/\D/g,'');
      if(cleaned.length === 10) return '+91' + cleaned;
      if(cleaned.length === 11 && cleaned.startsWith('0')) return '+91' + cleaned.slice(1);
      if(cleaned.length === 12 && cleaned.startsWith('91')) return '+' + cleaned;
      if(cleaned.length > 10){
        const last10 = cleaned.slice(-10);
        if(last10.length === 10) return '+91' + last10;
      }
      return '';
    }

    // digits only input for phone field
    phoneEl.addEventListener('input', () => {
      const s = phoneEl.value;
      const digits = s.replace(/\D/g,'').slice(0,12);
      phoneEl.value = digits;
    });

    // ensure recaptcha (render only once, ignore duplicate errors)
    async function ensureRecaptcha(){
      if(window.recaptchaVerifier) return window.recaptchaRenderPromise;
      window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', { size: 'invisible' }, auth);
      // render() returns a promise — swallow duplicate-render style errors
      window.recaptchaRenderPromise = window.recaptchaVerifier.render().catch(err => {
        // Some browsers may say it's already rendered; ignore those
        if(err && /already been rendered/i.test(err.message)) return;
        // other errors: rethrow
        throw err;
      });
      return window.recaptchaRenderPromise;
    }

    // check /driverdetails for phone variants
    async function phoneExistsInDriverDetails(e164){
      try {
        const dbRef = ref(db, 'driverdetails');
        // exact +91... match
        let q = query(dbRef, orderByChild('phone'), equalTo(e164));
        let snap = await get(q);
        if(snap.exists()) return true;
        // digits without plus
        const digits = e164.replace(/\D/g,'');
        q = query(dbRef, orderByChild('phone'), equalTo(digits));
        snap = await get(q);
        if(snap.exists()) return true;
        // last 10
        const last10 = digits.slice(-10);
        q = query(dbRef, orderByChild('phone'), equalTo(last10));
        snap = await get(q);
        if(snap.exists()) return true;
        return false;
      } catch(e){
        console.error('phoneExists check failed', e);
        return false; // on error assume not present so the flow continues (you can change)
      }
    }

    // send OTP
    sendBtn.addEventListener('click', async () => {
      const name = (nameEl.value||'').trim();
      const phoneRaw = (phoneEl.value||'').trim();

      if(!name){ showToast('Enter name'); nameEl.focus(); return; }
      if(!phoneRaw){ showToast('Enter mobile'); phoneEl.focus(); return; }

      const e164 = normalizeToE164(phoneRaw);
      console.log('normalized phone ->', e164);
      if(!e164){ showToast('Enter a valid 10-digit mobile'); phoneEl.focus(); return; }

      // UI feedback
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner"></span> Checking…';

      try {
        const exists = await phoneExistsInDriverDetails(e164);
        if(exists){
          showToast('Number already registered — use Login');
          sendBtn.style.display = 'none';
          const goLogin = document.createElement('button');
          goLogin.className = 'btn btn-ghost';
          goLogin.textContent = 'Go to Login';
          goLogin.addEventListener('click', ()=> location.href = 'driverlogin.html');
          sendBtn.parentNode.insertBefore(goLogin, sendBtn.nextSibling);
          return;
        }

        sendBtn.innerHTML = '<span class="spinner"></span> Sending…';

        // ensure reCAPTCHA rendered
        await ensureRecaptcha();

        // send OTP with modular signInWithPhoneNumber
        confirmationResult = await signInWithPhoneNumber(auth, e164, window.recaptchaVerifier);
        lastE164 = e164;
        showToast('OTP sent');
        otpArea.style.display = 'block';
        otpArea.setAttribute('aria-hidden','false');
        sendBtn.style.display = 'none';

        startResendCooldown();
      } catch(err){
        console.error('sendOtp error', err);
        // helpful user messages for common codes
        if(err && err.code === 'auth/invalid-phone-number'){
          showToast('Invalid phone format — please enter 10 digits');
        } else if(err && err.code === 'auth/invalid-api-key'){
          showToast('Invalid API key — check your Firebase / Google Cloud API Key settings');
        } else if(err && err.code === 'auth/quota-exceeded'){
          showToast('SMS quota exceeded — try later / use test numbers in Console');
        } else {
          showToast(err && err.message ? err.message : 'Failed to send OTP');
        }

        // reset UI and recaptcha so user can retry
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> Send OTP';
        try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); } catch(e){}
        window.recaptchaVerifier = null;
        window.recaptchaRenderPromise = null;
      }
    });

    // verify OTP
    verifyBtn.addEventListener('click', async ()=>{
      const code = (otpInput.value||'').trim();
      if(!/^\d{4,6}$/.test(code)){ showToast('Enter OTP'); otpInput.focus(); return; }

      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<span class="spinner"></span> Verifying…';

      try {
        if(!confirmationResult) throw new Error('No OTP request in progress');
        const result = await confirmationResult.confirm(code);
        const user = result.user;
        const uid = user.uid;
        const payload = {
          driverId: uid,
          name: (nameEl.value||'').trim(),
          email: (emailEl.value||'').trim(),
          phone: lastE164,
          createdAt: new Date().toISOString()
        };
        await set(ref(db, 'driverdetails/' + uid), payload);
        showToast('Signup complete');
        setTimeout(()=> location.href = 'driverdashboard.html', 900);
      } catch(err){
        console.error('verify error', err);
        showToast(err && err.message ? err.message : 'Invalid OTP');
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fa-regular fa-circle-check"></i> Verify';
      }
    });

    // resend cooldown logic
    function startResendCooldown(){
      resendBtn.disabled = true;
      countdown = 30;
      resendBtn.textContent = `Resend (${countdown}s)`;
      clearInterval(resendTimer);
      resendTimer = setInterval(()=>{
        countdown--;
        if(countdown <= 0){
          clearInterval(resendTimer);
          resendBtn.disabled = false;
          resendBtn.textContent = 'Resend';
        } else {
          resendBtn.textContent = `Resend (${countdown}s)`;
        }
      },1000);
    }

    // resend OTP
    resendBtn.addEventListener('click', async ()=>{
      if(!lastE164) return;
      resendBtn.disabled = true;
      resendBtn.textContent = 'Sending…';
      try {
        await ensureRecaptcha();
        confirmationResult = await signInWithPhoneNumber(auth, lastE164, window.recaptchaVerifier);
        showToast('OTP resent');
        startResendCooldown();
      } catch(err){
        console.error('resend error', err);
        showToast(err && err.message ? err.message : 'Resend failed');
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend';
        try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); } catch(e){}
        window.recaptchaVerifier = null;
        window.recaptchaRenderPromise = null;
      }
    });

    // NOTE: Don't render reCAPTCHA until user clicks Send OTP (we call ensureRecaptcha just before sending)
  </script>
</body>
</html>
