<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver Signup — WaveTravel</title>

  <!-- Font Awesome (icons) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root{
      --brand:#0b67f3;
      --accent:#2fb86f;
      --muted:#7d8a99;
      --card-radius:14px;
    }
    *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, Arial;}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef6ff 0%, #fff 100%);display:flex;align-items:center;justify-content:center;padding:20px;}

    .card{
      width:100%; max-width:420px; background:#fff; border-radius:var(--card-radius);
      padding:18px; box-shadow:0 10px 30px rgba(10,30,80,0.08); position:relative;
    }
    .top-link{ position:absolute; top:12px; right:12px; font-size:13px; }
    .top-link a{ color:var(--brand); text-decoration:none; font-weight:600; }

    .brand { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .logo { width:52px; height:52px; border-radius:10px; background:linear-gradient(135deg,var(--brand),#003db3); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:18px; }
    h1{ margin:0; font-size:18px; color:#0b254a; }
    p.lead{ margin:6px 0 14px 0; color:var(--muted); font-size:13px; }

    .field{ display:flex; align-items:center; gap:10px; background:#f6fafc; border-radius:10px; padding:10px; margin-bottom:12px; border:1px solid rgba(11,103,243,0.03); }
    .field i{ color:var(--brand); width:22px; text-align:center; font-size:16px; }
    .field input{ border:0; outline:0; background:transparent; font-size:15px; flex:1; }

    .btn{ width:100%; padding:12px; border-radius:10px; border:0; color:#fff; font-weight:700; font-size:15px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:10px; }
    .btn-primary{ background:var(--brand); }
    .btn-ghost{ background:transparent; color:var(--brand); border:1px solid rgba(11,103,243,0.08); }
    .btn-success{ background:var(--accent); }

    #otpArea{ display:none; margin-top:6px; }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    .row .grow{ flex:1; }
    .tiny{ font-size:13px; color:var(--muted); text-align:center; margin-top:12px; }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:rgba(11,18,32,0.95); color:#fff; padding:12px 16px; border-radius:10px; display:none; z-index:9999; font-weight:700; box-shadow:0 8px 30px rgba(2,6,23,0.35); }
    .spinner{ width:16px; height:16px; border:2px solid rgba(255,255,255,0.6); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    @media (max-width:420px){ .logo{ width:46px; height:46px; font-size:16px; } .top-link{ font-size:12px; top:8px; right:8px; } }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="card-title">
    <div class="top-link" aria-hidden="true"><a href="driverlogin.html">Login</a></div>

    <div class="brand" aria-hidden="true">
      <div class="logo">WT</div>
      <div>
        <h1 id="card-title">Driver Signup</h1>
        <p class="lead">Enter name & mobile — we’ll send OTP</p>
      </div>
    </div>

    <label class="sr-only" for="nameInput">Full name</label>
    <div class="field" role="group" aria-label="Full name">
      <i class="fa-solid fa-user"></i>
      <input id="nameInput" type="text" placeholder="Full name" inputmode="text" autocomplete="name" />
    </div>

    <label class="sr-only" for="emailInput">Email (optional)</label>
    <div class="field" role="group" aria-label="Email">
      <i class="fa-regular fa-envelope"></i>
      <input id="emailInput" type="email" placeholder="Email (optional)" inputmode="email" autocomplete="email" />
    </div>

    <label class="sr-only" for="phoneInput">Phone (10 digits)</label>
    <div class="field" role="group" aria-label="Phone">
      <i class="fa-solid fa-phone"></i>
      <input id="phoneInput" type="tel" placeholder="Mobile (10 digits)" inputmode="tel" maxlength="14" />
    </div>

    <button id="sendOtpBtn" class="btn btn-primary" aria-live="polite">
      <i class="fa-regular fa-paper-plane"></i><span>Send OTP</span>
    </button>

    <section id="otpArea" aria-hidden="true">
      <div class="field">
        <i class="fa-solid fa-key"></i>
        <input id="otpInput" type="text" placeholder="Enter OTP" inputmode="numeric" maxlength="6" />
      </div>

      <div class="row">
        <button id="verifyBtn" class="btn btn-success grow"><i class="fa-regular fa-circle-check"></i><span>Verify</span></button>
        <button id="resendBtn" class="btn btn-ghost" style="width:120px" disabled>Resend (30s)</button>
      </div>
    </section>

    <div id="recaptcha-container" style="height:0;overflow:hidden"></div>

    <p class="tiny">By continuing you agree to WaveTravel terms.</p>
    <p class="tiny" style="margin-top:8px; text-align:center;">Already registered? <a href="driverlogin.html" style="color:var(--brand); font-weight:700; text-decoration:none;">Login</a></p>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------- Firebase config (your project) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM
    const nameEl = document.getElementById('nameInput');
    const emailEl = document.getElementById('emailInput');
    const phoneEl = document.getElementById('phoneInput');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpArea = document.getElementById('otpArea');
    const otpInput = document.getElementById('otpInput');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const toast = document.getElementById('toast');

    // state
    let confirmationResult = null;
    let lastE164 = '';
    let resendInterval = null;
    let countdown = 30;

    // helpers
    function showToast(msg, ms = 2800){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> toast.style.display = 'none', ms);
    }

    // robust normalization to E.164 (India)
    function normalizeToE164(raw){
      if(!raw) return '';
      const digits = String(raw).replace(/\D/g,'');
      if(digits.length === 10) return '+91' + digits;
      if(digits.length === 11 && digits.startsWith('0')) return '+91' + digits.slice(1);
      if(digits.length === 12 && digits.startsWith('91')) return '+' + digits;
      if(digits.length > 10){
        // fallback: last 10 digits (common when user pastes various formats)
        const last10 = digits.slice(-10);
        if(last10.length === 10) return '+91' + last10;
      }
      return '';
    }

    function ensureRecaptcha(){
      if(window.recaptchaVerifier) return;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      // render to create widgets internals (some environments require render)
      try { window.recaptchaVerifier.render(); } catch(e){ /* ignore */ }
    }

    // try multiple stored formats to detect existing registration
    async function phoneExists(e164){
      try {
        // try exact +91...
        const snapPlus = await db.ref('driverdetails').orderByChild('phone').equalTo(e164).once('value');
        if(snapPlus.exists()) return { exists:true, snap: snapPlus };

        const digits = e164.replace(/\D/g,'');
        // try stored without plus
        const snapNoPlus = await db.ref('driverdetails').orderByChild('phone').equalTo(digits).once('value');
        if(snapNoPlus.exists()) return { exists:true, snap: snapNoPlus };

        // try last-10
        const last10 = digits.slice(-10);
        const snapLast10 = await db.ref('driverdetails').orderByChild('phone').equalTo(last10).once('value');
        if(snapLast10.exists()) return { exists:true, snap: snapLast10 };

        return { exists:false };
      } catch (err) {
        console.error('phoneExists err', err);
        return { exists:false };
      }
    }

    // keep input digits only and limit (allow user to paste various formats)
    phoneEl.addEventListener('input', ()=> {
      const raw = phoneEl.value;
      // allow + or digits for copy-paste, but show only digits for simplicity
      const digits = raw.replace(/[^\d+]/g,'');
      // If user typed leading +, keep it, else keep digits only. But to avoid confusion, show digits only.
      const cleaned = digits.replace(/\D/g,'').slice(0,12); // allow up to 12 in case user types 91...
      phoneEl.value = cleaned;
    });

    // send OTP
    sendOtpBtn.addEventListener('click', async () => {
      const name = (nameEl.value || '').trim();
      const phoneRaw = (phoneEl.value || '').trim();

      if(!name){ showToast('Enter name'); nameEl.focus(); return; }
      const e164 = normalizeToE164(phoneRaw);
      if(!e164){ showToast('Enter valid 10-digit mobile'); phoneEl.focus(); return; }

      ensureRecaptcha();

      // UI feedback
      sendOtpBtn.disabled = true;
      sendOtpBtn.innerHTML = '<span class="spinner"></span> Checking…';

      try {
        const exists = await phoneExists(e164);
        if(exists.exists){
          showToast('Number already registered — use Login');
          // replace send button with a login button
          sendOtpBtn.style.display = 'none';
          const loginBtn = document.createElement('button');
          loginBtn.className = 'btn btn-ghost';
          loginBtn.textContent = 'Go to Login';
          loginBtn.addEventListener('click', ()=> location.href = 'driverlogin.html');
          sendOtpBtn.parentNode.insertBefore(loginBtn, otpArea);
          return;
        }

        // send OTP
        sendOtpBtn.innerHTML = '<span class="spinner"></span> Sending…';
        confirmationResult = await auth.signInWithPhoneNumber(e164, window.recaptchaVerifier);
        lastE164 = e164;
        showToast('OTP sent');
        otpArea.style.display = 'block';
        otpArea.setAttribute('aria-hidden','false');
        sendOtpBtn.style.display = 'none';

        // start resend cooldown
        startResendCooldown();
      } catch (err) {
        console.error('sendOtp error', err);
        const msg = (err && err.message) ? err.message : 'Failed to send OTP';
        showToast(msg);
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> Send OTP';
        // reset recaptcha if needed
        try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); window.recaptchaVerifier = undefined; } catch(e){}
      }
    });

    // verify OTP
    verifyBtn.addEventListener('click', async () => {
      const code = (otpInput.value || '').trim();
      if(!/^\d{4,6}$/.test(code)){ showToast('Enter OTP'); otpInput.focus(); return; }
      verifyBtn.disabled = true;
      verifyBtn.innerHTML = '<span class="spinner"></span> Verifying…';

      try {
        const result = await confirmationResult.confirm(code);
        const user = result.user;
        const driverId = user.uid;
        const payload = {
          driverId,
          name: (nameEl.value||'').trim(),
          email: (emailEl.value||'').trim(),
          phone: lastE164,
          createdAt: new Date().toISOString()
        };
        await db.ref('driverdetails/' + driverId).set(payload);
        showToast('Signup complete');
        setTimeout(()=> location.href = 'driverdashboard.html', 900);
      } catch (err) {
        console.error('verify error', err);
        showToast((err && err.message) ? err.message : 'Invalid OTP');
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fa-regular fa-circle-check"></i> Verify';
      }
    });

    // resend logic
    function startResendCooldown(){
      resendBtn.disabled = true;
      countdown = 30;
      resendBtn.textContent = `Resend (${countdown}s)`;
      resendBtn.style.opacity = 0.8;

      clearInterval(resendInterval);
      resendInterval = setInterval(()=> {
        countdown--;
        if(countdown <= 0){
          clearInterval(resendInterval);
          resendBtn.disabled = false;
          resendBtn.textContent = 'Resend';
          resendBtn.style.opacity = 1;
        } else {
          resendBtn.textContent = `Resend (${countdown}s)`;
        }
      }, 1000);
    }

    resendBtn.addEventListener('click', async () => {
      if(resendBtn.disabled || !lastE164) return;
      ensureRecaptcha();
      resendBtn.disabled = true;
      resendBtn.textContent = 'Sending…';
      try {
        confirmationResult = await auth.signInWithPhoneNumber(lastE164, window.recaptchaVerifier);
        showToast('OTP resent');
        startResendCooldown();
      } catch (err) {
        console.error('resend error', err);
        showToast((err && err.message) ? err.message : 'Resend failed');
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend';
      }
    });

    // initialize recaptcha early
    ensureRecaptcha();
  </script>
</body>
</html>
