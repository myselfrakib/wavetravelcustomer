<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver Login — WaveTravel</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --accent:#06b6d4; --muted:#9aa4b2; }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:linear-gradient(180deg,#021025 0%, #071126 100%); color:#e6eef6; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px}
    .card{width:100%;max-width:420px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:22px;border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{font-size:20px;margin:0 0 6px}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:13px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text], input[type=tel], input[type=number]{width:100%;padding:12px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}
    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{flex:1;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#0ea5a5);color:#022}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    .otp-row{display:flex;gap:8px;margin-top:12px}
    .otp{flex:1;padding:12px;border-radius:8px;text-align:center;font-size:18px}
    .note{font-size:12px;color:#9aa4b2;margin-top:6px}
    .error{color:#ffb4b4;background:rgba(255,180,180,0.06);padding:8px;border-radius:8px;margin-top:10px}
    .success{color:#c8f0e6;background:rgba(40,200,180,0.06);padding:8px;border-radius:8px;margin-top:10px}
    .bottom-row{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
    a.link{color:var(--accent);text-decoration:none;font-weight:600}
    #recaptcha-container{margin-top:6px}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:16px}
    @media (max-width:420px){.card{padding:18px}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Driver Login</h1>
    <p class="lead">Sign in with the phone number you registered. We'll send an OTP — you'll be logged in as the <strong>driverId</strong> linked to that number.</p>

    <div id="form-area">
      <label for="phone">Mobile number</label>
      <input id="phone" type="tel" placeholder="e.g. 9876543210 or +919876543210" inputmode="tel" />

      <div class="actions">
        <button id="sendOtpBtn" class="btn btn-primary">Send OTP</button>
        <button id="signupBtn" class="btn btn-ghost">Sign up</button>
      </div>

      <div id="recaptcha-container"></div>

      <div id="otp-area" style="display:none">
        <label for="otp">Enter OTP</label>
        <div class="otp-row">
          <input id="otp" class="otp" type="number" inputmode="numeric" placeholder="123456" />
          <button id="verifyOtpBtn" class="btn btn-primary" style="flex:0 0 110px">Verify</button>
        </div>
        <div class="bottom-row">
          <div class="small">Didn't get OTP? <button id="resendBtn" class="btn btn-ghost" style="padding:6px 10px">Resend</button></div>
          <div class="note" id="cooldownNote"></div>
        </div>
      </div>

      <div id="message"></div>
    </div>

    <footer>
      By continuing you accept our <a class="link" href="#">terms</a>.
    </footer>
  </div>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ======= Hard-coded Firebase config (embedded as requested) =======
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.firebasestorage.app",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    // Initialize Firebase (compat)
    try {
      firebase.initializeApp(firebaseConfig);
      window.auth = firebase.auth();
      window.db = firebase.database();
      // optional: show success that Firebase initialized
      document.getElementById('message').innerHTML = `<div class="success">Firebase initialized.</div>`;
    } catch (err) {
      console.error('Firebase init error', err);
      document.getElementById('message').innerHTML = `<div class="error">Firebase initialization failed: ${err.message}</div>`;
    }

    // UI elements (cached)
    const phoneInput = document.getElementById('phone');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const signupBtn = document.getElementById('signupBtn');
    const otpArea = document.getElementById('otp-area');
    const otpInput = document.getElementById('otp');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendBtn = document.getElementById('resendBtn');
    const messageBox = document.getElementById('message');
    const cooldownNote = document.getElementById('cooldownNote');

    let currentDriverId = null;
    let confirmationResult = null;
    let cooldownTimer = null;
    const COOLDOWN_SECONDS = 30;
    let recaptchaVerifier = null;

    // Helpers
    function showMessage(text, type = 'error') {
      messageBox.innerHTML = `<div class="${type === 'error' ? 'error' : 'success'}">${text}</div>`;
    }
    function clearMessage() { messageBox.innerHTML = ''; }

    function normalizePhone(input) {
      let v = (input || '').trim();
      const digits = v.replace(/[^0-9]/g, '');
      if (digits.length === 10) { return '+91' + digits; }
      if (digits.length > 10 && v.startsWith('+')) { return '+' + digits; }
      if (digits.length > 10 && !v.startsWith('+')) { return '+' + digits; }
      return v;
    }

    // Setup invisible ReCAPTCHA (requires firebase to be initialized)
    function ensureRecaptcha() {
      try { if (!firebase || !firebase.auth) return null; } catch (e) { return null; }
      if (recaptchaVerifier) return recaptchaVerifier;
      recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
      recaptchaVerifier.render().catch(e => console.warn('recaptcha render error', e));
      return recaptchaVerifier;
    }

    // Query Realtime DB for driver by phone (uses window.db)
    async function findDriverByPhone(e164) {
      try {
        const q = window.db.ref('driverdetails').orderByChild('phone').equalTo(e164);
        const snap = await q.once('value');
        if (!snap.exists()) return null;
        const data = snap.val();
        const driverKeys = Object.keys(data);
        const driverId = driverKeys[0];
        const driverObj = data[driverId];
        return { driverId, driverObj };
      } catch (err) {
        console.error('DB lookup error', err);
        throw err;
      }
    }

    // Send OTP (only if driver exists for that number)
    async function sendOtp() {
      clearMessage();
      const raw = phoneInput.value;
      const phone = normalizePhone(raw);
      if (!phone) { showMessage('Please enter a phone number.'); return; }

      try {
        showMessage('Checking phone number...', 'success');
        const found = await findDriverByPhone(phone);
        if (!found) { showMessage('This phone number is not registered as a driver. Please sign up first.'); return; }
        currentDriverId = found.driverId;

        const appVerifier = ensureRecaptcha();
        if (!appVerifier) { showMessage('reCAPTCHA not ready. Try reloading the page.'); return; }

        showMessage('Sending OTP...', 'success');
        window.auth.signInWithPhoneNumber(phone, appVerifier)
          .then((res) => {
            confirmationResult = res;
            otpArea.style.display = 'block';
            startCooldown();
            showMessage('OTP sent. Enter it below.', 'success');
          })
          .catch((err) => {
            console.error(err);
            showMessage('Failed to send OTP: ' + (err.message || err));
            if (recaptchaVerifier) { try { recaptchaVerifier.clear(); recaptchaVerifier = null; } catch (e) { } }
          });
      } catch (err) {
        showMessage('Error checking driver: ' + (err.message || err));
      }
    }

    // Verify OTP and log in (app-level login by storing driverId)
    async function verifyOtp() {
      clearMessage();
      const code = otpInput.value && otpInput.value.trim();
      if (!code || !confirmationResult) { showMessage('Enter the OTP sent to your phone.'); return; }

      try {
        showMessage('Verifying...', 'success');
        confirmationResult.confirm(code).then((result) => {
          localStorage.setItem('driverId', currentDriverId);
          showMessage('Logged in successfully. Redirecting...', 'success');
          setTimeout(() => { window.location.href = '/driverdashboard.html'; }, 800);
        }).catch(err => {
          console.error('OTP verify error', err);
          showMessage('OTP verification failed: ' + (err.message || err));
        });
      } catch (err) {
        console.error(err);
        showMessage('Verification error: ' + (err.message || err));
      }
    }

    // Resend with cooldown
    function startCooldown() {
      resendBtn.disabled = true;
      let remaining = COOLDOWN_SECONDS;
      cooldownNote.textContent = `${remaining}s`;
      cooldownTimer = setInterval(() => {
        remaining -= 1;
        cooldownNote.textContent = remaining > 0 ? `${remaining}s` : '';
        if (remaining <= 0) { clearInterval(cooldownTimer); resendBtn.disabled = false; cooldownNote.textContent = ''; }
      }, 1000);
    }

    async function resendOtp() {
      if (recaptchaVerifier) { try { recaptchaVerifier.clear(); recaptchaVerifier = null; } catch (e) { } }
      confirmationResult = null;
      await sendOtp();
    }

    // Wire event listeners only after firebase is initialized
    function attachListeners() {
      sendOtpBtn.addEventListener('click', sendOtp);
      verifyOtpBtn.addEventListener('click', verifyOtp);
      resendBtn.addEventListener('click', resendOtp);
      signupBtn.addEventListener('click', () => { window.location.href = '/driversignup.html'; });

      phoneInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendOtp(); });
      otpInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') verifyOtp(); });

      // initialize recaptcha rendering (invisible) so first send is fast
      try { ensureRecaptcha(); } catch (e) { console.warn(e); }
    }

    // Initialize UI on load
    window.addEventListener('load', () => {
      // Ensure firebase is ready (we already initialized above)
      try { attachListeners(); ensureRecaptcha(); } catch (e) { console.warn(e); }
    });
  </script>
</body>
</html>
