<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Driver Signup — WaveTravel (Diagnostics)</title>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- Firebase compat SDKs (only compat; DO NOT mix with modular on same page) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <style>
    :root { --brand:#0b67f3; --accent:#15a45a; --muted:#6b7280; --card-radius:14px; }
    *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, Arial}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#eef6ff,#fff);padding:18px}
    .card{width:100%;max-width:520px;background:#fff;border-radius:var(--card-radius);padding:18px;box-shadow:0 10px 30px rgba(10,30,80,0.06);position:relative}
    .top-right{position:absolute;right:14px;top:12px}
    .top-right a{color:var(--brand);text-decoration:none;font-weight:600;font-size:13px}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--brand),#003db3);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:18px;color:#0b254a}
    .lead{margin:6px 0 14px;color:var(--muted);font-size:13px}
    .field{display:flex;align-items:center;gap:10px;background:#f6fafc;border-radius:10px;padding:10px;margin-bottom:12px;border:1px solid rgba(11,103,243,0.03)}
    .field i{color:var(--brand);width:22px;text-align:center;font-size:16px}
    .field input{border:0;outline:0;background:transparent;font-size:15px;flex:1;padding:6px 0}
    .btn{padding:12px;border-radius:10px;border:0;color:#fff;font-weight:700;font-size:15px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:10px}
    .btn-primary{background:var(--brand);width:100%}
    .btn-ghost{background:transparent;color:var(--brand);border:1px solid rgba(11,103,243,0.08);padding:10px}
    .btn-success{background:var(--accent)}
    #otpArea{display:none;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .grow{flex:1}
    .tiny{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(11,18,32,0.95);color:#fff;padding:10px 14px;border-radius:10px;display:none;font-weight:700;z-index:9999}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.6);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* diagnostics */
    .diag {margin-top:14px;padding:12px;border-radius:10px;background:#fff9e6;border:1px solid #f0dca6}
    .diag h3{margin:0 0 8px 0;font-size:15px}
    .diag pre{white-space:pre-wrap;background:#fff;border-radius:6px;padding:8px;border:1px solid #eee;overflow:auto}
    #recaptcha-container{height:0;overflow:hidden}
    @media(max-width:520px){ .card{padding:14px} }
  </style>
</head>
<body>

  <main class="card" role="main" aria-labelledby="title">
    <div class="top-right"><a href="driverlogin.html">Login</a></div>

    <div class="brand" aria-hidden="true">
      <div class="logo">WT</div>
      <div>
        <h1 id="title">Driver Signup</h1>
        <div class="lead">Enter name and mobile to receive OTP</div>
      </div>
    </div>

    <div class="field"><i class="fa-solid fa-user"></i><input id="name" type="text" placeholder="Full name" autocomplete="name"/></div>
    <div class="field"><i class="fa-regular fa-envelope"></i><input id="email" type="email" placeholder="Email (optional)" autocomplete="email"/></div>
    <div class="field"><i class="fa-solid fa-phone"></i><input id="phone" type="tel" placeholder="Mobile (10 digits)" inputmode="tel" maxlength="12"/></div>

    <button id="sendBtn" class="btn btn-primary" aria-live="polite"><i class="fa-regular fa-paper-plane"></i><span>Send OTP</span></button>

    <section id="otpArea" aria-hidden="true">
      <div class="field"><i class="fa-solid fa-key"></i><input id="otp" type="text" placeholder="Enter OTP" inputmode="numeric" maxlength="6"/></div>
      <div class="row">
        <button id="verifyBtn" class="btn btn-success grow"><i class="fa-regular fa-circle-check"></i><span>Verify</span></button>
        <button id="resendBtn" class="btn btn-ghost" style="width:130px" disabled>Resend (30s)</button>
      </div>
    </section>

    <div id="recaptcha-container"></div>
    <p class="tiny">We save phone as +91xxxxxxxxxx</p>

    <div class="diag" id="diag" aria-live="polite" style="display:none">
      <h3>Diagnostics & Fixes</h3>
      <div id="diagSummary"></div>
      <pre id="diagDetail"></pre>
      <div style="margin-top:8px"><button id="diagClose" class="btn-ghost btn">Close</button></div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.appspot.com",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };

  // Initialize Firebase (compat)
  try {
    firebase.initializeApp(firebaseConfig);
  } catch(e) {
    console.error('firebase.initializeApp error', e);
  }
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM
  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');
  const phoneEl = document.getElementById('phone');
  const sendBtn = document.getElementById('sendBtn');
  const otpArea = document.getElementById('otpArea');
  const otpInput = document.getElementById('otp');
  const verifyBtn = document.getElementById('verifyBtn');
  const resendBtn = document.getElementById('resendBtn');
  const toast = document.getElementById('toast');
  const diag = document.getElementById('diag');
  const diagSummary = document.getElementById('diagSummary');
  const diagDetail = document.getElementById('diagDetail');
  const diagClose = document.getElementById('diagClose');

  // state
  let confirmationResult = null;
  let lastE164 = '';
  let resendTimer = null;
  let countdown = 30;

  // recaptcha singletons
  window.recaptchaVerifier = null;
  window._recaptchaWidgetId = null;

  function showToast(msg, ms=3000){
    toast.textContent = msg;
    toast.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> toast.style.display = 'none', ms);
  }

  function showDiag(summary, detail) {
    diagSummary.textContent = summary;
    diagDetail.textContent = detail;
    diag.style.display = 'block';
  }

  diagClose.addEventListener('click', ()=> diag.style.display = 'none');

  // E.164 normalization (India)
  function normalizeToE164(raw){
    if(!raw) return '';
    const cleaned = String(raw).replace(/\D/g,'');
    if(cleaned.length === 10) return '+91' + cleaned;
    if(cleaned.length === 11 && cleaned.startsWith('0')) return '+91' + cleaned.slice(1);
    if(cleaned.length === 12 && cleaned.startsWith('91')) return '+' + cleaned;
    if(cleaned.length > 10){
      const last10 = cleaned.slice(-10);
      if(last10.length === 10) return '+91' + last10;
    }
    return '';
  }

  phoneEl.addEventListener('input', () => {
    const s = phoneEl.value;
    const digits = s.replace(/\D/g,'').slice(0,12);
    phoneEl.value = digits;
  });

  // Create & render recaptcha verifier (invisible). Called only when needed.
  async function ensureRecaptcha() {
    if(window.recaptchaVerifier) return;
    try {
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'invisible',
        badge: 'bottomright'
      }, auth);

      // render() returns a widget id
      window._recaptchaWidgetId = await window.recaptchaVerifier.render();
      console.log('reCAPTCHA rendered widgetId=', window._recaptchaWidgetId);
    } catch(err) {
      console.warn('recaptcha render failed (ensureRecaptcha):', err && err.message ? err.message : err);

      // If invalid-api-key, show diag with exact steps
      if(err && err.code === 'auth/invalid-api-key') {
        const detail = [
          'Firebase returned auth/invalid-api-key while initializing reCAPTCHA.',
          '',
          'Quick fixes:',
          '1) Confirm apiKey in firebaseConfig exactly matches Firebase Console -> Project settings -> Web API Key.',
          '2) In Google Cloud Console -> APIs & Services -> Credentials, check the API key\'s "Application restrictions".',
          '   - If restricted to HTTP referrers, add: http://localhost/* and https://yourdomain/* (or remove restriction during testing).',
          '3) In Firebase Console -> Authentication -> Settings -> Authorized domains, add "localhost" (and your domain).',
          '4) Serve this page from http://localhost or https (do NOT use file://). Example: python -m http.server 8000',
          '5) Ensure Phone sign-in is enabled in Firebase Console -> Authentication -> Sign-in method -> Phone.',
          '6) Optionally add test phone numbers in Firebase Console -> Authentication -> Sign-in method -> Phone -> Phone numbers for testing.',
          '7) If you use reCAPTCHA Enterprise or custom GCP setup, ensure relevant APIs are enabled (Identity Toolkit, reCAPTCHA Enterprise).',
          '',
          'If you want, copy this exact block and paste into Google Cloud Console when editing the key restrictions.'
        ].join('\\n');

        showDiag('auth/invalid-api-key — diagnosis and exact steps to fix', detail);
      } else {
        // fallback: attempt visible recaptcha if invisible failed for environment reasons
        try {
          // make container visible to show widget
          const rcContainer = document.getElementById('recaptcha-container');
          rcContainer.style.height = '';
          rcContainer.style.overflow = 'visible';

          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            size: 'normal'
          }, auth);
          window._recaptchaWidgetId = await window.recaptchaVerifier.render();
          console.log('fallback visible reCAPTCHA rendered, widgetId=', window._recaptchaWidgetId);
        } catch(err2) {
          console.error('fallback recaptcha render failed:', err2 && err2.message ? err2.message : err2);
          // Very explicit guidance
          const detail = [
            'reCAPTCHA initialization failed in this environment.',
            'Try these steps:',
            ' - Serve the page from http://localhost and add "localhost" to Firebase Authorized domains.',
            ' - Make sure you are not mixing Firebase SDK styles (modular + compat). This page uses compat only.',
            ' - Check browser console network tab for calls to identitytoolkit.googleapis.com — they should return 200.',
            ' - If nothing helps, reload the page after performing the above steps.'
          ].join('\\n');
          showDiag('reCAPTCHA init failed — fallback also failed', detail);
          throw new Error('reCAPTCHA init failed. Try reloading the page or test on localhost/https.');
        }
      }

      // clear partial verifier to allow retry
      try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); } catch(e){}
      window.recaptchaVerifier = null;
      window._recaptchaWidgetId = null;

      // rethrow so callers see failure
      throw err;
    }
  }

  // check /driverdetails for phone variants
  async function phoneExistsInDriverDetails(e164){
    try {
      const snapPlus = await db.ref('driverdetails').orderByChild('phone').equalTo(e164).once('value');
      if(snapPlus.exists()) return true;
      const digits = e164.replace(/\D/g,'');
      const snapDigits = await db.ref('driverdetails').orderByChild('phone').equalTo(digits).once('value');
      if(snapDigits.exists()) return true;
      const last10 = digits.slice(-10);
      const snapLast = await db.ref('driverdetails').orderByChild('phone').equalTo(last10).once('value');
      if(snapLast.exists()) return true;
      return false;
    } catch(e){
      console.error('phoneExists check failed', e);
      return false;
    }
  }

  // Send OTP
  sendBtn.addEventListener('click', async () => {
    const name = (nameEl.value||'').trim();
    const phoneRaw = (phoneEl.value||'').trim();

    if(!name){ showToast('Enter name'); nameEl.focus(); return; }
    if(!phoneRaw){ showToast('Enter mobile'); phoneEl.focus(); return; }

    const e164 = normalizeToE164(phoneRaw);
    console.log('normalized phone ->', e164);
    if(!e164){ showToast('Enter a valid 10-digit mobile'); phoneEl.focus(); return; }

    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner"></span> Checking…';

    try {
      const exists = await phoneExistsInDriverDetails(e164);
      if(exists){
        showToast('Number already registered — use Login');
        sendBtn.style.display = 'none';
        const goLogin = document.createElement('button');
        goLogin.className = 'btn btn-ghost';
        goLogin.textContent = 'Go to Login';
        goLogin.addEventListener('click', ()=> location.href = 'driverlogin.html');
        sendBtn.parentNode.insertBefore(goLogin, sendBtn.nextSibling);
        return;
      }

      sendBtn.innerHTML = '<span class="spinner"></span> Preparing reCAPTCHA…';
      await ensureRecaptcha();

      sendBtn.innerHTML = '<span class="spinner"></span> Sending…';
      confirmationResult = await firebase.auth().signInWithPhoneNumber(e164, window.recaptchaVerifier);
      lastE164 = e164;
      showToast('OTP sent');
      otpArea.style.display = 'block';
      otpArea.setAttribute('aria-hidden','false');
      sendBtn.style.display = 'none';
      startResendCooldown();

    } catch(err) {
      console.error('sendOtp error', err);
      // Friendly messages
      if(err && err.code === 'auth/invalid-phone-number'){
        showToast('Invalid phone format — please enter 10 digits');
      } else if(err && err.code === 'auth/invalid-api-key'){
        showToast('Invalid API key — see Diagnostics (below) for exact steps');
        // show detailed diag if not already visible
        if(diag.style.display === 'none'){
          const detail = [
            'Error details from console:',
            (err && err.message) ? err.message : String(err),
            '',
            'Follow the checklist shown in the yellow Diagnostics box above this form.',
            'If you want, take a screenshot of this Diagnostics block and paste it into Google Cloud Console when editing your API key restrictions.'
          ].join('\\n');
          showDiag('auth/invalid-api-key — must fix API key / key restrictions', detail);
        }
      } else if(err && err.code === 'auth/argument-error') {
        showToast('reCAPTCHA not ready — ensure page is served over localhost/https and try again');
      } else if(err && err.code === 'auth/quota-exceeded') {
        showToast('SMS quota exceeded — use console test numbers or wait');
      } else {
        showToast(err && err.message ? err.message : 'Failed to send OTP');
      }

      // reset UI and recaptcha so user can retry
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> Send OTP';
      try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); } catch(e){}
      window.recaptchaVerifier = null;
      window._recaptchaWidgetId = null;
    }
  });

  // Verify OTP handler
  verifyBtn.addEventListener('click', async ()=>{
    const code = (otpInput.value||'').trim();
    if(!/^\d{4,6}$/.test(code)){ showToast('Enter OTP'); otpInput.focus(); return; }

    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<span class="spinner"></span> Verifying…';

    try {
      if(!confirmationResult) throw new Error('No OTP request in progress');
      const result = await confirmationResult.confirm(code);
      const user = result.user;
      const uid = user.uid;
      const payload = {
        driverId: uid,
        name: (nameEl.value||'').trim(),
        email: (emailEl.value||'').trim(),
        phone: lastE164,
        createdAt: new Date().toISOString()
      };
      await db.ref('driverdetails/' + uid).set(payload);
      showToast('Signup complete');
      setTimeout(()=> location.href = 'driverdashboard.html', 900);
    } catch(err){
      console.error('verify error', err);
      showToast(err && err.message ? err.message : 'Invalid OTP');
      verifyBtn.disabled = false;
      verifyBtn.innerHTML = '<i class="fa-regular fa-circle-check"></i> Verify';
    }
  });

  // Resend cooldown
  function startResendCooldown(){
    resendBtn.disabled = true;
    countdown = 30;
    resendBtn.textContent = `Resend (${countdown}s)`;
    clearInterval(resendTimer);
    resendTimer = setInterval(()=>{
      countdown--;
      if(countdown <= 0){
        clearInterval(resendTimer);
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend';
      } else {
        resendBtn.textContent = `Resend (${countdown}s)`;
      }
    },1000);
  }

  resendBtn.addEventListener('click', async ()=>{
    if(!lastE164) return;
    resendBtn.disabled = true;
    resendBtn.textContent = 'Sending…';
    try {
      await ensureRecaptcha();
      confirmationResult = await firebase.auth().signInWithPhoneNumber(lastE164, window.recaptchaVerifier);
      showToast('OTP resent');
      startResendCooldown();
    } catch(err){
      console.error('resend error', err);
      showToast(err && err.message ? err.message : 'Resend failed');
      resendBtn.disabled = false;
      resendBtn.textContent = 'Resend';
      try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); } catch(e){}
      window.recaptchaVerifier = null;
      window._recaptchaWidgetId = null;
    }
  });

  // Clean up recaptcha on unload (best effort)
  window.addEventListener('beforeunload', () => {
    try { if(window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') window.recaptchaVerifier.clear(); } catch(e){}
  });

  // Small helper: show the API key in console for debugging (not in UI)
  console.info('DEBUG: firebaseConfig.apiKey =', firebaseConfig.apiKey);
</script>
</body>
</html>
