<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Driver Signup - WaveTravel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase v9 compat (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-functions-compat.js"></script>
</head>
<body>
  <h2>Driver Signup</h2>

  <input type="text" id="name" placeholder="Full Name"><br><br>
  <input type="text" id="email" placeholder="Email"><br><br>
  <input type="text" id="phone" placeholder="Phone Number (10 digits)"><br><br>

  <div id="recaptcha-container"></div>
  <button onclick="sendOTP()">Send OTP</button><br><br>

  <input type="text" id="otp" placeholder="Enter OTP"><br><br>
  <button onclick="verifyOTP()">Verify OTP & Signup</button>

  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();
    const functions = firebase.functions();

    let confirmationResult;

    async function sendOTP() {
      try {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const phoneInput = document.getElementById("phone").value.trim();

        if (!name || !email || !phoneInput) {
          alert("Please fill all fields");
          return;
        }

        if (phoneInput.length !== 10) {
          alert("Enter a valid 10-digit phone number");
          return;
        }

        const fullPhone = "+91" + phoneInput;

        // ✅ Call Cloud Function to check phone
        const checkPhone = firebase.functions().httpsCallable("checkPhoneNumber");
        const result = await checkPhone({ phone: fullPhone });

        if (result.data.exists) {
          alert("Phone number already registered. Please login.");
          return;
        }

        // ✅ Setup reCAPTCHA
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier("recaptcha-container", {
          size: "invisible"
        });

        confirmationResult = await auth.signInWithPhoneNumber(fullPhone, window.recaptchaVerifier);
        alert("OTP sent successfully!");

      } catch (error) {
        console.error("sendOTP error:", error);
        alert("Error: " + error.message);
      }
    }

    async function verifyOTP() {
      try {
        const otp = document.getElementById("otp").value.trim();
        if (!otp) {
          alert("Enter OTP");
          return;
        }

        const result = await confirmationResult.confirm(otp);
        const user = result.user;

        // ✅ Save driver details in DB
        const driverData = {
          name: document.getElementById("name").value.trim(),
          email: document.getElementById("email").value.trim(),
          phone: user.phoneNumber,
          role: "driver"
        };

        await db.ref("driverdetails/" + user.uid).set(driverData);

        alert("Driver registered successfully!");
        window.location.href = "driverdashboard.html";

      } catch (error) {
        console.error("verifyOTP error:", error);
        alert("Error: " + error.message);
      }
    }
  </script>
</body>
</html>
