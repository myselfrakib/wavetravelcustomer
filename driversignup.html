<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver Signup — WaveTravel</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* (same styles as you provided) */
body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(to right, #6a11cb, #2575fc);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}
.signup-card {
  background: #fff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 12px 25px rgba(0,0,0,0.2);
  width: 380px;
  text-align: center;
  animation: fadeIn 1s ease;
}
h2 { margin-bottom: 20px; color: #333; }
input { width: 100%; padding: 12px 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; transition: border-color 0.3s; }
input:focus { outline: none; border-color: #2575fc; }
button {
  width: 100%;
  padding: 12px;
  background: #2575fc;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
  transition: background 0.3s;
}
button:hover { background: #1a5ed1; }
button:disabled { background: #999; cursor: not-allowed; }
#otp-section { display: none; margin-top: 15px; }
.otp-inputs { display: flex; justify-content: space-between; }
.otp-inputs input { width: 45px; padding: 12px; font-size: 18px; text-align: center; }
#toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 12px 25px;
  border-radius: 5px;
  display: none;
  font-weight: 500;
}
#resendBtn { margin-top: 10px; display: none; }
.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #fff;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 1s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-left: 10px;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="signup-card">
  <h2>Driver Signup</h2>
  <form id="driverSignupForm">
    <input type="text" id="name" placeholder="Full Name" required>
    <input type="text" id="phone" placeholder="Phone Number" required>
    <input type="email" id="email" placeholder="Email" required>
    <button type="submit" id="signupBtn">Send OTP</button>
  </form>

  <div id="otp-section">
    <div class="otp-inputs">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
    </div>
    <button id="verifyBtn">Verify OTP</button>
    <button id="resendBtn">Resend OTP (60)</button>
  </div>

  <div id="recaptcha-container"></div>
</div>

<div id="toast"></div>

<!-- Firebase 10 compat SDKs (app, auth, database, functions-compat) -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
<!-- functions-compat to use callable functions via firebase.functions() (compat mode) -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-functions-compat.js"></script>

<script>
/* === Firebase config ===
   Replace with your values if they differ — these match your project from earlier messages.
*/
const firebaseConfig = {
  apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
  authDomain: "wavetravel-3c4c4.firebaseapp.com",
  databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
  projectId: "wavetravel-3c4c4",
  storageBucket: "wavetravel-3c4c4.appspot.com",
  messagingSenderId: "298226098137",
  appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const functions = firebase.functions(); // compat callable functions
let confirmationResultGlobal = null;

window.onload = () => {
  // reCAPTCHA verifier (invisible)
  window.reCAPTCHAVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
  // Render explicitly for certain browsers (not necessary with invisible, but safe)
  window.reCAPTCHAVerifier.render().catch(()=>{/* ignore for invisible */});
};

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.innerText = msg;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

const signupForm = document.getElementById('driverSignupForm');
const otpSection = document.getElementById('otp-section');
const signupBtn = document.getElementById('signupBtn');
const verifyBtn = document.getElementById('verifyBtn');
const resendBtn = document.getElementById('resendBtn');
const otpInputs = document.querySelectorAll('.otp-box');

// OTP input focus behavior (unchanged)
otpInputs.forEach((input, index) => {
  input.addEventListener('input', () => {
    if (input.value.length === 1 && index < otpInputs.length - 1) otpInputs[index + 1].focus();
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && input.value === '' && index > 0) otpInputs[index - 1].focus();
  });
});

/**
 * Helper: call Cloud Function to check if a phone (E.164) exists in Firebase Auth
 * Returns boolean
 */
async function checkPhoneExistsInAuth(phoneE164) {
  try {
    // Ensure functions callable is available
    const checkPhone = functions.httpsCallable('checkPhoneNumber');
    const res = await checkPhone({ phone: phoneE164 });
    return !!(res && res.data && res.data.exists);
  } catch (err) {
    // If App Check is enabled and token missing, function will throw failed-precondition
    console.error("checkPhoneExistsInAuth error:", err);
    // For UX, show safe message and stop signup
    showToast('Could not verify phone. Try again later.');
    throw err;
  }
}

// Send OTP
signupForm.addEventListener('submit', async function(e){
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const fullPhone = '+91' + phone;

  if (!name || !phone || !email) { showToast('Please fill all fields.'); return; }

  signupBtn.disabled = true;
  signupBtn.innerHTML = 'Checking <span class="spinner"></span>';

  try {
    // 1) Call Cloud Function to check if an Auth user already exists with this phone
    const authExists = await checkPhoneExistsInAuth(fullPhone);
    if (authExists) {
      showToast('This phone is already registered. Please sign in.');
      signupBtn.disabled = false;
      signupBtn.innerText = 'Send OTP';
      return;
    }

    // 2) Then check your Realtime DB driverdetails as before (keep the original behavior)
    const snapshot = await database.ref('driverdetails').once('value');
    let existsInDB = false;
    snapshot.forEach(child => {
      const val = child.val();
      if (val.phone === fullPhone || val.email === email) existsInDB = true;
    });
    if (existsInDB) {
      showToast('This number or email address is already being used');
      signupBtn.disabled = false;
      signupBtn.innerText = 'Send OTP';
      return;
    }

    // 3) Send OTP as before
    signupBtn.innerHTML = 'Sending OTP <span class="spinner"></span>';
    const result = await auth.signInWithPhoneNumber(fullPhone, window.reCAPTCHAVerifier);
    confirmationResultGlobal = result;
    showToast('OTP sent! Check your phone.');
    otpSection.style.display = 'block';
    otpInputs.forEach(i=>i.value='');
    otpInputs[0].focus();
    signupBtn.style.display = 'none';
    startResendCountdown();
  } catch (err) {
    // error already shown in checkPhoneExistsInAuth or here
    console.error(err);
    if (!err.message) {
      showToast('Error: Unable to process request.');
    } else {
      // if error from auth/signInWithPhoneNumber show message
      showToast('Error: ' + err.message);
    }
    signupBtn.disabled = false;
    signupBtn.innerText = 'Send OTP';
  }
});

// Verify OTP (unchanged logic except minor adjustments)
verifyBtn.addEventListener('click', () => {
  const otp = Array.from(otpInputs).map(input => input.value).join('');
  if (otp.length !== 6){ showToast('Enter complete 6-digit OTP'); return; }

  confirmationResultGlobal.confirm(otp)
    .then(userCredential => {
      const driverId = userCredential.user.uid;
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = '+91' + document.getElementById('phone').value.trim();
      const createdAt = new Date().toISOString();

      database.ref('driverdetails/' + driverId).set({name, phone, email, createdAt})
        .then(()=>{
          showToast('Signup successful! Redirecting...');
          setTimeout(()=>{ window.location.href='driverdashboard.html'; }, 2000);
        })
        .catch(err=>{ showToast('Error saving data: '+err.message); });
    })
    .catch(err => { showToast('Invalid OTP: '+err.message); });
});

// Resend OTP with 60-sec countdown (unchanged)
function startResendCountdown(){
  resendBtn.style.display='block';
  resendBtn.disabled=true;
  let counter=60;
  resendBtn.innerText = `Resend OTP (${counter})`;
  const interval = setInterval(()=>{
    counter--;
    resendBtn.innerText = `Resend OTP (${counter})`;
    if(counter===0){
      clearInterval(interval);
      resendBtn.innerText = 'Resend OTP';
      resendBtn.disabled=false;
    }
  },1000);
}

resendBtn.addEventListener('click', ()=>{
  resendBtn.disabled=true;
  const phone = '+91' + document.getElementById('phone').value.trim();
  auth.signInWithPhoneNumber(phone, window.reCAPTCHAVerifier)
    .then(res => {
      confirmationResultGlobal = res;
      showToast('OTP resent!');
      otpInputs.forEach(i=>i.value='');
      otpInputs[0].focus();
      startResendCountdown();
    })
    .catch(err => { showToast('Error resending OTP: ' + err.message); resendBtn.disabled=false; });
});
</script>
</body>
</html>
