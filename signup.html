<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' https://www.google.com https://www.gstatic.com">
  <title>WaveTravel - Sign Up (OTP)</title>
  <style>
    :root { --accent:#ff6ec4; --primary:#1e40af; --secondary:#0ea5e9; }
    html,body { height:100%; margin:0; }
    body{
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      position: relative;
      display:flex; align-items:center; justify-content:center;
      color:white;
      height:100vh;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 110, 199, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(14, 165, 233, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    .container{
      width:92%; max-width:440px;
      background: rgba(0,0,0,0.45);
      padding:26px; border-radius:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    h2{ margin:0 0 6px; text-align:center; font-size:24px; }
    h3{ margin:0 0 20px; text-align:center; font-weight:500; color:#ffd1f4; font-size:16px; }
    input, button {
      width:100%; padding:12px; margin:8px 0; border-radius:8px; border:none; box-sizing:border-box;
      font-size:15px;
    }
    input { background: rgba(255,255,255,0.06); color: #fff; }
    input::placeholder { color: rgba(255,255,255,0.65); }
    .row { display:flex; gap:8px; align-items:center; }
    .small { font-size:13px; color:#e9c7ef; text-align:center; margin-top:10px; }
    a { color:#ffd1f4; text-decoration:none; }
    a:hover { text-decoration:underline; }

    button.primary {
      background: var(--accent); color:#fff; font-weight:700; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    button.ghost { background: transparent; border:1px solid rgba(255,255,255,0.12); color:#fff; cursor:pointer; }
    button.disabled, .btn-disabled { opacity:0.6; pointer-events:none; }

    /* Spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.25);
      border-top-color: #fff;
      animation: spin 0.9s linear infinite;
      display:inline-block; vertical-align:middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* OTP actions */
    .otp-actions { display:flex; gap:8px; margin-top:6px; align-items:center; }
    .countdown { font-size:13px; color:#ffd1f4; min-width:90px; text-align:center; }

    /* Toasts */
    .toast-wrap {
      position: fixed; right:18px; bottom:18px; z-index:99999;
      display:flex; flex-direction:column; gap:10px; align-items:flex-end;
    }
    .toast {
      background: rgba(0,0,0,0.82); color:white; padding:10px 14px; border-radius:8px;
      min-width:220px; box-shadow: 0 8px 26px rgba(0,0,0,0.45);
      opacity:0; transform: translateY(10px); transition: all 240ms ease;
      font-size:14px;
    }
    .toast.show { opacity:1; transform: translateY(0); }
    .toast.success { border-left:4px solid #6ee7b7; }
    .toast.error { border-left:4px solid #fb7185; }
    .toast.info { border-left:4px solid #60a5fa; }

    /* Phone input highlight when pre-filled */
    .phone-prefilled {
      background: rgba(255, 255, 255, 0.12) !important;
      border: 1px solid rgba(255, 110, 199, 0.4);
      box-shadow: 0 0 0 2px rgba(255, 110, 199, 0.1);
    }

    /* responsive */
    @media (max-width:420px){
      .otp-actions { flex-direction:column; }
      .countdown { order: -1; margin-bottom:6px; }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-labelledby="title">
    <h2 id="title">WaveTravel</h2>
    <h3>Create Account (Phone OTP)</h3>

    <input id="name" type="text" placeholder="Full Name" autocomplete="name" />
    <input id="phone" type="text" placeholder="Phone Number (10 digits)" inputmode="numeric" maxlength="10" />

    <div id="sendSection">
      <button id="sendOtpBtn" class="primary" aria-live="polite">
        <span id="sendBtnText">Send OTP</span>
        <span id="sendSpinner" style="display:none" aria-hidden="true" class="spinner"></span>
      </button>
    </div>

    <div id="otpSection" style="display:none;">
      <input id="otp" type="text" placeholder="Enter OTP" inputmode="numeric" />
      <div class="otp-actions">
        <button id="verifyOtpBtn" class="primary">
          <span id="verifyBtnText">Verify & Create Account</span>
          <span id="verifySpinner" style="display:none" class="spinner" aria-hidden="true"></span>
        </button>

        <button id="resendBtn" class="ghost">Resend</button>
        <div class="countdown" id="countdownText"></div>
      </div>
    </div>

    <div id="recaptcha-container" style="height:1px; width:1px; overflow:hidden; position:absolute; left:-9999px;"></div>

    <div class="small">Already have an account? <a href="index.html">Login here</a></div>
  </div>

  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

  <script>
  // ====== CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.appspot.com",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // UI refs
  const nameInput = document.getElementById('name');
  const phoneInput = document.getElementById('phone');
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const sendBtnText = document.getElementById('sendBtnText');
  const sendSpinner = document.getElementById('sendSpinner');

  const otpSection = document.getElementById('otpSection');
  const sendSection = document.getElementById('sendSection');

  const otpInput = document.getElementById('otp');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const verifyBtnText = document.getElementById('verifyBtnText');
  const verifySpinner = document.getElementById('verifySpinner');

  const resendBtn = document.getElementById('resendBtn');
  const countdownText = document.getElementById('countdownText');

  const toastWrap = document.getElementById('toastWrap');

  // Resend cooldown (seconds)
  const RESEND_COOLDOWN = 60;
  let countdownTimer = null;
  let remaining = 0;

  // --- URL Parameter Reading Function ---
  function getURLParameter(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // --- Phone Number Pre-fill Logic ---
  function prefillPhoneFromURL() {
    const phoneParam = getURLParameter('phone');
    if (phoneParam) {
      // Remove any non-digit characters and take first 10 digits
      const cleanPhone = phoneParam.replace(/\D/g, '').slice(0, 10);
      if (cleanPhone.length === 10) {
        phoneInput.value = cleanPhone;
        phoneInput.classList.add('phone-prefilled');
        showToast('Phone number pre-filled from login', 'info', 2500);
        
        // Focus on name field since phone is already filled
        nameInput.focus();
        
        // Remove the highlight after a few seconds
        setTimeout(() => {
          phoneInput.classList.remove('phone-prefilled');
        }, 3000);
      }
    }
  }

  // --- Initialize on page load ---
  window.addEventListener('DOMContentLoaded', () => {
    prefillPhoneFromURL();
  });

  // --- Toast helper (replace alert) ---
  function showToast(message, type = 'info', duration = 3800) {
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.textContent = message;
    toastWrap.appendChild(t);
    // show
    requestAnimationFrame(() => t.classList.add('show'));
    // remove after duration
    setTimeout(() => {
      t.classList.remove('show');
      setTimeout(() => t.remove(), 260);
    }, duration);
  }

  // --- Phone input validation and formatting ---
  phoneInput.addEventListener('input', (e) => {
    // Remove non-digit characters
    e.target.value = e.target.value.replace(/\D/g, '');
    // Remove prefilled styling when user starts typing
    if (phoneInput.classList.contains('phone-prefilled')) {
      phoneInput.classList.remove('phone-prefilled');
    }
  });

  // --- Utility validators ---
  function validPhone(phone) {
    return /^\d{10}$/.test(phone);
  }

  async function phoneExists(fullPhone) {
    try {
      const snapshot = await db.ref('users').orderByChild('phone').equalTo(fullPhone).once('value');
      return snapshot.exists();
    } catch(e) {
      console.error('phoneExists error', e);
      return false;
    }
  }

  // Check if phone exists in driverdetails collection
  async function phoneExistsInDrivers(fullPhone) {
    try {
      const snapshot = await db.ref('driverdetails').orderByChild('phone').equalTo(fullPhone).once('value');
      return snapshot.exists();
    } catch(e) {
      console.error('phoneExistsInDrivers error', e);
      return false;
    }
  }

  // Check if phone exists in evplan/users/profile
  async function phoneExistsInEvPlan(fullPhone) {
    try {
      const snapshot = await db.ref('evplan/users/profile').once('value');
      if (snapshot.exists()) {
        const profiles = snapshot.val();
        for (const uid in profiles) {
          if (profiles[uid].userdetails && profiles[uid].userdetails.phone === fullPhone) {
            return true;
          }
        }
      }
      return false;
    } catch(e) {
      console.error('phoneExistsInEvPlan error', e);
      return false;
    }
  }

  // --- Spinner helpers ---
  function setSending(sending) {
    if (sending) {
      sendSpinner.style.display = 'inline-block';
      sendBtnText.textContent = 'Sending...';
      sendOtpBtn.classList.add('disabled');
      sendOtpBtn.disabled = true;
    } else {
      sendSpinner.style.display = 'none';
      sendBtnText.textContent = 'Send OTP';
      sendOtpBtn.classList.remove('disabled');
      sendOtpBtn.disabled = false;
    }
  }

  function setVerifying(verifying) {
    if (verifying) {
      verifySpinner.style.display = 'inline-block';
      verifyBtnText.textContent = 'Verifying...';
      verifyOtpBtn.classList.add('disabled');
      verifyOtpBtn.disabled = true;
    } else {
      verifySpinner.style.display = 'none';
      verifyBtnText.textContent = 'Verify & Create Account';
      verifyOtpBtn.classList.remove('disabled');
      verifyOtpBtn.disabled = false;
    }
  }

  // Start resend countdown
  function startResendCountdown(seconds = RESEND_COOLDOWN) {
    remaining = seconds;
    resendBtn.classList.add('btn-disabled');
    resendBtn.disabled = true;
    countdownText.textContent = `Retry in ${remaining}s`;
    clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        clearInterval(countdownTimer);
        countdownText.textContent = '';
        resendBtn.classList.remove('btn-disabled');
        resendBtn.disabled = false;
      } else {
        countdownText.textContent = `Retry in ${remaining}s`;
      }
    }, 1000);
  }

  // Create (or recreate) invisible reCAPTCHA verifier
  function createRecaptcha() {
    if (window.recaptchaVerifier) {
      try { window.recaptchaVerifier.clear(); } catch(e){/*ignore*/ }
    }
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      'size': 'invisible'
    });
    return window.recaptchaVerifier;
  }

  // Send OTP flow (initial and resend)
  async function sendOtpFlow(isResend = false) {
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();

    if (!name) { 
      showToast('Please enter your name.', 'error'); 
      nameInput.focus();
      return false; 
    }
    if (!phone) { 
      showToast('Please enter phone number.', 'error'); 
      phoneInput.focus();
      return false; 
    }
    if (!validPhone(phone)) { 
      showToast('Enter a valid 10-digit phone number.', 'error'); 
      phoneInput.focus();
      return false; 
    }

    const fullPhone = '+91' + phone;

    try {
      if (!isResend) {
        // Check if phone exists in users collection
        if (await phoneExists(fullPhone)) {
          showToast('Phone number already registered. Please login instead.', 'error');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          return false;
        }

        // Check if phone exists in driverdetails collection
        if (await phoneExistsInDrivers(fullPhone)) {
          showToast('Driver account is found with this number, Please login or use different mobile number', 'error');
          return false;
        }

        // Check if phone exists in evplan/users/profile
        if (await phoneExistsInEvPlan(fullPhone)) {
          showToast('Phone number already registered in EVPlan. Please login instead.', 'error');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          return false;
        }
      }

      setSending(true);
      // fresh recaptcha each time
      const appVerifier = createRecaptcha();

      const confirmationResult = await auth.signInWithPhoneNumber(fullPhone, appVerifier);
      window.confirmationResult = confirmationResult;

      showToast('OTP sent to ' + fullPhone + '.', 'success');

      // show otp UI
      sendSection.style.display = 'none';
      otpSection.style.display = 'block';

      // Focus on OTP input
      setTimeout(() => otpInput.focus(), 300);

      // start cooldown for resend
      startResendCountdown();

      setSending(false);
      return true;
    } catch (error) {
      console.error('Error sending OTP:', error);
      // try resetting recaptcha if possible
      try { window.recaptchaVerifier.render().then(widgetId => { try { grecaptcha.reset(widgetId); } catch(e){} }); } catch(e){}
      showToast('Error sending OTP: ' + (error.message || error), 'error');
      setSending(false);
      return false;
    }
  }

  // Event bindings
  sendOtpBtn.addEventListener('click', () => sendOtpFlow(false));

  resendBtn.addEventListener('click', async () => {
    showToast('Resending OTP...', 'info');
    const ok = await sendOtpFlow(true);
    if (ok) showToast('OTP resent.', 'success');
  });

  verifyOtpBtn.addEventListener('click', async () => {
    const code = otpInput.value.trim();
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();
    const fullPhone = '+91' + phone;

    if (!code) { 
      showToast('Please enter the OTP.', 'error'); 
      otpInput.focus();
      return; 
    }
    if (!window.confirmationResult) { 
      showToast('No OTP request found. Please request OTP again.', 'error'); 
      return; 
    }

    try {
      setVerifying(true);
      const result = await window.confirmationResult.confirm(code);
      const user = result.user;
      const uid = user.uid;

      const timestamp = Date.now();
      
      // User data object
      const userData = {
        name: name,
        phone: fullPhone,
        role: 'customer',
        createdAt: timestamp
      };

      // Save user data in both locations using Promise.all for parallel execution
      await Promise.all([
        // Save in original location: /users/{uid}
        db.ref('users/' + uid).set(userData),
        
        // Save in new location: /evplan/users/profile/{uid}/userdetails
        db.ref('evplan/users/profile/' + uid + '/userdetails').set(userData)
      ]);

      showToast('Account created and signed in successfully!', 'success');

      // redirect shortly after success
      setTimeout(() => {
        window.location.href = `booking.html?uid=${encodeURIComponent(uid)}`;
      }, 1500);
    } catch (error) {
      console.error('OTP verify error:', error);
      showToast('OTP verification failed: ' + (error.message || error), 'error');
      setVerifying(false);
      otpInput.focus();
    }
  });

  // Handle Enter key presses for better UX
  nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      if (phoneInput.value.trim()) {
        sendOtpBtn.click();
      } else {
        phoneInput.focus();
      }
    }
  });

  phoneInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendOtpBtn.click();
    }
  });

  otpInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      verifyOtpBtn.click();
    }
  });

  // Auto-verify OTP when 6 digits are entered
  otpInput.addEventListener('input', () => {
    const code = otpInput.value.trim();
    if (code.length === 6 && /^\d{6}$/.test(code)) {
      setTimeout(() => {
        if (!verifyOtpBtn.disabled) {
          verifyOtpBtn.click();
        }
      }, 300);
    }
  });

  // Optional: if already signed in, you may auto-redirect
  auth.onAuthStateChanged((user) => {
    if (user) {
      // Optionally uncomment to redirect already-signed-in users:
      // window.location.href = 'dashboard.html';
    }
  });

  </script>
</body>
</html>
