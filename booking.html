<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Ride - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      /* Palette provided:
         Lapis Lazuli:  #2f6690
         Cerulean:      #3a7ca5
         Platinum:      #d9dcd6
         Indigo dye:    #16425b
         Sky blue:      #81c3d7
      */
      --primary: #2f6690;      /* Lapis Lazuli */
      --accent:  #3a7ca5;      /* Cerulean */
      --light:   #d9dcd6;      /* Platinum */
      --dark:    #16425b;      /* Indigo dye */
      --sky:     #81c3d7;      /* Sky blue */
      --muted:   #6da5d0;      /* derived — gentle mid tone from palette */
      --card-radius: 14px;
      --card-padding: 14px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height:100%; }
    body {
      font-family: 'Poppins', sans-serif;
      /* gradient from Cerulean → Indigo dye */
      background: linear-gradient(to right, var(--accent), var(--dark));
      display: flex; flex-direction: column; min-height: 100vh;
      color: var(--dark);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
    }
    .container {
      flex: 1; max-width: 720px; width: 100%;
      margin: 0 auto; padding: 18px; padding-bottom: 120px;
    }
    h1 {
      font-size: 1.5rem; text-align: center; margin-bottom: 14px;
      color: var(--light);
    }
    .form-group { margin-bottom: 12px; }
    label {
      display: block; margin-bottom: 8px; font-weight: 600; color: var(--light);
    }
    select, input {
      width: 100%; padding: 0.75rem; border: 1px solid rgba(0,0,0,0.06);
      border-radius: 10px; background: #fff; font-size: 1rem;
      box-shadow: 0 1px 2px rgba(16,24,40,0.03);
    }
    .search-btn {
      display: block; width: 100%; padding: 12px;
      margin-top: 12px; /* primary button: Lapis -> Sky gradient */
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: #fff; font-size: 1.02rem; font-weight: 700;
      border: none; border-radius: 10px; cursor: pointer;
      transition: transform .08s ease, box-shadow .12s ease;
      box-shadow: 0 8px 18px rgba(2,6,23,0.12);
    }
    .search-btn:active { transform: translateY(1px); }

    .slots { margin-top: 14px; display: flex; flex-direction: column; gap: 14px; }

    /* Improved slot card UI */
    .slot-card {
      display: grid;
      grid-template-columns: 8px 1fr auto;
      gap: 12px;
      align-items: start;
      /* subtle platinum card surface */
      background: linear-gradient(180deg, #ffffff 0%, var(--light) 100%);
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      box-shadow: 0 12px 30px rgba(2,6,23,0.08);
      border: 1px solid rgba(2,6,23,0.04);
      overflow: hidden;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .slot-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(2,6,23,0.10); }

    .slot-accent { width: 8px; height: 100%;
      /* accent gradient Lapis → Cerulean */
      background: linear-gradient(180deg, var(--primary), var(--accent));
      border-radius: 6px;
    }

    .slot-main { display:flex; flex-direction:column; gap:10px; min-width:0; }

    .slot-number {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:34px;
      height:34px;
      border-radius:10px;
      /* soft sky background for number */
      background: linear-gradient(90deg, var(--sky), rgba(129,195,215,0.9));
      color: var(--dark);
      font-weight:800;
      font-size:0.95rem;
      box-shadow: 0 6px 14px rgba(2,6,23,0.06);
    }

    .pickup-drop { display:flex; flex-direction:column; gap:6px; }
    .pd-row { display:flex; gap:8px; align-items:center; }
    .pd-label { font-size:0.78rem; color:rgba(22,66,91,0.75); font-weight:800; text-transform:uppercase; letter-spacing:0.6px; width:74px; flex-shrink:0; }
    .pd-value { font-weight:800; color:var(--dark); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .car-row {
      display:flex; gap:8px; align-items:center; margin-top:4px;
    }
    .car-name { font-weight:700; color:var(--primary); font-size:0.95rem; display:flex; gap:8px; align-items:center; }
    .car-name i { color:var(--primary); font-size:1.05rem; background: rgba(47,102,144,0.06); padding:6px; border-radius:8px; }

    .slot-mid {
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      justify-content:space-between;
    }
    .slot-mid-left { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill {
      border-radius:999px; padding:6px 8px; font-weight:700; font-size:0.85rem; color:var(--dark);
      display:inline-flex; gap:8px; align-items:center; box-shadow: 0 3px 8px rgba(2,6,23,0.04);
    }
    .seat-pill { background: linear-gradient(90deg,#e6f7fb,#cfeff6); color: var(--dark); }
    .date-pill { background: linear-gradient(90deg,#eaf6ff,#dbeffb); color: var(--primary); }
    .time-pill { background: linear-gradient(90deg,#eefafc,#dff4f8); color:#0b5966; }
    .perseat-pill { background: linear-gradient(90deg,#f7fbff,#e8f2fb); color:var(--primary); font-weight:800; }

    .slot-right {
      display:flex; flex-direction:column; align-items:flex-end; gap:8px; margin-left:8px;
      justify-self:end;
    }
    .fare-large { font-weight:900; font-size:1.18rem; color:var(--dark); background:linear-gradient(90deg,rgba(0,0,0,0.02),transparent); padding:6px 10px; border-radius:10px; }
    .fare-small { font-size:12px; color:var(--muted); display:none; }

    /* Booking actions: grid for desktop, stacked for mobile */
    .slot-actions {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:8px;
      align-items:center;
    }
    @media (max-width:520px) {
      .slot-card { grid-template-columns: 6px 1fr; grid-template-rows: auto auto auto; }
      .slot-right { justify-self:start; flex-direction:row; gap:8px; }
      .fare-large { font-size:1.02rem; }
      .slot-actions { grid-template-columns: 1fr; }
      .pd-label { width:64px; }
    }

    .action-wrap { display:flex; width:100%; }
    .btn-action {
      display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%;
      padding: 14px 16px; border-radius: 12px; border: none; cursor: pointer; font-weight:800;
      font-size:1.02rem; box-shadow: 0 8px 20px rgba(2,6,23,0.06);
      transition: transform .06s ease, box-shadow .1s ease;
      color:#fff;
    }
    .btn-action:active { transform: translateY(1px); }

    /* single-seat button: sky -> cerulean */
    .btn-single { background: linear-gradient(90deg, var(--sky), var(--accent)); color:#fff; }
    /* full car button: accent -> lapis */
    .btn-full   { background: linear-gradient(90deg, var(--accent), var(--primary)); color:#fff; }

    .btn-left { display:flex; align-items:center; gap:12px; min-width:0; overflow:hidden; }
    .btn-left i { width:34px; text-align:center; font-size:1.15rem; }
    .btn-left span { white-space:nowrap; text-overflow:ellipsis; overflow:hidden; display:inline-block; max-width:160px; }

    .btn-right { display:flex; align-items:center; gap:8px; min-width:fit-content; }
    .price-pill { background: rgba(255,255,255,0.14); padding:6px 10px; border-radius:10px; font-weight:900; color:#fff; }

    .no-slots { text-align: center; padding: 1rem; background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(2,6,23,0.06); font-weight:700; color:var(--dark); }
    .fallback-msg { background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 4px 12px rgba(2,6,23,0.06); font-weight:700; color:var(--dark); }

    .navbar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: #fff; border-top: 1px solid rgba(0,0,0,0.06);
      display: flex; justify-content: space-around; padding: 0.6rem 0;
      box-shadow: 0 -6px 18px rgba(2,6,23,0.06);
    }
    .navbar a { color: var(--primary); text-decoration: none; font-size: 0.78rem; text-align:center; }
    .navbar a i { font-size:1.3rem; display:block; margin-bottom:4px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Book Your Ride</h1>

    <div class="form-group">
      <label for="pickup">Pickup Location</label>
      <select id="pickup"><option value="">Select Pickup</option></select>
    </div>

    <div class="form-group">
      <label for="dropoff">Dropoff Location</label>
      <select id="dropoff"><option value="">Select Dropoff</option></select>
    </div>

    <div class="form-group">
      <label for="date">Select Date</label>
      <input type="date" id="date"/>
    </div>

    <div class="form-group">
      <label for="seats">Seats Needed</label>
      <input type="number" id="seats" min="1" placeholder="Enter seats"/>
    </div>

    <button class="search-btn" onclick="searchSlots()">Search Available Slots</button>

    <div class="slots" id="slots"></div>
  </div>

  <div class="navbar">
    <a href="customerdashboard.html"><i class="fas fa-home"></i>Home</a>
    <a href="booking.html"><i class="fas fa-car"></i>Book</a>
    <a href="mybookings.html"><i class="fas fa-calendar-check"></i>Bookings</a>
    <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    const pickupEl  = document.getElementById('pickup');
    const dropoffEl = document.getElementById('dropoff');
    const dateEl    = document.getElementById('date');
    const seatsEl   = document.getElementById('seats');
    const slotsDiv  = document.getElementById('slots');
    const locationIndexMap = {};

    // Debounce helper so date changes don't fire repeat requests rapidly
    function debounce(fn, wait = 350) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    // We'll use a debounce-wrapped version of searchSlots for the date change
    const debounceSearch = debounce(() => {
      // Only trigger auto-search if pickup and dropoff are already chosen to avoid alert popups.
      if (pickupEl.value && dropoffEl.value && dateEl.value) {
        searchSlots();
      }
    }, 350);

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
      } else {
        loadLocations();
      }
    });

    function loadLocations() {
      db.ref('locations').once('value').then(snap => {
        let puOpts = '<option value="">Select Pickup</option>',
            doOpts = '<option value="">Select Dropoff</option>';
        snap.forEach(child => {
          const loc = child.val();
          locationIndexMap[loc.name] = loc.index;
          puOpts += `<option value="${loc.name}">${loc.name}</option>`;
          doOpts += `<option value="${loc.name}">${loc.name}</option>`;
        });
        pickupEl.innerHTML  = puOpts;
        dropoffEl.innerHTML = doOpts;

        const today = new Date().toISOString().split('T')[0];
        dateEl.value  = today;
        seatsEl.value = '1';

        const defaultPickup  = 'Berhampore Mohona Bus Stand';
        const defaultDropoff = 'Kolkata Airport';
        Array.from(pickupEl.options).forEach(opt => {
          if (opt.text === defaultPickup) opt.selected = true;
        });
        Array.from(dropoffEl.options).forEach(opt => {
          if (opt.text === defaultDropoff) opt.selected = true;
        });

        // If both defaults are set after load, we can auto-search once for the initial date.
        // (Optional helpful UX — won't run if user changed them)
        if (pickupEl.value && dropoffEl.value && dateEl.value) {
          // small timeout to let UI settle
          setTimeout(() => searchSlots(), 150);
        }
      });
    }

    // Bind change/input/blur events so selecting date auto-searches across devices
    dateEl.addEventListener('change', () => debounceSearch());
    dateEl.addEventListener('input', () => debounceSearch());
    // Many mobile browsers reliably fire blur/focusout when the native picker closes — listen for that too
    dateEl.addEventListener('blur', () => debounceSearch());
    dateEl.addEventListener('focusout', () => debounceSearch());

    // For mobile native pickers (some browsers), touch/pointer events happen before the value updates.
    // Use a short delayed call after touchend/pointerup to allow the control to set the value.
    dateEl.addEventListener('touchend', () => { setTimeout(() => debounceSearch(), 500); });
    dateEl.addEventListener('pointerup', () => { setTimeout(() => debounceSearch(), 350); });

    // Also trigger auto-search when pickup or dropoff changes and date already selected
    pickupEl.addEventListener('change', () => {
      if (dateEl.value && dropoffEl.value) debounceSearch();
    });
    dropoffEl.addEventListener('change', () => {
      if (dateEl.value && pickupEl.value) debounceSearch();
    });

    function formatTime24to12(time24) {
      const [hourStr, minute] = (time24||'00:00').split(':');
      let hour = parseInt(hourStr, 10);
      const period = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12 === 0 ? 12 : hour % 12;
      return `${hour}:${minute} ${period}`;
    }

    function formatDateISOtoDMY(isoDate) {
      const [year, month, day] = isoDate.split('-');
      return `${day}/${month}/${year}`;
    }

    function searchSlots() {
      slotsDiv.innerHTML = '';
      const pu  = pickupEl.value;
      const dof = dropoffEl.value;
      const dt  = dateEl.value;
      const req = parseInt(seatsEl.value, 10) || 1;
      if (!pu || !dof || !dt) {
        // Quiet early return for auto-searchs; manual button still calls this and will silently return as well (keeps behavior from last saved copy)
        return;
      }
      const doIdx = locationIndexMap[dof] || 0;

      db.ref('availableslots').once('value').then(snap => {
        const all = [];
        snap.forEach(driverSnap => {
          driverSnap.forEach(slotSnap => {
            all.push({
              driverId: driverSnap.key,
              slotKey:  slotSnap.key,
              ...slotSnap.val()
            });
          });
        });

        // Exact matches first
        let matched = all.filter(s =>
          s.pickup === pu && s.dropoff === dof && s.date === dt
        );

        // If no exact matches, fallback to alternatives (same date, same dropoff index)
        let fallbackUsed = false;
        if (!matched.length) {
          const alternatives = all.filter(s =>
            s.date === dt && locationIndexMap[s.dropoff] === doIdx
          );
          if (alternatives.length) {
            matched = alternatives;
            fallbackUsed = true;
          }
        }

        if (!matched.length) {
          slotsDiv.innerHTML = `<div class="no-slots">No slots found.</div>`;
        } else {
          renderSlots(matched, req, { used: fallbackUsed, pickup: pu, dropoff: dof, date: dt });
        }
      });
    }

    function renderSlots(slots, reqSeats, fallbackInfo = { used: false }) {
      if (fallbackInfo.used) {
        const friendlyDate = formatDateISOtoDMY(fallbackInfo.date);
        slotsDiv.innerHTML = `<div class="fallback-msg">No Car is Available From <strong>${escapeHtml(fallbackInfo.pickup)}</strong> but here are some alternatives to <strong>${escapeHtml(fallbackInfo.dropoff)}</strong> on <strong>${friendlyDate}</strong></div>`;
      } else {
        slotsDiv.innerHTML = '';
      }

      const user = auth.currentUser;
      if (!user) {
        alert('Please login first');
        return;
      }

      const driverCarCache = {};

      slots.forEach((slot, idx) => {
        const avail = parseInt(slot.seats, 10);
        if (avail < reqSeats) return;

        const puIdx = locationIndexMap[slot.pickup] || 0;
        const doIdx = locationIndexMap[slot.dropoff] || 0;
        const perSeatFare = Math.abs(puIdx - doIdx) * 120;
        const fare  = perSeatFare * reqSeats;

        const displayTime = formatTime24to12(slot.time);
        const displayDate = formatDateISOtoDMY(slot.date);

        const card = document.createElement('div');
        card.className = 'slot-card';

        // Car brand only
        const carBrand = slot.carBrand || 'Car';

        // Add slot number, position it at top-left of main area
        const slotNumberHtml = `<div style="display:flex;align-items:center;gap:10px;">
                                  <div class="slot-number" aria-hidden="true">${idx + 1}</div>
                                </div>`;

        card.innerHTML = `
          <div class="slot-accent" aria-hidden="true"></div>

          <div class="slot-main">
            <div style="display:flex;gap:12px;align-items:center;">
              ${slotNumberHtml}
              <div style="flex:1;min-width:0;">
                <!-- Pickup / Dropoff first -->
                <div class="pickup-drop">
                  <div class="pd-row">
                    <div class="pd-label">Pickup</div>
                    <div class="pd-value">${escapeHtml(slot.pickup)}</div>
                  </div>
                  <div class="pd-row">
                    <div class="pd-label">Dropoff</div>
                    <div class="pd-value">${escapeHtml(slot.dropoff)}</div>
                  </div>
                </div>

                <!-- Car Brand with icon -->
                <div class="car-row">
                  <div class="car-name"><i class="fas fa-car" aria-hidden="true"></i><span>${escapeHtml(carBrand)}</span></div>
                </div>
              </div>
            </div>

            <!-- Date / Time / Seats / Per-seat fare -->
            <div class="slot-mid">
              <div class="slot-mid-left">
                <div class="pill date-pill">${escapeHtml(displayDate)}</div>
                <div class="pill time-pill">${escapeHtml(displayTime)}</div>
                <div class="pill seat-pill">${avail} seats</div>
                <div class="pill perseat-pill">₹${perSeatFare}/seat</div>
              </div>
            </div>

            <!-- Booking actions -->
            <div class="slot-actions" role="group" aria-label="Booking actions">
              <div class="action-wrap">
                <button id="bookBtn${idx}" class="btn-action btn-single" aria-label="Book ${reqSeats} seats for ₹${fare}">
                  <div class="btn-left"><i class="fa fa-user-plus"></i><span>Book ${reqSeats}</span></div>
                  <div class="btn-right"><span class="price-pill">₹${fare}</span></div>
                </button>
              </div>
              <div class="action-wrap">
                <button id="bookFullBtn${idx}" class="btn-action btn-full" style="display:none" aria-label="Book entire car for discounted price">
                  <div class="btn-left"><i class="fa fa-car"></i><span>Book entire car</span></div>
                  <div class="btn-right"><span class="price-pill">₹<span id="fullFare${idx}"></span></span></div>
                </button>
              </div>
            </div>
          </div>

          <div class="slot-right" aria-hidden="true">
            <div class="fare-large">₹${fare}</div>
            <div class="fare-small"></div>
          </div>
        `;

        slotsDiv.appendChild(card);

        document.getElementById(`bookBtn${idx}`).addEventListener('click', async () => {
          const profileSnap = await db.ref(`users/${user.uid}`).once('value');
          const profile     = profileSnap.val() || {};

          const bookingData = {
            driverId:       slot.driverId,
            slotKey:        slot.slotKey,
            pickup:         slot.pickup,
            dropoff:        slot.dropoff,
            date:           slot.date,
            time:           slot.time,
            seatsRequested: reqSeats,
            seatsAvailable: avail,
            fare:           fare,
            customerId:     user.uid,
            carBrand:       slot.carBrand     || '',
            carReg:         slot.carReg       || '',
            driverName:     slot.driverName   || '',
            driverNumber:   slot.driverNumber || ''
          };
          localStorage.setItem('selectedBooking', JSON.stringify(bookingData));
          window.location.href = 'checkout.html';
        });

        (async function decideFullBooking(slot, idx, availSeats, perSeatFare){
          const maybeTotal = slot.maxSeats || slot.totalSeats || slot.carSeats || slot.seatCapacity;
          let carTotalSeats = (maybeTotal !== undefined && maybeTotal !== null) ? Number(maybeTotal) : NaN;

          try {
            if (!Number.isFinite(carTotalSeats) || carTotalSeats <= 0) {
              const driverId = slot.driverId;
              if (driverCarCache[driverId]) {
                const map = driverCarCache[driverId];
                if (slot.carReg && map.byReg && map.byReg[slot.carReg]) carTotalSeats = Number(map.byReg[slot.carReg].seats || map.byReg[slot.carReg].seat || NaN);
                if ((!Number.isFinite(carTotalSeats) || carTotalSeats <= 0) && slot.carBrand && map.byBrand && map.byBrand[slot.carBrand]) carTotalSeats = Number(map.byBrand[slot.carBrand].seats || map.byBrand[slot.carBrand].seat || NaN);
              } else {
                const snap = await db.ref(`approvedcars/${slot.driverId}`).once('value');
                const map = { byReg: {}, byBrand: {} };
                if (snap.exists()) {
                  snap.forEach(ch => {
                    const c = ch.val();
                    const reg = c.carReg || '';
                    const brand = c.carBrand || '';
                    map.byReg[reg] = c;
                    map.byBrand[brand] = c;
                  });
                }
                driverCarCache[slot.driverId] = map;
                if (slot.carReg && map.byReg && map.byReg[slot.carReg]) carTotalSeats = Number(map.byReg[slot.carReg].seats || map.byReg[slot.carReg].seat || NaN);
                if ((!Number.isFinite(carTotalSeats) || carTotalSeats <= 0) && slot.carBrand && map.byBrand && map.byBrand[slot.carBrand]) carTotalSeats = Number(map.byBrand[slot.carBrand].seats || map.byBrand[slot.carBrand].seat || NaN);
              }
            }
          } catch (err) {
            console.warn('Failed to fetch approvedcars for full-book decision', err);
          }

          // Show full-book only when available seats equals car's total seats
          if (Number.isFinite(carTotalSeats) && carTotalSeats > 0 && Number(availSeats) === Number(carTotalSeats)) {
            const fullFare = (Number(perSeatFare) || 0) * carTotalSeats;
            const discountedFullFare = Math.round(fullFare * 0.90); // 10% discount
            const fullFareEl = document.getElementById(`fullFare${idx}`);
            if (fullFareEl) fullFareEl.textContent = discountedFullFare;

            const fullBtn = document.getElementById(`bookFullBtn${idx}`);
            if (fullBtn) {
              fullBtn.style.display = 'inline-flex';
              // replace to avoid duplicate listeners
              const newBtn = fullBtn.cloneNode(true);
              fullBtn.parentNode.replaceChild(newBtn, fullBtn);
              newBtn.addEventListener('click', async () => {
                const profileSnap = await db.ref(`users/${user.uid}`).once('value');
                const profile     = profileSnap.val() || {};

                const bookingData = {
                  driverId:       slot.driverId,
                  slotKey:        slot.slotKey,
                  pickup:         slot.pickup,
                  dropoff:        slot.dropoff,
                  date:           slot.date,
                  time:           slot.time,
                  seatsRequested: carTotalSeats,
                  seatsAvailable: availSeats,
                  fare:           discountedFullFare,
                  customerId:     user.uid,
                  carBrand:       slot.carBrand     || '',
                  carReg:         slot.carReg       || '',
                  driverName:     slot.driverName   || '',
                  driverNumber:   slot.driverNumber || '',
                  bookEntireCar:  true
                };
                localStorage.setItem('selectedBooking', JSON.stringify(bookingData));
                window.location.href = 'checkout.html';
              });
            }
          } else {
            const fullBtn = document.getElementById(`bookFullBtn${idx}`);
            if (fullBtn) fullBtn.style.display = 'none';
          }
        })(slot, idx, avail, perSeatFare);
      });
    }

    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
