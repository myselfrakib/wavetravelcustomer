<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Ride - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #0077ff;
      --light: #f8f8f8;
      --dark: #333;
      --success: #28a745;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #74ebd5, #ACB6E5);
      display: flex; flex-direction: column; min-height: 100vh;
      color: var(--dark);
    }
    .container {
      flex: 1; max-width: 600px; width: 100%;
      margin: 0 auto; padding: 16px; padding-bottom: 100px;
    }
    h1 {
      font-size: 1.5rem; text-align: center; margin-bottom: 1rem;
      color: #fff;
    }
    .form-group { margin-bottom: 1rem; }
    label {
      display: block; margin-bottom: 0.5rem; font-weight: 600;
    }
    select, input {
      width: 100%; padding: 0.75rem; border: 1px solid #ccc;
      border-radius: 0.5rem; background: #fff; font-size: 1rem;
    }
    button {
      display: block; width: 100%; padding: 0.75rem;
      margin-top: 0.75rem; background: var(--primary);
      color: #fff; font-size: 1rem; font-weight: 600;
      border: none; border-radius: 0.5rem; cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #005dc1; }
    .slots {
      margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;
    }
    .slot-card {
      background: #fff; padding: 1rem; border-radius: 0.75rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .slot-card-header { font-weight: bold; margin-bottom: 0.5rem; }
    .slot-card strong { display: inline-block; width: 4.5rem; }
    .slot-card button {
      width: auto; margin-top: 0.75rem; background: var(--success);
      padding: 0.5rem 1rem; border: none; border-radius: 0.5rem;
      color: #fff; cursor: pointer;
    }
    .no-slots {
      text-align: center; padding: 1rem; background: #fff;
      border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-weight: 600;
    }
    .navbar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: #fff; border-top: 1px solid #ddd;
      display: flex; justify-content: space-around; padding: 0.5rem 0;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    .navbar a {
      color: var(--primary); text-decoration: none;
      font-size: 0.75rem; text-align: center;
    }
    .navbar a i {
      font-size: 1.25rem; display: block; margin-bottom: 0.25rem;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Book Your Ride</h1>

    <div class="form-group">
      <label for="pickup">Pickup Location</label>
      <select id="pickup"><option value="">Select Pickup</option></select>
    </div>

    <div class="form-group">
      <label for="dropoff">Dropoff Location</label>
      <select id="dropoff"><option value="">Select Dropoff</option></select>
    </div>

    <div class="form-group">
      <label for="date">Select Date</label>
      <input type="date" id="date"/>
    </div>

    <div class="form-group">
      <label for="seats">Seats Needed</label>
      <input type="number" id="seats" min="1" placeholder="Enter seats"/>
    </div>

    <button onclick="searchSlots()">Search Available Slots</button>

    <div class="slots" id="slots"></div>
  </div>

  <div class="navbar">
    <a href="customerdashboard.html"><i class="fas fa-home"></i>Home</a>
    <a href="book.html"><i class="fas fa-car"></i>Book</a>
    <a href="mybookings.html"><i class="fas fa-calendar-check"></i>Bookings</a>
    <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    const pickupEl  = document.getElementById('pickup');
    const dropoffEl = document.getElementById('dropoff');
    const dateEl    = document.getElementById('date');
    const seatsEl   = document.getElementById('seats');
    const slotsDiv  = document.getElementById('slots');

    const locationIndexMap = {};

    function loadLocations() {
      db.ref('locations').once('value').then(snap => {
        let puOpts = '<option value="">Select Pickup</option>',
            doOpts = '<option value="">Select Dropoff</option>';
        snap.forEach(child => {
          const loc = child.val();
          locationIndexMap[loc.name] = loc.index;
          puOpts += `<option value="${loc.name}">${loc.name}</option>`;
          doOpts += `<option value="${loc.name}">${loc.name}</option>`;
        });
        pickupEl.innerHTML  = puOpts;
        dropoffEl.innerHTML = doOpts;
      });
    }

    // Convert "HH:MM" to "h:MM AM/PM"
    function formatTime24to12(time24) {
      const [hourStr, minute] = time24.split(':');
      let hour = parseInt(hourStr, 10);
      const period = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12 === 0 ? 12 : hour % 12;
      return `${hour}:${minute} ${period}`;
    }

    // Convert "YYYY-MM-DD" to "DD/MM/YYYY"
    function formatDateISOtoDMY(isoDate) {
      const [year, month, day] = isoDate.split('-');
      return `${day}/${month}/${year}`;
    }

    function searchSlots() {
      slotsDiv.innerHTML = '';
      const pu  = pickupEl.value;
      const dof = dropoffEl.value;
      const dt  = dateEl.value;
      const req = parseInt(seatsEl.value, 10) || 1;

      if (!pu || !dof || !dt) {
        return alert('Please fill all fields');
      }

      const doIdx = locationIndexMap[dof] || 0;

      db.ref('availableslots').once('value').then(snap => {
        const all = [];
        snap.forEach(driverSnap => {
          driverSnap.forEach(slotSnap => {
            all.push({
              driverId: driverSnap.key,
              slotKey:  slotSnap.key,
              ...slotSnap.val()
            });
          });
        });

        let matched = all.filter(s =>
          s.pickup === pu && s.dropoff === dof && s.date === dt
        );
        if (!matched.length) {
          matched = all.filter(s =>
            s.date === dt && locationIndexMap[s.dropoff] === doIdx
          );
        }
        if (!matched.length) {
          slotsDiv.innerHTML = `<div class="no-slots">No slots found.</div>`;
        } else {
          renderSlots(matched, req);
        }
      });
    }

    function renderSlots(slots, reqSeats) {
      slotsDiv.innerHTML = '';
      auth.onAuthStateChanged(user => {
        if (!user) {
          alert('Please login first');
          return;
        }
        slots.forEach((slot, idx) => {
          const avail = parseInt(slot.seats, 10);
          if (avail < reqSeats) return;
          const puIdx = locationIndexMap[slot.pickup] || 0;
          const doIdx = locationIndexMap[slot.dropoff] || 0;
          const fare  = Math.abs(puIdx - doIdx) * reqSeats;

          const displayTime = formatTime24to12(slot.time);
          const displayDate = formatDateISOtoDMY(slot.date);

          const card = document.createElement('div');
          card.className = 'slot-card';
          card.innerHTML = `
            <div class="slot-card-header">Sl. No. ${idx + 1}</div>
            <div><strong>Pickup:</strong> ${slot.pickup}</div>
            <div><strong>Dropoff:</strong> ${slot.dropoff}</div>
            <div><strong>Date:</strong> ${displayDate}</div>
            <div><strong>Leave Time:</strong> ${displayTime}</div>
            <div><strong>Seats:</strong> ${avail}</div>
            <button id="bookBtn${idx}">
              Book ${reqSeats} for â‚¹${fare}
            </button>
          `;
          slotsDiv.appendChild(card);

          document.getElementById(`bookBtn${idx}`).addEventListener('click', () => {
            const bookingData = {
              driverId:       slot.driverId,
              slotKey:        slot.slotKey,
              pickup:         slot.pickup,
              dropoff:        slot.dropoff,
              date:           slot.date,
              time:           slot.time,
              seatsRequested: reqSeats,
              seatsAvailable: avail,
              fare:           fare,
              customerId:     user.uid,
              customerName:   user.displayName  || '',
              customerPhone:  user.phoneNumber  || '',
              carBrand:       slot.carBrand     || '',
              carReg:         slot.carReg       || '',
              driverName:     slot.driverName   || '',
              driverNumber:   slot.driverNumber || ''
            };
            localStorage.setItem('selectedBooking', JSON.stringify(bookingData));
            window.location.href = 'checkout.html';
          });
        });
      });
    }

    loadLocations();
  </script>
</body>
</html>
