<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book a Ride - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { background: linear-gradient(to right, #74ebd5, #ACB6E5); min-height: 100vh; display: flex; flex-direction: column; }
    .container { flex: 1; padding: 20px; }
    h1 { text-align: center; color: #fff; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    label { color: #333; font-weight: 600; }
    select, input[type="date"], input[type="time"], input[type="number"], button {
      width: 100%; padding: 12px; border-radius: 10px; border: none; margin-top: 5px;
      background: #f8f8f8; box-shadow: 0 4px 10px rgba(0,0,0,0.1); outline: none;
    }
    button { background: #0077ff; color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s; }
    button:hover { background: #005dc1; }
    .slots { margin-top: 20px; display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
    .slot-card {
      background: #fff; padding: 15px; border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.3s;
    }
    .slot-card:hover { transform: scale(1.03); }
    .navbar { background: #fff; padding: 10px; display: flex; justify-content: space-around; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -3px 10px rgba(0,0,0,0.1); }
    .navbar a { color: #0077ff; font-size: 16px; text-decoration: none; display: flex; flex-direction: column; align-items: center; }
    .navbar a i { font-size: 20px; }
    .no-slots { text-align: center; margin-top: 20px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<div class="container">
  <h1>Book Your Ride</h1>

  <div class="form-group">
    <label for="pickup">Pickup Location</label>
    <select id="pickup"></select>
  </div>

  <div class="form-group">
    <label for="dropoff">Dropoff Location</label>
    <select id="dropoff"></select>
  </div>

  <div class="form-group">
    <label for="date">Select Date</label>
    <input type="date" id="date">
  </div>

  <div class="form-group">
    <label for="seats">Seats Needed</label>
    <input type="number" id="seats" min="1" placeholder="Enter number of seats">
  </div>

  <button onclick="searchSlots()">Search Available Slots</button>

  <div class="slots" id="slots"></div>
</div>

<div class="navbar">
  <a href="home.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a href="book.html"><i class="fas fa-car"></i><span>Book</span></a>
  <a href="mybookings.html"><i class="fas fa-calendar-check"></i><span>Bookings</span></a>
  <a href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.appspot.com",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };
  firebase.initializeApp(firebaseConfig);

  const pickup = document.getElementById('pickup');
  const dropoff = document.getElementById('dropoff');
  const slotsDiv = document.getElementById('slots');

  function loadLocations() {
    firebase.database().ref('locations').once('value').then(snapshot => {
      snapshot.forEach(child => {
        const option1 = document.createElement('option');
        option1.value = option1.textContent = child.val().name;
        pickup.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = option2.textContent = child.val().name;
        dropoff.appendChild(option2);
      });
    });
  }

  function searchSlots() {
    slotsDiv.innerHTML = "";
    const selectedPickup = pickup.value;
    const selectedDropoff = dropoff.value;
    const selectedDate = document.getElementById('date').value;

    firebase.database().ref('availableslots').once('value').then(snapshot => {
      let slots = [];
      snapshot.forEach(driverSnap => {
        driverSnap.forEach(slotSnap => {
          slots.push({ driverId: driverSnap.key, key: slotSnap.key, ...slotSnap.val() });
        });
      });

      let matched = slots.filter(slot => slot.pickup === selectedPickup && slot.dropoff === selectedDropoff && slot.date === selectedDate);

      if (matched.length === 0) {
        let relaxed = slots.filter(slot => slot.dropoff === selectedDropoff && slot.date === selectedDate);
        if (relaxed.length > 0) showSlots(relaxed, true);
        else slotsDiv.innerHTML = `<div class='no-slots'>No slots found.</div>`;
      } else {
        showSlots(matched, false);
      }
    });
  }

  function showSlots(slots, relaxed) {
    slots.forEach(slot => {
      const card = document.createElement('div');
      card.className = 'slot-card';
      card.innerHTML = `
        <strong>Pickup:</strong> ${slot.pickup}<br>
        <strong>Dropoff:</strong> ${slot.dropoff}<br>
        <strong>Date:</strong> ${slot.date}<br>
        <strong>Time:</strong> ${slot.time}<br>
        <strong>Seats Available:</strong> ${slot.seats}<br>
        <button onclick="bookSlot('${slot.driverId}', '${slot.key}', ${slot.seats})">Book Now</button>
      `;
      slotsDiv.appendChild(card);
    });
  }

  function bookSlot(driverId, slotKey, availableSeats) {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert("Please login first.");
      return;
    }
    const seatsRequested = parseInt(document.getElementById('seats').value);
    if (!seatsRequested || seatsRequested <= 0) {
      alert("Please enter a valid number of seats.");
      return;
    }
    if (seatsRequested > availableSeats) {
      alert("Not enough seats available.");
      return;
    }

    const bookingData = {
      driverId,
      slotKey,
      userId: user.uid,
      seatsBooked: seatsRequested,
      status: "Pending",
      bookedAt: new Date().toISOString()
    };

    // Save booking
    firebase.database().ref(`bookings/${user.uid}`).push(bookingData)
      .then(() => {
        // Update seat count
        const slotRef = firebase.database().ref(`availableslots/${driverId}/${slotKey}`);
        slotRef.update({ seats: availableSeats - seatsRequested })
          .then(() => {
            alert("Booking Successful!");
            searchSlots(); // Refresh slots
          })
          .catch(error => alert("Failed to update seats: " + error.message));
      })
      .catch(error => alert("Booking Failed: " + error.message));
  }

  loadLocations();
</script>

</body>
</html>
