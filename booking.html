<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book a Ride - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background: linear-gradient(to right,#74ebd5,#ACB6E5); min-height:100vh; display:flex; flex-direction:column; }
    .container { flex:1; padding:20px; }
    h1 { text-align:center; color:#fff; margin-bottom:20px; }
    .form-group { margin-bottom:15px; }
    label { color:#333; font-weight:600; }
    select,input,button {
      width:100%; padding:12px; border-radius:10px; border:none; margin-top:5px;
      background:#f8f8f8; box-shadow:0 4px 10px rgba(0,0,0,0.1); outline:none;
    }
    button { background:#0077ff; color:#fff; font-weight:bold; cursor:pointer; transition:0.3s; }
    button:hover { background:#005dc1; }
    .slots { margin-top:20px; display:grid; gap:15px; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); }
    .slot-card {
      background:#fff; padding:15px; border-radius:15px;
      box-shadow:0 5px 15px rgba(0,0,0,0.2); transition:transform 0.3s;
    }
    .slot-card:hover { transform:scale(1.03); }
    .navbar {
      background:#fff; padding:10px; display:flex; justify-content:space-around;
      border-top-left-radius:20px; border-top-right-radius:20px;
      box-shadow:0 -3px 10px rgba(0,0,0,0.1);
    }
    .navbar a { color:#0077ff; text-decoration:none; font-size:14px; display:flex; flex-direction:column; align-items:center; }
    .navbar a i { font-size:20px; }
    .no-slots {
      text-align:center; margin-top:20px; background:#fff; padding:20px;
      border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Book Your Ride</h1>

  <div class="form-group">
    <label for="pickup">Pickup Location</label>
    <select id="pickup"><option value="">Select Pickup</option></select>
  </div>

  <div class="form-group">
    <label for="dropoff">Dropoff Location</label>
    <select id="dropoff"><option value="">Select Dropoff</option></select>
  </div>

  <div class="form-group">
    <label for="date">Select Date</label>
    <input type="date" id="date">
  </div>

  <div class="form-group">
    <label for="seats">Seats Needed</label>
    <input type="number" id="seats" min="1" placeholder="Enter number of seats">
  </div>

  <button onclick="searchSlots()">Search Available Cars</button>

  <div class="slots" id="slots"></div>
</div>

<div class="navbar">
  <a href="home.html"><i class="fas fa-home"></i><span>Home</span></a>
  <a href="book.html"><i class="fas fa-car"></i><span>Book</span></a>
  <a href="mybookings.html"><i class="fas fa-calendar-check"></i><span>Bookings</span></a>
  <a href="profile.html"><i class="fas fa-user"></i><span>Profile</span></a>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<!-- Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
  // --- INITIALIZE FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.appspot.com",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };
  firebase.initializeApp(firebaseConfig);

  const pickupEl = document.getElementById('pickup');
  const dropoffEl = document.getElementById('dropoff');
  const slotsDiv = document.getElementById('slots');
  const seatsEl = document.getElementById('seats');

  // --- LOAD LOCATIONS ---
  function loadLocations() {
    firebase.database().ref('locations').once('value').then(snap => {
      snap.forEach(ch => {
        const name = ch.val().name;
        pickupEl.innerHTML += `<option value="${name}">${name}</option>`;
        dropoffEl.innerHTML += `<option value="${name}">${name}</option>`;
      });
    });
  }

  // --- SEARCH SLOTS ---
  function searchSlots() {
    slotsDiv.innerHTML = '';
    const pu = pickupEl.value;
    const doff = dropoffEl.value;
    const date = document.getElementById('date').value;
    const reqSeats = parseInt(seatsEl.value) || 1;

    if (!pu || !doff || !date) {
      return alert('Fill pickup, dropoff & date');
    }

    // fetch all slots
    firebase.database().ref('availableslots').once('value').then(snap => {
      let all = [];
      snap.forEach(driver => {
        driver.forEach(slot => {
          all.push({
            driverId: driver.key,
            slotKey: slot.key,
            ...slot.val()
          });
        });
      });

      // strict filter
      let matched = all.filter(s => s.pickup===pu && s.dropoff===doff && s.date===date);
      if (matched.length===0) {
        // relaxed: match dropoff+date
        matched = all.filter(s => s.dropoff===doff && s.date===date);
      }
      if (!matched.length) {
        return slotsDiv.innerHTML = `<div class="no-slots">No slots found.</div>`;
      }
      showSlots(matched, reqSeats);
    });
  }

  // --- SHOW SLOTS ---
  function showSlots(slots, reqSeats) {
    slots.forEach(slot => {
      if (slot.seats < reqSeats) return; // skip if not enough
      const fare = reqSeats*100; // ₹100 per seat
      const btnText = `Book ${reqSeats} for ₹${fare}`;
      const card = document.createElement('div');
      card.className = 'slot-card';
      card.innerHTML = `
        <strong>Pickup:</strong> ${slot.pickup}<br>
        <strong>Dropoff:</strong> ${slot.dropoff}<br>
        <strong>Date:</strong> ${slot.date}<br>
        <strong>Deperture Time:</strong> ${slot.time}<br>
        <strong>Seats Available:</strong> ${slot.seats}<br>
        <button onclick="initiateBooking('${slot.driverId}','${slot.slotKey}',${slot.seats},${reqSeats},${fare})">
          ${btnText}
        </button>
      `;
      slotsDiv.appendChild(card);
    });
  }

  // --- BOOK WITH PAYMENT ---
  function initiateBooking(driverId, slotKey, availSeats, reqSeats, fare) {
    const user = firebase.auth().currentUser;
    if (!user) {
      return alert('Please log in first');
    }

    var options = {
      key: "YOUR_RAZORPAY_KEY_ID",
      amount: fare*100, // in paise
      currency: "INR",
      name: "WaveTravel",
      description: "Ride Booking",
      handler: function(res) {
        // 1) Update seats
        firebase.database()
          .ref(`availableslots/${driverId}/${slotKey}`)
          .update({ seats: availSeats - reqSeats });

        // 2) Fetch driver & car details
        firebase.database().ref(`driverdetails/${driverId}`).once('value').then(dsnap => {
          const drv = dsnap.val();
          // 3) Fetch car details (slot.carId saved under slot? we passed only slotKey)
          //    Assume carId stored as part of slot under /availableslots/{driverId}/{slotKey}/carId
          firebase.database().ref(`availableslots/${driverId}/${slotKey}/carId`)
            .once('value').then(csnap => {
            const carId = csnap.val();
            firebase.database().ref(`approvedcars/${driverId}/${carId}`).once('value').then(csnap2 => {
              const car = csnap2.val();

              // 4) Build booking record
              const booking = {
                customerId: user.uid,
                customerPhone: user.phoneNumber||"",
                customerName: user.displayName||"",
                driverId,
                driverName: drv.name,
                driverPhone: drv.phone,
                carBrand: car.carbrand,
                carReg: car.carReg,
                pickup: pickupEl.value,
                dropoff: dropoffEl.value,
                date: document.getElementById('date').value,
                time: slot.time,
                seatsBooked: reqSeats,
                fare,
                paymentId: res.razorpay_payment_id,
                status: "confirmed",
                bookedAt: new Date().toISOString()
              };

              // 5) Save booking
              firebase.database()
                .ref(`bookings/${user.uid}`)
                .push(booking)
                .then(() => {
                  alert("Payment successful & booking confirmed!");
                  // 6) reset and redirect
                  pickupEl.selectedIndex=0;
                  dropoffEl.selectedIndex=0;
                  document.getElementById('date').value="";
                  seatsEl.value="";
                  slotsDiv.innerHTML="";
                  window.location.href="mybookings.html";
                });
            });
          });
        });
      }
    };
    new Razorpay(options).open();
  }

  // --- START ---
  loadLocations();
</script>
</body>
</html>
