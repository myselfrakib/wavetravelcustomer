<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Ride - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #2f6690;
      --accent:  #3a7ca5;
      --light:   #d9dcd6;
      --dark:    #16425b;
      --sky:     #81c3d7;
      --muted:   #6da5d0;
      --card-radius: 14px;
      --card-padding: 14px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height:100%; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, var(--accent), var(--dark));
      display: flex; flex-direction: column; min-height: 100vh;
      color: var(--dark);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      -webkit-text-size-adjust:100%;
    }
    .container {
      flex: 1; max-width: 720px; width: 100%;
      margin: 0 auto; padding: 18px; padding-bottom: 120px;
    }
    h1 {
      font-size: 1.5rem; text-align: center; margin-bottom: 14px;
      color: var(--light);
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 20px;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--light);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .tab-btn.active {
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: white;
      box-shadow: 0 4px 12px rgba(47,102,144,0.3);
    }
    .tab-btn:hover:not(.active) {
      background: rgba(255,255,255,0.1);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    .form-group { margin-bottom: 12px; }
    label {
      display: block; margin-bottom: 8px; font-weight: 600; color: var(--light);
    }
    select, input {
      width: 100%; padding: 0.75rem; border: 1px solid rgba(0,0,0,0.06);
      border-radius: 10px; background: #fff; font-size: 1rem;
      box-shadow: 0 1px 2px rgba(16,24,40,0.03);
    }
    .search-btn {
      display: block; width: 100%; padding: 12px;
      margin-top: 12px;
      background: linear-gradient(90deg, var(--primary), var(--sky));
      color: #fff; font-size: 1.02rem; font-weight: 700;
      border: none; border-radius: 10px; cursor: pointer;
      transition: transform .08s ease, box-shadow .12s ease;
      box-shadow: 0 8px 18px rgba(2,6,23,0.12);
    }
    .search-btn:active { transform: translateY(1px); }
    .search-btn:disabled { opacity: 0.7; cursor: not-allowed; }

    .slots { margin-top: 14px; display: flex; flex-direction: column; gap: 14px; }

    .slot-card {
      display: grid;
      grid-template-columns: 8px 1fr auto;
      gap: 12px;
      align-items: start;
      background: linear-gradient(180deg, #ffffff 0%, var(--light) 100%);
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      box-shadow: 0 12px 30px rgba(2,6,23,0.08);
      border: 1px solid rgba(2,6,23,0.04);
      overflow: hidden;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .slot-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(2,6,23,0.10); }

    .slot-accent { width: 8px; height: 100%;
      background: linear-gradient(180deg, var(--primary), var(--accent));
      border-radius: 6px;
    }

    .slot-main { display:flex; flex-direction:column; gap:10px; min-width:0; }

    .slot-number {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:34px;
      height:34px;
      border-radius:10px;
      background: linear-gradient(90deg, var(--sky), rgba(129,195,215,0.9));
      color: var(--dark);
      font-weight:800;
      font-size:0.95rem;
      box-shadow: 0 6px 14px rgba(2,6,23,0.06);
    }

    .pickup-drop { display:flex; flex-direction:column; gap:6px; }
    .pd-row { display:flex; gap:8px; align-items:center; }
    .pd-label { font-size:0.78rem; color:rgba(22,66,91,0.75); font-weight:800; text-transform:uppercase; letter-spacing:0.6px; width:74px; flex-shrink:0; }
    .pd-value { font-weight:800; color:var(--dark); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .car-row {
      display:flex; gap:8px; align-items:center; margin-top:4px;
    }
    .car-name { font-weight:700; color:var(--primary); font-size:0.95rem; display:flex; gap:8px; align-items:center; }
    .car-name i { color:var(--primary); font-size:1.05rem; background: rgba(47,102,144,0.06); padding:6px; border-radius:8px; }

    .slot-mid {
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      justify-content:space-between;
    }
    .slot-mid-left { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill {
      border-radius:999px; padding:6px 8px; font-weight:700; font-size:0.85rem; color:var(--dark);
      display:inline-flex; gap:8px; align-items:center; box-shadow: 0 3px 8px rgba(2,6,23,0.04);
    }
    .trip-pill { background: linear-gradient(90deg,#e6f7fb,#cfeff6); color: var(--dark); }
    .date-pill { background: linear-gradient(90deg,#eaf6ff,#dbeffb); color: var(--primary); }
    .time-pill { background: linear-gradient(90deg,#eefafc,#dff4f8); color:#0b5966; }
    .fare-pill { background: linear-gradient(90deg,#f7fbff,#e8f2fb); color:var(--primary); font-weight:800; }

    .slot-right {
      display:flex; flex-direction:column; align-items:flex-end; gap:8px; margin-left:8px;
      justify-self:end;
    }
    .fare-large { font-weight:900; font-size:1.18rem; color:var(--dark); background:linear-gradient(90deg,rgba(0,0,0,0.02),transparent); padding:6px 10px; border-radius:10px; }

    .slot-actions {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top:8px;
      align-items:center;
    }
    @media (max-width:520px) {
      .slot-card { grid-template-columns: 6px 1fr; grid-template-rows: auto auto auto; }
      .slot-right { justify-self:start; flex-direction:row; gap:8px; }
      .fare-large { font-size:1.02rem; }
      .slot-actions { grid-template-columns: 1fr; }
      .pd-label { width:64px; }
    }

    .action-wrap { display:flex; width:100%; }
    .btn-action {
      display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%;
      padding: 14px 16px; border-radius: 12px; border: none; cursor: pointer; font-weight:800;
      font-size:1.02rem; box-shadow: 0 8px 20px rgba(2,6,23,0.06);
      transition: transform .06s ease, box-shadow .1s ease;
      color:#fff;
      position: relative;
    }
    .btn-action:active { transform: translateY(1px); }
    .btn-action:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-oneway { background: linear-gradient(90deg, var(--sky), var(--accent)); color:#fff; }
    .btn-roundtrip { background: linear-gradient(90deg, var(--accent), var(--primary)); color:#fff; }

    .btn-left { display:flex; align-items:center; gap:12px; min-width:0; overflow:hidden; }
    .btn-left i { width:34px; text-align:center; font-size:1.15rem; }
    .btn-left span { white-space:nowrap; text-overflow:ellipsis; overflow:hidden; display:inline-block; max-width:160px; }

    .btn-right { display:flex; align-items:center; gap:8px; min-width:fit-content; }
    .price-pill { background: rgba(255,255,255,0.14); padding:6px 10px; border-radius:10px; font-weight:900; color:#fff; }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .no-slots { 
      text-align: center; 
      padding: 2rem 1rem; 
      background: #fff; 
      border-radius: 10px; 
      box-shadow: 0 4px 12px rgba(2,6,23,0.06); 
      font-weight:700; 
      color:var(--dark); 
    }
    
    .request-btn {
      background: linear-gradient(90deg, #f59e0b, #f97316);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 16px;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }
    .request-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(245, 158, 11, 0.4);
    }
    .request-btn:active {
      transform: translateY(0);
    }

    .loading-msg { 
      text-align: center; padding: 1rem; background: #fff; border-radius: 10px; 
      box-shadow: 0 4px 12px rgba(2,6,23,0.06); font-weight:700; color:var(--primary);
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .loading-msg i { animation: spin 1s linear infinite; }

    /* Toast Message Styles */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 10000;
      font-weight: 600;
      font-size: 1.05rem;
      text-align: center;
      max-width: 400px;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .toast.show {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    .toast i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 10px;
    }

    .navbar {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: #fff; border-top: 1px solid rgba(0,0,0,0.06);
      display: flex; justify-content: space-around; padding: 0.6rem 0;
      box-shadow: 0 -6px 18px rgba(2,6,23,0.06);
    }
    .navbar a { color: var(--primary); text-decoration: none; font-size: 0.78rem; text-align:center; }
    .navbar a i { font-size:1.3rem; display:block; margin-bottom:4px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Book Your Ride</h1>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('oneway')">
        <i class="fas fa-arrow-right"></i> Oneway
      </button>
      <button class="tab-btn" onclick="switchTab('roundtrip')">
        <i class="fas fa-exchange-alt"></i> Roundtrip
      </button>
    </div>

    <!-- Oneway Tab -->
    <div id="oneway-tab" class="tab-content active">
      <div class="form-group">
        <label for="pickup-oneway">Pickup Location</label>
        <select id="pickup-oneway"><option value="">Select Pickup</option></select>
      </div>

      <div class="form-group">
        <label for="dropoff-oneway">Dropoff Location</label>
        <select id="dropoff-oneway"><option value="">Select Dropoff</option></select>
      </div>

      <div class="form-group">
        <label for="date-oneway">Select Date</label>
        <input type="date" id="date-oneway"/>
      </div>

      <button class="search-btn" id="search-btn-oneway" onclick="searchSlots('oneway')">
        <span class="search-text">Search Oneway Rides</span>
      </button>

      <div class="slots" id="slots-oneway"></div>
    </div>

    <!-- Roundtrip Tab -->
    <div id="roundtrip-tab" class="tab-content">
      <div class="form-group">
        <label for="pickup-roundtrip">Pickup Location</label>
        <select id="pickup-roundtrip"><option value="">Select Pickup</option></select>
      </div>

      <div class="form-group">
        <label for="dropoff-roundtrip">Dropoff Location</label>
        <select id="dropoff-roundtrip"><option value="">Select Dropoff</option></select>
      </div>

      <div class="form-group">
        <label for="date-roundtrip">Select Date</label>
        <input type="date" id="date-roundtrip"/>
      </div>

      <button class="search-btn" id="search-btn-roundtrip" onclick="searchSlots('roundtrip')">
        <span class="search-text">Search Roundtrip Rides</span>
      </button>

      <div class="slots" id="slots-roundtrip"></div>
    </div>
  </div>

  <!-- Toast Message -->
  <div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message">Your request has been received. Our team will contact you soon.</span>
  </div>

  <div class="navbar">
    <a href="customerdashboard.html"><i class="fas fa-home"></i>Home</a>
    <a href="booking.html"><i class="fas fa-car"></i>Book</a>
    <a href="mybookings.html"><i class="fas fa-calendar-check"></i>Bookings</a>
    <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    // Customize the emojis used in the WhatsApp message here
    const customEmojis = {
      greeting: "ðŸ™‹â€â™‚ï¸",   // after "Hi i'm"
      car: "ðŸš—",          // next to trip type line
      location: "ðŸ“",     // next to from/to lines
      date: "ðŸ“…"          // next to date line
    };

    let currentTab = 'oneway';
    let isSearching = false;

    // Toast message function
    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      toastMessage.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // Debounce helper
    function debounce(fn, wait = 350) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    function switchTab(tabName) {
      currentTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Debounced auto-search wrapper
    const debounceSearch = debounce(() => {
      const pickup = document.getElementById(`pickup-${currentTab}`);
      const dropoff = document.getElementById(`dropoff-${currentTab}`);
      const date = document.getElementById(`date-${currentTab}`);
      
      if (pickup.value && dropoff.value && date.value && !isSearching) {
        searchSlots(currentTab);
      }
    }, 350);

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
      } else {
        loadLocations();
      }
    });

    function setSearchingState(tripType, searching) {
      isSearching = searching;
      const searchBtn = document.getElementById(`search-btn-${tripType}`);
      const searchText = searchBtn.querySelector('.search-text');
      
      if (searching) {
        searchBtn.disabled = true;
        searchText.innerHTML = '<div class="spinner"></div> Searching...';
      } else {
        searchBtn.disabled = false;
        const typeDisplay = tripType === 'oneway' ? 'Oneway' : 'Roundtrip';
        searchText.innerHTML = `Search ${typeDisplay} Rides`;
      }
    }

    function loadLocations() {
      return db.ref('locations').once('value').then(snap => {
        let puOpts = '<option value="">Select Pickup</option>';
        let doOpts = '<option value="">Select Dropoff</option>';
        
        snap.forEach(child => {
          const loc = child.val();
          const name = (loc && typeof loc === 'object' && loc.name) ? loc.name : child.key;
          
          if (name) {
            const option = `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            puOpts += option;
            doOpts += option;
          }
        });
        
        // Update all dropdowns
        ['oneway', 'roundtrip'].forEach(tabType => {
          document.getElementById(`pickup-${tabType}`).innerHTML = puOpts;
          document.getElementById(`dropoff-${tabType}`).innerHTML = doOpts;
        });

        // Set defaults
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-oneway').value = today;
        document.getElementById('date-roundtrip').value = today;

        const defaultPickup = 'Berhampore';
        const defaultDropoff = 'Kolkata Airport';
        
        ['oneway', 'roundtrip'].forEach(tabType => {
          const pickupEl = document.getElementById(`pickup-${tabType}`);
          const dropoffEl = document.getElementById(`dropoff-${tabType}`);
          
          Array.from(pickupEl.options).forEach(opt => {
            if (opt.text === defaultPickup) opt.selected = true;
          });
          Array.from(dropoffEl.options).forEach(opt => {
            if (opt.text === defaultDropoff) opt.selected = true;
          });
        });

        // Setup event listeners
        setupEventListeners();

        // Auto-search for oneway tab with a slight delay
        setTimeout(() => {
          if (document.getElementById('pickup-oneway').value && 
              document.getElementById('dropoff-oneway').value && 
              document.getElementById('date-oneway').value) {
            searchSlots('oneway');
          }
        }, 500);
        
      }).catch(err => {
        console.error('Failed to load locations:', err);
        showToast('Failed to load locations. Please refresh the page.');
      });
    }

    function setupEventListeners() {
      ['oneway', 'roundtrip'].forEach(tabType => {
        const pickup = document.getElementById(`pickup-${tabType}`);
        const dropoff = document.getElementById(`dropoff-${tabType}`);
        const date = document.getElementById(`date-${tabType}`);

        pickup.addEventListener('change', () => {
          if (currentTab === tabType && dropoff.value && date.value) debounceSearch();
        });
        
        dropoff.addEventListener('change', () => {
          if (currentTab === tabType && pickup.value && date.value) debounceSearch();
        });

        date.addEventListener('change', () => {
          if (currentTab === tabType) debounceSearch();
        });
        date.addEventListener('input', () => {
          if (currentTab === tabType) debounceSearch();
        });
      });
    }

    function formatTime24to12(time24) {
      const [hourStr, minute] = (time24||'00:00').split(':');
      let hour = parseInt(hourStr, 10);
      const period = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12 === 0 ? 12 : hour % 12;
      return `${hour}:${minute} ${period}`;
    }

    function formatDateISOtoDMY(isoDate) {
      const [year, month, day] = isoDate.split('-');
      return `${day}/${month}/${year}`;
    }

    // Helper: open WhatsApp chat for a given number and message (auto-add +91 if missing)
    function openWhatsAppWithMessage(phone, message) {
      // Sanitize phone: remove non-digits
      let digits = String(phone || '').replace(/\D/g,'');
      if (!digits.startsWith('91')) {
        // assume India if not present
        digits = '91' + digits;
      }
      const encoded = encodeURIComponent(message);
      const url = `https://wa.me/${digits}?text=${encoded}`;
      // Open in same tab so mobile will switch to app; change to _blank if you prefer new tab
      window.location.href = url;
    }

    function raiseRideRequest(tripType) {
      const user = auth.currentUser;
      if (!user) {
        showToast('Please login to raise a ride request');
        return;
      }

      const pickup = document.getElementById(`pickup-${tripType}`).value;
      const dropoff = document.getElementById(`dropoff-${tripType}`).value;
      const date = document.getElementById(`date-${tripType}`).value;

      if (!pickup || !dropoff || !date) {
        showToast('Please fill in all fields before raising a request');
        return;
      }

      // Get user details
      db.ref(`users/${user.uid}`).once('value').then(userSnap => {
        const userData = userSnap.val() || {};
        
        // Prepare ride request data
        const requestData = {
          // User details
          customerId: user.uid,
          customerEmail: user.email || userData.email || '',
          customerName: userData.name || userData.username || 'Not provided',
          customerPhone: userData.phone || userData.mobile || 'Not provided',
          
          // Ride details
          pickup: pickup,
          dropoff: dropoff,
          date: date,
          tripType: tripType,
          
          // Request metadata
          status: 'pending',
          requestedAt: firebase.database.ServerValue.TIMESTAMP,
          
          // Additional info
          notes: `Customer requested ${tripType} ride from ${pickup} to ${dropoff} on ${formatDateISOtoDMY(date)}`,
        };

        // Save to Firebase with new structure: /riderequests/uid/requestuid/
        const requestRef = db.ref(`riderequests/${user.uid}`).push();
        requestRef.set(requestData)
          .then(() => {
            showToast('Your request has been received. Redirecting to WhatsApp...');

            // Build WhatsApp message with emojis (customizable via customEmojis)
            const nameForMsg = requestData.customerName || (user.email || 'Customer');
            const tripDetail = tripType;
            const pickupLoc = pickup;
            const dropoffLoc = dropoff;
            const rideDate = formatDateISOtoDMY(date);

            const waMessage = `Hi i'm ${nameForMsg} ${customEmojis.greeting}\n` +
                              `I need a car for ${tripDetail} trip ${customEmojis.car}\n` +
                              `from - ${pickupLoc} ${customEmojis.location}\n` +
                              `to - ${dropoffLoc} ${customEmojis.location}\n` +
                              `on - ${rideDate} ${customEmojis.date}`;

            // Redirect to WhatsApp number +91 7439654831
            openWhatsAppWithMessage('7439654831', waMessage);
          })
          .catch(err => {
            console.error('Error saving ride request:', err);
            showToast('Failed to submit request to server. Redirecting to WhatsApp...');

            // Even if DB save failed, still open WhatsApp so customer can contact
            const nameForMsg = (user.displayName || user.email || 'Customer');
            const tripDetail = tripType;
            const pickupLoc = pickup;
            const dropoffLoc = dropoff;
            const rideDate = formatDateISOtoDMY(date);

            const waMessage = `Hi i'm ${nameForMsg} ${customEmojis.greeting}\n` +
                              `I need a car for ${tripDetail} trip ${customEmojis.car}\n` +
                              `from - ${pickupLoc} ${customEmojis.location}\n` +
                              `to - ${dropoffLoc} ${customEmojis.location}\n` +
                              `on - ${rideDate} ${customEmojis.date}`;

            openWhatsAppWithMessage('7439654831', waMessage);
          });
      }).catch(err => {
        console.error('Error fetching user data:', err);
        showToast('Failed to submit request. Redirecting to WhatsApp...');

       // Fallback: build message using available info and redirect anyway
        const nameForMsg = (user.displayName || user.email || 'Customer');
        const tripDetail = tripType;
        const pickupLoc = pickup;
        const dropoffLoc = dropoff;
        const rideDate = formatDateISOtoDMY(date);

        const waMessage = `Hi i'm ${nameForMsg} ${customEmojis.greeting}\n` +
                          `I need a car for ${tripDetail} trip ${customEmojis.car}\n` +
                          `from - ${pickupLoc} ${customEmojis.location}\n` +
                          `to - ${dropoffLoc} ${customEmojis.location}\n` +
                          `on - ${rideDate} ${customEmojis.date}`;

        openWhatsAppWithMessage('7439654831', waMessage);
      });
    }

    function searchSlots(tripType) {
      if (isSearching) return;

      const pickup = document.getElementById(`pickup-${tripType}`).value;
      const dropoff = document.getElementById(`dropoff-${tripType}`).value;
      const date = document.getElementById(`date-${tripType}`).value;

      if (!pickup || !dropoff || !date) {
        document.getElementById(`slots-${tripType}`).innerHTML = '';
        return;
      }

      setSearchingState(tripType, true);

      const slotsContainer = document.getElementById(`slots-${tripType}`);
      slotsContainer.innerHTML = '<div class="loading-msg"><i class="fas fa-spinner"></i>Searching available rides...</div>';

      // Simulate API delay
      setTimeout(() => {
        // Generate sample slots
        const slots = generateSampleSlots(pickup, dropoff, date, tripType);
        displaySlots(slots, tripType);
        setSearchingState(tripType, false);
      }, 1500);
    }

    function generateSampleSlots(pickup, dropoff, date, tripType) {
      const slots = [];
      const cars = [
        { name: 'Swift Dzire', icon: 'fas fa-car', baseFare: 2500 },
        { name: 'Toyota Innova', icon: 'fas fa-car-side', baseFare: 4000 },
        { name: 'Mahindra Scorpio', icon: 'fas fa-truck', baseFare: 4500 },
        { name: 'Tata Nexon', icon: 'fas fa-car', baseFare: 3000 },
      ];

      const times = ['06:00', '08:30', '11:00', '14:30', '17:00', '20:00'];
      const multiplier = tripType === 'roundtrip' ? 1.8 : 1;

      for (let i = 0; i < Math.min(cars.length, 4); i++) {
        const car = cars[i];
        const time = times[i];
        const fare = Math.round(car.baseFare * multiplier);
        
        slots.push({
          id: i + 1,
          carName: car.name,
          carIcon: car.icon,
          time: time,
          fare: fare,
          pickup: pickup,
          dropoff: dropoff,
          date: date,
          tripType: tripType
        });
      }

      return slots;
    }

    function displaySlots(slots, tripType) {
      const slotsContainer = document.getElementById(`slots-${tripType}`);
      
      if (slots.length === 0) {
        slotsContainer.innerHTML = `
          <div class="no-slots">
            <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--muted);"></i>
            <div>No rides available for the selected route and date.</div>
            <button class="request-btn" onclick="raiseRideRequest('${tripType}')">
              <i class="fas fa-plus"></i> Request a Ride
            </button>
          </div>
        `;
        return;
      }

      let html = '';
      slots.forEach(slot => {
        const formattedTime = formatTime24to12(slot.time);
        const formattedDate = formatDateISOtoDMY(slot.date);
        const actionBtnClass = tripType === 'oneway' ? 'btn-oneway' : 'btn-roundtrip';
        const actionIcon = tripType === 'oneway' ? 'fas fa-arrow-right' : 'fas fa-exchange-alt';
        const actionText = tripType === 'oneway' ? 'Book Oneway' : 'Book Roundtrip';

        html += `
          <div class="slot-card">
            <div class="slot-accent"></div>
            
            <div class="slot-main">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <div class="slot-number">${slot.id}</div>
                <div class="car-row">
                  <div class="car-name">
                    <i class="${slot.carIcon}"></i>
                    <span>${slot.carName}</span>
                  </div>
                </div>
              </div>

              <div class="pickup-drop">
                <div class="pd-row">
                  <div class="pd-label">From</div>
                  <div class="pd-value">${slot.pickup}</div>
                </div>
                <div class="pd-row">
                  <div class="pd-label">To</div>
                  <div class="pd-value">${slot.dropoff}</div>
                </div>
              </div>

              <div class="slot-mid">
                <div class="slot-mid-left">
                  <div class="pill trip-pill">
                    <i class="${actionIcon}"></i>
                    <span>${tripType.charAt(0).toUpperCase() + tripType.slice(1)}</span>
                  </div>
                  <div class="pill date-pill">
                    <i class="fas fa-calendar"></i>
                    <span>${formattedDate}</span>
                  </div>
                  <div class="pill time-pill">
                    <i class="fas fa-clock"></i>
                    <span>${formattedTime}</span>
                  </div>
                </div>
              </div>

              <div class="slot-actions">
                <div class="action-wrap">
                  <button class="btn-action ${actionBtnClass}" onclick="bookSlot(${JSON.stringify(slot).replace(/"/g, '&quot;')})">
                    <div class="btn-left">
                      <i class="${actionIcon}"></i>
                      <span>${actionText}</span>
                    </div>
                    <div class="btn-right">
                      <div class="price-pill">â‚¹${slot.fare}</div>
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </button>
                </div>
                <div class="action-wrap">
                  <button class="btn-action" style="background: linear-gradient(90deg, #f59e0b, #f97316);" onclick="raiseRideRequest('${tripType}')">
                    <div class="btn-left">
                      <i class="fas fa-phone"></i>
                      <span>Request Ride</span>
                    </div>
                    <div class="btn-right">
                      <i class="fas fa-external-link-alt"></i>
                    </div>
                  </button>
                </div>
              </div>
            </div>
            
            <div class="slot-right">
              <div class="fare-large">â‚¹${slot.fare}</div>
            </div>
          </div>
        `;
      });

      slotsContainer.innerHTML = html;
    }

    function bookSlot(slot) {
      const user = auth.currentUser;
      if (!user) {
        showToast('Please login to book a ride');
        return;
      }

      // Get user details for WhatsApp message
      db.ref(`users/${user.uid}`).once('value').then(userSnap => {
        const userData = userSnap.val() || {};
        const userName = userData.name || userData.username || user.displayName || user.email || 'Customer';
        
        // Format the booking details for WhatsApp
        const formattedTime = formatTime24to12(slot.time);
        const formattedDate = formatDateISOtoDMY(slot.date);
        
        const waMessage = `Hi i'm ${userName} ${customEmojis.greeting}\n` +
                          `I want to book ${slot.carName} ${customEmojis.car}\n` +
                          `for ${slot.tripType} trip\n` +
                          `from - ${slot.pickup} ${customEmojis.location}\n` +
                          `to - ${slot.dropoff} ${customEmojis.location}\n` +
                          `on - ${formattedDate} at ${formattedTime} ${customEmojis.date}\n` +
                          `Fare: â‚¹${slot.fare}`;

        // Save booking attempt to Firebase (optional)
        const bookingData = {
          customerId: user.uid,
          customerEmail: user.email,
          customerName: userName,
          ...slot,
          bookingAttemptedAt: firebase.database.ServerValue.TIMESTAMP,
          status: 'attempted'
        };

        db.ref(`bookings/${user.uid}`).push(bookingData).then(() => {
          showToast('Redirecting to WhatsApp to confirm booking...');
          // Open WhatsApp
          setTimeout(() => {
            openWhatsAppWithMessage('7439654831', waMessage);
          }, 1500);
        }).catch(err => {
          console.error('Booking save error:', err);
          showToast('Redirecting to WhatsApp...');
          setTimeout(() => {
            openWhatsAppWithMessage('7439654831', waMessage);
          }, 1500);
        });
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-oneway').min = today;
      document.getElementById('date-roundtrip').min = today;
    });
  </script>

</body>
</html>
