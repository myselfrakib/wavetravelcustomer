<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book a Ride - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #0077ff;
      --light-bg: #f8f8f8;
      --dark-bg: #333;
      --text: #333;
      --success: #28a745;
    }
    [data-theme='dark'] {
      --light-bg: #333;
      --dark-bg: #f8f8f8;
      --text: #f8f8f8;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--light-bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .theme-toggle {
      position: fixed; top: 1rem; right: 1rem;
      background: var(--primary); color: #fff; border:none;
      padding: 0.5rem; border-radius:0.25rem; cursor:pointer;
    }
    .container {
      flex: 1; max-width: 600px; width: 100%;
      margin: 2rem auto; padding: 0 1rem;
    }
    h1 {
      text-align: center; margin-bottom: 1rem;
    }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: 0.5rem; }
    select, input {
      width: 100%; padding: 0.75rem; border:1px solid #ccc;
      border-radius:0.5rem; font-size:1rem;
    }
    #searchBtn {
      width:100%; padding:0.75rem; background:var(--primary);
      color:#fff; border:none; border-radius:0.5rem;
      font-weight:600; cursor:pointer; opacity:0.5;
    }
    #searchBtn.enabled { opacity:1; }
    #slots {
      margin-top:1rem; min-height:200px;
    }
    .spinner {
      text-align:center; padding:2rem;
    }
    .no-slots, .notice {
      text-align:center; padding:1rem; margin-top:1rem;
      background:#fff3cd; border:1px solid #ffeeba; border-radius:0.5rem;
    }
    .slot-card {
      background:#fff; padding:1rem; border-radius:0.75rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:1rem;
    }
    .slot-card-header { font-weight:bold; margin-bottom:0.5rem; }
    .slot-card button {
      margin-top:0.5rem; background:var(--success); color:#fff;
      padding:0.5rem 1rem; border:none; border-radius:0.5rem; cursor:pointer;
    }
    .navbar {
      position:fixed; bottom:0; left:0; width:100%; background:#fff;
      border-top:1px solid #ddd; display:flex; justify-content:space-around;
      padding:0.5rem 0;
    }
    .navbar a { color:var(--primary); font-size:0.75rem; text-align:center; }
    .navbar a i { display:block; font-size:1.25rem; }
  </style>
</head>
<body data-theme="light">

  <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
    ðŸŒ™
  </button>

  <div class="container">
    <h1>Book Your Ride</h1>

    <div class="form-group">
      <label for="pickup">Pickup Location</label>
      <select id="pickup" required><option value="">Select Pickup</option></select>
    </div>

    <div class="form-group">
      <label for="dropoff">Dropoff Location</label>
      <select id="dropoff" required><option value="">Select Dropoff</option></select>
    </div>

    <div class="form-group">
      <label for="date">Select Date</label>
      <input type="date" id="date" required/>
    </div>

    <div class="form-group">
      <label for="seats">Seats Needed</label>
      <input type="number" id="seats" min="1" placeholder="1" required/>
    </div>

    <button id="searchBtn" disabled>Search Available Slots</button>

    <div id="slots" aria-live="polite"></div>
  </div>

  <div class="navbar">
    <a href="customerdashboard.html"><i class="fas fa-home"></i>Home</a>
    <a href="book.html"><i class="fas fa-car"></i>Book</a>
    <a href="mybookings.html"><i class="fas fa-calendar-check"></i>Bookings</a>
    <a href="profile.html"><i class="fas fa-user"></i>Profile</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script>
    // ---- Firebase Init ----
    const firebaseConfig = { /* your config */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    // ---- Theming ----
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      const body = document.body;
      const next = body.dataset.theme === 'light' ? 'dark' : 'light';
      body.dataset.theme = next;
      themeToggle.textContent = next === 'light' ? 'ðŸŒ™' : 'â˜€ï¸';
    });

    // ---- Utils ----
    function debounce(fn, ms=300) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }
    function formatTime24to12(time) {
      let [h, m] = time.split(':').map(Number);
      const suf = h>=12?'PM':'AM';
      h = h%12||12;
      return `${h}:${m.toString().padStart(2,'0')} ${suf}`;
    }
    function formatDateDMY(iso) {
      const [y,m,d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }
    // cache locations 5m
    async function loadLocations() {
      const key = 'wavetravel-locs';
      const now = Date.now();
      let data = JSON.parse(localStorage.getItem(key)||'{}');
      if (!data.time || now - data.time > 300_000) {
        try {
          const snap = await db.ref('locations').once('value');
          const arr = [];
          snap.forEach(ch=>arr.push(ch.val()));
          data = { time: now, arr };
          localStorage.setItem(key, JSON.stringify(data));
        } catch(e) {
          alert('Failed to load locations.');
          return [];
        }
      }
      return data.arr;
    }

    // ---- Main ----
    (async function init(){
      // Auth guard
      auth.onAuthStateChanged(user=>{
        if(!user) location='login.html';
      });

      const pickupEl = document.getElementById('pickup'),
            dropoffEl= document.getElementById('dropoff'),
            dateEl   = document.getElementById('date'),
            seatsEl  = document.getElementById('seats'),
            searchBtn= document.getElementById('searchBtn'),
            slotsDiv = document.getElementById('slots');

      const locs = await loadLocations();
      locs.forEach(l=>{
        const opt = `<option value="${l.name}">${l.name}</option>`;
        pickupEl.insertAdjacentHTML('beforeend', opt);
        dropoffEl.insertAdjacentHTML('beforeend', opt);
      });

      // Enable search when valid
      [pickupEl,dropoffEl,dateEl,seatsEl].forEach(el=>
        el.addEventListener('input', ()=>{
          const ok = pickupEl.value && dropoffEl.value && dateEl.value && seatsEl.value>0;
          searchBtn.disabled = !ok;
          searchBtn.classList.toggle('enabled', ok);
        })
      );

      async function doSearch(){
        slotsDiv.innerHTML = '<div class="spinner">Loadingâ€¦</div>';
        const pu = pickupEl.value, dof = dropoffEl.value, dt = dateEl.value;
        const req = +seatsEl.value;
        try {
          // Query by date index
          const snap = await db.ref('availableslots')
            .orderByChild('date').equalTo(dt).once('value');
          const all = [];
          snap.forEach(drv=>{
            drv.forEach(s=> all.push({ driverId:drv.key, slotKey:s.key, ...s.val() }));
          });
          // exact
          let matched = all.filter(s=>s.pickup===pu && s.dropoff===dof);
          // fallback
          if(!matched.length){
            const idxMap = Object.fromEntries(locs.map(l=>[l.name,l.index]));
            const idx = idxMap[dof];
            matched = all.filter(s=>idxMap[s.dropoff]===idx);
            if(matched.length){
              slotsDiv.innerHTML = '<div class="notice">No exact match; here are alternatives:</div>';
            }
          }
          if(!matched.length){
            slotsDiv.innerHTML = '<div class="no-slots">No slots found.</div>';
            return;
          }
          // render
          slotsDiv.innerHTML = '';
          const profileSnap = await db.ref(`users/${auth.currentUser.uid}`).once('value');
          const prof = profileSnap.val()||{};
          matched.forEach((slot,i)=>{
            const avail = +slot.seats;
            if(avail<req) return;
            const puIdx = locs.find(l=>l.name===slot.pickup)?.index||0;
            const doIdx = locs.find(l=>l.name===slot.dropoff)?.index||0;
            const fare = Math.abs(puIdx-doIdx)*req;
            const card = document.createElement('div');
            card.className='slot-card';
            card.innerHTML=`
              <div class="slot-card-header">Sl. No. ${i+1}</div>
              <div><strong>Pickup:</strong> ${slot.pickup}</div>
              <div><strong>Dropoff:</strong> ${slot.dropoff}</div>
              <div><strong>Date:</strong> ${formatDateDMY(slot.date)}</div>
              <div><strong>Time:</strong> ${formatTime24to12(slot.time)}</div>
              <div><strong>Seats:</strong> ${avail}</div>
              <button>Book ${req} for â‚¹${fare}</button>
            `;
            card.querySelector('button').onclick = ()=>{
              const bk = {
                ...slot, seatsRequested:req, fare,
                customerId: auth.currentUser.uid,
                customerName: prof.name||'', customerPhone: prof.phone||''
              };
              localStorage.setItem('selectedBooking', JSON.stringify(bk));
              location='checkout.html';
            };
            slotsDiv.appendChild(card);
          });
        } catch(err){
          console.error(err);
          slotsDiv.innerHTML = '<div class="no-slots">Error loading slots.</div>';
        }
      }

      const searchSlots = debounce(doSearch, 500);
      searchBtn.addEventListener('click', searchSlots);
    })();
  </script>
</body>
</html>
