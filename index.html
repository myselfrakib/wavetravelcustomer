<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>WaveTravel Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --primary: #0077ff;
      --primary-dark: #005bb5;
      --secondary: #00d4aa;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --dark-text: #2c3e50;
      --light-text: #7f8c8d;
      --error: #e74c3c;
      --success: #27ae60;
      --shadow: 0 8px 20px rgba(0,0,0,0.15);
      --border-radius: 20px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--dark-text);
      position: relative;
      overflow-x: hidden;
      padding: 0;
      margin: 0;
      font-size: 16px; /* Prevent zoom on iOS */
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.08"/><circle cx="80" cy="40" r="1.5" fill="white" opacity="0.08"/><circle cx="40" cy="80" r="1" fill="white" opacity="0.08"/></svg>');
      animation: float 25s infinite linear;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes float {
      0% { transform: translateY(100vh) rotate(0deg); }
      100% { transform: translateY(-100vh) rotate(360deg); }
    }

    .container { position: relative; z-index: 1; width: 100%; min-height: 100vh; display: flex; flex-direction: column; justify-content: flex-start; padding: 20px 16px 40px 16px; overflow-y: auto; }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: var(--border-radius);
      padding: 32px 24px 40px 24px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 400px;
      margin: 20px auto 0 auto;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }

    .logo-section { text-align: center; margin-bottom: 30px; padding-top: 10px; }
    .logo-icon { width: 70px; height: 70px; border-radius: 18px; display: inline-block; margin-bottom: 16px; box-shadow: 0 8px 20px rgba(0,119,255,0.3); overflow: hidden; background: linear-gradient(135deg, var(--primary), var(--secondary)); }
    .logo-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 18px; }
    .card h1 { text-align: center; color: var(--dark-text); margin-bottom: 8px; font-size: 1.6rem; font-weight: 700; line-height: 1.2; }
    .subtitle { text-align: center; color: var(--light-text); font-size: 0.9rem; margin-bottom: 30px; line-height: 1.4; padding: 0 10px; }

    .form-group { position: relative; margin-bottom: 20px; }
    .form-group i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--light-text); font-size: 18px; z-index: 2; }
    .input-field { width: 100%; padding: 18px 18px 18px 52px; border: 2px solid #e8ecf0; border-radius: 16px; font-size: 16px; font-family: inherit; transition: all 0.3s ease; background: rgba(255,255,255,0.9); -webkit-appearance: none; appearance: none; }
    .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,119,255,0.1); background: rgba(255,255,255,1); }
    .input-field::placeholder { color: var(--light-text); font-size: 15px; }

    .button-group { display:flex; flex-direction: column; gap:16px; margin-bottom: 24px; }
    .button { width:100%; padding:18px 20px; font-size:16px; font-weight:600; border:none; border-radius:16px; cursor:pointer; transition:all 0.3s ease; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; gap:10px; min-height:56px; }
    .button-primary { background: linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; box-shadow: 0 8px 20px rgba(0,119,255,0.3); }
    .button-secondary { background: rgba(255,255,255,0.95); color: var(--dark-text); border: 2px solid #e8ecf0; }

    .divider { display:flex; align-items:center; margin:16px 0; color:var(--light-text); font-size:0.85rem; }
    .divider::before, .divider::after { content:''; flex:1; height:1px; background:#e8ecf0; }
    .divider span { margin:0 20px; font-weight:500; }

    .links { text-align:center; padding-top:24px; border-top:1px solid #e8ecf0; }
    .links p { color: var(--light-text); font-size:0.9rem; margin-bottom:12px; }
    .links a { color: var(--primary); text-decoration:none; font-weight:600; font-size:1rem; padding:8px 16px; border-radius:12px; display:inline-flex; align-items:center; gap:8px; }

    .error { color: var(--error); font-size:0.9rem; text-align:center; margin-bottom:20px; padding:14px; background: rgba(231,76,60,0.1); border:1px solid rgba(231,76,60,0.2); border-radius:12px; display:none; line-height:1.4; }
    .error.show { display:block; animation: slideIn 0.4s ease; }
    @keyframes slideIn { from { opacity:0; transform: translateY(-15px); } to { opacity:1; transform:translateY(0); } }

    .loading { pointer-events:none; opacity:0.7; }
    .loading .button-text { opacity:0; }
    .loading::after { content:''; position:absolute; width:22px; height:22px; border:2px solid transparent; border-top:2px solid currentColor; border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .admin-button { position:fixed; bottom:24px; right:24px; width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,#ff6b35,#f7931e); color:white; border:none; font-size:20px; cursor:pointer; box-shadow:0 8px 20px rgba(255,107,53,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }

    /* responsive styles omitted for brevity (kept from original) */
    @media (max-width: 320px) { .container { padding: 16px 12px 32px 12px; } .card { padding: 24px 18px 32px 18px; margin: 10px auto 0 auto; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="logo-section">
        <div class="logo-icon">
          <img src="https://firebasestorage.googleapis.com/v0/b/wavetravel-3c4c4.firebasestorage.app/o/logo%20ss.png?alt=media&token=ab259e7a-1e22-41fe-be3e-0845c996670f" alt="WaveTravel Logo">
        </div>
        <h1>Welcome Back</h1>
        <p class="subtitle">Sign in to continue your journey with WaveTravel</p>
      </div>

      <div id="errorMsg" class="error"></div>

      <form id="loginForm">
        <div class="form-group">
          <i class="fas fa-envelope" aria-hidden="true"></i>
          <input type="email" id="email" class="input-field" placeholder="Enter your email" required autocomplete="email" />
        </div>

        <div class="form-group">
          <i class="fas fa-lock" aria-hidden="true"></i>
          <input type="password" id="password" class="input-field" placeholder="Enter your password" required autocomplete="current-password" />
        </div>

        <div class="button-group">
          <button type="submit" id="loginBtn" class="button button-primary" aria-label="Sign in">
            <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
            <span class="button-text">Sign In</span>
          </button>

          <div class="divider">
            <span>or</span>
          </div>

          <!-- Driver Login button: fixed and now redirects to driverlogin.html -->
          <button type="button" id="driverLoginBtn" class="button button-secondary" aria-label="Driver login">
            <i class="fas fa-car" aria-hidden="true"></i>
            <span class="button-text">Driver Login</span>
          </button>
        </div>
      </form>

      <div class="links">
        <p>Don't have an account?</p>
        <a href="signup.html" id="signupLink">
          <i class="fas fa-user-plus" aria-hidden="true"></i> Create Account
        </a>
      </div>
    </div>
  </div>

  <!-- Admin button -->
  <button id="adminBtn" class="admin-button" aria-label="Admin Dashboard" title="Admin Dashboard">
    <i class="fas fa-user-shield" aria-hidden="true"></i>
  </button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      setPersistence,
      browserSessionPersistence,
      onAuthStateChanged,
      // signOut // no signOut on load now
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    import {
      getDatabase,
      ref as dbRef,
      child,
      get
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const driverLoginBtn = document.getElementById("driverLoginBtn");
    const adminBtn = document.getElementById("adminBtn");
    const errorMsgEl = document.getElementById("errorMsg");
    const loginForm = document.getElementById("loginForm");

    // ---------- Persistence ----------
    // Use browserSessionPersistence so auth survives reloads in the same tab/window.
    // This allows us to rely on sessionStorage's last-role marker to route correctly when the app reopens.
    (async () => {
      try {
        await setPersistence(auth, browserSessionPersistence);
      } catch (err) {
        console.warn("Failed to set browserSessionPersistence:", err);
      }
    })();

    // ---------- Session role helpers ----------
    function setSessionRole(uid, role) {
      try {
        sessionStorage.setItem(`lastRoleFor:${uid}`, role);
      } catch (e) { /* ignore */ }
    }
    function getSessionRole(uid) {
      try {
        return sessionStorage.getItem(`lastRoleFor:${uid}`) || null;
      } catch (e) { return null; }
    }

    // ---------- DB fallback checks ----------
    async function getUsersRole(uid) {
      try {
        const snap = await get(child(dbRef(db), `users/${uid}/role`));
        if (snap.exists()) return snap.val(); // "driver" or "customer"
        return null;
      } catch (e) {
        console.warn("getUsersRole err", e);
        return null;
      }
    }

    async function isDriverDetailsPresent(uid) {
      try {
        const snap = await get(child(dbRef(db), `driverdetails/${uid}`));
        return snap.exists();
      } catch (e) {
        console.warn("isDriverDetailsPresent err", e);
        return false;
      }
    }

    // ---------- Decide authoritative role ----------
    async function determineRole(user) {
      const uid = user.uid;

      // 1) sessionStorage (highest priority for user-experience)
      const sRole = getSessionRole(uid);
      if (sRole) return sRole;

      // 2) users/{uid}/role
      const usersRole = await getUsersRole(uid);
      if (usersRole) return usersRole;

      // 3) driverdetails presence (last resort)
      const driverPresent = await isDriverDetailsPresent(uid);
      if (driverPresent) return "driver";

      // default
      return "customer";
    }

    // ---------- Route and remember ----------
    async function routeAfterLogin(user) {
      const role = await determineRole(user);
      // remember for future reloads in this tab
      setSessionRole(user.uid, role);

      if (role === "driver") {
        // change to your actual driver landing page if different
        window.location.href = "driverhome.html";
      } else {
        window.location.href = "booking.html";
      }
    }

    // ---------- Auth state listener ----------
    // If the user is already signed in (auth persists in session), this will run on app open.
    onAuthStateChanged(auth, async (user) => {
      if (!user) return; // not signed in — show login

      // Only auto-route when on login/index page (prevents loops on other pages)
      const path = window.location.pathname.split("/").pop().toLowerCase();
      const isLoginPage = ["", "index.html", "login.html"].includes(path);
      if (!isLoginPage) return;

      // Route according to sessionStorage first (fast) then DB fallback
      await routeAfterLogin(user);
    });

    // ---------- Show / hide error ----------
    function showError(message) {
      errorMsgEl.textContent = message;
      errorMsgEl.classList.add("show");
      setTimeout(() => { errorMsgEl.classList.remove("show"); }, 6000);
    }
    function hideError() { errorMsgEl.classList.remove("show"); }

    // ---------- Loading UI ----------
    function setLoading(button, isLoading) {
      if (isLoading) { button.classList.add("loading"); button.disabled = true; }
      else { button.classList.remove("loading"); button.disabled = false; }
    }

    // ---------- Login form submit ----------
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = emailEl.value.trim();
      const pass = passEl.value;
      hideError();

      if (!email || !pass) { showError("Please enter both email and password."); return; }
      if (!isValidEmail(email)) { showError("Please enter a valid email address."); return; }

      setLoading(loginBtn, true);

      try {
        const result = await signInWithEmailAndPassword(auth, email, pass);
        const user = result.user;

        // THIS PAGE is the **customer** login flow — remember that choice in sessionStorage
        setSessionRole(user.uid, "customer");

        // Optionally: write users/{uid}/role = "customer" here if you want persistent DB role.
        // (Uncomment the next lines if you want to persist the role in DB — ensure security rules allow it.)
        /*
        import { set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
        await set(child(dbRef(db), `users/${user.uid}/role`), "customer");
        */

        // Route immediately
        await routeAfterLogin(user);
      } catch (err) {
        console.error("Login error:", err);
        let errorMessage = "Login failed. Please try again.";
        switch (err.code) {
          case 'auth/user-not-found': errorMessage = "No account found with this email address."; break;
          case 'auth/wrong-password': errorMessage = "Incorrect password. Please try again."; break;
          case 'auth/invalid-email': errorMessage = "Please enter a valid email address."; break;
          case 'auth/user-disabled': errorMessage = "This account has been disabled."; break;
          case 'auth/too-many-requests': errorMessage = "Too many failed attempts. Please try again later."; break;
          case 'auth/invalid-credential': errorMessage = "Invalid email or password. Please check your credentials."; break;
        }
        showError(errorMessage);
      } finally {
        setLoading(loginBtn, false);
      }
    });

    // ---------- Driver/login/admin buttons ----------
    driverLoginBtn.addEventListener("click", () => {
      // On the driver login page, make sure that after the driver signs in you call:
      // setSessionRole(driverUid, "driver");
      // so subsequent reloads in same tab go to driver UI.
      window.location.href = "driverlogin.html";
    });
    adminBtn.addEventListener("click", () => { window.location.href = "admindashboard.html"; });

    // ---------- Basic UI helpers ----------
    function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

    emailEl.addEventListener('blur', () => {
      if (emailEl.value && !isValidEmail(emailEl.value)) emailEl.style.borderColor = 'var(--error)';
      else emailEl.style.borderColor = '#e8ecf0';
    });
    emailEl.addEventListener('input', () => { if (emailEl.style.borderColor === 'var(--error)') emailEl.style.borderColor = '#e8ecf0'; });

    document.querySelectorAll('.input-field').forEach(input => {
      input.addEventListener('focus', function() {
        this.parentElement.querySelector('i').style.color = 'var(--primary)';
        setTimeout(() => { this.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300);
      });
      input.addEventListener('blur', function() {
        if (!this.value) this.parentElement.querySelector('i').style.color = 'var(--light-text)';
      });
    });

    // Prevent double-tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, false);

    // Handle keyboard show/hide on mobile
    function handleViewportChange() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', handleViewportChange);
    window.addEventListener('orientationchange', handleViewportChange);
    handleViewportChange();
  </script>
</body>
</html>
