<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout – WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary: #2f6690;
      --accent: #3a7ca5;
      --light: #d9dcd6;
      --dark: #16425b;
      --sky: #81c3d7;
      --muted: #6da5d0;
      --bg-grad: linear-gradient(to right, var(--accent), var(--dark));
      --card-bg: #ffffff;
      --danger:#ff4d4f;
      --success:#28a745;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg-grad); color: #0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .page { min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:16px; padding-bottom:20px; }
    .wrap { width:100%; max-width:720px; }
    header.app-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .app-title { color: var(--light); font-size:1.1rem; font-weight:700; letter-spacing:0.2px; }
    .back-btn { background:rgba(255,255,255,0.12); border:none; color: var(--light); padding:6px 8px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; transition: background 0.2s ease; font-size:0.9rem; }
    .back-btn:hover { background:rgba(255,255,255,0.2); }
    
    .summary-card { background: var(--card-bg); border-radius:12px; padding:14px; box-shadow: 0 8px 24px rgba(2,6,23,0.06); color: var(--dark); overflow:hidden; border: 1px solid rgba(2,6,23,0.04); }
    .info-row { display:flex; gap:10px; align-items:center; background: rgba(47,102,144,0.04); padding:10px; border-radius:8px; margin-bottom: 6px; transition: all 0.2s ease; }
    .info-row .icon { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, var(--sky), rgba(129,195,215,0.8)); color: var(--dark); font-size:1rem; flex-shrink:0; box-shadow: 0 2px 6px rgba(2,6,23,0.06); }
    .meta .label { font-weight:700; color: var(--dark); font-size:0.85rem; }
    .meta .val { color: var(--muted); font-size:0.8rem; margin-top:1px; max-width:100%; word-break:break-word; }
    .details { margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .detail-pill { background: rgba(47,102,144,0.04); padding:10px; border-radius:8px; display:flex; flex-direction:column; transition: all 0.2s ease; border: 1px solid rgba(47,102,144,0.08); }
    .detail-pill small { font-size:0.75rem; color: var(--muted); font-weight:600; }
    .detail-pill strong { font-size:0.9rem; color: var(--dark); font-weight:700; margin-top:2px; }

    .terms { margin-top:14px; display:flex; gap:10px; align-items:center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; }
    .checkbox { width:20px; height:20px; border-radius:4px; border:2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition: all 0.2s ease; }
    .checkbox.checked { background: var(--primary); border-color: var(--primary); color:#fff; box-shadow: 0 3px 10px rgba(47,102,144,0.3); }
    .terms-label { font-size:0.85rem; color: var(--light); font-weight: 600; }
    .terms-label a { color: var(--light); text-decoration:underline; }

    #payBtn { 
      margin-top:16px; width:100%; padding:14px 12px; 
      background: linear-gradient(90deg, var(--primary), var(--sky)); 
      border: none; border-radius:10px; color:#fff; font-weight:800; font-size:1rem; 
      box-shadow: 0 6px 20px rgba(47,102,144,0.2); 
      transition: all 0.2s ease; cursor: pointer; 
      display: flex; align-items: center; justify-content: center; gap: 6px; 
      position: relative;
    }
    #payBtn:hover:not(:disabled) { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 25px rgba(47,102,144,0.3); 
    }
    #payBtn:disabled { 
      opacity:0.6; cursor:not-allowed; transform:none; 
      box-shadow: 0 3px 8px rgba(47,102,144,0.1); 
    }

    .spinner {
      width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-msg {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; padding: 20px; font-weight: 700; color: var(--muted);
    }
    .loading-msg i { animation: spin 1s linear infinite; }

    .error-msg {
      background: rgba(255,77,79,0.1); color: var(--danger);
      padding: 16px; border-radius: 8px; margin-top: 14px;
      font-weight: 600; display: flex; align-items: center; gap: 8px;
    }

    #center-toast { 
      position: fixed; left: 50%; top: 50%; 
      transform: translate(-50%, -50%) scale(0.95); 
      background: rgba(11,18,32,0.94); color: #fff; 
      padding: 20px 28px; border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(2,6,23,0.6); 
      opacity: 0; pointer-events: none; 
      transition: opacity .22s ease, transform .22s ease; 
      z-index: 9999; font-weight: 700; min-width: 320px; 
      text-align: center; display: flex; align-items: center; 
      justify-content: center; gap: 12px; font-size: 0.95rem; 
      backdrop-filter: blur(10px); 
    }
    #center-toast.show { 
      opacity:1; transform: translate(-50%,-50%) scale(1); 
      pointer-events:auto; 
    }
    .toast-success { background: linear-gradient(135deg, var(--success), #22c55e); }
    .toast-error { background: linear-gradient(135deg, var(--danger), #ef4444); }
    
    .progress-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 9998;
      display: none; align-items: center; justify-content: center;
    }
    .progress-card {
      background: white; padding: 30px; border-radius: 12px;
      text-align: center; max-width: 400px; margin: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .progress-card h3 { margin-bottom: 16px; color: var(--dark); }
    .progress-card p { color: var(--muted); margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header class="app-header">
        <button class="back-btn" onclick="goBack()">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="app-title">Confirm & Pay</div>
      </header>

      <div id="summary" class="summary-card" aria-live="polite">
        <div class="loading-msg">
          <i class="fas fa-spinner"></i>
          Loading booking details...
        </div>
      </div>

      <div class="terms">
        <label class="checkbox" id="termsBox" title="Agree to T&C">
          <input type="checkbox" id="termsChk" style="display:none" />
          <svg id="termsTick" viewBox="0 0 24 24" width="14" height="14" style="display:none;color:white">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"></path>
          </svg>
        </label>
        <div class="terms-label">
          I agree to the 
          <a href="terms.html" target="_blank">Terms & Conditions</a>
        </div>
      </div>

      <button id="payBtn" disabled>
        <i class="fas fa-lock"></i>
        <span id="payBtnText">Pay & Book</span>
      </button>
    </div>
  </div>

  <div id="center-toast" role="status" aria-live="polite">
    <span class="icon" style="width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:var(--success);color:#fff">
      ✓
    </span>
    <span id="center-toast-text">Success</span>
  </div>

  <div id="progress-overlay" class="progress-overlay">
    <div class="progress-card">
      <h3>Processing Payment</h3>
      <p>Please wait while we confirm your booking...</p>
      <div class="spinner" style="margin: 0 auto;"></div>
    </div>
  </div>

  <!-- Firebase & Razorpay -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // UI elements
    const summaryEl = document.getElementById('summary');
    const payBtn = document.getElementById('payBtn');
    const payBtnText = document.getElementById('payBtnText');
    const termsChk = document.getElementById('termsChk');
    const termsBox = document.getElementById('termsBox');
    const termsTick = document.getElementById('termsTick');
    const progressOverlay = document.getElementById('progress-overlay');

    // booking expected in localStorage (must include driverId and slotKey)
    let booking = null;
    let currentUser = null;
    let isProcessing = false;

    function goBack() {
      if (isProcessing) {
        showCenterToast('Please wait for the current process to complete', 2000, 'error');
        return;
      }
      window.history.back();
    }

    function showCenterToast(message, duration = 2200, type = 'success') {
      const toast = document.getElementById('center-toast');
      const text = document.getElementById('center-toast-text');
      const icon = toast.querySelector('.icon');
      
      text.textContent = message;
      
      // Update toast styling based on type
      toast.className = '';
      if (type === 'error') {
        toast.classList.add('toast-error');
        icon.innerHTML = '✗';
        icon.style.background = 'var(--danger)';
      } else {
        toast.classList.add('toast-success');
        icon.innerHTML = '✓';
        icon.style.background = 'var(--success)';
      }
      
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showProgress(show = true) {
      progressOverlay.style.display = show ? 'flex' : 'none';
    }

    // checkbox UI sync
    function setCheckboxChecked(state) {
      if (state) {
        termsBox.classList.add('checked');
        termsTick.style.display = 'inline-block';
      } else {
        termsBox.classList.remove('checked');
        termsTick.style.display = 'none';
      }
      termsChk.checked = !!state;
      updatePayButton();
    }

    function updatePayButton() {
      const canPay = termsChk.checked && booking && booking.fare > 0 && !isProcessing;
      payBtn.disabled = !canPay;
      
      if (isProcessing) {
        payBtnText.innerHTML = '<div class="spinner"></div> Processing...';
      } else if (!termsChk.checked) {
        payBtnText.textContent = 'Accept Terms to Continue';
      } else if (!booking || booking.fare <= 0) {
        payBtnText.textContent = 'Contact for Booking';
      } else {
        payBtnText.innerHTML = '<i class="fas fa-lock"></i> Pay & Book';
      }
    }

    // Event listeners for checkbox
    termsBox.addEventListener('click', () => {
      if (!isProcessing) {
        setCheckboxChecked(!termsChk.checked);
      }
    });
    termsChk.addEventListener('change', () => setCheckboxChecked(termsChk.checked));

    // Ultra-fast payment processing - immediate redirect
    async function processSuccessfulPayment(paymentId, bookingData, userData) {
      try {
        const driverId = bookingData.driverId;
        const slotKey = bookingData.slotKey;
        const bookingKey = db.ref(`bookings/${driverId}`).push().key;

        // Build atomic update
        const updates = {};
        updates[`bookings/${driverId}/${bookingKey}`] = {
          ...bookingData,
          userId: userData.uid,
          userName: userData.name,
          userPhone: userData.phone,
          paymentId: paymentId,
          bookedAt: new Date().toISOString(),
          status: 'confirmed'
        };
        updates[`driverWallet/${driverId}/${bookingKey}`] = {
          amount: (bookingData.fare || 0) * 0.6,
          status: 'unpaid',
          bookingId: bookingKey,
          date: new Date().toISOString()
        };
        updates[`availableslots/${driverId}/${slotKey}`] = null;

        // Execute and redirect immediately
        db.ref().update(updates);
        localStorage.removeItem('selectedBooking');
        window.location.href = 'mybookings.html';

      } catch (err) {
        alert('Booking error. Contact support with Payment ID: ' + paymentId);
      }
    }

    // format helpers
    function formatDate(d) {
      if (!d || typeof d !== 'string') return d || '-';
      const [y, m, dd] = d.split('-');
      if (!dd) return d;
      return `${dd}/${m}/${y}`;
    }

    function formatTime(t) {
      if (!t || typeof t !== 'string') return t || '-';
      let [h, mm] = t.split(':').map(Number);
      if (isNaN(h)) return t;
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${(mm||0).toString().padStart(2,'0')} ${suffix}`;
    }

    function renderBookingSummary(userData) {
      if (!booking) {
        summaryEl.innerHTML = `
          <div class="error-msg">
            <i class="fas fa-exclamation-triangle"></i>
            No booking data found. Please select a trip first.
          </div>
        `;
        return;
      }

      const pickup = booking.pickup || '—';
      const dropoff = booking.dropoff || '—';
      const date = booking.date || '—';
      const time = booking.time || '—';
      const tripType = booking.triptype || booking.tripType || 'oneway';
      const fare = booking.fare || 0;
      const tripTypeDisplay = tripType === 'oneway' ? 'Oneway' : 'Roundtrip';
      const carInfo = `${booking.carBrand || 'Car'}${booking.carReg ? ' (' + booking.carReg + ')' : ''}`;

      summaryEl.innerHTML = `
        <div role="region" aria-label="Booking summary">
          <div style="font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
            <i class="fas fa-user"></i> 
            Passenger Details
          </div>
          
          <div class="info-row" style="margin-bottom:12px">
            <div class="icon"><i class="fas fa-user"></i></div>
            <div class="meta">
              <div class="label">${userData.name || 'Guest'}</div>
              <div class="val">${userData.phone || 'No phone'}</div>
            </div>
          </div>

          <div style="font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
            <i class="fas fa-route"></i> 
            Trip Details
          </div>
          
          <div class="info-row">
            <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
            <div class="meta">
              <div class="label">Pickup Location</div>
              <div class="val">${pickup}</div>
            </div>
          </div>
          
          <div class="info-row">
            <div class="icon" style="background: linear-gradient(180deg,#ffdede,#fff7f7); color:var(--danger)">
              <i class="fas fa-map-pin"></i>
            </div>
            <div class="meta">
              <div class="label">Dropoff Location</div>
              <div class="val">${dropoff}</div>
            </div>
          </div>

          <div class="info-row" style="margin-bottom:12px">
            <div class="icon"><i class="fas fa-car"></i></div>
            <div class="meta">
              <div class="label">Vehicle</div>
              <div class="val">${carInfo}</div>
            </div>
          </div>

          <div class="details" aria-hidden="false">
            <div class="detail-pill">
              <small>Trip Type</small>
              <strong>${tripTypeDisplay}</strong>
            </div>
            <div class="detail-pill">
              <small>Date</small>
              <strong>${formatDate(date)}</strong>
            </div>
            <div class="detail-pill">
              <small>Time</small>
              <strong>${formatTime(time)}</strong>
            </div>
            <div class="detail-pill">
              <small>Total Fare</small>
              <strong>₹${fare}</strong>
            </div>
          </div>
        </div>
      `;
    }

    function showError(message) {
      summaryEl.innerHTML = `
        <div class="error-msg">
          <i class="fas fa-exclamation-triangle"></i>
          ${message}
        </div>
      `;
    }

    // Streamlined initialization - fast loading
    function initializeBooking() {
      try {
        const bookingStr = localStorage.getItem('selectedBooking');
        if (!bookingStr) {
          showError('Please select a trip first.');
          return;
        }

        booking = JSON.parse(bookingStr);
        
        if (!booking.driverId || !booking.slotKey) {
          showError('Invalid booking data. Missing required information.');
          return;
        }

        // Load user data immediately without extra checks
        loadUserData();

      } catch (err) {
        console.error('Error parsing booking data:', err);
        showError('Invalid booking data. Please try again.');
      }
    }

    // Fast user data loading
    async function loadUserData() {
      const user = auth.currentUser;
      if (!user) {
        showError('Please login first.');
        return;
      }

      try {
        // Quick user data fetch
        const snapUid = await db.ref(`users/${user.uid}`).once('value');
        let userData = snapUid.val();

        if (!userData) {
          showError('Profile not found. Please complete your profile first.');
          return;
        }

        userData.uid = user.uid;
        currentUser = userData;
        renderBookingSummary(userData);
        
        // Quick setup
        setCheckboxChecked(false);
        updatePayButton();

      } catch (err) {
        console.error('Error loading user data:', err);
        showError('Failed to load profile. Please try again.');
      }
    }

    // Simplified payment initialization
    function initializePayment() {
      if (!booking || !currentUser || !termsChk.checked || isProcessing) {
        return;
      }

      isProcessing = true;
      updatePayButton();

      // Direct payment without extra checks
      const rzpOptions = {
        key: 'rzp_test_RIMi0wlC12kjhY',
        amount: (booking.fare || 0) * 100,
        currency: 'INR',
        name: 'WaveTravel',
        description: `${booking.triptype || booking.tripType || 'Trip'} Booking`,
        prefill: {
          name: currentUser.name || '',
          contact: currentUser.phone || '',
          email: auth.currentUser.email || ''
        },
        theme: { color: '#2f6690' },
        handler: function(response) {
          processSuccessfulPayment(response.razorpay_payment_id, booking, currentUser);
        },
        modal: {
          ondismiss: function() {
            isProcessing = false;
            updatePayButton();
          }
        }
      };

      try {
        const rzp = new Razorpay(rzpOptions);
        rzp.open();
      } catch (error) {
        console.error('Razorpay failed:', error);
        isProcessing = false;
        updatePayButton();
        alert('Payment failed to load. Please try again.');
      }
    }

    // Event listeners
    payBtn.addEventListener('click', initializePayment);

    // Auth state monitoring
    auth.onAuthStateChanged(user => {
      if (!user) {
        showError('Please login first.');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);
      } else {
        initializeBooking();
      }
    });

    // Error handling
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      if (isProcessing) {
        showProgress(false);
        isProcessing = false;
        updatePayButton();
        showCenterToast('An unexpected error occurred. Please try again.', 3000, 'error');
      }
    });

    // Prevent accidental page refresh during processing
    window.addEventListener('beforeunload', function(e) {
      if (isProcessing) {
        e.preventDefault();
        e.returnValue = 'Payment is being processed. Are you sure you want to leave?';
        return e.returnValue;
      }
    });

    console.log('Checkout page initialized');
  </script>
</body>
</html>
