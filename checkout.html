<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout – WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary: #2f6690;
      --accent: #3a7ca5;
      --light: #d9dcd6;
      --dark: #16425b;
      --sky: #81c3d7;
      --muted: #6da5d0;
      --bg-grad: linear-gradient(to right, var(--accent), var(--dark));
      --card-bg: #ffffff;
      --danger: #ff4d4f;
      --success: #28a745;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg-grad); color: #0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .page {
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:18px;
      padding-bottom:80px;
    }
    .wrap {
      width:100%;
      max-width:720px;
    }

    header.app-header {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .app-title {
      color: var(--light);
      font-size:1.25rem;
      font-weight:700;
      letter-spacing:0.2px;
    }
    .back-btn {
      background:rgba(255,255,255,0.12);
      border:none; color: var(--light); padding:8px 10px; border-radius:10px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: background 0.2s ease;
    }
    .back-btn:hover {
      background:rgba(255,255,255,0.18);
    }

    .summary-card {
      background: var(--card-bg);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(2,6,23,0.08);
      color: var(--dark);
      overflow:hidden;
      border: 1px solid rgba(2,6,23,0.04);
    }
    .summary-grid {
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px 16px;
      align-items:start;
    }

    /* Enhanced info rows */
    .info-row {
      display:flex; gap:12px; align-items:center;
      background: rgba(47,102,144,0.04);
      padding:12px; border-radius:10px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
    }
    .info-row:hover {
      background: rgba(47,102,144,0.06);
    }
    .info-row .icon {
      width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, var(--sky), rgba(129,195,215,0.8));
      color: var(--dark); font-size:1.15rem;
      flex-shrink:0;
      box-shadow: 0 3px 8px rgba(2,6,23,0.06);
    }
    .info-row .meta {
      display:flex; flex-direction:column;
      flex: 1;
      min-width: 0;
    }
    .meta .label { font-weight:700; color: var(--dark); font-size:0.95rem; }
    .meta .val { color: var(--muted); font-size:0.9rem; margin-top:2px; max-width:100%; word-break:break-word; }

    .summary-grid .fare-box {
      background: linear-gradient(180deg, #fdf6e6, #fff6d9);
      border-radius:12px;
      padding:16px 20px;
      text-align:center;
      min-width:160px;
      align-self:start;
      box-shadow: 0 8px 20px rgba(2,6,23,0.06);
      border: 1px solid rgba(138,107,0,0.1);
    }
    .fare-box .label { color:#8a6b00; font-weight:700; font-size:0.9rem; }
    .fare-box .amt { font-size:1.35rem; font-weight:800; color:#402a00; margin-top:8px; }
    .fare-box .trip-type {
      background: rgba(138,107,0,0.1);
      color: #8a6b00;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 8px;
      display: inline-block;
    }

    .details {
      margin-top:16px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .detail-pill {
      background: rgba(47,102,144,0.04);
      padding:12px; border-radius:10px;
      display:flex; flex-direction:column;
      transition: all 0.2s ease;
      border: 1px solid rgba(47,102,144,0.08);
    }
    .detail-pill:hover {
      background: rgba(47,102,144,0.06);
    }
    .detail-pill small { color: var(--muted); font-size:0.82rem; font-weight: 600; }
    .detail-pill strong { font-size:0.98rem; margin-top:6px; color: var(--dark); font-weight: 700; }

    /* Enhanced terms section */
    .terms {
      margin-top:16px; display:flex; gap:12px; align-items:center;
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 10px;
    }
    .checkbox {
      width:24px; height:24px; border-radius:6px; border:2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1); display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      transition: all 0.2s ease;
    }
    .checkbox:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.4);
    }
    .checkbox input { display:none; }
    .checkbox.checked { 
      background: var(--primary); 
      border-color: var(--primary); 
      color:#fff; 
      box-shadow: 0 4px 12px rgba(47,102,144,0.3);
    }

    .terms-label { 
      font-size:0.95rem; 
      color: var(--light); 
      font-weight: 600;
    }
    .terms-label a {
      color: var(--light);
      text-decoration: underline;
      font-weight: 700;
    }
    .terms-label a:hover {
      color: #fff;
    }

    /* Enhanced Pay button */
    #payBtn {
      margin-top:20px;
      width:100%;
      padding:16px 14px;
      background: linear-gradient(90deg, var(--primary), var(--sky));
      border: none; border-radius:12px; color:#fff; font-weight:800; font-size:1.1rem;
      box-shadow: 0 8px 26px rgba(47,102,144,0.2);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    #payBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(47,102,144,0.25);
    }
    #payBtn:active:not(:disabled) { 
      transform: translateY(1px); 
    }
    #payBtn:disabled { 
      opacity:0.6; 
      cursor:not-allowed; 
      transform:none; 
      box-shadow: 0 4px 12px rgba(47,102,144,0.1);
    }

    /* Enhanced centered toast */
    #center-toast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: rgba(11,18,32,0.94);
      color: #fff;
      padding: 28px 36px;
      border-radius: 14px;
      box-shadow: 0 12px 36px rgba(2,6,23,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 9999;
      font-weight: 700;
      min-width: 420px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      font-size: 1.05rem;
      backdrop-filter: blur(10px);
    }
    #center-toast.show { opacity:1; transform: translate(-50%,-50%) scale(1); pointer-events:auto; }
    #center-toast .icon { 
      width:40px; height:40px; 
      display:inline-flex; align-items:center; justify-content:center; 
      border-radius:50%; 
      background: var(--success); 
      color:#fff; 
      font-size:18px; 
      flex:0 0 40px;
      box-shadow: 0 4px 12px rgba(40,167,69,0.3);
    }

    @media (max-width:720px){
      .summary-grid { grid-template-columns: 1fr; }
      .fare-box { order:-1; margin-bottom:12px; }
      #center-toast { 
        min-width: calc(100% - 32px); 
        padding:18px 20px; 
        gap:10px; 
        font-size:1rem; 
      }
      .wrap { padding:6px; }
      .details { grid-template-columns: 1fr; }
    }

    .card-heading { 
      font-size:1rem; 
      color: var(--dark); 
      font-weight:800; 
      margin-bottom:8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .muted { color: var(--muted); font-size:0.9rem; }

    /* Trip type indicator */
    .trip-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(90deg, var(--sky), rgba(129,195,215,0.8));
      color: var(--dark);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      box-shadow: 0 3px 8px rgba(2,6,23,0.06);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">

      <header class="app-header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <div class="app-title">Confirm &amp; Pay</div>
      </header>

      <div id="summary" class="summary-card" aria-live="polite">
        Loading booking…
      </div>

      <div style="height:8px;"></div>

      <div class="terms">
        <label class="checkbox" id="termsBox" title="Agree to T&C">
          <input type="checkbox" id="termsChk" />
          <svg id="termsTick" viewBox="0 0 24 24" width="16" height="16" style="display:none;color:white">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"></path>
          </svg>
        </label>
        <div class="terms-label">I agree to the <a href="terms.html">Terms &amp; Conditions</a></div>
      </div>

      <button id="payBtn" disabled>
        <i class="fas fa-lock"></i>
        Pay &amp; Book
      </button>

    </div>
  </div>

  <div id="center-toast" role="status" aria-live="polite">
    <span class="icon">✓</span>
    <span id="center-toast-text">Success</span>
  </div>

  <div style="height: 80px;"></div>

  <!-- Firebase & Razorpay -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    const summaryEl = document.getElementById('summary');
    const payBtn    = document.getElementById('payBtn');
    const termsChk  = document.getElementById('termsChk');
    const termsBox  = document.getElementById('termsBox');
    const tickSvg   = document.getElementById('termsTick');

    const booking   = JSON.parse(localStorage.getItem('selectedBooking') || 'null');

    // Enhanced WebView detection
    function isInWebView() {
      const ua = navigator.userAgent.toLowerCase();
      
      const webviewIndicators = [
        'wv', // Chrome WebView
        'android.*version.*safari', // Android WebView
        'webview',
        'fb_iab', // Facebook in-app browser
        'twitter',
        'instagram',
        'tiktok',
        'linkedin'
      ];
      
      return webviewIndicators.some(indicator => {
        const regex = new RegExp(indicator);
        return regex.test(ua);
      }) || (
        // iOS WebView detection
        window.navigator.standalone === false && 
        /iphone|ipad|ipod/i.test(ua) &&
        !/safari/i.test(ua)
      );
    }

    function isMobileDevice() {
      return /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()) ||
             window.innerWidth <= 768;
    }

    // Process successful payment
    async function processSuccessfulPayment(paymentId, bookingData, userData) {
      // For trip booking, we don't need to update seat availability like before
      // Just create the booking directly
      
      try {
        const bookingsRef = db.ref(`bookings/${bookingData.driverId}`);
        const newBookingRef = bookingsRef.push();
        const finalBookingData = {
          ...bookingData,
          userId: userData.uid,
          userName: userData.name,
          userPhone: userData.phone,
          paymentId: paymentId,
          bookedAt: new Date().toISOString(),
          status: 'confirmed'
        };

        await newBookingRef.set(finalBookingData);

        // Update driver wallet
        await db.ref(`driverWallet/${bookingData.driverId}/${newBookingRef.key}`).set({
          amount: bookingData.fare * 0.6, // 60% to driver
          status: 'unpaid',
          booking: finalBookingData,
          date: new Date().toISOString()
        });

        // If this is a slot booking, we might want to mark it as booked or reduce availability
        // This depends on your business logic - whether one slot can have multiple bookings
        if (bookingData.slotKey) {
          try {
            await db.ref(`availableslots/${bookingData.driverId}/${bookingData.slotKey}/status`).set('booked');
          } catch (err) {
            console.warn('Could not update slot status:', err);
          }
        }

        showCenterToast('Payment successful & booking confirmed!', 2000);
        setTimeout(() => {
          localStorage.removeItem('selectedBooking');
          window.location = 'mybookings.html';
        }, 2100);

      } catch (err) {
        console.error('Error saving booking:', err);
        alert('Error saving booking. Please contact support with payment ID: ' + paymentId);
      }
    }

    // Centered toast helper
    function showCenterToast(message, duration = 2200) {
      const toast = document.getElementById('center-toast');
      const text = document.getElementById('center-toast-text');
      text.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // Sync custom checkbox UI with real input
    function setCheckboxChecked(state) {
      if (state) {
        termsBox.classList.add('checked');
        tickSvg.style.display = 'inline-block';
      } else {
        termsBox.classList.remove('checked');
        tickSvg.style.display = 'none';
      }
      termsChk.checked = !!state;
      payBtn.disabled = !termsChk.checked;
    }
    
    termsBox.addEventListener('click', () => setCheckboxChecked(!termsChk.checked));
    termsChk.addEventListener('change', () => setCheckboxChecked(termsChk.checked));

    // Payment status checker for WebView browser redirect
    function checkPaymentStatus(sessionId) {
      console.log('Starting payment status check for session:', sessionId);
      
      const statusRef = db.ref(`paymentSessions/${sessionId}/status`);
      
      showCenterToast('Payment opened in browser. Complete payment and return to app.', 5000);
      
      // Listen for status changes
      const statusListener = statusRef.on('value', async (snapshot) => {
        const status = snapshot.val();
        console.log('Payment status update:', status);
        
        if (status === 'completed') {
          const sessionData = await db.ref(`paymentSessions/${sessionId}`).once('value');
          const session = sessionData.val();
          
          if (session && session.paymentId) {
            showCenterToast('Payment successful! Processing booking...', 3000);
            
            await processSuccessfulPayment(session.paymentId, session.bookingData, session.userData);
            
            await db.ref(`paymentSessions/${sessionId}`).remove();
            statusRef.off('value', statusListener);
          }
        } else if (status === 'failed') {
          showCenterToast('Payment failed. Please try again.', 3000);
          statusRef.off('value', statusListener);
          
          setTimeout(async () => {
            await db.ref(`paymentSessions/${sessionId}`).remove();
          }, 5000);
        }
      });
      
      // Set a timeout to clean up if no response
      setTimeout(() => {
        statusRef.off('value', statusListener);
        console.log('Payment check timeout for session:', sessionId);
      }, 300000); // 5 minutes timeout
    }

    if (!booking) {
      summaryEl.innerHTML = '<div style="padding:18px;color:#6b7280;font-weight:700">Please select a trip first.</div>';
      payBtn.disabled = true;
    } else {
      let bound = false;

      function renderSummary(userName, userPhone) {
        const pickup = booking.pickup || '—';
        const dropoff = booking.dropoff || '—';
        const date = booking.date || '—';
        const time = booking.time || '—';
        const tripType = booking.tripType || 'oneway';
        const fare = booking.fare || 0;

        const tripTypeDisplay = tripType === 'oneway' ? 'Oneway' : 'Roundtrip';
        const tripIcon = tripType === 'oneway' ? 'fa-arrow-right' : 'fa-exchange-alt';

        summaryEl.innerHTML = `
          <div class="summary-grid" role="region" aria-label="Booking summary">
            <div>
              <div class="card-heading">
                <i class="fas fa-user"></i>
                Passenger Details
              </div>
              <div class="info-row" style="margin-bottom:12px">
                <div class="icon"><i class="fas fa-user"></i></div>
                <div class="meta">
                  <div class="label">${userName || 'Guest'}</div>
                  <div class="val">${userPhone || 'No phone'}</div>
                </div>
              </div>

              <div class="card-heading">
                <i class="fas fa-route"></i>
                Trip Details
              </div>
              <div class="info-row">
                <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="meta">
                  <div class="label">Pickup Location</div>
                  <div class="val">${pickup}</div>
                </div>
              </div>
              <div class="info-row">
                <div class="icon" style="background: linear-gradient(180deg,#ffdede,#fff7f7); color:var(--danger)"><i class="fas fa-map-pin"></i></div>
                <div class="meta">
                  <div class="label">Dropoff Location</div>
                  <div class="val">${dropoff}</div>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="details" aria-hidden="false">
                <div class="detail-pill">
                  <small>Trip Type</small>
                  <strong>
                    <span class="trip-type-badge">
                      <i class="fas ${tripIcon}"></i>
                      ${tripTypeDisplay}
                    </span>
                  </strong>
                </div>
                <div class="detail-pill">
                  <small>Date</small>
                  <strong>${formatDate(date)}</strong>
                </div>
                <div class="detail-pill">
                  <small>Time</small>
                  <strong>${formatTime(time)}</strong>
                </div>
                <div class="detail-pill">
                  <small>Total Fare</small>
                  <strong>₹${fare}</strong>
                </div>
              </div>
            </div>

            <div class="fare-box" aria-hidden="true">
              <div class="label">Amount to Pay</div>
              <div class="amt">₹${fare}</div>
              <div class="trip-type">${tripTypeDisplay} Trip</div>
              <div class="muted" style="margin-top:8px;font-weight:600">Secure Payment</div>
            </div>
          </div>
        `;
      }

      auth.onAuthStateChanged(async user => {
        if (!user) {
          alert('Please login first.');
          window.location = 'index.html';
          return;
        }

        let dbUid = user.uid;
        let userData = null;

        // Get user data
        const snapUid = await db.ref(`users/${dbUid}`).once('value');
        if (snapUid.exists()) {
          userData = snapUid.val();
        } else {
          // Try to find by phone or email if uid lookup fails
          if (user.phoneNumber) {
            const phoneSnap = await db.ref("users")
              .orderByChild("phone")
              .equalTo(user.phoneNumber)
              .once("value");
            if (phoneSnap.exists()) {
              const rec = phoneSnap.val();
              dbUid = Object.keys(rec)[0];
              userData = rec[dbUid];
            }
          }
          if (!userData && user.email) {
            const emailSnap = await db.ref("users")
              .orderByChild("email")
              .equalTo(user.email)
              .once("value");
            if (emailSnap.exists()) {
              const rec = emailSnap.val();
              dbUid = Object.keys(rec)[0];
              userData = rec[dbUid];
            }
          }
        }

        if (!userData) {
          summaryEl.innerHTML = '<div style="padding:18px;color:#6b7280;font-weight:700">Profile not found. Cannot proceed.</div>';
          payBtn.disabled = true;
          return;
        }

        const { name, phone } = userData;
        userData.uid = dbUid;
        renderSummary(name, phone);
        setCheckboxChecked(false);

        if (!bound) {
          bound = true;

          termsChk.addEventListener('change', () => { 
            payBtn.disabled = !termsChk.checked; 
          });

          // Payment handler
          payBtn.addEventListener('click', async () => {
            if (!termsChk.checked) return;

            // Verify slot still exists (basic check)
            if (booking.slotKey) {
              try {
                const slotRef = db.ref(`availableslots/${booking.driverId}/${booking.slotKey}`);
                const snap = await slotRef.once('value');
                if (!snap.exists()) {
                  alert('This trip is no longer available. Please search for another one.');
                  return;
                }
              } catch (e) {
                console.error('Slot verification failed:', e);
                alert('Failed to verify trip availability. Please try again.');
                return;
              }
            }

            // If WebView, redirect to mobile browser for payment
            if (isInWebView()) {
              console.log('WebView detected - redirecting to mobile browser for payment');
              
              const paymentSessionId = `payment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
              
              const paymentData = {
                bookingData: booking,
                userData: userData,
                sessionId: paymentSessionId,
                createdAt: new Date().toISOString(),
                status: 'pending'
              };
              
              try {
                await db.ref(`paymentSessions/${paymentSessionId}`).set(paymentData);
                
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
                const paymentUrl = `${baseUrl}/payment.html?session=${paymentSessionId}`;
                
                console.log('Payment URL created:', paymentUrl);
                
                showCenterToast('Opening payment in browser...', 2000);
                
                setTimeout(() => {
                  let browserOpened = false;
                  
                  // Try multiple methods to open browser
                  try {
                    const newWindow = window.open(paymentUrl, '_blank', 'noopener,noreferrer');
                    if (newWindow && !newWindow.closed) {
                      console.log('Browser opened with window.open(_blank)');
                      browserOpened = true;
                    } else {
                      throw new Error('window.open returned null');
                    }
                  } catch (e) {
                    console.warn('window.open(_blank) failed:', e);
                  }
                  
                  if (!browserOpened) {
                    try {
                      const systemWindow = window.open(paymentUrl, '_system');
                      if (systemWindow) {
                        console.log('Browser opened with window.open(_system)');
                        browserOpened = true;
                      }
                    } catch (e) {
                      console.warn('window.open(_system) failed:', e);
                    }
                  }
                  
                  if (!browserOpened) {
                    try {
                      window.location.href = paymentUrl;
                      console.log('Redirecting with location.href');
                      browserOpened = true;
                    } catch (e) {
                      console.warn('location.href failed:', e);
                    }
                  }
                  
                  if (!browserOpened) {
                    try {
                      const link = document.createElement('a');
                      link.href = paymentUrl;
                      link.target = '_blank';
                      link.rel = 'noopener noreferrer';
                      link.style.display = 'none';
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      console.log('Browser opened with link click');
                      browserOpened = true;
                    } catch (e) {
                      console.warn('Link click method failed:', e);
                    }
                  }
                  
                  if (browserOpened) {
                    checkPaymentStatus(paymentSessionId);
                    setTimeout(() => {
                      showCenterToast('Payment opened in browser. Complete payment and return to app.', 5000);
                    }, 1000);
                  } else {
                    alert('Unable to open payment page. Please try again or use a different browser.');
                  }
                }, 800);
                
              } catch (error) {
                console.error('Failed to create payment session:', error);
                alert('Failed to initialize payment session. Please try again.');
              }
              
              return;
            }

            // For native mobile browser, use direct Razorpay
            console.log('Native browser - using direct Razorpay');
            
            const rzpOptions = {
              key: 'rzp_live_RJxLTulsCPKQqD',
              amount: booking.fare * 100,
              currency: 'INR',
              name: 'WaveTravel',
              description: `${booking.tripType} Trip Booking`,
              prefill: { 
                name: name, 
                contact: phone, 
                email: user.email || ''
              },
              theme: {
                color: '#2f6690'
              },
              handler: function(res) {
                processSuccessfulPayment(res.razorpay_payment_id, booking, userData);
              },
              modal: {
                ondismiss: function() {
                  console.log('Payment cancelled by user');
                }
              }
            };

            try {
              const rzp = new Razorpay(rzpOptions);
              rzp.open();
            } catch (error) {
              console.error('Razorpay initialization failed:', error);
              alert('Payment initialization failed. Please try again.');
            }
          });
        }
      });
    }

    function formatDate(d) {
      if (!d || typeof d !== 'string') return d || '-';
      const [y, m, dd] = d.split('-');
      if (!dd) return d;
      return `${dd}/${m}/${y}`;
    }
    
    function formatTime(t) {
      if (!t || typeof t !== 'string') return t || '-';
      let [h, mm] = t.split(':').map(Number);
      if (isNaN(h)) return t;
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${(mm||0).toString().padStart(2,'0')} ${suffix}`;
    }

    // Force mobile viewport for consistent behavior
    if (isMobileDevice()) {
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport) {
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
      }
    }
  </script>
</body>
</html>
