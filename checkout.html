<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout – WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary: #2f6690;
      --accent: #3a7ca5;
      --light: #d9dcd6;
      --dark: #16425b;
      --sky: #81c3d7;
      --muted: #6da5d0;
      --bg-grad: linear-gradient(to right, var(--accent), var(--dark));
      --card-bg: #ffffff;
      --danger:#ff4d4f;
      --success:#28a745;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg-grad); color: #0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .page { min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:16px; padding-bottom:20px; }
    .wrap { width:100%; max-width:720px; }
    header.app-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .app-title { color: var(--light); font-size:1.1rem; font-weight:700; letter-spacing:0.2px; }
    .back-btn { background:rgba(255,255,255,0.12); border:none; color: var(--light); padding:6px 8px; border-radius:8px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; transition: background 0.2s ease; font-size:0.9rem; }
    .back-btn:hover { background:rgba(255,255,255,0.18); }
    .summary-card { background: var(--card-bg); border-radius:12px; padding:14px; box-shadow: 0 8px 24px rgba(2,6,23,0.06); color: var(--dark); overflow:hidden; border: 1px solid rgba(2,6,23,0.04); }
    .info-row { display:flex; gap:10px; align-items:center; background: rgba(47,102,144,0.04); padding:10px; border-radius:8px; margin-bottom: 6px; transition: all 0.2s ease; }
    .info-row .icon { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, var(--sky), rgba(129,195,215,0.8)); color: var(--dark); font-size:1rem; flex-shrink:0; box-shadow: 0 2px 6px rgba(2,6,23,0.06); }
    .info-row .meta { display:flex; flex-direction:column; flex: 1; min-width: 0; }
    .meta .label { font-weight:700; color: var(--dark); font-size:0.85rem; }
    .meta .val { color: var(--muted); font-size:0.8rem; margin-top:1px; max-width:100%; word-break:break-word; }
    .details { margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .detail-pill { background: rgba(47,102,144,0.04); padding:10px; border-radius:8px; display:flex; flex-direction:column; transition: all 0.2s ease; border: 1px solid rgba(47,102,144,0.08); }
    .detail-pill small { color: var(--muted); font-size:0.75rem; font-weight: 600; }
    .detail-pill strong { font-size:0.88rem; margin-top:4px; color: var(--dark); font-weight: 700; }
    .terms { margin-top:14px; display:flex; gap:10px; align-items:center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; }
    .checkbox { width:20px; height:20px; border-radius:4px; border:2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition: all 0.2s ease; }
    .checkbox input { display:none; }
    .checkbox.checked { background: var(--primary); border-color: var(--primary); color:#fff; box-shadow: 0 3px 10px rgba(47,102,144,0.3); }
    .terms-label { font-size:0.85rem; color: var(--light); font-weight: 600; }
    #payBtn { margin-top:16px; width:100%; padding:14px 12px; background: linear-gradient(90deg, var(--primary), var(--sky)); border: none; border-radius:10px; color:#fff; font-weight:800; font-size:1rem; box-shadow: 0 6px 20px rgba(47,102,144,0.2); transition: all 0.2s ease; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    #payBtn:disabled { opacity:0.6; cursor:not-allowed; transform:none; box-shadow: 0 3px 8px rgba(47,102,144,0.1); }
    #center-toast { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.95); background: rgba(11,18,32,0.94); color: #fff; padding: 20px 28px; border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); opacity: 0; pointer-events: none; transition: opacity .22s ease, transform .22s ease; z-index: 9999; font-weight: 700; min-width: 320px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; font-size: 0.95rem; backdrop-filter: blur(10px); }
    #center-toast.show { opacity:1; transform: translate(-50%,-50%) scale(1); pointer-events:auto; }
    #center-toast .icon { width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; background: var(--success); color:#fff; font-size:14px; flex:0 0 32px; box-shadow: 0 3px 10px rgba(40,167,69,0.3); }
    @media (max-width:720px){ #center-toast { min-width: calc(100% - 24px); padding:14px 16px; gap:8px; font-size:0.9rem; } .wrap { padding:4px; } .details { grid-template-columns: 1fr; } .page { padding:12px; padding-bottom:16px; } }
    .card-heading { font-size:0.9rem; color: var(--dark); font-weight:800; margin-bottom:6px; display: flex; align-items: center; gap: 6px; }
    .trip-type-badge { display: inline-flex; align-items: center; gap: 4px; background: linear-gradient(90deg, var(--sky), rgba(129,195,215,0.8)); color: var(--dark); padding: 4px 8px; border-radius: 16px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 6px rgba(2,6,23,0.06); }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header class="app-header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <div class="app-title">Confirm &amp; Pay</div>
      </header>

      <div id="summary" class="summary-card" aria-live="polite">Loading booking…</div>

      <div class="terms">
        <label class="checkbox" id="termsBox" title="Agree to T&C">
          <input type="checkbox" id="termsChk" />
          <svg id="termsTick" viewBox="0 0 24 24" width="14" height="14" style="display:none;color:white">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"></path>
          </svg>
        </label>
        <div class="terms-label">I agree to the <a href="terms.html">Terms &amp; Conditions</a></div>
      </div>

      <button id="payBtn" disabled>
        <i class="fas fa-lock"></i>
        Pay &amp; Book
      </button>
    </div>
  </div>

  <div id="center-toast" role="status" aria-live="polite">
    <span class="icon">✓</span>
    <span id="center-toast-text">Success</span>
  </div>

  <!-- Firebase & Razorpay -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    const summaryEl = document.getElementById('summary');
    const payBtn    = document.getElementById('payBtn');
    const termsChk  = document.getElementById('termsChk');
    const termsBox  = document.getElementById('termsBox');
    const tickSvg   = document.getElementById('termsTick');

    const booking = JSON.parse(localStorage.getItem('selectedBooking') || 'null');

    function showCenterToast(message, duration = 2200) {
      const toast = document.getElementById('center-toast');
      const text = document.getElementById('center-toast-text');
      text.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function setCheckboxChecked(state) {
      if (state) {
        termsBox.classList.add('checked');
        tickSvg.style.display = 'inline-block';
      } else {
        termsBox.classList.remove('checked');
        tickSvg.style.display = 'none';
      }
      termsChk.checked = !!state;
      payBtn.disabled = !termsChk.checked;
    }
    termsBox.addEventListener('click', () => setCheckboxChecked(!termsChk.checked));
    termsChk.addEventListener('change', () => setCheckboxChecked(termsChk.checked));

    // transaction helper that removes a slot by key (returns {committed, prev})
    function removeSlotByKeyWithTransaction(driverId, key) {
      return new Promise((resolve) => {
        const ref = db.ref(`availableslots/${driverId}/${key}`);
        let prev = null;
        ref.transaction(current => {
          prev = current;
          // if slot missing or already booked, abort transaction by returning undefined (which means no change)
          if (!current) return; // abort - nothing to remove
          if (current.status === 'booked') return; // abort - already booked
          // remove node by returning null
          return null;
        }, (error, committed, snapshot) => {
          if (error) {
            console.error('Transaction error for key', key, error);
            resolve({ committed: false, error });
          } else {
            console.log('Transaction result for key', key, { committed, valAfter: snapshot ? snapshot.val() : null });
            resolve({ committed, prev });
          }
        }, false);
      });
    }

    // transaction helper that searches by slotNumber and attempts to remove one candidate
    async function findAndRemoveSlotByNumber(driverId, slotNumber) {
      if (!driverId) return { committed: false, reason: 'no-driver' };
      const slotsRef = db.ref(`availableslots/${driverId}`);
      const snap = await slotsRef.orderByChild('slotNumber').equalTo(slotNumber).once('value');
      if (!snap.exists()) return { committed: false, reason: 'no-match' };
      const items = snap.val();
      const keys = Object.keys(items);
      for (let k of keys) {
        // attempt transaction on each key until one commits
        const res = await removeSlotByKeyWithTransaction(driverId, k);
        if (res.committed) return { committed: true, key: k, prev: res.prev };
      }
      return { committed: false, reason: 'all-aborted' };
    }

    // Main: after payment success, remove slot via transaction first, then write booking+wallet.
    async function processSuccessfulPayment(paymentId, bookingData, userData) {
      try {
        if (!bookingData || !bookingData.driverId) {
          alert('Booking information incomplete. Contact support with Payment ID: ' + paymentId);
          return;
        }

        const driverId = bookingData.driverId;
        let removedInfo = { committed: false, reason: 'not-attempted' };
        let removedPrev = null;
        let removedKey = null;

        // 1) If slotKey present -> attempt transaction removal on that key
        if (bookingData.slotKey) {
          removedInfo = await removeSlotByKeyWithTransaction(driverId, bookingData.slotKey);
          if (removedInfo.committed) {
            removedPrev = removedInfo.prev;
            removedKey = bookingData.slotKey;
            console.log('Removed slot via provided slotKey:', bookingData.slotKey);
          } else {
            console.warn('Failed to remove slot by provided slotKey:', bookingData.slotKey, removedInfo);
          }
        }

        // 2) If not removed and slotNumber present -> search and try to remove candidate
        if (!removedInfo.committed && bookingData.slotNumber !== undefined && bookingData.slotNumber !== null) {
          const found = await findAndRemoveSlotByNumber(driverId, bookingData.slotNumber);
          if (found.committed) {
            removedInfo = found;
            removedPrev = found.prev;
            removedKey = found.key;
            console.log('Removed slot by slotNumber. key:', found.key);
          } else {
            console.warn('Could not remove by slotNumber:', bookingData.slotNumber, found);
          }
        }

        // 3) If still not removed and bookingData.slotKey existed earlier, we will not proceed - notify user
        if (!removedInfo.committed) {
          // If the user provided a slotKey/slotNumber but we couldn't remove it, stop and inform user.
          // This prevents booking being created while slot still available to others.
          alert('Unable to secure this slot — it may already be booked. Please try another slot.');
          payBtn.disabled = false;
          return;
        }

        // 4) Write booking + driverWallet now that slot removal succeeded
        const bookingsRef = db.ref(`bookings/${driverId}`);
        const newBookingRef = bookingsRef.push();
        const bookingKey = newBookingRef.key;

        const finalBookingData = {
          ...bookingData,
          userId: userData.uid,
          userName: userData.name,
          userPhone: userData.phone,
          paymentId: paymentId,
          bookedAt: new Date().toISOString(),
          status: 'confirmed'
        };

        const walletEntry = {
          amount: (bookingData.fare || 0) * 0.6,
          status: 'unpaid',
          bookingId: bookingKey,
          booking: finalBookingData,
          date: new Date().toISOString()
        };

        const updates = {};
        updates[`bookings/${driverId}/${bookingKey}`] = finalBookingData;
        updates[`driverWallet/${driverId}/${bookingKey}`] = walletEntry;

        // attempt to write booking + wallet
        try {
          await db.ref().update(updates);
          console.log('Booking + wallet saved. bookingKey:', bookingKey);
          showCenterToast('Payment successful & booking confirmed!', 2000);
          setTimeout(() => {
            localStorage.removeItem('selectedBooking');
            window.location = 'mybookings.html';
          }, 2100);
        } catch (err) {
          console.error('Failed to save booking after removing slot. Attempting to restore slot. Error:', err);
          // Try to restore the slot node using removedPrev (if we have it)
          try {
            if (removedKey && removedPrev !== null && removedPrev !== undefined) {
              await db.ref(`availableslots/${driverId}/${removedKey}`).set(removedPrev);
              console.warn('Restored availableslot[' + removedKey + '] after failed booking write.');
            } else {
              console.warn('No previous slot data available to restore.');
            }
          } catch (restoreErr) {
            console.error('Failed to restore slot after booking write failure:', restoreErr);
          }
          alert('Booking failed after payment. We attempted to restore the slot. Contact support with Payment ID: ' + paymentId);
          payBtn.disabled = false;
        }

      } catch (err) {
        console.error('processSuccessfulPayment fatal error:', err);
        alert('An unexpected error occurred. Contact support with Payment ID: ' + paymentId);
        payBtn.disabled = false;
      }
    }

    // render summary + auth flow (same UX)
    if (!booking) {
      summaryEl.innerHTML = '<div style="padding:16px;color:#6b7280;font-weight:700">Please select a trip first.</div>';
      payBtn.disabled = true;
    } else {
      let bound = false;

      function renderSummary(userName, userPhone) {
        const pickup = booking.pickup || '—';
        const dropoff = booking.dropoff || '—';
        const date = booking.date || '—';
        const time = booking.time || '—';
        const tripType = booking.tripType || 'oneway';
        const fare = booking.fare || 0;
        const tripTypeDisplay = tripType === 'oneway' ? 'Oneway' : 'Roundtrip';
        const tripIcon = tripType === 'oneway' ? 'fa-arrow-right' : 'fa-exchange-alt';

        summaryEl.innerHTML = `
          <div role="region" aria-label="Booking summary">
            <div class="card-heading"><i class="fas fa-user"></i> Passenger Details</div>
            <div class="info-row" style="margin-bottom:10px">
              <div class="icon"><i class="fas fa-user"></i></div>
              <div class="meta"><div class="label">${userName || 'Guest'}</div><div class="val">${userPhone || 'No phone'}</div></div>
            </div>
            <div class="card-heading"><i class="fas fa-route"></i> Trip Details</div>
            <div class="info-row"><div class="icon"><i class="fas fa-map-marker-alt"></i></div><div class="meta"><div class="label">Pickup Location</div><div class="val">${pickup}</div></div></div>
            <div class="info-row"><div class="icon" style="background: linear-gradient(180deg,#ffdede,#fff7f7); color:var(--danger)"><i class="fas fa-map-pin"></i></div><div class="meta"><div class="label">Dropoff Location</div><div class="val">${dropoff}</div></div></div>
            <div class="details" aria-hidden="false">
              <div class="detail-pill"><small>Trip Type</small><strong><span class="trip-type-badge"><i class="fas ${tripIcon}"></i> ${tripTypeDisplay}</span></strong></div>
              <div class="detail-pill"><small>Date</small><strong>${formatDate(date)}</strong></div>
              <div class="detail-pill"><small>Time</small><strong>${formatTime(time)}</strong></div>
              <div class="detail-pill"><small>Total Fare</small><strong>₹${fare}</strong></div>
            </div>
          </div>
        `;
      }

      auth.onAuthStateChanged(async user => {
        if (!user) {
          alert('Please login first.');
          window.location = 'index.html';
          return;
        }

        let dbUid = user.uid;
        let userData = null;

        try {
          const snapUid = await db.ref(`users/${dbUid}`).once('value');
          if (snapUid.exists()) {
            userData = snapUid.val();
          } else {
            if (user.phoneNumber) {
              const phoneSnap = await db.ref("users").orderByChild("phone").equalTo(user.phoneNumber).once("value");
              if (phoneSnap.exists()) {
                const rec = phoneSnap.val();
                dbUid = Object.keys(rec)[0];
                userData = rec[dbUid];
              }
            }
            if (!userData && user.email) {
              const emailSnap = await db.ref("users").orderByChild("email").equalTo(user.email).once("value");
              if (emailSnap.exists()) {
                const rec = emailSnap.val();
                dbUid = Object.keys(rec)[0];
                userData = rec[dbUid];
              }
            }
          }
        } catch (err) {
          console.error('Error fetching user profile:', err);
        }

        if (!userData) {
          summaryEl.innerHTML = '<div style="padding:16px;color:#6b7280;font-weight:700">Profile not found. Cannot proceed.</div>';
          payBtn.disabled = true;
          return;
        }

        const { name, phone } = userData;
        userData.uid = dbUid;
        renderSummary(name, phone);
        setCheckboxChecked(false);

        if (!bound) {
          bound = true;
          termsChk.addEventListener('change', () => { payBtn.disabled = !termsChk.checked; });

          payBtn.addEventListener('click', async () => {
            if (!termsChk.checked) return;
            payBtn.disabled = true;

            // availability quick check before opening payment
            try {
              if (booking.slotKey) {
                const slotRef = db.ref(`availableslots/${booking.driverId}/${booking.slotKey}`);
                const snap = await slotRef.once('value');
                if (!snap.exists()) {
                  alert('This trip is no longer available. Please search for another one.');
                  payBtn.disabled = false;
                  return;
                }
                if (snap.val() && snap.val().status === 'booked') {
                  alert('This trip has already been booked. Please search for another one.');
                  payBtn.disabled = false;
                  return;
                }
              } else if (booking.slotNumber !== undefined && booking.slotNumber !== null) {
                const snap = await db.ref(`availableslots/${booking.driverId}`).orderByChild('slotNumber').equalTo(booking.slotNumber).once('value');
                if (!snap.exists()) {
                  alert('This trip is no longer available. Please search for another one.');
                  payBtn.disabled = false;
                  return;
                }
              }
            } catch (e) {
              console.error('Slot verification failed:', e);
              alert('Failed to verify trip availability. Please try again.');
              payBtn.disabled = false;
              return;
            }

            // Razorpay flow
            const rzpOptions = {
              key: 'rzp_live_RJxLTulsCPKQqD',
              amount: (booking.fare || 0) * 100,
              currency: 'INR',
              name: 'WaveTravel',
              description: `${booking.tripType} Trip Booking`,
              prefill: { name: name, contact: phone, email: user.email || '' },
              theme: { color: '#2f6690' },
              handler: function(res) {
                // On success -> remove slot via transaction(s) then create booking
                processSuccessfulPayment(res.razorpay_payment_id, booking, userData)
                  .catch(err => {
                    console.error('Processing payment callback failed:', err);
                    alert('There was an error processing your booking after payment. Contact support with Payment ID: ' + res.razorpay_payment_id);
                  });
              },
              modal: {
                ondismiss: function() {
                  console.log('Payment cancelled by user');
                  payBtn.disabled = false;
                }
              }
            };

            try {
              const rzp = new Razorpay(rzpOptions);
              rzp.open();
            } catch (error) {
              console.error('Razorpay initialization failed:', error);
              alert('Payment initialization failed. Please try again.');
              payBtn.disabled = false;
            }
          });
        }
      });
    }

    function formatDate(d) {
      if (!d || typeof d !== 'string') return d || '-';
      const [y, m, dd] = d.split('-');
      if (!dd) return d;
      return `${dd}/${m}/${y}`;
    }
    function formatTime(t) {
      if (!t || typeof t !== 'string') return t || '-';
      let [h, mm] = t.split(':').map(Number);
      if (isNaN(h)) return t;
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${(mm||0).toString().padStart(2,'0')} ${suffix}`;
    }
  </script>
</body>
</html>
