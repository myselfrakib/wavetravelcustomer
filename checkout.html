<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout – WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary:#0077ff;
      --accent:#ffd700;
      --bg-grad: linear-gradient(to right,#16425b, #81c3d7);
      --card-bg: #ffffff;
      --muted:#6b7280;
      --danger:#ff4d4f;
      --success:#28a745;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg-grad); color: #0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .page {
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:18px;
      padding-bottom:80px;
    }
    .wrap {
      width:100%;
      max-width:720px;
    }

    header.app-header {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    .app-title {
      color:#fff;
      font-size:1.25rem;
      font-weight:700;
      letter-spacing:0.2px;
    }
    .back-btn {
      background:rgba(255,255,255,0.12);
      border:none; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }

    .summary-card {
      background: var(--card-bg);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 6px 22px rgba(11,18,32,0.12);
      color:var(--dark, #0b1220);
      overflow:hidden;
    }
    .summary-grid {
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px 16px;
      align-items:center;
    }

    /* nice info rows */
    .info-row {
      display:flex; gap:12px; align-items:center;
      background: rgba(11,18,32,0.02);
      padding:10px; border-radius:10px;
    }
    .info-row .icon {
      width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(0,119,255,0.12), rgba(0,119,255,0.06));
      color:var(--primary); font-size:1.15rem;
      flex-shrink:0;
    }
    .info-row .meta {
      display:flex; flex-direction:column;
    }
    .meta .label { font-weight:700; color:#071124; font-size:0.95rem; }
    .meta .val { color:var(--muted); font-size:0.9rem; margin-top:2px; max-width:100%; word-break:break-word; }

    .summary-grid .fare-box {
      background: linear-gradient(180deg,#fdf6e6,#fff6d9);
      border-radius:10px;
      padding:12px 16px;
      text-align:center;
      min-width:140px;
      align-self:center;
      box-shadow: 0 4px 14px rgba(2,6,23,0.06);
    }
    .fare-box .label { color:#8a6b00; font-weight:700; font-size:0.9rem; }
    .fare-box .amt { font-size:1.25rem; font-weight:800; color:#402a00; margin-top:6px; }

    .details {
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .detail-pill {
      background: rgba(11,18,32,0.03);
      padding:8px; border-radius:10px;
      display:flex; flex-direction:column;
    }
    .detail-pill small { color:var(--muted); font-size:0.82rem; }
    .detail-pill strong { font-size:0.98rem; margin-top:6px; color:#071124; }

    /* terms */
    .terms {
      margin-top:14px; display:flex; gap:10px; align-items:center;
    }
    .checkbox {
      width:22px; height:22px; border-radius:6px; border:2px solid rgba(7,17,36,0.08);
      background:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .checkbox input { display:none; }
    .checkbox.checked { background:var(--primary); border-color:var(--primary); color:#fff; }

    .terms-label { font-size:0.95rem; color:#fff; text-shadow: 0 1px 0 rgba(11,18,32,0.12); }

    /* Pay button */
    #payBtn {
      margin-top:16px;
      width:100%;
      padding:12px 14px;
      background: linear-gradient(90deg,var(--primary), #005dc1);
      border: none; border-radius:10px; color:#fff; font-weight:800; font-size:1.05rem;
      box-shadow: 0 8px 26px rgba(2,6,23,0.12);
      transition: transform .14s ease, opacity .12s ease;
    }
    #payBtn:active { transform: translateY(1px) scale(.998); }
    #payBtn:disabled { opacity:0.6; cursor:not-allowed; transform:none; box-shadow:none; }

    /* Centered toast — doubled size */
    #center-toast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: rgba(11,18,32,0.94);
      color: #fff;
      padding: 28px 36px;
      border-radius: 14px;
      box-shadow: 0 12px 36px rgba(2,6,23,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 9999;
      font-weight: 700;
      min-width: 420px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      font-size: 1.05rem;
    }
    #center-toast.show { opacity:1; transform: translate(-50%,-50%) scale(1); pointer-events:auto; }
    #center-toast .icon { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; background:var(--success); color:#fff; font-size:18px; flex:0 0 40px; }

    @media (max-width:720px){
      .summary-grid { grid-template-columns: 1fr; }
      .fare-box { order:-1; margin-bottom:8px; }
      #center-toast { min-width: calc(100% - 32px); padding:18px 20px; gap:10px; font-size:1rem; }
      .wrap { padding:6px; }
    }

    .card-heading { font-size:0.95rem; color:#071124; font-weight:800; margin-bottom:6px; }
    .muted { color:var(--muted); font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">

      <header class="app-header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <div class="app-title">Confirm &amp; Pay</div>
      </header>

      <div id="summary" class="summary-card" aria-live="polite">
        Loading booking…
      </div>

      <div style="height:8px;"></div>

      <div class="terms" style="align-items:center;">
        <label class="checkbox" id="termsBox" title="Agree to T&C">
          <input type="checkbox" id="termsChk" />
          <svg id="termsTick" viewBox="0 0 24 24" width="16" height="16" style="display:none;color:white">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"></path>
          </svg>
        </label>
        <div class="terms-label">I agree to the <a href="terms.html" style="color:#fff; text-decoration:underline;">Terms &amp; Conditions</a></div>
      </div>

      <!-- PAY BUTTON placed right after terms -->
      <button id="payBtn" disabled>Pay &amp; Book</button>

    </div>
  </div>

  <div id="center-toast" role="status" aria-live="polite">
    <span class="icon">✓</span>
    <span id="center-toast-text">Success</span>
  </div>

  <div style="height: 80px;"></div>

  <!-- Firebase & Razorpay -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    const summaryEl = document.getElementById('summary');
    const payBtn    = document.getElementById('payBtn');
    const termsChk  = document.getElementById('termsChk');
    const termsBox  = document.getElementById('termsBox');
    const tickSvg   = document.getElementById('termsTick');

    const booking   = JSON.parse(localStorage.getItem('selectedBooking') || 'null');

    // Enhanced WebView detection
    function isInWebView() {
      const ua = navigator.userAgent.toLowerCase();
      
      // Check for specific WebView indicators
      const webviewIndicators = [
        'wv', // Chrome WebView
        'android.*version.*safari', // Android WebView
        'webview',
        'fb_iab', // Facebook in-app browser
        'twitter',
        'instagram',
        'tiktok',
        'linkedin'
      ];
      
      return webviewIndicators.some(indicator => {
        const regex = new RegExp(indicator);
        return regex.test(ua);
      }) || (
        // iOS WebView detection
        window.navigator.standalone === false && 
        /iphone|ipad|ipod/i.test(ua) &&
        !/safari/i.test(ua)
      );
    }

    function isMobileDevice() {
      return /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()) ||
             window.innerWidth <= 768;
    }

    // CRITICAL: Override navigator properties BEFORE Razorpay loads
    function forceNativeAppMode() {
      console.log('Forcing native app mode for Razorpay...');
      
      // Store original values
      const originalUserAgent = navigator.userAgent;
      
      // Create a convincing mobile browser user agent (not WebView)
      const mobileUA = 'Mozilla/5.0 (Linux; Android 12; SM-G998B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36';
      
      // Override user agent to remove WebView indicators
      try {
        Object.defineProperty(navigator, 'userAgent', {
          get: function() { return mobileUA; },
          configurable: true
        });
        console.log('User agent overridden:', navigator.userAgent);
      } catch (e) {
        console.warn('Could not override userAgent:', e);
      }

      // Override platform
      try {
        Object.defineProperty(navigator, 'platform', {
          get: function() { return 'Linux armv8l'; },
          configurable: true
        });
      } catch (e) {
        console.warn('Could not override platform:', e);
      }

      // Force mobile screen properties
      try {
        Object.defineProperty(screen, 'width', {
          get: function() { return 393; },
          configurable: true
        });
        
        Object.defineProperty(screen, 'height', {
          get: function() { return 851; },
          configurable: true
        });
      } catch (e) {
        console.warn('Could not override screen properties:', e);
      }

      // Add device pixel ratio if missing
      if (!window.devicePixelRatio || window.devicePixelRatio === 1) {
        try {
          Object.defineProperty(window, 'devicePixelRatio', {
            get: function() { return 3; },
            configurable: true
          });
        } catch (e) {
          console.warn('Could not set devicePixelRatio:', e);
        }
      }

      // Add orientation support
      if (typeof window.orientation === 'undefined') {
        try {
          Object.defineProperty(window, 'orientation', {
            get: function() { return 0; },
            configurable: true
          });
        } catch (e) {
          console.warn('Could not set orientation:', e);
        }
      }

      // Override document.documentElement.webkitRequestFullScreen to simulate native
      if (!document.documentElement.webkitRequestFullScreen) {
        document.documentElement.webkitRequestFullScreen = function() {};
      }

      // Remove WebView specific properties
      try {
        delete window.navigator.standalone;
      } catch (e) {
        console.warn('Could not delete standalone property:', e);
      }

      console.log('Native app mode configuration complete');
    }

    // Process successful payment
    async function processSuccessfulPayment(paymentId, bookingData, userData) {
      const slotRef = db.ref(`availableslots/${bookingData.driverId}/${bookingData.slotKey}`);
      
      slotRef.transaction(cur => {
        if (!cur) return cur;
        const currentSeats = parseInt(cur.seats, 10);
        const requested = parseInt(bookingData.seatsRequested, 10);
        if (isNaN(currentSeats) || isNaN(requested)) return cur;
        if (currentSeats < requested) return;
        const newSeats = currentSeats - requested;
        return { ...cur, seats: String(newSeats) };
      }, async (error, committed) => {
        if (error) {
          console.error('Seat deduction failed:', error);
          alert('Seat deduction failed. Please contact support.');
          return;
        }
        if (!committed) {
          alert('Seats just ran out. Payment captured; please contact support for refund/alternate slot.');
          return;
        }

        try {
          const bookingsRef = db.ref(`bookings/${bookingData.driverId}`);
          const newBookingRef = bookingsRef.push();
          const finalBookingData = {
            ...bookingData,
            userId: userData.uid,
            userName: userData.name,
            userPhone: userData.phone,
            paymentId: paymentId,
            bookedAt: new Date().toISOString(),
            status: 'confirmed'
          };

          await newBookingRef.set(finalBookingData);

          await db.ref(`driverWallet/${bookingData.driverId}/${newBookingRef.key}`).set({
            amount: bookingData.fare * 0.6,
            status: 'unpaid',
            booking: finalBookingData,
            date: new Date().toISOString()
          });

          showCenterToast('Payment successful & booking confirmed!', 2000);
          setTimeout(() => {
            localStorage.removeItem('selectedBooking');
            window.location = 'mybookings.html';
          }, 2100);

        } catch (err) {
          console.error(err);
          alert('Error saving booking. Contact support.');
        }
      });
    }

    // centered toast helper
    function showCenterToast(message, duration = 2200) {
      const toast = document.getElementById('center-toast');
      const text = document.getElementById('center-toast-text');
      text.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // sync custom checkbox UI with real input
    function setCheckboxChecked(state) {
      if (state) {
        termsBox.classList.add('checked');
        tickSvg.style.display = 'inline-block';
      } else {
        termsBox.classList.remove('checked');
        tickSvg.style.display = 'none';
      }
      termsChk.checked = !!state;
      payBtn.disabled = !termsChk.checked;
    }
    
    termsBox.addEventListener('click', () => setCheckboxChecked(!termsChk.checked));
    termsChk.addEventListener('change', () => setCheckboxChecked(termsChk.checked));

    // Payment status checker for WebView browser redirect
    function checkPaymentStatus(sessionId) {
      console.log('Starting payment status check for session:', sessionId);
      
      const statusRef = db.ref(`paymentSessions/${sessionId}/status`);
      
      showCenterToast('Payment opened in browser. Complete payment and return to app.', 5000);
      
      // Listen for status changes
      const statusListener = statusRef.on('value', async (snapshot) => {
        const status = snapshot.val();
        console.log('Payment status update:', status);
        
        if (status === 'completed') {
          // Get the full payment session data
          const sessionData = await db.ref(`paymentSessions/${sessionId}`).once('value');
          const session = sessionData.val();
          
          if (session && session.paymentId) {
            showCenterToast('Payment successful! Processing booking...', 3000);
            
            // Process the successful payment
            await processSuccessfulPayment(session.paymentId, session.bookingData, session.userData);
            
            // Clean up the session
            await db.ref(`paymentSessions/${sessionId}`).remove();
            
            // Remove listener
            statusRef.off('value', statusListener);
          }
        } else if (status === 'failed') {
          showCenterToast('Payment failed. Please try again.', 3000);
          statusRef.off('value', statusListener);
          
          // Clean up failed session after delay
          setTimeout(async () => {
            await db.ref(`paymentSessions/${sessionId}`).remove();
          }, 5000);
        }
      });
      
      // Set a timeout to clean up if no response
      setTimeout(() => {
        statusRef.off('value', statusListener);
        console.log('Payment check timeout for session:', sessionId);
      }, 300000); // 5 minutes timeout
    }

    if (!booking) {
      summaryEl.innerHTML = '<div style="padding:18px;color:#6b7280;font-weight:700">Please select a slot first.</div>';
      payBtn.disabled = true;
    } else {
      let bound = false;

      function renderSummary(userName, userPhone) {
        const pickup = booking.pickup || '—';
        const dropoff = booking.dropoff || '—';
        const date = booking.date || '—';
        const time = booking.time || '—';
        const seats = booking.seatsRequested || 1;
        const fare = booking.fare || 0;
        summaryEl.innerHTML = `
          <div class="summary-grid" role="region" aria-label="Booking summary">
            <div>
              <div class="card-heading">Passenger</div>
              <div class="info-row" style="margin-bottom:10px">
                <div class="icon"><i class="fas fa-user"></i></div>
                <div class="meta">
                  <div class="label">${userName || 'Guest'}</div>
                  <div class="val">${userPhone || 'No phone'}</div>
                </div>
              </div>

              <div class="card-heading">Route</div>
              <div class="info-row">
                <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="meta">
                  <div class="label">Pickup</div>
                  <div class="val">${pickup}</div>
                </div>
              </div>
              <div style="height:8px"></div>
              <div class="info-row">
                <div class="icon" style="background: linear-gradient(180deg,#ffdede,#fff7f7); color:var(--danger)"><i class="fas fa-map-pin"></i></div>
                <div class="meta">
                  <div class="label">Dropoff</div>
                  <div class="val">${dropoff}</div>
                </div>
              </div>

              <div style="height:12px"></div>

              <div class="details" aria-hidden="false">
                <div class="detail-pill">
                  <small>Date</small>
                  <strong>${formatDate(date)}</strong>
                </div>
                <div class="detail-pill">
                  <small>Time</small>
                  <strong>${formatTime(time)}</strong>
                </div>
                <div class="detail-pill">
                  <small>Seats</small>
                  <strong>${seats}</strong>
                </div>
                <div class="detail-pill">
                  <small>Fare</small>
                  <strong>₹${fare}</strong>
                </div>
              </div>
            </div>

            <div class="fare-box" aria-hidden="true">
              <div class="label">Amount to pay</div>
              <div class="amt">₹${fare}</div>
              <div class="muted" style="margin-top:6px;font-weight:600">Secure payment</div>
            </div>
          </div>
        `;
      }

      auth.onAuthStateChanged(async user => {
        if (!user) {
          alert('Please login first.');
          window.location = 'index.html';
          return;
        }

        let dbUid = user.uid;
        let userData = null;

        const snapUid = await db.ref(`users/${dbUid}`).once('value');
        if (snapUid.exists()) {
          userData = snapUid.val();
        } else {
          if (user.phoneNumber) {
            const phoneSnap = await db.ref("users")
              .orderByChild("phone")
              .equalTo(user.phoneNumber)
              .once("value");
            if (phoneSnap.exists()) {
              const rec = phoneSnap.val();
              dbUid = Object.keys(rec)[0];
              userData = rec[dbUid];
            }
          }
          if (!userData && user.email) {
            const emailSnap = await db.ref("users")
              .orderByChild("email")
              .equalTo(user.email)
              .once("value");
            if (emailSnap.exists()) {
              const rec = emailSnap.val();
              dbUid = Object.keys(rec)[0];
              userData = rec[dbUid];
            }
          }
        }

        if (!userData) {
          summaryEl.innerHTML = '<div style="padding:18px;color:#6b7280;font-weight:700">Profile not found. Cannot proceed.</div>';
          payBtn.disabled = true;
          return;
        }

        const { name, phone } = userData;
        userData.uid = dbUid;
        renderSummary(name, phone);
        setCheckboxChecked(false);

        if (!bound) {
          bound = true;

          termsChk.addEventListener('change', () => { 
            payBtn.disabled = !termsChk.checked; 
          });

          // Smart payment handler - WebView opens in browser, native stays in app
          payBtn.addEventListener('click', async () => {
            if (!termsChk.checked) return;

            const slotRef = db.ref(`availableslots/${booking.driverId}/${booking.slotKey}`);

            try {
              const snap = await slotRef.once('value');
              if (!snap.exists()) {
                alert('Slot no longer exists.');
                return;
              }
              const cur = snap.val();
              const available = parseInt(cur.seats, 10);
              const requested = parseInt(booking.seatsRequested, 10);
              if (isNaN(available) || isNaN(requested)) {
                alert('Seat information invalid. Contact support.');
                return;
              }
              if (available < requested) {
                alert(`Only ${available} seats left. Please reduce seats or choose another slot.`);
                return;
              }
            } catch (e) {
              console.error('Pre-check failed:', e);
              alert('Failed to verify seats. Please try again.');
              return;
            }

            // If WebView, redirect to mobile browser for payment
            if (isInWebView()) {
              console.log('WebView detected - redirecting to mobile browser for payment');
              
              // Create a unique payment session ID
              const paymentSessionId = `payment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
              
              // Store payment data in Firebase for the browser session
              const paymentData = {
                bookingData: booking,
                userData: userData,
                sessionId: paymentSessionId,
                createdAt: new Date().toISOString(),
                status: 'pending'
              };
              
              try {
                await db.ref(`paymentSessions/${paymentSessionId}`).set(paymentData);
                
                // Create the payment URL for mobile browser
                const currentUrl = window.location.href;
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
                const paymentUrl = `${baseUrl}/payment.html?session=${paymentSessionId}`;
                
                console.log('Payment URL created:', paymentUrl);
                
                // Show user instruction
                showCenterToast('Opening payment in browser...', 2000);
                
                // Multiple fallback methods to open browser
                setTimeout(() => {
                  let browserOpened = false;
                  
                  // Method 1: Try window.open with different targets
                  try {
                    const newWindow = window.open(paymentUrl, '_blank', 'noopener,noreferrer');
                    if (newWindow && !newWindow.closed) {
                      console.log('Browser opened with window.open(_blank)');
                      browserOpened = true;
                    } else {
                      throw new Error('window.open returned null');
                    }
                  } catch (e) {
                    console.warn('window.open(_blank) failed:', e);
                  }
                  
                  // Method 2: Try with _system target (for some WebViews)
                  if (!browserOpened) {
                    try {
                      const systemWindow = window.open(paymentUrl, '_system');
                      if (systemWindow) {
                        console.log('Browser opened with window.open(_system)');
                        browserOpened = true;
                      }
                    } catch (e) {
                      console.warn('window.open(_system) failed:', e);
                    }
                  }
                  
                  // Method 3: Try direct location assignment
                  if (!browserOpened) {
                    try {
                      window.location.href = paymentUrl;
                      console.log('Redirecting with location.href');
                      browserOpened = true;
                    } catch (e) {
                      console.warn('location.href failed:', e);
                    }
                  }
                  
                  // Method 4: Create invisible link and click
                  if (!browserOpened) {
                    try {
                      const link = document.createElement('a');
                      link.href = paymentUrl;
                      link.target = '_blank';
                      link.rel = 'noopener noreferrer';
                      link.style.display = 'none';
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      console.log('Browser opened with link click');
                      browserOpened = true;
                    } catch (e) {
                      console.warn('Link click method failed:', e);
                    }
                  }
                  
                  if (browserOpened) {
                    // Start checking for payment completion
                    checkPaymentStatus(paymentSessionId);
                    
                    // Show success message
                    setTimeout(() => {
                      showCenterToast('Payment opened in browser. Complete payment and return to app.', 5000);
                    }, 1000);
                  } else {
                    // All methods failed - show manual option
                    showManualPaymentOption(paymentUrl, paymentSessionId);
                  }
                }, 800);
                
              } catch (error) {
                console.error('Failed to create payment session:', error);
                alert('Failed to initialize payment session. Please try again.');
              }
              
              return;
            }

            // For native mobile browser, use direct Razorpay
            console.log('Native browser - using direct Razorpay');
            
            const rzpOptions = {
              key: 'rzp_live_RJxLTulsCPKQqD',
              amount: booking.fare * 100,
              currency: 'INR',
              name: 'WaveTravel',
              description: 'Ride Booking',
              prefill: { 
                name: name, 
                contact: phone, 
                email: user.email || ''
              },
              theme: {
                color: '#0077ff'
              },
              handler: function(res) {
                processSuccessfulPayment(res.razorpay_payment_id, booking, userData);
              },
              modal: {
                ondismiss: function() {
                  console.log('Payment cancelled by user');
                }
              }
            };

            try {
              const rzp = new Razorpay(rzpOptions);
              rzp.open();
            } catch (error) {
              console.error('Razorpay initialization failed:', error);
              alert('Payment initialization failed. Please try again.');
            }
          });
        }
      });
    }

    function formatDate(d) {
      if (!d || typeof d !== 'string') return d || '-';
      const [y, m, dd] = d.split('-');
      if (!dd) return d;
      return `${dd}/${m}/${y}`;
    }
    
    function formatTime(t) {
      if (!t || typeof t !== 'string') return t || '-';
      let [h, mm] = t.split(':').map(Number);
      if (isNaN(h)) return t;
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${(mm||0).toString().padStart(2,'0')} ${suffix}`;
    }

    // Force mobile viewport for consistent behavior
    if (isMobileDevice()) {
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport) {
        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
      }
    }
  </script>
</body>
</html>
