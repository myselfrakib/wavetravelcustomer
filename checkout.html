<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout – WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary: #2f6690;
      --accent: #3a7ca5;
      --light: #d9dcd6;
      --dark: #16425b;
      --sky: #81c3d7;
      --muted: #6da5d0;
      --bg-grad: linear-gradient(to right, var(--accent), var(--dark));
      --card-bg: #ffffff;
      --danger:#ff4d4f;
      --success:#28a745;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg-grad); color: #0b1220; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .page {
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px;
      padding-bottom:20px;
    }
    .wrap {
      width:100%;
      max-width:720px;
    }

    header.app-header {
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .app-title {
      color: var(--light);
      font-size:1.1rem;
      font-weight:700;
      letter-spacing:0.2px;
    }
    .back-btn {
      background:rgba(255,255,255,0.12);
      border:none; color: var(--light); padding:6px 8px; border-radius:8px; cursor:pointer;
      display:inline-flex; align-items:center; gap:6px;
      transition: background 0.2s ease;
      font-size:0.9rem;
    }
    .back-btn:hover {
      background:rgba(255,255,255,0.18);
    }

    .summary-card {
      background: var(--card-bg);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 8px 24px rgba(2,6,23,0.06);
      color: var(--dark);
      overflow:hidden;
      border: 1px solid rgba(2,6,23,0.04);
    }

    /* Enhanced info rows */
    .info-row {
      display:flex; gap:10px; align-items:center;
      background: rgba(47,102,144,0.04);
      padding:10px; border-radius:8px;
      margin-bottom: 6px;
      transition: all 0.2s ease;
    }
    .info-row:hover {
      background: rgba(47,102,144,0.06);
    }
    .info-row .icon {
      width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, var(--sky), rgba(129,195,215,0.8));
      color: var(--dark); font-size:1rem;
      flex-shrink:0;
      box-shadow: 0 2px 6px rgba(2,6,23,0.06);
    }
    .info-row .meta {
      display:flex; flex-direction:column;
      flex: 1;
      min-width: 0;
    }
    .meta .label { font-weight:700; color: var(--dark); font-size:0.85rem; }
    .meta .val { color: var(--muted); font-size:0.8rem; margin-top:1px; max-width:100%; word-break:break-word; }

    .details {
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .detail-pill {
      background: rgba(47,102,144,0.04);
      padding:10px; border-radius:8px;
      display:flex; flex-direction:column;
      transition: all 0.2s ease;
      border: 1px solid rgba(47,102,144,0.08);
    }
    .detail-pill:hover {
      background: rgba(47,102,144,0.06);
    }
    .detail-pill small { color: var(--muted); font-size:0.75rem; font-weight: 600; }
    .detail-pill strong { font-size:0.88rem; margin-top:4px; color: var(--dark); font-weight: 700; }

    /* Enhanced terms section */
    .terms {
      margin-top:14px; display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
    }
    .checkbox {
      width:20px; height:20px; border-radius:4px; border:2px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1); display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      transition: all 0.2s ease;
    }
    .checkbox:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.4);
    }
    .checkbox input { display:none; }
    .checkbox.checked { 
      background: var(--primary); 
      border-color: var(--primary); 
      color:#fff; 
      box-shadow: 0 3px 10px rgba(47,102,144,0.3);
    }

    .terms-label { 
      font-size:0.85rem; 
      color: var(--light); 
      font-weight: 600;
    }
    .terms-label a {
      color: var(--light);
      text-decoration: underline;
      font-weight: 700;
    }
    .terms-label a:hover {
      color: #fff;
    }

    /* Enhanced Pay button */
    #payBtn {
      margin-top:16px;
      width:100%;
      padding:14px 12px;
      background: linear-gradient(90deg, var(--primary), var(--sky));
      border: none; border-radius:10px; color:#fff; font-weight:800; font-size:1rem;
      box-shadow: 0 6px 20px rgba(47,102,144,0.2);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    #payBtn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(47,102,144,0.25);
    }
    #payBtn:active:not(:disabled) { 
      transform: translateY(1px); 
    }
    #payBtn:disabled { 
      opacity:0.6; 
      cursor:not-allowed; 
      transform:none; 
      box-shadow: 0 3px 8px rgba(47,102,144,0.1);
    }

    /* Enhanced centered toast */
    #center-toast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: rgba(11,18,32,0.94);
      color: #fff;
      padding: 20px 28px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease, transform .22s ease;
      z-index: 9999;
      font-weight: 700;
      min-width: 320px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 0.95rem;
      backdrop-filter: blur(10px);
    }
    #center-toast.show { opacity:1; transform: translate(-50%,-50%) scale(1); pointer-events:auto; }
    #center-toast .icon { 
      width:32px; height:32px; 
      display:inline-flex; align-items:center; justify-content:center; 
      border-radius:50%; 
      background: var(--success); 
      color:#fff; 
      font-size:14px; 
      flex:0 0 32px;
      box-shadow: 0 3px 10px rgba(40,167,69,0.3);
    }

    @media (max-width:720px){
      #center-toast { 
        min-width: calc(100% - 24px); 
        padding:14px 16px; 
        gap:8px; 
        font-size:0.9rem; 
      }
      .wrap { padding:4px; }
      .details { grid-template-columns: 1fr; }
      .page { padding:12px; padding-bottom:16px; }
      .app-title { font-size:1rem; }
      .back-btn { padding:5px 7px; font-size:0.85rem; }
      .summary-card { padding:12px; }
      .info-row { padding:8px; gap:8px; margin-bottom:5px; }
      .info-row .icon { width:32px; height:32px; font-size:0.9rem; }
      .meta .label { font-size:0.8rem; }
      .meta .val { font-size:0.75rem; }
      .detail-pill { padding:8px; }
      .detail-pill small { font-size:0.7rem; }
      .detail-pill strong { font-size:0.82rem; margin-top:3px; }
      .terms { margin-top:12px; padding:8px; }
      .terms-label { font-size:0.8rem; }
      #payBtn { margin-top:12px; padding:12px 10px; font-size:0.95rem; }
    }

    .card-heading { 
      font-size:0.9rem; 
      color: var(--dark); 
      font-weight:800; 
      margin-bottom:6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .muted { color: var(--muted); font-size:0.8rem; }

    /* Trip type indicator */
    .trip-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: linear-gradient(90deg, var(--sky), rgba(129,195,215,0.8));
      color: var(--dark);
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 0.75rem;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(2,6,23,0.06);
    }

    @media (max-width:480px) {
      .card-heading { font-size:0.85rem; margin-bottom:5px; }
      .trip-type-badge { font-size:0.7rem; padding:3px 6px; }
    }

    /* WebView fallback modal styles */
    #wv-fallback-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.45);
      z-index: 99998;
    }
    #wv-fallback-card {
      background: #fff; padding: 18px; border-radius: 10px; width: 94%; max-width:520px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25); font-family: 'Poppins', system-ui, sans-serif;
      color: #111;
    }
    #wv-fallback-card h3 { margin:0 0 8px; font-size:16px; color:var(--dark); }
    #wv-fallback-card p { margin:0 0 12px; color:#444; font-size:14px; }
    .wv-copy { width:100%; padding:8px; margin-bottom:8px; border-radius:6px; border:1px solid #e5e7eb; font-size:13px; }
    .wv-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn.primary { background:var(--primary); color:white; }
    .btn.ghost { background:#f3f4f6; color:#111; }
    .wv-qr { display:block; margin:8px auto 0; max-width:180px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">

      <header class="app-header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <div class="app-title">Confirm &amp; Pay</div>
      </header>

      <div id="summary" class="summary-card" aria-live="polite">
        Loading booking…
      </div>

      <div class="terms">
        <label class="checkbox" id="termsBox" title="Agree to T&C">
          <input type="checkbox" id="termsChk" />
          <svg id="termsTick" viewBox="0 0 24 24" width="14" height="14" style="display:none;color:white">
            <path fill="currentColor" d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"></path>
          </svg>
        </label>
        <div class="terms-label">I agree to the <a href="terms.html">Terms &amp; Conditions</a></div>
      </div>

      <button id="payBtn" disabled>
        <i class="fas fa-lock"></i>
        Pay &amp; Book
      </button>

    </div>
  </div>

  <div id="center-toast" role="status" aria-live="polite">
    <span class="icon">✓</span>
    <span id="center-toast-text">Success</span>
  </div>

  <!-- WebView fallback modal -->
  <div id="wv-fallback-modal" aria-hidden="true">
    <div id="wv-fallback-card" role="dialog" aria-modal="true" aria-labelledby="wv-title">
      <h3 id="wv-title">Payments inside some apps may be limited</h3>
      <p>If you prefer UPI, try opening the payment in your phone's UPI app or open this page in your system browser. Otherwise continue with web checkout (cards/netbanking).</p>

      <input id="wv-upi-text" class="wv-copy" readonly aria-label="UPI payment string" />
      <img id="wv-qr" class="wv-qr" src="" alt="UPI QR code" style="display:none" />

      <div class="wv-actions">
        <button id="wv-try-intent-btn" class="btn primary">Try UPI app</button>
        <button id="wv-open-browser-btn" class="btn ghost">Open in Browser</button>
        <button id="wv-continue-web-btn" class="btn ghost">Continue with Web Checkout</button>
        <button id="wv-copy-btn" class="btn ghost">Copy UPI</button>
      </div>
    </div>
  </div>

  <!-- Firebase & Razorpay -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.database();
    const auth = firebase.auth();

    const summaryEl = document.getElementById('summary');
    const payBtn    = document.getElementById('payBtn');
    const termsChk  = document.getElementById('termsChk');
    const termsBox  = document.getElementById('termsBox');
    const tickSvg   = document.getElementById('termsTick');

    const wvModal = document.getElementById('wv-fallback-modal');
    const wvUpiInput = document.getElementById('wv-upi-text');
    const wvQr = document.getElementById('wv-qr');
    const wvTryIntentBtn = document.getElementById('wv-try-intent-btn');
    const wvOpenBrowserBtn = document.getElementById('wv-open-browser-btn');
    const wvContinueWebBtn = document.getElementById('wv-continue-web-btn');
    const wvCopyBtn = document.getElementById('wv-copy-btn');

    const booking   = JSON.parse(localStorage.getItem('selectedBooking') || 'null');

    // Process successful payment (atomic update to remove slot)
    async function processSuccessfulPayment(paymentId, bookingData, userData) {
      try {
        const bookingsRef = db.ref(`bookings/${bookingData.driverId}`);
        const newBookingRef = bookingsRef.push();
        const bookingKey = newBookingRef.key;

        const finalBookingData = {
          ...bookingData,
          userId: userData.uid,
          userName: userData.name,
          userPhone: userData.phone,
          paymentId: paymentId,
          bookedAt: new Date().toISOString(),
          status: 'confirmed'
        };

        const walletEntry = {
          amount: (bookingData.fare || 0) * 0.6,
          status: 'unpaid',
          bookingId: bookingKey,
          booking: finalBookingData,
          date: new Date().toISOString()
        };

        const updates = {};
        updates[`bookings/${bookingData.driverId}/${bookingKey}`] = finalBookingData;
        updates[`driverWallet/${bookingData.driverId}/${bookingKey}`] = walletEntry;
        if (bookingData.slotKey) {
          updates[`availableslots/${bookingData.driverId}/${bookingData.slotKey}`] = null;
        }

        await db.ref().update(updates);

        showCenterToast('Payment successful & booking confirmed!', 2000);
        setTimeout(() => {
          localStorage.removeItem('selectedBooking');
          window.location = 'mybookings.html';
        }, 2100);

      } catch (err) {
        console.error('Error saving booking:', err);
        alert('Error saving booking. Please contact support with payment ID: ' + paymentId);
      }
    }

    // Center toast helper
    function showCenterToast(message, duration = 2200) {
      const toast = document.getElementById('center-toast');
      const text = document.getElementById('center-toast-text');
      text.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // Checkbox UI sync
    function setCheckboxChecked(state) {
      if (state) {
        termsBox.classList.add('checked');
        tickSvg.style.display = 'inline-block';
      } else {
        termsBox.classList.remove('checked');
        tickSvg.style.display = 'none';
      }
      termsChk.checked = !!state;
      payBtn.disabled = !termsChk.checked;
    }
    termsBox.addEventListener('click', () => setCheckboxChecked(!termsChk.checked));
    termsChk.addEventListener('change', () => setCheckboxChecked(termsChk.checked));

    // Detect third-party WebView heuristics
    function isInWebView() {
      const ua = navigator.userAgent || '';
      return /wv|Android.*WebView|FBAN|FBAV|Instagram|Twitter|Line|WhatsApp/i.test(ua) || !!window.ReactNativeWebView;
    }

    // Modal controls
    function showWvModal() { wvModal.style.display = 'flex'; wvModal.setAttribute('aria-hidden', 'false'); }
    function hideWvModal() { wvModal.style.display = 'none'; wvModal.setAttribute('aria-hidden', 'true'); }

    // Attempt to open UPI intent or fallback to modal
    function tryOpenIntentThenFallback({ upiUri, intentUri, fallbackExternalUrl }) {
      wvUpiInput.value = upiUri;
      // generate a simple QR using Google Chart API
      try {
        const qrURL = 'https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=' + encodeURIComponent(upiUri);
        wvQr.src = qrURL;
        wvQr.style.display = 'block';
      } catch (e) {
        wvQr.style.display = 'none';
      }

      // copy handler
      wvCopyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(upiUri);
          alert('UPI text copied. Open your UPI app and paste to pay.');
        } catch (err) {
          wvUpiInput.select();
          document.execCommand('copy');
          alert('Copied. Open your UPI app and paste the text.');
        }
      };

      // Open in system browser
      wvOpenBrowserBtn.onclick = () => {
        const openUrl = fallbackExternalUrl || location.href;
        try { window.open(openUrl, '_blank', 'noopener'); } catch(e) { location.href = openUrl; }
        hideWvModal();
      };

      // Try intent
      wvTryIntentBtn.onclick = () => {
        attemptOpen();
        hideWvModal();
      };

      // Continue with web checkout (close modal and trigger RZP)
      wvContinueWebBtn.onclick = () => {
        hideWvModal();
        // dispatch a custom event so the flow continues (RZP flow is bound to payBtn click)
        payBtn.dispatchEvent(new CustomEvent('continue-web-checkout'));
      };

      function attemptOpen() {
        const start = Date.now();

        if (intentUri && /Android/i.test(navigator.userAgent)) {
          // try intent scheme first on Android
          try { window.location.href = intentUri; }
          catch (e) {}
        } else {
          // fallback older iframe method (some webviews allow)
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = upiUri;
          document.body.appendChild(iframe);
          setTimeout(() => {
            try { document.body.removeChild(iframe); } catch (e) {}
          }, 1000);
        }

        setTimeout(() => {
          if (document.hidden || document.visibilityState === 'hidden') {
            return; // likely succeeded
          }
          // assume blocked; show modal to let user copy/open in browser
          showWvModal();
        }, 1200);
      }

      // initially try direct attempt once before showing the modal
      attemptOpen();
    }

    // Build UPI URI (best-effort; placeholder VPA used if none provided)
    function buildUpiUri({pa, pn, am, tn, cu = 'INR'}) {
      // pa (payee vpa) should be provided by merchant. If not, show an informational placeholder.
      const params = new URLSearchParams();
      if (pa) params.set('pa', pa);
      if (pn) params.set('pn', pn);
      if (am) params.set('am', Number(am).toFixed(2));
      if (tn) params.set('tn', tn);
      params.set('cu', cu);
      return 'upi://pay?' + params.toString();
    }

    // Start Razorpay checkout (extracted into function to reuse)
    function startRazorpayCheckout(name, phone, email, bookingObj, userData) {
      const rzpOptions = {
        key: 'rzp_live_RJxLTulsCPKQqD',
        amount: (bookingObj.fare || 0) * 100,
        currency: 'INR',
        name: 'WaveTravel',
        description: `${bookingObj.tripType} Trip Booking`,
        prefill: { 
          name: name, 
          contact: phone, 
          email: email || ''
        },
        theme: {
          color: '#2f6690'
        },
        handler: function(res) {
          processSuccessfulPayment(res.razorpay_payment_id, bookingObj, userData);
        },
        modal: {
          ondismiss: function() {
            console.log('Payment cancelled by user');
            payBtn.disabled = false;
          }
        }
      };

      try {
        const rzp = new Razorpay(rzpOptions);
        rzp.open();
      } catch (error) {
        console.error('Razorpay initialization failed:', error);
        alert('Payment initialization failed. Please try again.');
        payBtn.disabled = false;
      }
    }

    if (!booking) {
      summaryEl.innerHTML = '<div style="padding:16px;color:#6b7280;font-weight:700">Please select a trip first.</div>';
      payBtn.disabled = true;
    } else {
      let bound = false;

      function renderSummary(userName, userPhone) {
        const pickup = booking.pickup || '—';
        const dropoff = booking.dropoff || '—';
        const date = booking.date || '—';
        const time = booking.time || '—';
        const tripType = booking.tripType || 'oneway';
        const fare = booking.fare || 0;

        const tripTypeDisplay = tripType === 'oneway' ? 'Oneway' : 'Roundtrip';
        const tripIcon = tripType === 'oneway' ? 'fa-arrow-right' : 'fa-exchange-alt';

        summaryEl.innerHTML = `
          <div role="region" aria-label="Booking summary">
            <div class="card-heading">
              <i class="fas fa-user"></i>
              Passenger Details
            </div>
            <div class="info-row" style="margin-bottom:10px">
              <div class="icon"><i class="fas fa-user"></i></div>
              <div class="meta">
                <div class="label">${userName || 'Guest'}</div>
                <div class="val">${userPhone || 'No phone'}</div>
              </div>
            </div>

            <div class="card-heading">
              <i class="fas fa-route"></i>
              Trip Details
            </div>
            <div class="info-row">
              <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
              <div class="meta">
                <div class="label">Pickup Location</div>
                <div class="val">${pickup}</div>
              </div>
            </div>
            <div class="info-row">
              <div class="icon" style="background: linear-gradient(180deg,#ffdede,#fff7f7); color:var(--danger)"><i class="fas fa-map-pin"></i></div>
              <div class="meta">
                <div class="label">Dropoff Location</div>
                <div class="val">${dropoff}</div>
              </div>
            </div>

            <div class="details" aria-hidden="false">
              <div class="detail-pill">
                <small>Trip Type</small>
                <strong>
                  <span class="trip-type-badge">
                    <i class="fas ${tripIcon}"></i>
                    ${tripTypeDisplay}
                  </span>
                </strong>
              </div>
              <div class="detail-pill">
                <small>Date</small>
                <strong>${formatDate(date)}</strong>
              </div>
              <div class="detail-pill">
                <small>Time</small>
                <strong>${formatTime(time)}</strong>
              </div>
              <div class="detail-pill">
                <small>Total Fare</small>
                <strong>₹${fare}</strong>
              </div>
            </div>
          </div>
        `;
      }

      auth.onAuthStateChanged(async user => {
        if (!user) {
          alert('Please login first.');
          window.location = 'index.html';
          return;
        }

        let dbUid = user.uid;
        let userData = null;

        // Get user data
        const snapUid = await db.ref(`users/${dbUid}`).once('value');
        if (snapUid.exists()) {
          userData = snapUid.val();
        } else {
          // Try to find by phone or email if uid lookup fails
          if (user.phoneNumber) {
            const phoneSnap = await db.ref("users")
              .orderByChild("phone")
              .equalTo(user.phoneNumber)
              .once("value");
            if (phoneSnap.exists()) {
              const rec = phoneSnap.val();
              dbUid = Object.keys(rec)[0];
              userData = rec[dbUid];
            }
          }
          if (!userData && user.email) {
            const emailSnap = await db.ref("users")
              .orderByChild("email")
              .equalTo(user.email)
              .once("value");
            if (emailSnap.exists()) {
              const rec = emailSnap.val();
              dbUid = Object.keys(rec)[0];
              userData = rec[dbUid];
            }
          }
        }

        if (!userData) {
          summaryEl.innerHTML = '<div style="padding:16px;color:#6b7280;font-weight:700">Profile not found. Cannot proceed.</div>';
          payBtn.disabled = true;
          return;
        }

        const { name, phone } = userData;
        userData.uid = dbUid;
        renderSummary(name, phone);
        setCheckboxChecked(false);

        if (!bound) {
          bound = true;

          termsChk.addEventListener('change', () => { 
            payBtn.disabled = !termsChk.checked; 
          });

          // Main click handler decides between webview fallback or normal checkout
          payBtn.addEventListener('click', async () => {
            if (!termsChk.checked) return;
            // Prevent double-clicks
            payBtn.disabled = true;

            // Verify slot still exists (basic check)
            if (booking.slotKey) {
              try {
                const slotRef = db.ref(`availableslots/${booking.driverId}/${booking.slotKey}`);
                const snap = await slotRef.once('value');
                if (!snap.exists()) {
                  alert('This trip is no longer available. Please search for another one.');
                  payBtn.disabled = false;
                  return;
                }
                const slotData = snap.val();
                if (slotData && slotData.status === 'booked') {
                  alert('This trip has already been booked. Please search for another one.');
                  payBtn.disabled = false;
                  return;
                }
              } catch (e) {
                console.error('Slot verification failed:', e);
                alert('Failed to verify trip availability. Please try again.');
                payBtn.disabled = false;
                return;
              }
            }

            // If inside a third-party WebView, show the WebView-friendly modal with options
            if (isInWebView()) {
              // Build a best-effort UPI URI for users to copy / attempt. 
              // NOTE: merchant VPA should be replaced with your actual VPA. Using a placeholder if not known.
              const merchantVpa = booking.merchantVpa || booking.vpa || 'merchant@upi';
              const upiNote = `WaveTravel trip ${booking.pickup || ''} → ${booking.dropoff || ''}`;
              const upiUri = buildUpiUri({
                pa: merchantVpa,
                pn: 'WaveTravel',
                am: booking.fare,
                tn: upiNote
              });
              // Intent wrapper (prefers Google Pay package; adjust as needed)
              const intentUri = `intent:${upiUri.replace(/^upi:\/\//,'') }#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`;

              // Configure fallback URL (open same page in browser)
              const fallbackExternalUrl = location.href;

              // Populate modal fields now and show it
              wvUpiInput.value = upiUri;
              try {
                wvQr.src = 'https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=' + encodeURIComponent(upiUri);
                wvQr.style.display = 'block';
              } catch (e) { wvQr.style.display = 'none'; }

              // set handlers to attempt intent/open browser/continue web
              wvCopyBtn.onclick = async () => {
                try {
                  await navigator.clipboard.writeText(upiUri);
                  alert('UPI text copied. Open your UPI app and paste to pay.');
                } catch (err) {
                  wvUpiInput.select();
                  document.execCommand('copy');
                  alert('Copied. Open your UPI app and paste the text.');
                }
              };
              wvOpenBrowserBtn.onclick = () => {
                try { window.open(fallbackExternalUrl, '_blank', 'noopener'); } catch(e) { location.href = fallbackExternalUrl; }
                hideWvModal();
                // re-enable pay button so user can come back
                payBtn.disabled = false;
              };
              wvTryIntentBtn.onclick = () => {
                // attempt to open via intent/iframe
                const start = Date.now();
                if (intentUri && /Android/i.test(navigator.userAgent)) {
                  try { window.location.href = intentUri; }
                  catch(e) {}
                } else {
                  const iframe = document.createElement('iframe');
                  iframe.style.display = 'none';
                  iframe.src = upiUri;
                  document.body.appendChild(iframe);
                  setTimeout(() => {
                    try { document.body.removeChild(iframe); } catch (e) {}
                  }, 1000);
                }
                hideWvModal();
                // allow some time; re-enable pay button
                setTimeout(() => { payBtn.disabled = false; }, 1400);
              };
              wvContinueWebBtn.onclick = () => {
                hideWvModal();
                // Continue with web checkout (trigger the RZP flow below)
                startRazorpayCheckout(name, phone, user.email || '', booking, userData);
              };

              // Show the modal to the user (also try a quick attempt and fall back to modal)
              // First attempt a quick 'intent' opening; if nothing happens, modal will remain visible via fallback logic.
              const quickAttempt = () => {
                const start = Date.now();
                if (intentUri && /Android/i.test(navigator.userAgent)) {
                  try { window.location.href = intentUri; }
                  catch (e) {}
                } else {
                  const iframe = document.createElement('iframe');
                  iframe.style.display = 'none';
                  iframe.src = upiUri;
                  document.body.appendChild(iframe);
                  setTimeout(() => { try { document.body.removeChild(iframe); } catch(e) {} }, 1000);
                }
                // If after 1.2s the page is still visible, show the modal
                setTimeout(() => {
                  if (document.hidden || document.visibilityState === 'hidden') {
                    // likely succeeded; re-enable pay button not necessary
                    return;
                  }
                  showWvModal();
                  payBtn.disabled = false; // let user choose
                }, 1200);
              };

              quickAttempt();
              return; // exit click handler (modal will allow continuing)
            }

            // Not in a WebView — proceed with Razorpay web checkout
            startRazorpayCheckout(name, phone, user.email || '', booking, userData);
          });

          // Also listen for custom event when modal's "Continue with Web Checkout" dispatches
          payBtn.addEventListener('continue-web-checkout', () => {
            // when this event is fired we should start RZP checkout.
            startRazorpayCheckout(userData.name || '', userData.phone || '', user.email || '', booking, userData);
          });
        }
      });
    }

    function formatDate(d) {
      if (!d || typeof d !== 'string') return d || '-';
      const [y, m, dd] = d.split('-');
      if (!dd) return d;
      return `${dd}/${m}/${y}`;
    }
    
    function formatTime(t) {
      if (!t || typeof t !== 'string') return t || '-';
      let [h, mm] = t.split(':').map(Number);
      if (isNaN(h)) return t;
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${(mm||0).toString().padStart(2,'0')} ${suffix}`;
    }
  </script>
</body>
</html>
