<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Login â€” WaveTravel</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(to right, #6a11cb, #2575fc);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}
.container {
  background: #fff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 12px 25px rgba(0,0,0,0.2);
  width: 350px;
  text-align: center;
}
h2 { margin-bottom: 25px; color: #333; }
input {
  width: 100%;
  padding: 12px 15px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
  outline: none;
  transition: border-color 0.3s;
}
input:focus { border-color: #2575fc; }
button {
  width: 100%;
  padding: 12px;
  background: #2575fc;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.3s;
  margin-top: 10px;
}
button:hover { background: #1a5ed1; }
button:disabled { background: #999; cursor: not-allowed; }
#otp-section { display: none; margin-top: 15px; }
.otp-inputs { display: flex; justify-content: space-between; }
.otp-inputs input {
  width: 40px;
  padding: 10px;
  font-size: 18px;
  text-align: center;
  border-radius: 8px;
  border: 1px solid #ccc;
}
#resendOtpBtn { margin-top: 10px; display: block; }
#toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: #28a745;
  color: #fff;
  padding: 12px 25px;
  border-radius: 6px;
  display: none;
  font-weight: 500;
}
.spinner {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #fff;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  animation: spin 1s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-left: 10px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.signup-link { margin-top: 15px; font-size: 14px; }
.signup-link a { color: #2575fc; text-decoration: none; }
.signup-link a:hover { text-decoration: underline; }
</style>
</head>
<body>

<div class="container">
  <h2>Driver Login</h2>

  <div id="phone-section">
    <input type="text" id="phoneNumber" placeholder="Enter mobile number" />
    <div id="recaptcha-container"></div>
    <button id="sendOtpBtn" onclick="sendOTP()">Send OTP</button>
  </div>

  <div id="otp-section">
    <div class="otp-inputs">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
      <input type="text" maxlength="1" class="otp-box">
    </div>
    <button id="verifyBtn">Verify OTP</button>
    <button id="resendOtpBtn" onclick="resendOTP()" disabled>Resend OTP (60s)</button>
  </div>

  <div class="signup-link">
    Don't have an account? <a href="driversignup.html">Sign up</a>
  </div>
</div>

<div id="toast"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
  authDomain: "wavetravel-3c4c4.firebaseapp.com",
  databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
  projectId: "wavetravel-3c4c4",
  storageBucket: "wavetravel-3c4c4.appspot.com",
  messagingSenderId: "298226098137",
  appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
let confirmationResultGlobal = null;

// Invisible reCAPTCHA
window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });

function showToast(msg){
  const toast = document.getElementById('toast');
  toast.innerText = msg;
  toast.style.display = 'block';
  setTimeout(()=>{ toast.style.display='none'; }, 3000);
}

function formatPhoneNumber(number){
  number = number.trim();
  if(number.startsWith('+91')) return number;
  if(/^\d{10}$/.test(number)) return '+91'+number;
  return number;
}

// OTP auto-focus
const otpInputs = document.querySelectorAll('.otp-box');
otpInputs.forEach((input,index)=>{
  input.addEventListener('input', ()=>{ if(input.value.length===1 && index<otpInputs.length-1) otpInputs[index+1].focus(); });
  input.addEventListener('keydown', e=>{ if(e.key==='Backspace' && input.value==='' && index>0) otpInputs[index-1].focus(); });
});

// Send OTP
async function sendOTP(){
  const phoneInput = document.getElementById('phoneNumber').value;
  const phone = formatPhoneNumber(phoneInput);
  const sendBtn = document.getElementById('sendOtpBtn');

  sendBtn.disabled = true;
  sendBtn.innerHTML = 'Sending OTP <span class="spinner"></span>';

  try{
    const confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
    confirmationResultGlobal = confirmationResult;
    showToast('OTP sent successfully!');
    document.getElementById('phone-section').style.display = 'none';
    document.getElementById('otp-section').style.display = 'block';
    startResendCountdown();
  } catch(err){
    showToast(err.message);
    sendBtn.disabled = false;
    sendBtn.innerText = 'Send OTP';
  }
}

// Resend OTP
async function resendOTP(){
  const phoneInput = document.getElementById('phoneNumber').value;
  const phone = formatPhoneNumber(phoneInput);

  try{
    const confirmationResult = await auth.signInWithPhoneNumber(phone, window.recaptchaVerifier);
    confirmationResultGlobal = confirmationResult;
    showToast('OTP resent successfully!');
    otpInputs.forEach(i=>i.value='');
    otpInputs[0].focus();
    startResendCountdown();
  } catch(err){
    showToast(err.message);
  }
}

// Verify OTP
document.getElementById('verifyBtn').addEventListener('click', async ()=>{
  const otp = Array.from(otpInputs).map(i=>i.value).join('');
  if(otp.length!==6){ showToast('Enter 6-digit OTP'); return; }

  try{
    const result = await confirmationResultGlobal.confirm(otp);
    const user = result.user;

    // Check driverdetails
    const snapshot = await database.ref('driverdetails').orderByChild('phone').equalTo(user.phoneNumber).once('value');
    if(snapshot.exists()){
      const driverId = Object.keys(snapshot.val())[0];
      showToast('Login successful!');
      setTimeout(()=>{ window.location.href='driverdashboard.html?driverId='+driverId; }, 1000);
    } else showToast('No driver record found. Please sign up.');
  } catch(err){
    showToast('Invalid OTP: '+err.message);
  }
});

// Resend OTP countdown
function startResendCountdown(){
  const btn = document.getElementById('resendOtpBtn');
  let time = 60;
  btn.disabled = true;
  btn.textContent = `Resend OTP (${time}s)`;
  const interval = setInterval(()=>{
    time--;
    btn.textContent = `Resend OTP (${time}s)`;
    if(time<=0){ clearInterval(interval); btn.disabled=false; btn.textContent='Resend OTP'; }
  },1000);
}
</script>
</body>
</html>
