<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Driver Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      width: 92%;
      max-width: 400px;
      background: #fff;
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #222;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    button:hover:enabled {
      background: #0056b3;
    }
    .link {
      text-align: center;
      margin-top: 16px;
      font-size: 14px;
    }
    .link a {
      color: #007bff;
      text-decoration: none;
    }
    #recaptcha-container {
      margin-top: 10px;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      font-size: 14px;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Driver Login</h2>

  <input type="tel" id="phoneNumber" placeholder="Enter Mobile Number">
  <div id="recaptcha-container"></div>
  <button id="sendOtpBtn">Send OTP</button>

  <input type="text" id="otp" placeholder="Enter OTP" style="display:none;">
  <button id="verifyOtpBtn" style="display:none;">Verify OTP</button>
  <button id="resendOtpBtn" style="display:none;" disabled>Resend OTP (30s)</button>

  <div class="link">
    New driver? <a href="driversignup.html">Signup with us</a>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
    authDomain: "wavetravel-3c4c4.firebaseapp.com",
    databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
    projectId: "wavetravel-3c4c4",
    storageBucket: "wavetravel-3c4c4.appspot.com",
    messagingSenderId: "298226098137",
    appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const phoneInput = document.getElementById("phoneNumber");
  const sendOtpBtn = document.getElementById("sendOtpBtn");
  const otpInput = document.getElementById("otp");
  const verifyOtpBtn = document.getElementById("verifyOtpBtn");
  const resendOtpBtn = document.getElementById("resendOtpBtn");
  const toast = document.getElementById("toast");

  let confirmationResultGlobal = null;
  let resendTimer;

  // Recaptcha
  const recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });

  // Show Toast
  function showToast(msg) {
    toast.textContent = msg;
    toast.className = "toast show";
    setTimeout(() => toast.className = "toast", 3000);
  }

  // Start cooldown
  function startCooldown() {
    let seconds = 30;
    resendOtpBtn.disabled = true;
    resendOtpBtn.textContent = `Resend OTP (${seconds}s)`;
    resendOtpBtn.style.display = "block";

    resendTimer = setInterval(() => {
      seconds--;
      if (seconds > 0) {
        resendOtpBtn.textContent = `Resend OTP (${seconds}s)`;
      } else {
        clearInterval(resendTimer);
        resendOtpBtn.textContent = "Resend OTP";
        resendOtpBtn.disabled = false;
      }
    }, 1000);
  }

  // Send OTP
  sendOtpBtn.addEventListener("click", async () => {
    const phoneNumber = "+91" + phoneInput.value.trim();
    if (!phoneInput.value.trim()) return showToast("Enter mobile number");

    try {
      // check if number exists in driverdetails
      const snapshot = await get(child(ref(db), "driverdetails"));
      let driverFound = null;
      snapshot.forEach(childSnap => {
        if (childSnap.val().phone === phoneNumber) driverFound = childSnap.key;
      });

      if (!driverFound) {
        showToast("Number not registered. Please signup.");
        return;
      }

      const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
      confirmationResultGlobal = confirmationResult;

      otpInput.style.display = "block";
      verifyOtpBtn.style.display = "block";
      startCooldown();

      showToast("OTP sent!");
    } catch (err) {
      console.error(err);
      showToast("Error: " + err.message);
    }
  });

  // Resend OTP
  resendOtpBtn.addEventListener("click", async () => {
    sendOtpBtn.click();
  });

  // Verify OTP
  verifyOtpBtn.addEventListener("click", async () => {
    const otp = otpInput.value.trim();
    if (!otp) return showToast("Enter OTP");

    try {
      const result = await confirmationResultGlobal.confirm(otp);
      const user = result.user;

      // Get driverId from DB
      const snapshot = await get(child(ref(db), "driverdetails"));
      let driverId = null;
      snapshot.forEach(childSnap => {
        if (childSnap.val().phone === "+91" + phoneInput.value.trim()) driverId = childSnap.key;
      });

      if (driverId) {
        showToast("Login successful!");
        setTimeout(() => {
          window.location.href = "driverdashboard.html?driverId=" + driverId;
        }, 1500);
      } else {
        showToast("No driver linked to this number.");
      }
    } catch (err) {
      console.error(err);
      showToast("Invalid OTP");
    }
  });
</script>

</body>
</html>
