<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment - WaveTravel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --primary:#0077ff;
      --accent:#ffd700;
      --bg-grad: linear-gradient(to right,#16425b, #81c3d7);
      --card-bg: #ffffff;
      --muted:#6b7280;
      --danger:#ff4d4f;
      --success:#28a745;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:'Poppins',sans-serif; background:var(--bg-grad); color: #0b1220; }
    .page {
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:20px;
      justify-content:center;
    }
    .payment-card {
      background: var(--card-bg);
      border-radius:16px;
      padding:24px;
      box-shadow: 0 8px 32px rgba(11,18,32,0.15);
      max-width:400px;
      width:100%;
      text-align:center;
    }
    .icon-large {
      width:80px;
      height:80px;
      margin:0 auto 20px;
      background: linear-gradient(180deg, var(--primary), #005dc1);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:2rem;
    }
    .title {
      font-size:1.4rem;
      font-weight:700;
      color:#071124;
      margin-bottom:12px;
    }
    .amount {
      font-size:2rem;
      font-weight:800;
      color:var(--primary);
      margin-bottom:20px;
    }
    .description {
      color:var(--muted);
      margin-bottom:24px;
      line-height:1.5;
    }
    .pay-btn {
      width:100%;
      padding:14px;
      background: linear-gradient(90deg,var(--primary), #005dc1);
      border: none;
      border-radius:12px;
      color:#fff;
      font-weight:700;
      font-size:1.1rem;
      cursor:pointer;
      margin-bottom:16px;
      transition: transform .2s ease;
    }
    .pay-btn:hover { transform: translateY(-1px); }
    .pay-btn:active { transform: translateY(0); }
    .cancel-btn {
      width:100%;
      padding:12px;
      background: transparent;
      border: 2px solid var(--muted);
      border-radius:12px;
      color:var(--muted);
      font-weight:600;
      cursor:pointer;
    }
    .loading {
      display:none;
      text-align:center;
      color:var(--muted);
    }
    .spinner {
      width:40px;
      height:40px;
      border:3px solid #f3f3f3;
      border-top:3px solid var(--primary);
      border-radius:50%;
      animation: spin 1s linear infinite;
      margin:0 auto 16px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: #ffe6e6;
      color: var(--danger);
      padding:16px;
      border-radius:10px;
      margin-bottom:16px;
      display:none;
    }
    .success {
      background: #e8f5e8;
      color: var(--success);
      padding:16px;
      border-radius:10px;
      margin-bottom:16px;
      display:none;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="payment-card">
      <div class="icon-large">
        <i class="fas fa-credit-card"></i>
      </div>
      
      <div class="title">Complete Payment</div>
      <div class="amount" id="amount">Loading...</div>
      <div class="description" id="description">Please complete your payment to confirm the booking.</div>
      
      <div class="error" id="error"></div>
      <div class="success" id="success"></div>
      
      <div id="payment-section">
        <button class="pay-btn" id="payBtn">
          <i class="fas fa-mobile-alt"></i> Pay with UPI
        </button>
        <button class="cancel-btn" id="cancelBtn">Cancel Payment</button>
      </div>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Processing payment...</div>
      </div>
    </div>
  </div>

  <!-- Firebase & Razorpay -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Get session ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');

    const amountEl = document.getElementById('amount');
    const descriptionEl = document.getElementById('description');
    const payBtn = document.getElementById('payBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const loadingEl = document.getElementById('loading');
    const paymentSection = document.getElementById('payment-section');
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');

    let paymentData = null;

    function showError(message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      successEl.style.display = 'none';
    }

    function showSuccess(message) {
      successEl.textContent = message;
      successEl.style.display = 'block';
      errorEl.style.display = 'none';
    }

    function showLoading(show = true) {
      loadingEl.style.display = show ? 'block' : 'none';
      paymentSection.style.display = show ? 'none' : 'block';
    }

    async function loadPaymentSession() {
      if (!sessionId) {
        showError('Invalid payment session. Please try again from the app.');
        return;
      }

      try {
        const snapshot = await db.ref(`paymentSessions/${sessionId}`).once('value');
        paymentData = snapshot.val();

        if (!paymentData || paymentData.status !== 'pending') {
          showError('Payment session expired or invalid. Please try again from the app.');
          return;
        }

        // Check if session is older than 10 minutes
        const sessionAge = Date.now() - new Date(paymentData.createdAt).getTime();
        if (sessionAge > 600000) { // 10 minutes
          showError('Payment session expired. Please try again from the app.');
          await db.ref(`paymentSessions/${sessionId}`).remove();
          return;
        }

        // Display payment info
        amountEl.textContent = `₹${paymentData.bookingData.fare}`;
        descriptionEl.innerHTML = `
          <strong>Route:</strong> ${paymentData.bookingData.pickup} → ${paymentData.bookingData.dropoff}<br>
          <strong>Date:</strong> ${formatDate(paymentData.bookingData.date)} ${formatTime(paymentData.bookingData.time)}<br>
          <strong>Seats:</strong> ${paymentData.bookingData.seatsRequested}
        `;

      } catch (error) {
        console.error('Failed to load payment session:', error);
        showError('Failed to load payment details. Please try again.');
      }
    }

    // Initialize Razorpay payment
    payBtn.addEventListener('click', async () => {
      if (!paymentData) return;

      showLoading();

      const rzpOptions = {
        key: 'rzp_live_RJxLTulsCPKQqD',
        amount: paymentData.bookingData.fare * 100,
        currency: 'INR',
        name: 'WaveTravel',
        description: 'Ride Booking Payment',
        prefill: {
          name: paymentData.userData.name,
          contact: paymentData.userData.phone,
          email: paymentData.userData.email || ''
        },
        theme: {
          color: '#0077ff'
        },
        handler: async function(response) {
          console.log('Payment successful:', response);
          
          try {
            // Update payment session with success
            await db.ref(`paymentSessions/${sessionId}`).update({
              status: 'completed',
              paymentId: response.razorpay_payment_id,
              completedAt: new Date().toISOString()
            });

            showSuccess('Payment successful! You can now return to the app.');
            
            // Auto-close after delay
            setTimeout(() => {
              window.close();
            }, 3000);

          } catch (error) {
            console.error('Failed to update payment status:', error);
            showError('Payment successful but failed to update status. Please contact support.');
          }
        },
        modal: {
          ondismiss: function() {
            console.log('Payment cancelled by user');
            showLoading(false);
          }
        }
      };

      try {
        const rzp = new Razorpay(rzpOptions);
        rzp.open();
        showLoading(false);
      } catch (error) {
        console.error('Failed to initialize Razorpay:', error);
        showError('Failed to initialize payment. Please try again.');
        showLoading(false);
      }
    });

    // Cancel payment
    cancelBtn.addEventListener('click', async () => {
      try {
        await db.ref(`paymentSessions/${sessionId}`).update({
          status: 'failed',
          cancelledAt: new Date().toISOString()
        });
        
        showError('Payment cancelled. You can return to the app.');
        
        setTimeout(() => {
          window.close();
        }, 2000);
        
      } catch (error) {
        console.error('Failed to cancel payment:', error);
        window.close();
      }
    });

    function formatDate(d) {
      if (!d || typeof d !== 'string') return d || '-';
      const [y, m, dd] = d.split('-');
      if (!dd) return d;
      return `${dd}/${m}/${y}`;
    }

    function formatTime(t) {
      if (!t || typeof t !== 'string') return t || '-';
      let [h, mm] = t.split(':').map(Number);
      if (isNaN(h)) return t;
      const suffix = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return `${h}:${(mm||0).toString().padStart(2,'0')} ${suffix}`;
    }

    // Load payment session on page load
    loadPaymentSession();

    // Handle page visibility change (user returns from UPI app)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        console.log('User returned to payment page');
        // Could check payment status here if needed
      }
    });

    // Auto-close if window loses focus for too long (optional)
    let focusTimer;
    window.addEventListener('blur', () => {
      focusTimer = setTimeout(() => {
        console.log('Payment window inactive too long');
      }, 300000); // 5 minutes
    });

    window.addEventListener('focus', () => {
      if (focusTimer) {
        clearTimeout(focusTimer);
        focusTimer = null;
      }
    });
  </script>
</body>
</html>
