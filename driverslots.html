<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Driver Slot Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0;
      background: linear-gradient(to right, #8e2de2, #4a00e0); color: white;
      min-height: 100vh; padding-bottom: 80px; }
    .container { padding: 16px; max-width: 600px; margin: 0 auto; }
    h1 { font-size: 1.5rem; text-align: center; margin-bottom: 16px; }
    label { display: block; margin-top: 12px; font-size: 0.9rem; }
    select, input { width: 100%; padding: 10px; border: none; border-radius: 8px;
      margin-top: 6px; font-size: 1rem; }
    button { margin-top: 20px; padding: 12px; width: 100%; background: #ffd700;
      color: black; font-weight: bold; border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer; }
    .slot-list { margin-top: 24px; }
    .slot-card { background: rgba(255,255,255,0.1); padding: 16px;
      border-radius: 10px; margin-bottom: 15px; }
    .slot-card p { margin: 6px 0; font-size: 0.9rem; }
    .slot-card button { background: #ff4d4d; color: white; padding: 8px 12px;
      margin-top: 10px; font-size: 0.85rem; border: none; border-radius: 6px;
      cursor: pointer; }
    .navbar { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px); display: flex; justify-content: space-around;
      align-items: center; padding: 12px 0; z-index: 999; }
    .navbar a { color: #fff; text-decoration: none; font-size: 0.75rem;
      display: flex; flex-direction: column; align-items: center; }
    .navbar a i { font-size: 1.2rem; margin-bottom: 2px; }
    .time-select-group { display: flex; gap: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Add Available Slot</h1>

    <label for="pickup">Pickup Location</label>
    <select id="pickup"></select>

    <label for="dropoff">Dropoff Location</label>
    <select id="dropoff"></select>

    <label for="car">Select Car</label>
    <select id="car"><option disabled selected>Loading...</option></select>

    <label for="date">Date</label>
    <input type="date" id="date"/>

    <label>Time</label>
    <div class="time-select-group">
      <select id="hour"></select>
      <select id="minute"></select>
      <select id="ampm"><option>AM</option><option>PM</option></select>
    </div>

    <label for="seats">Available Seats (Max 6)</label>
    <input type="number" id="seats" min="1" max="6"/>

    <button id="addSlotBtn">Add Slot</button>

    <div class="slot-list" id="slotList"></div>
  </div>

  <div class="navbar">
    <a href="driverdashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="drivermybookings.html"><i class="fas fa-list"></i><span>My Bookings</span></a>
    <a href="driverslots.html"><i class="fas fa-calendar"></i><span>Slots</span></a>
    <a href="drivermycars.html"><i class="fas fa-car"></i><span>My Cars</span></a>
    <a href="driverprofile.html"><i class="fas fa-user"></i><span>Profile</span></a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, push, get, onValue, remove } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      // ← changed here to the classic firebaseio.com endpoint:
      databaseURL: "https://wavetravel-3c4c4.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const pickup = document.getElementById("pickup");
    const dropoff = document.getElementById("dropoff");
    const car = document.getElementById("car");
    const date = document.getElementById("date");
    const hour = document.getElementById("hour");
    const minute = document.getElementById("minute");
    const ampm = document.getElementById("ampm");
    const seats = document.getElementById("seats");
    const slotList = document.getElementById("slotList");
    const addBtn = document.getElementById("addSlotBtn");

    // Populate time selectors
    for (let i = 1; i <= 12; i++) hour.innerHTML += `<option>${i}</option>`;
    for (let i = 0; i < 60; i += 5) {
      const val = i.toString().padStart(2, '0');
      minute.innerHTML += `<option>${val}</option>`;
    }

    // Date default
    const today = new Date();
    const iso = today.toISOString().split("T")[0];
    date.min = date.value = iso;

    function to24(h,m,ap){
      h = parseInt(h,10);
      if (ap==='PM'&&h<12) h+=12;
      if (ap==='AM'&&h===12) h=0;
      return `${h.toString().padStart(2,'0')}:${m}`;
    }
    function fmt12(t){
      let [h,m]=t.split(':').map(Number);
      const ap = h>=12?'PM':'AM';
      h = h%12||12;
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')} ${ap}`;
    }

    function loadLoc(){
      onValue(ref(db,"locations"),snap=>{
        const locs=snap.val()||[];
        let opts="";
        locs.forEach(l=> opts+=`<option>${l.name}</option>`);
        pickup.innerHTML = dropoff.innerHTML = opts;
      });
    }

    function loadSlots(uid){
      onValue(ref(db,`availableslots/${uid}`),snap=>{
        let cnt=1, html="";
        snap.forEach(ch=>{
          const s=ch.val();
          html+=`
            <div class="slot-card">
              <p><strong>Sl No. ${cnt++}</strong></p>
              <p><strong>${s.pickup}</strong> → <strong>${s.dropoff}</strong></p>
              <p>Date: ${s.date}, Time: ${fmt12(s.time)}</p>
              <p>Seats: ${s.seats}</p>
              <button onclick="remove(ref(db,'availableslots/${uid}/${ch.key}'))">Delete</button>
            </div>`;
        });
        slotList.innerHTML=html;
      });
    }

    onAuthStateChanged(auth,user=>{
      if(!user) return location.href="login.html";
      const uid=user.uid;
      loadLoc(); loadSlots(uid);

      // load approved cars
      onValue(ref(db,"approvedcars"),snap=>{
        let o="", found=false;
        snap.forEach(ch=>{
          const d=ch.val();
          if(d.driverId===uid){
            found=true;
            o+=`<option value="${ch.key}">${d.carBrand} (${d.carReg})</option>`;
          }
        });
        car.innerHTML=found?o:`<option disabled>No approved cars</option>`;
      });

      addBtn.onclick=async()=>{
        const cid=car.value, pu=pickup.value, dr=dropoff.value,
              dt=date.value, h=hour.value, mi=minute.value, ap=ampm.value,
              st=seats.value;
        if(!cid||!pu||!dr||!dt||!h||!mi||!ap||!st) return alert("Fill all fields");
        // fetch car details
        const csnap = await get(ref(db,`approvedcars/${cid}`));
        const cd = csnap.val()||{};
        const t24 = to24(h,mi,ap);
        const slot = {
          pickup: pu, dropoff: dr, date: dt, time: t24, seats: st,
          driverName: cd.driverName||"", driverNumber: cd.driverNumber||"",
          carBrand: cd.carBrand||""
        };
        await push(ref(db,`availableslots/${uid}`),slot);
        alert("Slot added successfully");
        seats.value="";
      };
    });
  </script>
</body>
</html>
