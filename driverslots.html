<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Driver Slot Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(to right, #8e2de2, #4a00e0);
      color: white;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    .container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      margin-top: 6px;
      font-size: 1rem;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background: #ffd700;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .fare-display {
      margin-top: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .fare-display.show {
      background: rgba(255, 215, 0, 0.2);
      border: 2px solid #ffd700;
    }
    .slot-list {
      margin-top: 24px;
    }
    .slot-card {
      background: rgba(255,255,255,0.1);
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .slot-card p {
      margin: 6px 0;
      font-size: 0.9rem;
    }
    .slot-card .fare-highlight {
      background: rgba(255, 215, 0, 0.2);
      padding: 8px;
      border-radius: 6px;
      margin: 8px 0;
      font-weight: bold;
      text-align: center;
    }
    .slot-card button {
      background: #ff4d4d;
      color: white;
      padding: 8px 12px;
      margin-top: 10px;
      font-size: 0.85rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .navbar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 999;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .navbar a i {
      font-size: 1.2rem;
      margin-bottom: 2px;
    }
    .time-select-group {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Add Available Slot</h1>

    <label for="pickup">Pickup Location</label>
    <select id="pickup"></select>

    <label for="dropoff">Dropoff Location</label>
    <select id="dropoff"></select>

    <label for="triptype">Trip Type</label>
    <select id="triptype">
      <option value="oneway">One Way</option>
      <option value="roundtrip">Round Trip</option>
    </select>

    <label for="car">Select Car</label>
    <select id="car">
      <option disabled selected>Loading cars...</option>
    </select>

    <label for="date">Date</label>
    <input type="date" id="date"/>

    <label>Time</label>
    <div class="time-select-group">
      <select id="hour"></select>
      <select id="minute"></select>
      <select id="ampm">
        <option value="AM">AM</option>
        <option value="PM">PM</option>
      </select>
    </div>

    <button id="addSlotBtn">Add Slot</button>

    <div class="slot-list" id="slotList"></div>
  </div>

  <div class="navbar">
    <a href="driverdashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="drivermybookings.html"><i class="fas fa-list"></i><span>My Bookings</span></a>
    <a href="driverslots.html"><i class="fas fa-calendar"></i><span>Slots</span></a>
    <a href="drivermycars.html"><i class="fas fa-car"></i><span>My Cars</span></a>
    <a href="driverprofile.html"><i class="fas fa-user"></i><span>Profile</span></a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import {
      getDatabase, ref, push, get, onValue, remove
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const pickup = document.getElementById("pickup");
    const dropoff = document.getElementById("dropoff");
    const triptype = document.getElementById("triptype");
    const car = document.getElementById("car");
    const date = document.getElementById("date");
    const hour = document.getElementById("hour");
    const minute = document.getElementById("minute");
    const ampm = document.getElementById("ampm");
    const slotList = document.getElementById("slotList");
    const addBtn = document.getElementById("addSlotBtn");

    // Store location fare data
    let locationFareMap = {};

    // Populate hour/minute selectors
    for (let i = 1; i <= 12; i++) hour.innerHTML += `<option>${i}</option>`;
    for (let i = 0; i < 60; i += 5) {
      const v = i.toString().padStart(2, '0');
      minute.innerHTML += `<option>${v}</option>`;
    }

    // Default date to today
    const today = new Date();
    const iso = today.toISOString().split("T")[0];
    date.min = date.value = iso;

    function to24(h, m, ap) {
      let hh = parseInt(h, 10);
      if (ap === "PM" && hh < 12) hh += 12;
      if (ap === "AM" && hh === 12) hh = 0;
      return `${hh.toString().padStart(2, '0')}:${m}`;
    }
    function fmt12(t) {
      if (!t) return '-';
      let [hh, mm] = t.split(":").map(Number);
      if (isNaN(hh) || isNaN(mm)) return t;
      const ap = hh >= 12 ? "PM" : "AM";
      hh = hh % 12 || 12;
      return `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')} ${ap}`;
    }

    let driverId = "";

    // small helper to escape text inserted into HTML attributes
    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Calculate fare based on pickup, dropoff, and trip type
    function calculateFare(pickupName, dropoffName, tripType) {
      const pickupData = locationFareMap[pickupName];
      const dropoffData = locationFareMap[dropoffName];
      
      if (!pickupData || !dropoffData) {
        console.warn('Missing fare data for:', pickupName, dropoffName);
        return 0;
      }

      let fare = 0;
      if (tripType === 'oneway') {
        const pickupFare = Number(pickupData.onewayfare || 0);
        const dropoffFare = Number(dropoffData.onewayfare || 0);
        fare = Math.abs(pickupFare - dropoffFare);
      } else if (tripType === 'roundtrip') {
        const pickupFare = Number(pickupData.roundtripfare || pickupData.roundtrip || 0);
        const dropoffFare = Number(dropoffData.roundtripfare || dropoffData.roundtrip || 0);
        fare = Math.abs(pickupFare - dropoffFare);
      }
      
      return fare;
    }

    // Update fare display when pickup, dropoff, or trip type changes
    function updateFareDisplay() {
      const pickupValue = pickup.value;
      const dropoffValue = dropoff.value;
      const tripTypeValue = triptype.value;
      
      if (!pickupValue || !dropoffValue) {
        fareDisplay.textContent = "Select pickup and dropoff to see fare";
        fareDisplay.classList.remove('show');
        return;
      }
      
      if (pickupValue === dropoffValue) {
        fareDisplay.textContent = "Pickup and dropoff cannot be the same";
        fareDisplay.classList.remove('show');
        return;
      }
      
      const fare = calculateFare(pickupValue, dropoffValue, tripTypeValue);
      const tripTypeDisplay = tripTypeValue === 'roundtrip' ? 'Round Trip' : 'One Way';
      
      if (fare > 0) {
        fareDisplay.innerHTML = `
          <div style="font-size: 0.9rem; margin-bottom: 5px;">${tripTypeDisplay} Fare</div>
          <div style="font-size: 1.3rem; color: #ffd700;">₹${fare}</div>
        `;
        fareDisplay.classList.add('show');
      } else {
        fareDisplay.textContent = "Unable to calculate fare";
        fareDisplay.classList.remove('show');
      }
    }

    /**
     * Load locations and set defaults:
     * - Pickup default to "Berhampore" (with flexible matching for spaces/case)
     * - Dropoff default to "Kolkata Airport" (case-insensitive) if present.
     * Works whether /locations is an array or object.
     */
    function loadLocations() {
      onValue(ref(db, "locations"), snap => {
        const val = snap.val();
        let opts = "";
        let pickupDefaultOption = null;
        let dropoffDefaultOption = null;
        
        // Clear fare map
        locationFareMap = {};
        
        // If nothing, clear selects
        if (!val) {
          pickup.innerHTML = `<option disabled>No locations</option>`;
          dropoff.innerHTML = `<option disabled>No locations</option>`;
          return;
        }

        // Collect all location names and build options
        const locationNames = [];
        
        // If array-like
        if (Array.isArray(val)) {
          for (const l of val) {
            if (!l) continue;
            const name = l.name || String(l);
            locationNames.push({ name, data: l });
          }
        } else {
          // object: iterate keys so structure like /locations/8 works
          for (const k of Object.keys(val)) {
            const l = val[k];
            if (!l) continue;
            const name = (typeof l === 'object' && l.name) ? l.name : String(l);
            locationNames.push({ name, data: l });
          }
        }

        // Build options, fare map, and find defaults
        for (const { name, data } of locationNames) {
          const cleanName = String(name).trim();
          const nameLower = cleanName.toLowerCase();
          
          opts += `<option value="${escapeHtml(cleanName)}">${escapeHtml(cleanName)}</option>`;
          
          // Store fare data
          if (typeof data === 'object' && data !== null) {
            locationFareMap[cleanName] = {
              onewayfare: Number(data.onewayfare || 0),
              roundtripfare: Number(data.roundtripfare || data.roundtrip || 0)
            };
          }
          
          // Check for Berhampore (flexible matching - handles "Berhampore ", "berhampore", etc.)
          if (nameLower === "berhampore" && !pickupDefaultOption) {
            pickupDefaultOption = cleanName;
          }
          
          // Check for Kolkata Airport
          if (nameLower === "kolkata airport" && !dropoffDefaultOption) {
            dropoffDefaultOption = cleanName;
          }
        }

        // Assign built options to both pickup and dropoff
        pickup.innerHTML = opts;
        dropoff.innerHTML = opts;

        // Set defaults if found
        if (pickupDefaultOption) {
          try { 
            pickup.value = pickupDefaultOption;
            console.log(`Set pickup default to: "${pickupDefaultOption}"`);
          } catch (e) { 
            console.warn('Failed to set pickup default:', e);
          }
        }
        
        if (dropoffDefaultOption) {
          try {
            dropoff.value = dropoffDefaultOption;
            console.log(`Set dropoff default to: "${dropoffDefaultOption}"`);
          } catch (e) {
            console.warn('Failed to set dropoff default:', e);
          }
        }
        
        console.log('Available locations:', locationNames.map(l => l.name));
        console.log('Location fare map:', locationFareMap);
        console.log('Pickup default found:', pickupDefaultOption);
        console.log('Dropoff default found:', dropoffDefaultOption);
      }, err => {
        console.error("Failed to read locations:", err);
        pickup.innerHTML = `<option disabled>Error loading locations</option>`;
        dropoff.innerHTML = `<option disabled>Error loading locations</option>`;
      });
    }

    function loadSlots(uid) {
      onValue(ref(db, `availableslots/${uid}`), snap => {
        let cnt = 1, html = "";
        snap.forEach(ch => {
          const s = ch.val();
          const tripTypeDisplay = s.triptype === 'roundtrip' ? 'Round Trip' : 'One Way';
          
          html += `
            <div class="slot-card">
              <p><strong>Sl No. ${cnt++}</strong></p>
              <p><strong>${escapeHtml(s.pickup)}</strong> ➝ <strong>${escapeHtml(s.dropoff)}</strong></p>
              <p>Trip Type: ${escapeHtml(tripTypeDisplay)}</p>
              <p>Date: ${escapeHtml(s.date)}, Time: ${escapeHtml(fmt12(s.time))}</p>
              <p>Seats: ${escapeHtml(s.seats)}</p>
              <p>Car: ${escapeHtml(s.carBrand)} (${escapeHtml(s.carReg)})</p>
              <p>Driver: ${escapeHtml(s.driverName)}</p>
              <button onclick="deleteSlot('${ch.key}')">Delete</button>
            </div>`;
        });
        slotList.innerHTML = html;
      });
    }

    // expose deleteSlot globally for inline onclick
    window.deleteSlot = function(key) {
      if (!driverId) return;
      if (confirm("Are you sure to delete this slot?")) {
        remove(ref(db, `availableslots/${driverId}/${key}`));
      }
    };

    // Add event listeners for fare calculation
    // pickup.addEventListener('change', updateFareDisplay);
    // dropoff.addEventListener('change', updateFareDisplay);
    // triptype.addEventListener('change', updateFareDisplay);

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Please log in.");
        return window.location.href = "login.html";
      }
      driverId = user.uid;

      loadLocations();
      loadSlots(driverId);

      // Load this driver's cars, showing seat count in the dropdown
      onValue(ref(db, `approvedcars/${driverId}`), snap => {
        let opts = "";
        snap.forEach(ch => {
          const d = ch.val();
          const seatText = d.seats ? `${d.seats} seats` : "Unknown seats";
          opts += `<option value="${escapeHtml(ch.key)}">${escapeHtml(d.carBrand)} (${escapeHtml(seatText)})</option>`;
        });
        car.innerHTML = opts || `<option disabled>No approved cars</option>`;
      });

      addBtn.onclick = async () => {
        const cid = car.value,
              pu = pickup.value,
              dr = dropoff.value,
              tt = triptype.value,
              dt = date.value,
              h  = hour.value,
              mi = minute.value,
              ap = ampm.value;
              
        if (!cid || !pu || !dr || !tt || !dt || !h || !mi || !ap) {
          return alert("All fields are required");
        }
        
        if (pu === dr) {
          return alert("Pickup and dropoff locations must be different");
        }

        // Calculate fare
        const fare = calculateFare(pu, dr, tt);
        if (fare <= 0) {
          return alert("Unable to calculate fare. Please check pickup and dropoff locations.");
        }

        // Fetch car details (including seats) from approvedcars
        const carSnap = await get(ref(db, `approvedcars/${driverId}/${cid}`));
        const cd = carSnap.val() || {};
        const seatCount = cd.seats || 0;

        const t24 = to24(h, mi, ap);
        const slotData = {
          pickup: pu,
          dropoff: dr,
          triptype: tt,
          date: dt,
          time: t24,
          fare: fare, // Include calculated fare
          seats: seatCount,
          driverName: cd.driverName || "",
          driverNumber: cd.driverNumber || "",
          carBrand: cd.carBrand || "",
          carReg: cd.carReg || ""
        };

        try {
          await push(ref(db, `availableslots/${driverId}`), slotData);
          alert("Slot added successfully!");
          
          // Reset form (optional)
          // car.selectedIndex = 0;
          // date.value = iso;
          // hour.selectedIndex = 0;
          // minute.selectedIndex = 0;
          // ampm.value = "AM";
        } catch (error) {
          console.error("Error adding slot:", error);
          alert("Failed to add slot. Please try again.");
        }
      };
    });
  </script>
</body>
</html>
