<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Driver Slot Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(to right, #8e2de2, #4a00e0);
      color: white;
      min-height: 100vh;
      padding-bottom: 80px;
    }
    .container {
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      margin-top: 6px;
      font-size: 1rem;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background: #ffd700;
      color: black;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }
    .slot-list {
      margin-top: 24px;
    }
    .slot-card {
      background: rgba(255,255,255,0.1);
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .slot-card p {
      margin: 6px 0;
      font-size: 0.9rem;
    }
    .slot-card button {
      background: #ff4d4d;
      color: white;
      padding: 8px 12px;
      margin-top: 10px;
      font-size: 0.85rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .navbar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 12px 0;
      z-index: 999;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .navbar a i {
      font-size: 1.2rem;
      margin-bottom: 2px;
    }
    .time-select-group {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Add Available Slot</h1>

    <label for="pickup">Pickup Location</label>
    <select id="pickup"></select>

    <label for="dropoff">Dropoff Location</label>
    <select id="dropoff"></select>

    <label for="car">Select Car</label>
    <select id="car">
      <option disabled selected>Loading cars...</option>
    </select>

    <label for="date">Date</label>
    <input type="date" id="date"/>

    <label>Time</label>
    <div class="time-select-group">
      <select id="hour"></select>
      <select id="minute"></select>
      <select id="ampm">
        <option value="AM">AM</option>
        <option value="PM">PM</option>
      </select>
    </div>

    <button id="addSlotBtn">Add Slot</button>

    <div class="slot-list" id="slotList"></div>
  </div>

  <div class="navbar">
    <a href="driverdashboard.html"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="drivermybookings.html"><i class="fas fa-list"></i><span>My Bookings</span></a>
    <a href="driverslots.html"><i class="fas fa-calendar"></i><span>Slots</span></a>
    <a href="drivermycars.html"><i class="fas fa-car"></i><span>My Cars</span></a>
    <a href="driverprofile.html"><i class="fas fa-user"></i><span>Profile</span></a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import {
      getDatabase, ref, push, get, onValue, remove
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsn16p7w8b-x8pEA_WTO5F2oUk4MHwcUc",
      authDomain: "wavetravel-3c4c4.firebaseapp.com",
      databaseURL: "https://wavetravel-3c4c4-default-rtdb.firebaseio.com",
      projectId: "wavetravel-3c4c4",
      storageBucket: "wavetravel-3c4c4.appspot.com",
      messagingSenderId: "298226098137",
      appId: "1:298226098137:web:720953b80e3e61c8bc43c8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const pickup = document.getElementById("pickup");
    const dropoff = document.getElementById("dropoff");
    const car = document.getElementById("car");
    const date = document.getElementById("date");
    const hour = document.getElementById("hour");
    const minute = document.getElementById("minute");
    const ampm = document.getElementById("ampm");
    const slotList = document.getElementById("slotList");
    const addBtn = document.getElementById("addSlotBtn");

    // Populate hour/minute selectors
    for (let i = 1; i <= 12; i++) hour.innerHTML += `<option>${i}</option>`;
    for (let i = 0; i < 60; i += 5) {
      const v = i.toString().padStart(2, '0');
      minute.innerHTML += `<option>${v}</option>`;
    }

    // Default date to today
    const today = new Date();
    const iso = today.toISOString().split("T")[0];
    date.min = date.value = iso;

    function to24(h, m, ap) {
      let hh = parseInt(h, 10);
      if (ap === "PM" && hh < 12) hh += 12;
      if (ap === "AM" && hh === 12) hh = 0;
      return `${hh.toString().padStart(2, '0')}:${m}`;
    }
    function fmt12(t) {
      if (!t) return '-';
      let [hh, mm] = t.split(":").map(Number);
      if (isNaN(hh) || isNaN(mm)) return t;
      const ap = hh >= 12 ? "PM" : "AM";
      hh = hh % 12 || 12;
      return `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')} ${ap}`;
    }

    let driverId = "";

    // small helper to escape text inserted into HTML attributes
    function escapeHtml(s) {
      if (s === undefined || s === null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    /**
     * Load locations and set defaults:
     * - Pickup default to "Berhampore Mohona Bus Stand" if present.
     * - Dropoff default to "Kolkata Airport" (case-insensitive) if present.
     * Works whether /locations is an array or object.
     */
    function loadLocations() {
      onValue(ref(db, "locations"), snap => {
        const val = snap.val();
        let opts = "";
        let pickupDefaultFound = false;
        let dropoffDefaultFound = false;
        // If nothing, clear selects
        if (!val) {
          pickup.innerHTML = `<option disabled>No locations</option>`;
          dropoff.innerHTML = `<option disabled>No locations</option>`;
          return;
        }

        // If array-like
        if (Array.isArray(val)) {
          for (const l of val) {
            if (!l) continue;
            const name = l.name || String(l);
            const nameLower = String(name).trim().toLowerCase();
            opts += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            if (nameLower === "berhampore mohona bus stand") pickupDefaultFound = true;
            if (nameLower === "kolkata airport") dropoffDefaultFound = true;
          }
        } else {
          // object: iterate keys so structure like /locations/8 works
          for (const k of Object.keys(val)) {
            const l = val[k];
            if (!l) continue;
            const name = (typeof l === 'object' && l.name) ? l.name : String(l);
            const nameLower = String(name).trim().toLowerCase();
            opts += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            if (nameLower === "berhampore mohona bus stand") pickupDefaultFound = true;
            if (nameLower === "kolkata airport") dropoffDefaultFound = true;
          }
        }

        // assign built options to both pickup and dropoff
        pickup.innerHTML = opts;
        dropoff.innerHTML = opts;

        // If defaults exist, set them (use try/catch to avoid select value errors)
        if (pickupDefaultFound) {
          try { pickup.value = "Berhampore Mohona Bus Stand"; }
          catch (e) { /* ignore */ }
        }
        if (dropoffDefaultFound) {
          try {
            // find exact option that matches case-insensitively and set it
            const optsArr = Array.from(dropoff.options);
            const match = optsArr.find(o => o.value.trim().toLowerCase() === "kolkata airport");
            if (match) dropoff.value = match.value;
            else dropoff.value = "Kolkata Airport";
          } catch (e) { /* ignore */ }
        }
      }, err => {
        console.error("Failed to read locations:", err);
        pickup.innerHTML = `<option disabled>Error loading locations</option>`;
        dropoff.innerHTML = `<option disabled>Error loading locations</option>`;
      });
    }

    function loadSlots(uid) {
      onValue(ref(db, `availableslots/${uid}`), snap => {
        let cnt = 1, html = "";
        snap.forEach(ch => {
          const s = ch.val();
          html += `
            <div class="slot-card">
              <p><strong>Sl No. ${cnt++}</strong></p>
              <p><strong>${escapeHtml(s.pickup)}</strong> ‚ûù <strong>${escapeHtml(s.dropoff)}</strong></p>
              <p>Date: ${escapeHtml(s.date)}, Time: ${escapeHtml(fmt12(s.time))}</p>
              <p>Seats: ${escapeHtml(s.seats)}</p>
              <p>Car: ${escapeHtml(s.carBrand)} (${escapeHtml(s.carReg)})</p>
              <p>Driver: ${escapeHtml(s.driverName)}</p>
              <button onclick="deleteSlot('${ch.key}')">Delete</button>
            </div>`;
        });
        slotList.innerHTML = html;
      });
    }

    // expose deleteSlot globally for inline onclick
    window.deleteSlot = function(key) {
      if (!driverId) return;
      if (confirm("Are you sure to delete this slot?")) {
        remove(ref(db, `availableslots/${driverId}/${key}`));
      }
    };

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Please log in.");
        return window.location.href = "login.html";
      }
      driverId = user.uid;

      loadLocations();
      loadSlots(driverId);

      // Load this driver's cars, showing seat count in the dropdown
      onValue(ref(db, `approvedcars/${driverId}`), snap => {
        let opts = "";
        snap.forEach(ch => {
          const d = ch.val();
          const seatText = d.seats ? `${d.seats} seats` : "Unknown seats";
          opts += `<option value="${escapeHtml(ch.key)}">${escapeHtml(d.carBrand)} (${escapeHtml(seatText)})</option>`;
        });
        car.innerHTML = opts || `<option disabled>No approved cars</option>`;
      });

      addBtn.onclick = async () => {
        const cid = car.value,
              pu = pickup.value,
              dr = dropoff.value,
              dt = date.value,
              h  = hour.value,
              mi = minute.value,
              ap = ampm.value;
        if (!cid || !pu || !dr || !dt || !h || !mi || !ap) {
          return alert("All fields are required");
        }

        // Fetch car details (including seats) from approvedcars
        const carSnap = await get(ref(db, `approvedcars/${driverId}/${cid}`));
        const cd = carSnap.val() || {};
        const seatCount = cd.seats || 0;

        const t24 = to24(h, mi, ap);
        const slotData = {
          pickup: pu,
          dropoff: dr,
          date: dt,
          time: t24,
          seats: seatCount,
          driverName: cd.driverName || "",
          driverNumber: cd.driverNumber || "",
          carBrand: cd.carBrand || "",
          carReg: cd.carReg || ""
        };

        await push(ref(db, `availableslots/${driverId}`), slotData);
        alert("Slot added successfully");
      };
    });
  </script>
</body>
</html>
